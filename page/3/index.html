<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zyt">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Matrix</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matrix</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/14/Simple-Instruction-Count/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/14/Simple-Instruction-Count/" itemprop="url">一、Simple Instruction Count (Instruction Instrumentation)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-14T16:58:05+08:00">
                2020-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Simple-Instruction-Count-Instruction-Instrumentation"><a href="#Simple-Instruction-Count-Instruction-Instrumentation" class="headerlink" title="Simple Instruction Count (Instruction Instrumentation)"></a>Simple Instruction Count (Instruction Instrumentation)</h2><p><strong>动态插桩基本流程：</strong>  </p>
<p>动态插桩(Dynamic Instrumentation)就是在程序运行中对其插入一定分析代码，主要流程包含两个部分：</p>
<ul>
<li>确定插桩代码插入的位置和插入的代码</li>
<li>确定在插入点需要执行的分析代码</li>
</ul>
<p>这两个组件是 instrumentation 代码和 analysis 代码。 这两个组件都位于一个可执行文件Pintool中。 Pintools可以看作是可以修改Pin内部代码生成过程的插件。</p>
<p>Pintool会在需要生成新代码的情况下调用Pin来注册 instrumentation 回调函数。 该 instrumentation 回调函数表示 instrumentation 组件。 它检查要生成的代码，提取其静态属性，并确定是否以及在何处插入 analysis 函数。</p>
<p>analysis 函数会收集有关应用程序的数据。 Pin 确保整数和浮点寄存器的状态在必要时得以保存和恢复，并允许将参数传递给函数。</p>
<p>Pintool还可以为诸如线程创建或派生之类的事件注册回调函数。 这些回调函数通常用于收集数据或工具初始化或清理。</p>
<p>编写 Pintool 时，调整 analysis 代码比 instrumentation 代码更重要。 这是因为 instrumentation 仅执行一次，但是 analysis 代码却被多次调用。</p>
<p><strong>Pintool 包含的内容：</strong>  </p>
<p>Instrumentation routines：仅当事件第一次发生时被调用<br>Analysis routines：某对象每次被访问时都调用<br>Callbacks routines：无论何时当特定事件发生时都调用</p>
<p>当尚未重新编译的代码将要被执行时，将调用 Instrumentation routines，并允许插入 Analysis routines。当运行与 Analysis routines 相关的代码时，将调用这些 Analysis routines。 仅当满足特定条件或发生特定事件时，才调用 Callbacks routines。 Pin提供了广泛的应用程序编程接口（API），可用于从对单条指令到整个二进制模块的不同抽象级别的插桩。它还支持许多事件的回调 Callbacks，例如库加载，系统调用，信号/异常和线程创建事件。</p>
<blockquote>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Pin_(computer_program)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Pin_(computer_program)</a></li>
<li><a href="https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/" target="_blank" rel="noopener">https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/</a></li>
</ol>
</blockquote>
<p><strong>例子程序：</strong>  </p>
<p>下面的例子对程序进行插桩，统计其指令数目。在每一条指令前插入函数<code>docount</code>。当程序退出的时候，将<code>count</code>保存在文件<code>iscount.pout</code>中。</p>
<p>首先进行编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cd source&#x2F;tools&#x2F;ManualExamples</span><br><span class="line"></span><br><span class="line"># make obj-ia32&#x2F;inscount0.so TARGET&#x3D;ia32</span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER&#x3D;1 -Wall -Werror -Wno-unknown-pragmas -fno-stack-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;gen -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;components&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;tools&#x2F;InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32&#x2F;inscount0.o inscount0.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style&#x3D;sysv -Wl,-Bsymbolic -Wl,--version-script&#x3D;..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;pintool.ver    -o obj-ia32&#x2F;inscount0.so obj-ia32&#x2F;inscount0.o  -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib-ext -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;runtime&#x2F;glibc -L..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;lib -lpin -lxed -ldwarf -lelf -ldl</span><br><span class="line"></span><br><span class="line"># ls .&#x2F;obj-ia32&#x2F;</span><br><span class="line">inscount0.o  inscount0.so</span><br></pre></td></tr></table></figure>

<p>pin的使用方式为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pin [OPTION] [-t &lt;tool&gt; [&lt;toolargs&gt;]] -- &lt;command line&gt;</span><br></pre></td></tr></table></figure>

<p><code>-t</code>之后接 pintool 的so文件，之后接传递给pintool的参数，在–之后接需要进行分析的程序以及它的参数。</p>
<p>下面是如何运行它并显示它的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;inscount0.so -- &#x2F;bin&#x2F;ls</span><br><span class="line">2comp  hello.txt  inscount.out	pinatrace.out  pin.log	tmp_res.out</span><br><span class="line"></span><br><span class="line"># cat inscount.out </span><br><span class="line">Count 454790</span><br></pre></td></tr></table></figure>

<p><code>KNOB</code>可以覆盖默认的输出文件的名字，在命令行中增加<code>-o &lt;file_name&gt;</code>即可使用。工具的命令行选项应当插入在<code>pintool_name</code>和<code>--</code>之间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;inscount0.so -o inscount0.log -- &#x2F;bin&#x2F;ls</span><br><span class="line">2comp  hello.txt  inscount0.log  inscount.out  pinatrace.out  pin.log  tmp_res.out</span><br><span class="line"></span><br><span class="line"># cat inscount0.log </span><br><span class="line">Count 463404</span><br></pre></td></tr></table></figure>

<p>本例的源码在<code>source/tools/ManualExamples/inscount0.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"></span><br><span class="line">ofstream OutFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The running count of instructions is kept here</span></span><br><span class="line"><span class="comment">// make it static to help the compiler optimize docount</span></span><br><span class="line"><span class="keyword">static</span> UINT64 icount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called before every instruction is executed </span></span><br><span class="line"><span class="comment">// 每一条指令被执行前调用此函数</span></span><br><span class="line"><span class="function">VOID <span class="title">docount</span><span class="params">()</span> </span>&#123; icount++; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin calls this function every time a new instruction is encountered </span></span><br><span class="line"><span class="comment">// 每当遇到新的指令时调用此函数</span></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Insert a call to docount before every instruction, no arguments are passed</span></span><br><span class="line">    INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)docount, IARG_END);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;<span class="built_in">string</span>&gt; <span class="title">KnobOutputFile</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"o"</span>, <span class="string">"inscount.out"</span>, <span class="string">"specify output file name"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    OutFile.setf(ios::showbase);</span><br><span class="line">    OutFile &lt;&lt; <span class="string">"Count "</span> &lt;&lt; icount &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    OutFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool counts the number of dynamic instructions executed"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/*   argc, argv are the entire command line: pin -t &lt;toolname&gt; -- ...    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line"></span><br><span class="line">    OutFile.<span class="built_in">open</span>(KnobOutputFile.Value().c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">    <span class="comment">// 对指令进行插桩</span></span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    <span class="comment">// 程序退出时的回调函数</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子程序给出了一般pintool的基本框架，在main函数中首先调用函数<code>PIN_Init</code>初始化，之后就可以使用<code>INS_AddInstrumentFunction</code>注册一个插桩函数，当原始程序执行到一条新的指令时，都会执行函数<code>Instruction</code>，其第2个参数为一个额外传递给<code>Instruction</code>的参数，即对应<code>VOID *v</code>这个参数，这里没有使用。而<code>Instruction</code>接受的第一个参数为<code>INS</code>，用来表示一条指令。</p>
<p>最后又注册了一个程序退出时的函数Fini，接着就可以使用PIN_StartProgram启动程序了。</p>
<p><strong>回调函数模式:</strong>  </p>
<p>可以看到，上面 inscount0.cpp 这个pintool插桩的对象就是所有指令。pintool在编写中将比较多的使用回调函数的机制，譬如<code>每当遇见新的指令</code>时会调Instruction函数。而在Instruction函数的内部又使用INS_InsertCall注册了一个函数docount，意为在<code>每条指令执行之前</code>插入一个对docount函数的调用。</p>
<p>注意INS_InsertCall是一个变参函数，前3个参数分别为指令，插入的时机（这里IPOINT_BEFORE表示之前）以及函数指针（转为AFUNPTR类型），在之后就可以指定传给函数的参数，并以IARG_END结尾，这里没有指定参数，直接调用。而docount的作用即是将一个全局变量加1，以达到统计执行指令条数的目的。</p>
<p><strong>指令插桩的位置：</strong>  </p>
<p>最简单的情况是直接针对所有指令插桩，INS模块中提供了很多API来判断当前指令的类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INS_IsMemoryRead (INS ins)</span><br><span class="line">INS_IsMemoryWrite (INS ins)</span><br><span class="line">INS_IsLea (INS ins)</span><br><span class="line">INS_IsNop (INS ins)</span><br><span class="line">INS_IsBranch (INS ins)</span><br><span class="line">INS_IsDirectBranch (INS ins)</span><br><span class="line">INS_IsDirectCall (INS ins)</span><br><span class="line">INS_IsDirectBranchOrCall (INS ins)</span><br><span class="line">INS_IsBranchOrCall (INS ins)</span><br><span class="line">INS_IsCall (INS ins)</span><br><span class="line">INS_IsRet (INS ins)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>还有种更加直接、具体的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (INS_Opcode(ins) &#x3D;&#x3D; XED_ICLASS_MOV &amp;&amp;</span><br><span class="line">    INS_IsMemoryRead(ins) &amp;&amp;</span><br><span class="line">    INS_OperandIsReg(ins, 0) &amp;&amp;</span><br><span class="line">    INS_OperandIsMemory(ins, 1))</span><br></pre></td></tr></table></figure>

<p>上面的代码来自safecopy.cpp，直接通过Opcode来识别mov指令，并且是一条内存读指令，指令的第一个操作数是寄存器,第二个操作数是内存。通过组合这些API就可以非常精确地筛选出想要插桩的指令。</p>
<p>指令插桩的API:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">LEVEL_PINCLIENT::INS_InsertCall</span>	<span class="params">(	INS ins, IPOINT action, AFUNPTR funptr, ... )</span>		</span></span><br><span class="line">对于指令ins插入函数调用funptr。</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">ins			被插桩的指令</span><br><span class="line">action	特指 before, after等等</span><br><span class="line">				IPOINT_BEFORE 对所有指令永久有效</span><br><span class="line">				IPOINT_AFTER 仅当存在`fall-through`时才有效(i.e. call指令和无条件跳转指令将失败).</span><br><span class="line">				IPOINT_TAKEN_BRANCH 对非分支指令无效</span><br><span class="line">funptr	插入的函数</span><br><span class="line">...			传给函数 funptr 的参数列表，以 IARG_END 结束</span><br><span class="line">  </span><br><span class="line">若对同一指令插入了多个函数调用，那么函数调用的顺序取决于IARG_CALL_ORDER</span><br></pre></td></tr></table></figure>

<p><strong>插桩分析代码：</strong></p>
<p>inscount0中的分析代码写的非常简略，再之后还有一个例子itrace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; This function is called before every instruction is executed</span><br><span class="line">&#x2F;&#x2F; and prints the IP</span><br><span class="line">VOID printip(VOID *ip) &#123; fprintf(trace, &quot;%p\n&quot;, ip); &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Pin calls this function every time a new instruction is encountered</span><br><span class="line">VOID Instruction(INS ins, VOID *v)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Insert a call to printip before every instruction, and pass it the IP</span><br><span class="line">    INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)printip, IARG_INST_PTR, IARG_END);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里传递给printip的是一个IARG_INST_PTR参数，实际对应的类型是VOID *，指示了当前指令的位置，而printip则是把它输出出来，所以itrace的作用即是输出所有指令的地址。</p>
<p>实际来说<code>Instrumentation arguments</code>中给出了很多可以传递给回调函数的参数，包括当前指令读取的有效内存地址、相关寄存器的值等等，能够对程序的运行状态有很全面的描述，便于回调函数的进一步分析。</p>
<p><strong>程序运行状态监控 &amp; 修改:</strong><br><strong>寄存器:</strong>  </p>
<p>想要获得当前某个寄存器的值，可以传递<code>...IARG_REG_VALUE</code>, <code>REG_RAX...</code>参数，实际对应的类型是ADDRINT，将寄存器当前的值传给回调函数。或者可以通过INS_OperandReg函数首先提取出指令中的寄存器操作数，然后再用IARG_REG_VALUE传递给回调函数。</p>
<p>想要修改寄存器的值，可以传递…IARG_REG_REFERENCE, REG_RAX…这种参数，实际对应的类型是PIN_REGISTER *指针，指向一个表示寄存器值的union类型，在64位中，可以使用reg-&gt;qword[0]来访问RAX，reg-&gt;dword[0]来访问EAX，以达到修改寄存器值的目的。</p>
<p><strong>内存:</strong>  </p>
<p>关于内存数据的获取和写入，可以参考safecopy，其中使用到了PIN_SafeCopy函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F;  Analysis routines</span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Move from memory to register</span><br><span class="line">ADDRINT DoLoad(REG reg, ADDRINT * addr)</span><br><span class="line">&#123;</span><br><span class="line">    *out &lt;&lt; &quot;Emulate loading from addr &quot; &lt;&lt; addr &lt;&lt; &quot; to &quot; &lt;&lt; REG_StringShort(reg) &lt;&lt; endl;</span><br><span class="line">    ADDRINT value;</span><br><span class="line">    PIN_SafeCopy(&amp;value, addr, sizeof(ADDRINT));</span><br><span class="line">    return value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F; Instrumentation routines</span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">VOID EmulateLoad(INS ins, VOID* v)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Find the instructions that move a value from memory to a register</span><br><span class="line">    if (INS_Opcode(ins) &#x3D;&#x3D; XED_ICLASS_MOV &amp;&amp;</span><br><span class="line">        INS_IsMemoryRead(ins) &amp;&amp;</span><br><span class="line">        INS_OperandIsReg(ins, 0) &amp;&amp;</span><br><span class="line">        INS_OperandIsMemory(ins, 1))</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; op0 &lt;- *op1</span><br><span class="line">        INS_InsertCall(ins,</span><br><span class="line">                       IPOINT_BEFORE,</span><br><span class="line">                       AFUNPTR(DoLoad),</span><br><span class="line">                       IARG_UINT32, REG(INS_OperandReg(ins, 0)),</span><br><span class="line">                       IARG_MEMORYREAD_EA,</span><br><span class="line">                       IARG_RETURN_REGS, INS_OperandReg(ins, 0),</span><br><span class="line">                       IARG_END);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Delete the instruction</span><br><span class="line">        INS_Delete(ins);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>safecopy实际模拟了mov指令内存读的过程，将寄存器和指令操作的内存地址传递给分析函数DoLoad，并在最后用IARG_RETURN_REGS指定将分析函数的返回值写入到指令的操作寄存器中，实际指令的语义没有改变。</p>
<p>而在DoLoad函数中，实际调用了PIN_SafeCopy(&amp;value, addr, sizeof(ADDRINT));将对应地址的内容模拟装载并返回。由此就可以看出在程序实际运行时pintool和原始程序位于同一地址空间，因而PIN_SafeCopy既可以从内存中读取数据，亦可以写入数据。</p>
<p><strong>更粗粒度的插桩:</strong>  </p>
<p>有时我们并不需要在指令级的插桩，pin也可以实现基于Basic Block，Routine或Image的插桩函数，以例子中的malloctrace来说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">VOID Image(IMG img, VOID *v)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Instrument the malloc() and free() functions.  Print the input argument</span><br><span class="line">    &#x2F;&#x2F; of each malloc() or free(), and the return value of malloc().</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F;  Find the malloc() function.</span><br><span class="line">    RTN mallocRtn &#x3D; RTN_FindByName(img, MALLOC);</span><br><span class="line">    if (RTN_Valid(mallocRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(mallocRtn);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Instrument malloc() to print the input argument value and the return value.</span><br><span class="line">        RTN_InsertCall(mallocRtn, </span><br><span class="line">                       IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, MALLOC,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, 0,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_InsertCall(mallocRtn, </span><br><span class="line">                       IPOINT_AFTER, (AFUNPTR)MallocAfter,</span><br><span class="line">                       IARG_FUNCRET_EXITPOINT_VALUE, </span><br><span class="line">                       IARG_END);</span><br><span class="line"></span><br><span class="line">        RTN_Close(mallocRtn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Find the free() function.</span><br><span class="line">    RTN freeRtn &#x3D; RTN_FindByName(img, FREE);</span><br><span class="line">    if (RTN_Valid(freeRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(freeRtn);</span><br><span class="line">        &#x2F;&#x2F; Instrument free() to print the input argument value.</span><br><span class="line">        RTN_InsertCall(freeRtn, </span><br><span class="line">                       IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, FREE,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, 0,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_Close(freeRtn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>使用 IMG_AddInstrumentFunction 来注册一个在Image载入时插桩的函数，随后在Image里面使用RTN_FindByName来找到模块里的malloc和free两个符号，注意在pintool开头除了PIN_Init之外还要用PIN_InitSymbols来初始化symbol manager。在找到相应的函数之后，可以使用RTN_InsertCall来插入分析代码Arg1Before，并将此时函数的参数传递给分析函数。最后这个pintool完成的作用就是追踪malloc/free的调用，并输出它们的参数与返回值。</p>
<blockquote>
<ol>
<li><a href="http://brieflyx.me/2017/binary-analysis/intel-pin-intro/" target="_blank" rel="noopener">http://brieflyx.me/2017/binary-analysis/intel-pin-intro/</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/11/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/11/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/" itemprop="url">Hexo博客中图片显示问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-11T12:17:16+08:00">
                2020-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo博客搭建</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hexo 提供了一种更方便管理 Asset 的设定：post_asset_folder 当您设置 post_asset_folder 为true参数后，在建立文件时，Hexo会自动建立一个与文章同名的文件夹，您可以把与该文章相关的所有资源都放到那个文件夹。</p>
<h2 id="修改博客配置"><a href="#修改博客配置" class="headerlink" title="修改博客配置"></a>修改博客配置</h2><p>修改博客根目录中<code>_config.yml</code>文件的配置项<code>post_asset_folder</code>为<code>true</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true</span><br></pre></td></tr></table></figure>

<p>完成此设置后，当你通过<code>hexo new 文件名</code>新建博客后，会产生一个和文件同名的文件夹。</p>
<p><img src="/2020/07/11/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/image-20200711122009203.png" alt="image-20200711122009203"></p>
<h2 id="下载插件"><a href="#下载插件" class="headerlink" title="下载插件"></a>下载插件</h2><p>在博客根目录中下使用npm安装插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install https:&#x2F;&#x2F;github.com&#x2F;CodeFalling&#x2F;hexo-asset-image --save</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>当文章需要添加图片时，将需要添加的图片放入同名的文件夹中，同时通过相对路径索引到该图片。</p>
<p>例如我在上方修改博客配置中展示的那张图片的md源码为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![image-20200711122009203](.&#x2F;Hexo博客中图片显示问题&#x2F;image-20200711122009203.png)</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://blog.csdn.net/DreamHome_S/article/details/90142578" target="_blank" rel="noopener">https://blog.csdn.net/DreamHome_S/article/details/90142578</a></li>
<li><a href="https://www.jianshu.com/p/ea78bdd0551f" target="_blank" rel="noopener">https://www.jianshu.com/p/ea78bdd0551f</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/" itemprop="url">MacOS 配置 LaTeX（MacTeX + VSCode + Skim）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-11T11:33:09+08:00">
                2020-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Latex/" itemprop="url" rel="index">
                    <span itemprop="name">Latex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、安装准备"><a href="#一、安装准备" class="headerlink" title="一、安装准备"></a>一、安装准备</h2><h3 id="1-安装-MacTeX"><a href="#1-安装-MacTeX" class="headerlink" title="1 安装 MacTeX"></a>1 安装 MacTeX</h3><p>从 <a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.tug.org%2Fmactex%2Fmactex-download.html" target="_blank" rel="noopener">Downloading MacTeX 2019 </a>中下载最新版本的 MacTeX 并安装。</p>
<h3 id="2-安装-VSCode-及相关插件"><a href="#2-安装-VSCode-及相关插件" class="headerlink" title="2 安装 VSCode 及相关插件"></a>2 安装 VSCode 及相关插件</h3><p>从 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fcode.visualstudio.com%2Fdownload" target="_blank" rel="noopener">Download Visual Studio Code</a> 中下载最新版本的 VSCode 并安装。打开 VSCode，在 <code>Extensions</code> 搜索框中输入 LaTeX, 选择 <code>LaTeX WorkShop</code> 插件并安装。本次测试VSCode版本信息：<code>Version: 1.47.0-insider</code></p>
<h2 id="二、LaTeX-WorkShop-插件配置中文环境"><a href="#二、LaTeX-WorkShop-插件配置中文环境" class="headerlink" title="二、LaTeX WorkShop 插件配置中文环境"></a>二、LaTeX WorkShop 插件配置中文环境</h2><p>LaTeX WorkShop 插件默认只提供<code>PDFLaTeX</code>，而中文编译需要<code>XeFLaTeX</code>，所以还需另行配置。进入 Settings 的 JSON 文件，加入以下配置：</p>
<ol>
<li><p>在latex-workshop.latex.tools配置中，增加xelatex项，具体如下。这一项的作用是在工具集中定义xelatex项，以便下一项配置能找到。在setting搜索框中搜索<code>latex-workshop.latex.tools</code>，打开进行编辑</p>
<p><img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711114101327.png" alt="image-20200711114101327"></p>
<p>增加的内容为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">    <span class="attr">"command"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: [</span><br><span class="line">        <span class="string">"-synctex=1"</span>,</span><br><span class="line">        <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">        <span class="string">"-file-line-error"</span>,</span><br><span class="line">        <span class="string">"-pdf"</span>,</span><br><span class="line">        <span class="string">"%DOC%"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>在latex-workshop.latex.recipes配置中，将第一项的latexmk改为xelatex。这里定义的是编译时调用的工具顺序，默认第一个为latexmk，因为我们要支持中文，所以替换为xelatex。在setting搜索框中搜索<code>latex-workshop.latex.tools</code>，打开进行编辑：</p>
<p><img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711114358156.png" alt="image-20200711114358156"></p>
<p>增加的内容为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">    <span class="attr">"tools"</span>: [</span><br><span class="line">    		<span class="string">"xelatex"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改后的<code>settings.json</code>文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"editor.fontSize"</span>: <span class="number">13</span>,</span><br><span class="line">    <span class="attr">"workbench.startupEditor"</span>: <span class="string">"newUntitledFile"</span>,</span><br><span class="line">    <span class="attr">"editor.renderControlCharacters"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"files.autoSave"</span>: <span class="string">"off"</span>,</span><br><span class="line">    <span class="attr">"python.analysis.memory.keepLibraryLocalVariables"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"window.zoomLevel"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"latex-workshop.latex.tools"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"-pdf"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"-pdf"</span>,</span><br><span class="line">                <span class="string">"-outdir=%OUTDIR%"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"lualatexmk"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"-lualatex"</span>,</span><br><span class="line">                <span class="string">"-outdir=%OUTDIR%"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk_rconly"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"pdflatex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"pdflatex"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"bibtex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"bibtex"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"rnw2tex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"Rscript"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-e"</span>,</span><br><span class="line">                <span class="string">"knitr::opts_knit$set(concordance = TRUE); knitr::knit('%DOCFILE_EXT%')"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"jnw2tex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"julia"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-e"</span>,</span><br><span class="line">                <span class="string">"using Weave; weave(\"%DOC_EXT%\", doctype=\"tex\")"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"jnw2texmintex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"julia"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-e"</span>,</span><br><span class="line">                <span class="string">"using Weave; weave(\"%DOC_EXT%\", doctype=\"texminted\")"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"latex-workshop.latex.recipes"</span>: [  </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"xelatex"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk 🔃"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk (latexmkrc)"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"latexmk_rconly"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk (lualatex)"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"lualatexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"pdflatex ➞ bibtex ➞ pdflatex × 2"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"pdflatex"</span>,</span><br><span class="line">                <span class="string">"bibtex"</span>,</span><br><span class="line">                <span class="string">"pdflatex"</span>,</span><br><span class="line">                <span class="string">"pdflatex"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Compile Rnw files"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"rnw2tex"</span>,</span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Compile Jnw files"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"jnw2tex"</span>,</span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个.tex文件，编码为utf8，输入以下内容。保存，<code>option + command + B</code>编译，自动编译产生对应的pdf。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">\<span class="name">documentclass</span><span class="string">[UTF8]</span><span class="string">&#123;ctexart&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">title</span><span class="string">&#123;你好，world!&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">author</span><span class="string">&#123;李明&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">date</span><span class="string">&#123;\today&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">begin</span><span class="string">&#123;document&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">maketitle</span></span></span><br><span class="line">你好，world!</span><br><span class="line"><span class="tag">\<span class="name">end</span><span class="string">&#123;document&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>得到的结果为：</p>
<p><img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711115109103.png" alt="image-20200711115109103"></p>
</li>
</ol>
<h2 id="三、配置VSCode与Skim的LaTeX正反跳转"><a href="#三、配置VSCode与Skim的LaTeX正反跳转" class="headerlink" title="三、配置VSCode与Skim的LaTeX正反跳转"></a>三、配置VSCode与Skim的LaTeX正反跳转</h2><ol>
<li>安装 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fskim-app.sourceforge.io%2F" target="_blank" rel="noopener">Skim</a> PDF 阅读器</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install skim</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>正向跳转</li>
</ol>
<p>正向跳转指的是从 .tex 源文件向编译生成的 PDF 文件的跳转。这部分我们主要需要寻找到合适的方式，在命令行状态打开 Skim 应用。</p>
<p>根据 Skim 官网的介绍，Skim 提供了名为 displayline 的脚本，用于和 TeX 正反同步协同工作。其脚本位于:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Skim.app&#x2F;Contents&#x2F;SharedSupport&#x2F;displayline</span><br></pre></td></tr></table></figure>

<p>具体用法是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Skim.app&#x2F;Contents&#x2F;SharedSupport&#x2F;displayline %line &quot;%pdffile&quot; &quot;%texfile&quot;</span><br></pre></td></tr></table></figure>

<p>此处 <strong><code>%line</code></strong> 表示 <strong><code>.tex</code></strong> 文件的行号，<strong><code>%pdffile</code></strong> 表示编译生成的 PDF 文件的完整路径，<strong><code>%texfile</code></strong>则是对应的 .tex 源文件。考虑到我们对反向搜索也有需求，按照官方文档，我们还需要加上<strong><code>-r</code></strong>参数。</p>
<p>因此，在 VSCode 的配置里，我们需要给出这样的 <strong><code>JSON 配置</code></strong>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">"latex-workshop.view.pdf.viewer": "external",</span><br><span class="line">"latex-workshop.view.pdf.external.synctex": &#123;</span><br><span class="line">    "command": "/Applications/Skim.app/Contents/SharedSupport/displayline",</span><br><span class="line">    "args": [</span><br><span class="line">        "-r",</span><br><span class="line">        "%LINE%",</span><br><span class="line">        "%PDF%",</span><br><span class="line">        <span class="string">"%TEX%"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><strong><code>LaTeX workshop</code></strong>插件的配置中，除了 <strong><code>latex-workshop.view.pdf.external.synctex</code></strong>，还有一项也和打开外部 PDF 浏览器有关。它是 <strong><code>latex-workshop.view.pdf.external.command</code></strong>，表示简单地打开 PDF 文件，而忽略正向搜索功能。<strong><code>Skim</code></strong>提供的命令行脚本默认不支持这样的操作，我们需要根据<strong><code>displayline</code></strong>脚本自行修改。</p>
<p><strong><code>displayline</code></strong>脚本调用了 <strong><code>Apple Script</code></strong> 来实现与 <strong><code>Skim.app</code></strong> 的交互，此处我们照葫芦画瓢，模拟一个即可。我们可以将如下脚本保存为 <strong><code>displayfile</code></strong> 并以 <strong><code>chmod u+x displayfile</code></strong> 使其变为可执行脚本，而后将其放在<strong><code>环境变量 PATH</code></strong> 包含的目录中，如：<code>/usr/local/bin</code>。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># displayfile (Skim)</span><br><span class="line">#</span><br><span class="line"># Usage: displayfile [-r] [-g] PDFFILE</span><br><span class="line">#</span><br><span class="line"># Modified from "displayline" to only revert the file, not jump to a given line</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">if [ $# == 0 -o "$1" == "-h" -o "$1" == "-help" ]; then</span><br><span class="line">  echo "Usage: displayfile [-r] [-g] PDFFILE</span><br><span class="line">Options:</span><br><span class="line">-r, -revert      Revert the file from disk if it was open</span><br><span class="line">-g, -background  Do not bring Skim to the foreground"</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># get arguments</span><br><span class="line">revert=false</span><br><span class="line">activate=true</span><br><span class="line">while [ "$&#123;1:0:1&#125;" == "-" ]; do</span><br><span class="line">  if [ "$1" == "-r" -o "$1" == "-revert" ]; then</span><br><span class="line">    revert=true</span><br><span class="line">  elif [ "$1" == "-g" -o "$1" == "-background" ]; then</span><br><span class="line">    activate=false</span><br><span class="line">  fi</span><br><span class="line">  shift</span><br><span class="line">done</span><br><span class="line">file="$1"</span><br><span class="line">#shopt -s extglob</span><br><span class="line">#[ $# -gt 2 ] &amp;&amp; source="$3" || source="$&#123;file%.@(pdf|dvi|xdv)&#125;.tex"</span><br><span class="line"></span><br><span class="line"># expand relative paths</span><br><span class="line">[ "$&#123;file:0:1&#125;" == "/" ] || file="$&#123;PWD&#125;/$&#123;file&#125;"</span><br><span class="line"></span><br><span class="line"># pass file arguments as NULL-separated string to osascript</span><br><span class="line"># pass through cat to get them as raw bytes to preserve non-ASCII characters</span><br><span class="line">/usr/bin/osascript \</span><br><span class="line">  -e "set theFile to POSIX file \"$file\"" \</span><br><span class="line">  -e "set thePath to POSIX path of (theFile as alias)" \</span><br><span class="line">  -e "tell application \"Skim\"" \</span><br><span class="line">  -e "  if $activate then activate" \</span><br><span class="line">  -e "  if $revert then" \</span><br><span class="line">  -e "    try" \</span><br><span class="line">  -e "      set theDocs to get documents whose path is thePath" \</span><br><span class="line">  -e "      if (count of theDocs) &gt; 0 then revert theDocs" \</span><br><span class="line">  -e "    end try" \</span><br><span class="line">  -e "  end if" \</span><br><span class="line">  -e "  open theFile" \</span><br><span class="line">  -e "end tell"</span><br></pre></td></tr></table></figure>

<p>至此，需要更新 VSCode 的配置。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"latex-workshop.view.pdf.external.command": &#123;</span><br><span class="line">    "command": "displayfile",</span><br><span class="line">    "args": [</span><br><span class="line">        "-r",</span><br><span class="line">        <span class="string">"%PDF%"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><strong>配置完成后,可以从 TeX 源码跳转到 Skim 中对应的 PDF 文件位置(有圆点醒目位置提醒)，快捷键为: <code>option+command+j</code> ；</strong></p>
<h3 id="反向搜索"><a href="#反向搜索" class="headerlink" title="反向搜索"></a>反向搜索</h3><p>在反向搜索中，我们需要让 Skim 能够打开 VSCode，并将文件名和相应的行号正确地传给 VSCode。根据 Skim 官网的介绍，它只会从<strong><code>/usr/bin</code></strong>和 <strong><code>/usr/local/bin</code></strong> 中检索可执行程序。为此，我们需要将 VSCode 的可执行程序软链到这两个目录中的一个当中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf &#x2F;Applications&#x2F;Visual\ Studio\ Code.app&#x2F;Contents&#x2F;MacOS&#x2F;Electron &#x2F;usr&#x2F;local&#x2F;bin&#x2F;vscode</span><br></pre></td></tr></table></figure>

<p>至此，我们在命令行中执行 <strong><code>vscode -g &quot;%file&quot;:%line</code></strong> 即可打开 <strong><code>%file</code></strong> 文件并定位到第 <strong><code>%line</code></strong> 行。于是，我们只需要在 Skim 的同步配置中将预设改为「自定义」(必须改为自动以才可以使用后向跳转)，并将命令和参数分别设置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Command: vscode</span><br><span class="line">Arguments: -g &quot;%file&quot;:%line</span><br></pre></td></tr></table></figure>

<img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711115731991.png" alt="image-20200711115109103" style="zoom:50%;">

<p>如此即完成了配置。</p>
<p><strong>在 Skim 中跳转到TeX源码对应的位置的快捷键: <code>command + shift + click</code></strong></p>
<h2 id="四、vscode-配置-Latex-编译后自动清理多余文件-log-out等文件"><a href="#四、vscode-配置-Latex-编译后自动清理多余文件-log-out等文件" class="headerlink" title="四、vscode 配置 Latex 编译后自动清理多余文件(.log .out等文件)"></a>四、vscode 配置 Latex 编译后自动清理多余文件(.log .out等文件)</h2><p>在使用VSCode配置Latex时我们都会安装一个环境，就是：Latex Wordshop，在setting中是可以设置生成pdf后清理这些文件，但是版本不同的设置的方法也不同，因此：</p>
<p>新版VSCode中的setting配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">"latex-workshop.latex.autoClean.run": "onBuilt", //注意结尾是 t 不是 d</span><br><span class="line">"latex-workshop.latex.clean.fileTypes": [</span><br><span class="line">  "*.aux",</span><br><span class="line">  "*.bbl",</span><br><span class="line">  "*.blg",</span><br><span class="line">  "*.idx",</span><br><span class="line">  "*.ind",</span><br><span class="line">  "*.lof",</span><br><span class="line">  "*.lot",</span><br><span class="line">  "*.out",</span><br><span class="line">  "*.toc",</span><br><span class="line">  "*.acn",</span><br><span class="line">  "*.acr",</span><br><span class="line">  "*.alg",</span><br><span class="line">  "*.glg",</span><br><span class="line">  "*.glo",</span><br><span class="line">  "*.gls",</span><br><span class="line">  "*.ist",</span><br><span class="line">  "*.fls",</span><br><span class="line">  "*.log",</span><br><span class="line">  "*.fdb_latexmk",</span><br><span class="line">],</span><br></pre></td></tr></table></figure>


<p>一般来说建议保留.synctex.gz 文件，如果希望把这个文件也清理掉，可以在 latex-wordshop.latex.clean.fileTypes 中添加”*.gz”</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://www.jianshu.com/p/4aee83e66ab8" target="_blank" rel="noopener">https://www.jianshu.com/p/4aee83e66ab8</a></li>
<li><a href="https://www.jianshu.com/p/29adf0eadd30" target="_blank" rel="noopener">https://www.jianshu.com/p/29adf0eadd30</a></li>
<li><a href="https://liam.page/2018/04/24/Working-with-VSCode-on-macOS-configuration-LaTeX-workshop-and-Skim/" target="_blank" rel="noopener">https://liam.page/2018/04/24/Working-with-VSCode-on-macOS-configuration-LaTeX-workshop-and-Skim/</a></li>
<li><a href="https://blog.csdn.net/weixin_35757704/article/details/90597405" target="_blank" rel="noopener">https://blog.csdn.net/weixin_35757704/article/details/90597405</a></li>
</ol>
<h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>1.<a href="https://zhuanlan.zhihu.com/p/108095566" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/108095566</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/10/REX%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/10/REX%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B/" itemprop="url">REX漏洞利用流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-10T12:21:31+08:00">
                2020-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rex/" itemprop="url" rel="index">
                    <span itemprop="name">Rex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、crash分析"><a href="#一、crash分析" class="headerlink" title="一、crash分析"></a>一、crash分析</h2><h3 id="路径重现（收集trace）"><a href="#路径重现（收集trace）" class="headerlink" title="路径重现（收集trace）"></a>路径重现（收集trace）</h3><ol>
<li>利用QEMU具体化执行获取基本块执行序列：tarce</li>
<li>利用trace引导angr进行符号执行，收集路径约束，到达崩溃时记录崩溃的 State 和前一个 State</li>
</ol>
<h3 id="符号化内存写"><a href="#符号化内存写" class="headerlink" title="符号化内存写"></a>符号化内存写</h3><p>符号执行中收集所有可以符号化内存写的地址，为后面利用时布置shellcode做准备</p>
<h3 id="漏洞分类"><a href="#漏洞分类" class="headerlink" title="漏洞分类"></a>漏洞分类</h3><ol>
<li><p>ip 是否符号化，并根据可控的大小将漏洞分为 IP_OVERWRITE / PARTIAL_IP_OVERWRITE。</p>
</li>
<li><p>bp 是否符号化，并根据可控的大小将漏洞判定为 BP_OVERWRITE / PARTIAL_BP_OVERWRITE</p>
</li>
<li><p>检查崩溃时前一个 State，筛选出可以控制内存读、写目标地址的操作：</p>
<ul>
<li><p>如果符号化操作中有内存写，根据写的内容是否可控将漏洞判定为 WRITE_WHAT_WHERE / WRITE_X_WHERE 。</p>
</li>
<li><p>如果符号化操作中有内存读，将漏洞判定为 ARBITRARY_READ 。</p>
</li>
</ul>
</li>
</ol>
<h2 id="二、可利用性判断"><a href="#二、可利用性判断" class="headerlink" title="二、可利用性判断"></a>二、可利用性判断</h2><p>能被利用的漏洞类型有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exploitables &#x3D; [Vulnerability.IP_OVERWRITE, Vulnerability.PARTIAL_IP_OVERWRITE, Vulnerability.BP_OVERWRITE,</span><br><span class="line">            Vulnerability.PARTIAL_BP_OVERWRITE, Vulnerability.WRITE_WHAT_WHERE, Vulnerability.WRITE_X_WHERE]</span><br></pre></td></tr></table></figure>

<p>若崩溃时属于其中的类型则可以被利用，但是在REX现有的利用技术中，仅当满足<code>IP_OVERWRITE、PARTIAL_IP_OVERWRITE</code>时候，才可以进行利用。若漏洞类型是<code>WRITE_WHAT_WHERE、WRITE_X_WHERE、ARBITRARY_READ</code>，可以调用函数<code>explore</code>对当前漏洞再次进行探索，看最终能否控制<code>ip</code>。</p>
<h2 id="三、进行利用"><a href="#三、进行利用" class="headerlink" title="三、进行利用"></a>三、进行利用</h2><p>在Rex中，漏洞利用手段的父类是 Technique，每一种利用技术 technique 都是它的子类，需要对父类中 check、apply 这两个函数进行重写：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">check: 检查利用技术能否应用到 binary 上，主要是判断能否控制 ip（完全控制和部分控制）</span><br><span class="line">apply: 对崩溃时的 state 进行利用，成功则返回 Exploit 对象</span><br></pre></td></tr></table></figure>

<p>现有的支持 Linux 平台的利用技术：</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">限定漏洞类型</th>
<th align="left">其他条件</th>
<th align="left">平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">call_jmp_sp_shellcode</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">栈可执行</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">call_shellcode</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">栈可执行</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_register_control</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left"></td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_accept_system</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">存在 accept &amp; read函数</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_execl</td>
<td align="left">IP_OVERWRITE/ PARTIAL_IP_OVERWRITE</td>
<td align="left">存在 execl &amp; dup2 函数</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_system</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">存在 system 函数</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_system_complicated</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">libc被加载 &amp; system 函数 &amp; plt</td>
<td align="left">unix</td>
</tr>
</tbody></table>
<p>进行利用时候可能需要实现的一些公共的功能：</p>
<ul>
<li><strong>_write_global_data() :</strong> 对我们能控制的内存进行约束求解，目的在于判断是否可以写入指定的内容，如：gadget</li>
<li><strong>_read_in_global_data()：</strong>若上述判断为True，则构建rop_chain将数据写到相应的地址：<ul>
<li><strong>_read_in_global_data_with_read(data)：</strong>调用read函数上传数据</li>
<li><strong>_read_in_global_data_with_gets(data)：</strong>调用gets函数上传数据</li>
</ul>
</li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://xz.aliyun.com/t/7179" target="_blank" rel="noopener">https://xz.aliyun.com/t/7179</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/09/Hexo%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%88%86%E7%B1%BB%E3%80%81%E6%A0%87%E7%AD%BE%E9%A1%B5%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/09/Hexo%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%88%86%E7%B1%BB%E3%80%81%E6%A0%87%E7%AD%BE%E9%A1%B5%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA/" itemprop="url">Hexo添加的分类、标签页无法显示</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T22:44:32+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo博客搭建</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-点击home、tags等显示404"><a href="#1-点击home、tags等显示404" class="headerlink" title="1. 点击home、tags等显示404"></a>1. 点击home、tags等显示404</h2><p><strong>url：</strong><a href="https://zytmatrix.github.io/tags/" target="_blank" rel="noopener">https://zytmatrix.github.io/tags/%20</a></p>
<p>页面显示内容：</p>
<img src="/2020/07/09/Hexo%E6%B7%BB%E5%8A%A0%E7%9A%84%E5%88%86%E7%B1%BB%E3%80%81%E6%A0%87%E7%AD%BE%E9%A1%B5%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA/image-20200709224900196.png" alt="image-20200709224900196" style="zoom:50%;">

<p><strong>原因及解决办法</strong></p>
<p>在主题的配置文件<code>themes/next/_config.yml</code>中，为了打开<code>home、tags、categories</code>等页面，需要去掉前面的注释。但是在<code>||</code>前面有一个空格，更新后在博客中点<code>tags</code>，浏览器显示404且<code>url</code>的末尾有一个%20（表示空格）。因此我们需要去掉所有<code>||</code>前面的空格：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">menu:</span><br><span class="line">  home: /|| home</span><br><span class="line">  <span class="comment">#about: /about/ || user ## “||”前面有个空格</span></span><br><span class="line">  tags: /tags/|| tags <span class="comment">## 去掉“||”前面的空格</span></span><br><span class="line">  categories: /categories/|| th</span><br><span class="line">  archives: /archives/|| archive</span><br><span class="line">  <span class="comment">#schedule: /schedule/ || calendar</span></span><br><span class="line">  <span class="comment">#sitemap: /sitemap.xml || sitemap</span></span><br><span class="line">  <span class="comment">#commonweal: /404/ || heartbeat</span></span><br></pre></td></tr></table></figure>

<h2 id="2-分类、标签页面不显示"><a href="#2-分类、标签页面不显示" class="headerlink" title="2. 分类、标签页面不显示"></a>2. 分类、标签页面不显示</h2><p>分别在<code>categories/index.md、tags/index.md</code>中添加<code>layout</code>属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">layout: categories <span class="comment">## themes/next/layout/category.swig</span></span><br><span class="line">layout: tags  <span class="comment">## themes/next/layout/tag.swig</span></span><br></pre></td></tr></table></figure>

<p>其中，<code>layout</code>的值来自于对应主题目录<code>layout</code>下的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls themes/next/layout/</span><br><span class="line">_custom       _macro        _scripts      archive.swig  index.swig    post.swig     tag.swig</span><br><span class="line">_layout.swig  _partials     _third-party  category.swig page.swig     schedule.swig</span><br></pre></td></tr></table></figure>

<h2 id="3-参考链接"><a href="#3-参考链接" class="headerlink" title="3. 参考链接"></a>3. 参考链接</h2><blockquote>
<ol>
<li>博客搭建参考链接：<a href="https://www.jianshu.com/p/cbf8ba8af532" target="_blank" rel="noopener">https://www.jianshu.com/p/cbf8ba8af532</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/09/rex-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/09/rex-2/" itemprop="url">Rex 自动化利用引擎分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T22:07:40+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rex/" itemprop="url" rel="index">
                    <span itemprop="name">Rex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转载自：<a href="https://xz.aliyun.com/t/7179" target="_blank" rel="noopener">https://xz.aliyun.com/t/7179</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在看 rex，没有官方文档，已有的教程也有点过时，基本只能通过看源码学习。</p>
<p>本篇教程当作是学习的记录，也希望能帮助对 rex 感兴趣的同学对 rex 的架构和使用方式有个整体的认识。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Rex 是 Shellphish 团队开发的自动生成 exploit 的引擎，是 Mechaphish 中的一个模块，最初用于 CGC 竞赛。</p>
<p>Rex 基于硬件模拟器 QEMU 和 angr ，通过混合执行（Concolic Execution）复现崩溃路径，根据寄存器及内存信息对漏洞类型/可利用性进行判定等，并尝试应用多种漏洞利用技术自动生成利用脚本。</p>
<p>本篇文章会介绍 rex 安装/顶层接口/内部实现/相关依赖等内容。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>有两种方法</p>
<ol>
<li>安装 rex 及其依赖</li>
<li>直接安装 mechaphish 镜像</li>
</ol>
<p>推荐直接使用 shellphish/mechaphish docker 镜像，比较方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull shellphish&#x2F;mechaphish; </span><br><span class="line">docker run -it shellphish&#x2F;mechaphish</span><br></pre></td></tr></table></figure>

<p>rex 基于 angr，关于 angr 的使用方式，可以查看我的另一篇教程。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>首先测试一下 rex 是否安装成功，简单测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tg &#x3D; archr.targets.LocalTarget(&lt;path_to_binary&gt;, target_os&#x3D;&#39;cgc&#39;)</span><br><span class="line">crash &#x3D; rex.Crash(tg, &lt;input&gt;)</span><br></pre></td></tr></table></figure>

<p>首先需要创建 target ,类型是 archr.targets.Target 并指定配置。</p>
<p>接下来通过 rex.Crash 接口，传递创建的 target 和可以触发 crash 的输入，我们可以获得 Crash 对象，便可以对 Crash 对象进行一系列分析，下面会涉及对 Crash 对象的操作。</p>
<p>这里 path_to_binary 为二进制文件路径，target_os 指定系统，cgc 或者 linux, 这里我们可以使用 cgc 的文件进行测试（可以在binaries 中找到）</p>
<p>简单测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t &#x3D; archr.targets.LocalTarget([&quot;&#x2F;home&#x2F;angr-dev&#x2F;binaries&#x2F;tests&#x2F;defcon24&#x2F;legit_00003&quot;], target_os&#x3D;&#39;cgc&#39;)</span><br><span class="line">crash &#x3D; rex.Crash(t, b&quot;\x00\x0b1\xc1\x00\x0c\xeb\xe4\xf1\xf1\x14\r\rM\r\xf3\x1b\r\r\r~\x7f\x1b\xe3\x0c&#96;_222\r\rM\r\xf3\x1b\r\x7f\x002\x7f~\x7f\xe2\xff\x7f\xff\xff\x8b\xc7\xc9\x83\x8b\x0c\xeb\x80\x002\xac\xe2\xff\xff\x00t\x8bt\x8bt_o_\x00t\x8b\xc7\xdd\x83\xc2t~n~~\xac\xe2\xff\xff_k_\x00t\x8b\xc7\xdd\x83\xc2t~n~~\xac\xe2\xff\xff\x00t\x8bt\x8b\xac\xf1\x83\xc2t~c\x00\x00\x00~~\x7f\xe2\xff\xff\x00t\x9e\xac\xe2\xf1\xf2@\x83\xc3t&quot;)</span><br></pre></td></tr></table></figure>

<p>如果没有出现报错则说明安装成功。</p>
<p>rex 也提供了多种测试样例, 可以在 tests 目录查看, 测试使用的文件可以在 binaries 仓库 中找到.</p>
<h2 id="顶层接口"><a href="#顶层接口" class="headerlink" title="顶层接口"></a>顶层接口</h2><p>使用 rex 通常步骤：</p>
<ol>
<li>创建 target 对象，随后使用 target 和 input 创建 Crash 对象</li>
<li>对 Crash 进行分析，调用 explore 探索路径，调用 exploit() 方法构建 exp</li>
<li>获取 exploit 相关信息，导出到文件等<br>此外也可以对 state 添加约束进行求解等，自行探索。</li>
</ol>
<h3 id="Crash-对象"><a href="#Crash-对象" class="headerlink" title="Crash 对象"></a>Crash 对象</h3><p>属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- crash_types 返回 crash 的漏洞类型</span><br></pre></td></tr></table></figure>

<p>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- explorable()  Determine if the crash can be explored with the &#39;crash explorer&#39;.</span><br><span class="line">- exploitable() Determine if the crash is exploitable.</span><br><span class="line">- exploit() 返回一个 ExploitFactory  实例，用于管理和构建 exp</span><br><span class="line">- explore() explore a crash further to find new bugs</span><br><span class="line">- memory_control()  determine what symbolic memory we control which is at a constant address</span><br><span class="line">- stack_control()  determine what symbolic memory we control on the stack.</span><br><span class="line">- copy() 拷贝 crash 对象</span><br><span class="line">- checkpoint()   Save intermediate results (traced states, etc.) to a file </span><br><span class="line">- checkpoint_restore()</span><br></pre></td></tr></table></figure>

<h3 id="ExploitFactory"><a href="#ExploitFactory" class="headerlink" title="ExploitFactory"></a>ExploitFactory</h3><p>通过 crash 的 exploit 方法我们可以获得 ExploitFactory 实例，用于管理和构建 exploit。</p>
<p>ExploitFactory 有一个重要的属性 arsenal，是一个字典，用来存储对应 technique 的 exploit, 关于 rex 中实现的 technique 后面会涉及。</p>
<h3 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h3><p>rex 定义了如下几种漏洞：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IP_OVERWRITE              &#x3D; &quot;ip_overwrite&quot;</span><br><span class="line">    PARTIAL_IP_OVERWRITE      &#x3D; &quot;partial_ip_overwrite&quot;</span><br><span class="line">    UNCONTROLLED_IP_OVERWRITE &#x3D; &quot;uncontrolled_ip_overwrite&quot;</span><br><span class="line">    BP_OVERWRITE              &#x3D; &quot;bp_overwrite&quot;</span><br><span class="line">    PARTIAL_BP_OVERWRITE      &#x3D; &quot;partial_bp_overwrite&quot;</span><br><span class="line">    WRITE_WHAT_WHERE          &#x3D; &quot;write_what_where&quot;</span><br><span class="line">    WRITE_X_WHERE             &#x3D; &quot;write_x_where&quot;</span><br><span class="line">    UNCONTROLLED_WRITE        &#x3D; &quot;uncontrolled_write&quot; # a write where the destination address is uncontrolled</span><br><span class="line">    ARBITRARY_READ            &#x3D; &quot;arbitrary_read&quot;</span><br><span class="line">    NULL_DEREFERENCE          &#x3D; &quot;null_dereference&quot;</span><br><span class="line">    ARBITRARY_TRANSMIT        &#x3D; &quot;arbitrary_transmit&quot; # transmit where the buf argument is completely controlled</span><br><span class="line">    ARBITRARY_RECEIVE         &#x3D; &quot;arbitrary_receive&quot; # receive where the buf argument is completel controlled</span><br></pre></td></tr></table></figure>

<h2 id="内部解读"><a href="#内部解读" class="headerlink" title="内部解读"></a>内部解读</h2><p>Rex 内部实现主要包含三个模块:</p>
<ul>
<li>Crash：重现崩溃路径，包括漏洞类型判定, Crash 的可利用性判定等；</li>
<li>Technique：对于可利用的 Crash，采取相应的利用技术，构造 Exploit；</li>
<li>Exploit：调用各子模块，自动生成 Exploit</li>
</ul>
<p>可以简单理解成 crash + technique = exploit ,下面我们来看具体内容</p>
<h3 id="crash-分析"><a href="#crash-分析" class="headerlink" title="crash 分析"></a>crash 分析</h3><p>导入 crash 后，首先对 crash 进行 trace、筛选内存写操作和 判定漏洞类型。对应的函数分别为 _trace / _filter_memory_writes / _triage_crash</p>
<p>接下来我们对这三个函数进行分析：</p>
<h3 id="路径重现（tracing"><a href="#路径重现（tracing" class="headerlink" title="路径重现（tracing)"></a>路径重现（tracing)</h3><p>函数： _trace</p>
<p>使用给定的输入，通过符号执行，重现路径，如果没有 Crash 会抛出 NonCrashingInput 异常.</p>
<p>首先使用用户输入获得具体的 trace，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># collect a concrete trace</span></span><br><span class="line">   save_core = <span class="literal">True</span></span><br><span class="line">   <span class="keyword">if</span> isinstance(self.tracer_bow, archr.arsenal.RRTracerBow):</span><br><span class="line">       save_core = <span class="literal">False</span></span><br><span class="line">   r = self.tracer_bow.fire(testcase=test_case, channel=channel,save_core=save_core)</span><br></pre></td></tr></table></figure>

<p>再进行符号化 trace</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self._t = r.tracer_technique(keep_predecessors=<span class="number">2</span>, copy_states=<span class="literal">False</span>, mode=TracingMode.Strict)</span><br><span class="line">simgr.use_technique(self._t)</span><br><span class="line">simgr.use_technique(angr.exploration_techniques.Oppologist())</span><br></pre></td></tr></table></figure>

<p>结束 trace, 检查是否有 crash</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tracing completed</span></span><br><span class="line">        <span class="comment"># if there was no crash we'll have to use the previous path's state</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'crashed'</span> <span class="keyword">in</span> simgr.stashes:</span><br><span class="line">            <span class="comment"># the state at crash time</span></span><br><span class="line">            self.state = simgr.crashed[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># a path leading up to the crashing basic block</span></span><br><span class="line">            self.prev = self._t.predecessors[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.state = simgr.traced[<span class="number">0</span>]</span><br><span class="line">            self.prev = self.state</span><br></pre></td></tr></table></figure>

<h3 id="获得内存写操作"><a href="#获得内存写操作" class="headerlink" title="获得内存写操作"></a>获得内存写操作</h3><p>_filter_memory_writes 获得所有的写内存操作，并将分成符号内存（ symbolic memory bytes ）和 flag 内存（ flag memory bytes ）。flag memory 针对的是 cgc 格式文件，其他情况下为空。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_filter_memory_writes</span><span class="params">(self)</span>:</span></span><br><span class="line">        memory_writes = sorted(self.state.memory.mem.get_symbolic_addrs())</span><br><span class="line">        <span class="keyword">if</span> self.is_cgc:</span><br><span class="line">            <span class="comment"># remove all memory writes that directly end up in the CGC flag page (0x4347c000 - 0x4347d000)</span></span><br><span class="line">            memory_writes = [m <span class="keyword">for</span> m <span class="keyword">in</span> memory_writes <span class="keyword">if</span> m // <span class="number">0x1000</span> != <span class="number">0x4347c</span>]</span><br><span class="line">        user_writes = [m <span class="keyword">for</span> m <span class="keyword">in</span> memory_writes <span class="keyword">if</span></span><br><span class="line">                       any(<span class="string">"aeg_stdin"</span> <span class="keyword">in</span> v <span class="keyword">for</span> v <span class="keyword">in</span> self.state.memory.load(m, <span class="number">1</span>).variables)]</span><br><span class="line">        <span class="keyword">if</span> self.is_cgc:</span><br><span class="line">            flag_writes = [m <span class="keyword">for</span> m <span class="keyword">in</span> memory_writes <span class="keyword">if</span></span><br><span class="line">                           any(v.startswith(<span class="string">"cgc-flag"</span>) <span class="keyword">for</span> v <span class="keyword">in</span> self.state.memory.load(m, <span class="number">1</span>).variables)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flag_writes = []</span><br><span class="line">        l.debug(<span class="string">"Finished filtering memory writes."</span>)</span><br><span class="line">        self.symbolic_mem = self._segment(user_writes)</span><br><span class="line">        self.flag_mem = self._segment(flag_writes)</span><br></pre></td></tr></table></figure>

<h3 id="漏洞类型判断-triage-crash"><a href="#漏洞类型判断-triage-crash" class="headerlink" title="漏洞类型判断(triage_crash)"></a>漏洞类型判断(triage_crash)</h3><p>rex 中 _triage_crash 函数用于判断 crash 对应的漏洞类型，漏洞类型之后的可利用性判定</p>
<p>漏洞判断基本思路如下：</p>
<ol>
<li>检查 ip 是否符号化（即ip是否可控），并且检查可控的大小。通过此我们可以将漏洞判定为 IP_OVERWRITE / PARTIAL_IP_OVERWRITE。</li>
<li>检查 bp 是否符号化，并且检查可控的大小，通过此我们可以漏洞判定为 BP_OVERWRITE / PARTIAL_BP_OVERWRITE</li>
<li>检查触发崩溃时前一个 State，查看最近的操作（ recent_actions ）筛选出内存读写地址可控的操作，得到数组 symbolic_actions</li>
<li>如果符号化操作中有内存写，则判断写数据是否可控，通过此我们可以将漏洞判定为 WRITE_WHAT_WHERE / WRITE_X_WHERE 。</li>
<li>如果符号化操作中有内存读，我们可以将漏洞判定为 ARBITRARY_READ 。</li>
</ol>
<p>以下截取该函数的部分内容帮助理解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断 ip 是否可控，bp 类似        </span></span><br><span class="line">    <span class="keyword">if</span> self.state.solver.symbolic(ip): </span><br><span class="line">        <span class="comment"># how much control of ip do we have?</span></span><br><span class="line">        <span class="keyword">if</span> self._symbolic_control(ip) &gt;= self.state.arch.bits:</span><br><span class="line">            l.info(<span class="string">"detected ip overwrite vulnerability"</span>)</span><br><span class="line">            self.crash_types.append(Vulnerability.IP_OVERWRITE)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l.info(<span class="string">"detected partial ip overwrite vulnerability"</span>)</span><br><span class="line">            self.crash_types.append(Vulnerability.PARTIAL_IP_OVERWRITE)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 筛选出目的地址可控的操作</span></span><br><span class="line">        <span class="comment"># grab the all actions in the last basic block</span></span><br><span class="line">        symbolic_actions = [ ]</span><br><span class="line">        <span class="keyword">if</span> self._t <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self._t.last_state <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            recent_actions = reversed(self._t.last_state.history.recent_actions)</span><br><span class="line">            state = self._t.last_state</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> this is a dead assignment! what was this supposed to be?</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            recent_actions = reversed(self.state.history.actions)</span><br><span class="line">            state = self.state</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> recent_actions:</span><br><span class="line">            <span class="keyword">if</span> a.type == <span class="string">'mem'</span>:</span><br><span class="line">                <span class="keyword">if</span> self.state.solver.symbolic(a.addr.ast):</span><br><span class="line">                    symbolic_actions.append(a)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#判断是内存读还是内存写，并判断数据是否可控，由此确定漏洞类型</span></span><br><span class="line">        <span class="keyword">for</span> sym_action <span class="keyword">in</span> symbolic_actions:</span><br><span class="line">            <span class="keyword">if</span> sym_action.action == <span class="string">"write"</span>:</span><br><span class="line">                <span class="keyword">if</span> self.state.solver.symbolic(sym_action.data):</span><br><span class="line">                    l.info(<span class="string">"detected write-what-where vulnerability"</span>)</span><br><span class="line">                    self.crash_types.append(Vulnerability.WRITE_WHAT_WHERE)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    l.info(<span class="string">"detected write-x-where vulnerability"</span>)</span><br><span class="line">                    self.crash_types.append(Vulnerability.WRITE_X_WHERE)</span><br><span class="line"></span><br><span class="line">                self.violating_action = sym_action</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> sym_action.action == <span class="string">"read"</span>:</span><br><span class="line">                <span class="comment"># special vulnerability type, if this is detected we can explore the crash further</span></span><br><span class="line">                l.info(<span class="string">"detected arbitrary-read vulnerability"</span>)</span><br><span class="line">                self.crash_types.append(Vulnerability.ARBITRARY_READ)</span><br><span class="line"></span><br><span class="line">                self.violating_action = sym_action</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>完成漏洞类型判定后，我们会对 crash 进行一些判断如 explorable/leakable，如 explore 目的是寻找一个更有价值的 crash, 方便漏洞利用。</p>
<h3 id="explore"><a href="#explore" class="headerlink" title="explore"></a>explore</h3><p>首先判断 crash 是否可 explore, 可以 explore 的漏洞类型是: ARBITRARY_READ/WRITE_WHAT_WHERE/WRITE_X_WHERE</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">explorable</span><span class="params">(self)</span>:</span></span><br><span class="line">        explorables = [Vulnerability.ARBITRARY_READ, Vulnerability.WRITE_WHAT_WHERE, Vulnerability.WRITE_X_WHERE]</span><br><span class="line">        <span class="keyword">return</span> self.one_of(explorables)</span><br></pre></td></tr></table></figure>

<p>explore 主要针对任意内存读写漏洞，对应两种实现：_explore_arbitrary_read 和 _explore_arbitrary_write。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.one_of([Vulnerability.ARBITRARY_READ]):</span><br><span class="line">                self._explore_arbitrary_read(path_file)</span><br><span class="line">        <span class="keyword">elif</span> self.one_of([Vulnerability.WRITE_WHAT_WHERE, Vulnerability.WRITE_X_WHERE]):</span><br><span class="line">            self._explore_arbitrary_write(path_file)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> CannotExplore(<span class="string">"unknown explorable crash type: %s"</span> % self.crash_types)</span><br></pre></td></tr></table></figure>

<p>_explore_arbitrary_read / _explore_arbitrary_write 进行路径探索，分别对应任意写和任意读漏洞，使读写的地址是符号化地址，即我们可控的 ( point the violating address at a symbolic memory region )，返回一个 crash 对象。</p>
<h3 id="可利用性判定"><a href="#可利用性判定" class="headerlink" title="可利用性判定"></a>可利用性判定</h3><p>通过调用 exploitable 接口判断 crash 是否可利用，rex 会判断 Crash 的漏洞类型是否属于可 exploitable 漏洞之一 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploitable</span><span class="params">(self)</span>:</span></span><br><span class="line">        exploitables = [Vulnerability.IP_OVERWRITE, Vulnerability.PARTIAL_IP_OVERWRITE, Vulnerability.BP_OVERWRITE,</span><br><span class="line">                Vulnerability.PARTIAL_BP_OVERWRITE, Vulnerability.WRITE_WHAT_WHERE, Vulnerability.WRITE_X_WHERE]</span><br><span class="line">        <span class="keyword">return</span> self.one_of(exploitables)</span><br></pre></td></tr></table></figure>

<p>检查是否可以泄露信息, 判断 crash 类型是否属于 ARBITRARY_READ/ARBITRARY_TRANSMIT 其中一种.</p>
<h3 id="Technique-对象"><a href="#Technique-对象" class="headerlink" title="Technique 对象"></a>Technique 对象</h3><p>每个 technique 都是 Technique 对象的子类, 主要对 check / apply 这两个接口进行重写. 同时 Technique 对象实现了一些通用的接口, 作为构造 exploit 的辅助函数.</p>
<p>下面介绍一下 check / apply</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">check: 检查对于给定的crash, 该技术能否应用到 binary 上,返回布尔值</span><br><span class="line"></span><br><span class="line">apply : 在binary的崩溃状态点应用该技术,返回 Exploit 对象或抛出  CannotExploit  异常</span><br></pre></td></tr></table></figure>

<p>apply 其实就是根据每个技术的不同，添加不同的约束。</p>
<p>每种包含 applicable_to 属性,表示可以应用的平台, unix 或者 cgc</p>
<p>以下是 technique 的基本信息, 基本通过名称就能知道攻击技术，就不一一介绍了，它们的实现也比较朴素。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>限定漏洞类型</th>
<th>其他条件</th>
<th>平台</th>
</tr>
</thead>
<tbody><tr>
<td>call_jmp_sp_shellcode</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>栈可执行</td>
<td>unix</td>
</tr>
<tr>
<td>call_shellcode</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>栈可执行</td>
<td>unix</td>
</tr>
<tr>
<td>circumstantially_set_register</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td></td>
<td>cgc</td>
</tr>
<tr>
<td>rop_leak_memory</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td></td>
<td>cgc</td>
</tr>
<tr>
<td>rop_register_control</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td></td>
<td>unix</td>
</tr>
<tr>
<td>rop_set_register</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td></td>
<td>cgc</td>
</tr>
<tr>
<td>rop_to_accept_system</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>存在</td>
<td>accept&amp; read函数</td>
</tr>
<tr>
<td>rop_to_execl</td>
<td>IP_OVERWRITE/  PARTIAL_IP_OVERWRITE</td>
<td>存在</td>
<td>execl&amp;dup2 函数</td>
</tr>
<tr>
<td>rop_to_system</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>存在</td>
<td>system 函数</td>
</tr>
<tr>
<td>rop_to_system_complicated</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>libc</td>
<td>被加载&amp; system 函数 &amp; plt</td>
</tr>
<tr>
<td>shellcode_leak_address</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>栈可执行</td>
<td>cgc</td>
</tr>
<tr>
<td>shellcode_set_register</td>
<td>IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td>栈可执行</td>
<td>cgc</td>
</tr>
</tbody></table>
<p>可以在调用 exploit 时设置 blacklist_techniques 参数排除不需要使用的技术.</p>
<p>成功应用 Technique 会返回 Exploit 对象，接下来介绍 Exploit 对象。</p>
<h2 id="Exploit-对象"><a href="#Exploit-对象" class="headerlink" title="Exploit 对象"></a>Exploit 对象</h2><blockquote>
<p>An Exploit object represents the successful application of an exploit technique to a crash state.</p>
</blockquote>
<p>rex 实现了 ExploitFactory 类，用于管理和构建 exploit,</p>
<p>调用 exploit() 方法时，ExploitFactory 会依次应用每一种利用技术, 尝试生成 exploit, 得到的 exploit 会以arsenal[<techinique_name>] 形式存储在 arsenal 属性中. 针对 CGC 实现了 CGCExploitFactory 类.</techinique_name></p>
<p>构建 exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(self, blacklist_symbolic_explore=True, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Initialize an exploit factory, with which you can build exploits.</span></span><br><span class="line"><span class="string">        :return:    An initialized ExploitFactory instance.</span></span><br><span class="line"><span class="string">        :rtype:     ExploitFactory</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        factory = self._prepare_exploit_factory(blacklist_symbolic_explore, **kwargs)</span><br><span class="line">        factory.initialize()</span><br><span class="line">        <span class="keyword">return</span> factory</span><br></pre></td></tr></table></figure>

<p>_prepare_exploit_factory 函数主要为 exploit 的生成做一些准备操作，比如设置 technique 的黑名单，判断输入类型等。</p>
<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>以下是分别对 cgc 和 linux 两种格式的测试样例</p>
<p>cgc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_legit_00003</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Test exploration and exploitation of legit_00003.</span></span><br><span class="line">    inp = <span class="string">b"1\n"</span> + <span class="string">b"A"</span> * <span class="number">200</span> <span class="comment">#设置输入内容</span></span><br><span class="line">    path = os.path.join(bin_location, <span class="string">"tests/defcon24/legit_00003"</span>)</span><br><span class="line">    <span class="keyword">with</span> archr.targets.LocalTarget([path], target_os=<span class="string">'cgc'</span>) <span class="keyword">as</span> target:</span><br><span class="line">        crash = rex.Crash(target, inp, fast_mode=<span class="literal">True</span>, rop_cache_path=os.path.join(cache_location, <span class="string">'legit_00003'</span>))</span><br><span class="line"></span><br><span class="line">        nose.tools.assert_true(crash.explorable())  <span class="comment">#判断是否可以 explore</span></span><br><span class="line">        nose.tools.assert_true(crash.one_of(Vulnerability.WRITE_WHAT_WHERE)) <span class="comment"># 漏洞是否为任意写</span></span><br><span class="line"></span><br><span class="line">        crash.explore() <span class="comment">#进行探索m</span></span><br><span class="line">        arsenal = crash.exploit(blacklist_techniques=&#123;<span class="string">'rop_set_register'</span>, <span class="string">'rop_leak_memory'</span>&#125;)</span><br><span class="line"></span><br><span class="line">        nose.tools.assert_true(len(arsenal.register_setters) &gt;= <span class="number">2</span>)</span><br><span class="line">        nose.tools.assert_true(len(arsenal.leakers) &gt;= <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        crash.project.loader.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> reg_setter <span class="keyword">in</span> arsenal.register_setters:</span><br><span class="line">            nose.tools.assert_true(_do_pov_test(reg_setter))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> leaker <span class="keyword">in</span> arsenal.leakers:</span><br><span class="line">            nose.tools.assert_true(_do_pov_test(leaker))</span><br></pre></td></tr></table></figure>

<p>linux</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_linux_stacksmash_32</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Test exploiting a simple linux program with a stack buffer overflow. We should be able to exploit the test binary by</span></span><br><span class="line">    <span class="comment"># ropping to 'system', calling shellcode in the BSS and calling 'jmpsp' shellcode in the BSS.</span></span><br><span class="line"></span><br><span class="line">    inp = <span class="string">b"A"</span> * <span class="number">227</span></span><br><span class="line">    lib_path = os.path.join(bin_location, <span class="string">"tests/i386"</span>)</span><br><span class="line">    ld_path = os.path.join(lib_path, <span class="string">"ld-linux.so.2"</span>)</span><br><span class="line">    path = os.path.join(lib_path, <span class="string">"vuln_stacksmash"</span>)</span><br><span class="line">    <span class="keyword">with</span> archr.targets.LocalTarget([ld_path, <span class="string">'--library-path'</span>, lib_path, path], path, target_arch=<span class="string">'i386'</span>).build().start() <span class="keyword">as</span> target:</span><br><span class="line">        crash = rex.Crash(target, inp, fast_mode=<span class="literal">True</span>, rop_cache_path=os.path.join(cache_location, <span class="string">'vuln_stacksmash'</span>))</span><br><span class="line"></span><br><span class="line">        exploit = crash.exploit(blacklist_techniques=&#123;<span class="string">'rop_leak_memory'</span>, <span class="string">'rop_set_register'</span>&#125;)</span><br><span class="line">        crash.project.loader.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># make sure we're able to exploit it in all possible ways</span></span><br><span class="line">        <span class="keyword">assert</span> len(exploit.arsenal) == <span class="number">3</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'rop_to_system'</span> <span class="keyword">in</span> exploit.arsenal</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'call_shellcode'</span> <span class="keyword">in</span> exploit.arsenal</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'call_jmp_sp_shellcode'</span> <span class="keyword">in</span> exploit.arsenal</span><br><span class="line"></span><br><span class="line">        _check_arsenal_has_send(exploit.arsenal)</span><br></pre></td></tr></table></figure>

<h2 id="相关库"><a href="#相关库" class="headerlink" title="相关库"></a>相关库</h2><p>这里顺便介绍一些 rex 依赖的 archr 模块</p>
<h3 id="archr"><a href="#archr" class="headerlink" title="archr"></a>archr</h3><p>前面提到，在使用 rex 前，需要使用 archr 创建 target 对象。我们可以指定 target_path / target_os(linux /cgc) / target_arch(linux , x86_64) 等.</p>
<p>archr 模块实现了以 target 为中心的分析模型。（传统是以程序 program 为中心）</p>
<p>其中包含两个重要的概念，</p>
<p>Targets: 包含 target 的说明，如何配置，如何启动以及如何交互。</p>
<p>Bows：明确 target 特定的分析动作，包括 tracing，符号执行（symbolic execution）等，为了实现目标，Bows 可能会注入 Arrows （如qemu-user, gdbserver等）到 target 中。</p>
<p>archr 提供了两种 target:</p>
<ul>
<li>DockerImageTarget: docker 镜像</li>
<li>LocalTarget：本地系统运行的 target<br>提供了以下 Bows ：</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>DataScoutBow</td>
<td>获取进程启动时的内存映射，环境，属性</td>
</tr>
<tr>
<td>AngrProjectBow</td>
<td>创建 angr Project</td>
</tr>
<tr>
<td>AngrStateBow</td>
<td>创建 angr State</td>
</tr>
<tr>
<td>QEMUTraceBow</td>
<td>执行 qemu tracing</td>
</tr>
<tr>
<td>GDBServerBow</td>
<td>在 gdbserver 中启动 target</td>
</tr>
<tr>
<td>STraceBow</td>
<td>strace 目标（即跟踪系统调用和信号）</td>
</tr>
<tr>
<td>CoreBow</td>
<td>启动target 并恢复 core</td>
</tr>
<tr>
<td>InputFDBow</td>
<td>确定用户输入的FD数目</td>
</tr>
</tbody></table>
<p>具体使用方法可以查看项目。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对于自动化利用，rex 比较简陋，漏洞利用技术也比较简单，但是我们可以学习它的思路，对其进行改进。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://paper.seebug.org/papers/Security%20Conf/Hitcon/Hitcon-2016/1202%20R2%201510%20automatic%20binary%20exploitation%20and%20patching%20using%20mechanical%20shellphish.pdf" target="_blank" rel="noopener">https://paper.seebug.org/papers/Security%20Conf/Hitcon/Hitcon-2016/1202%20R2%201510%20automatic%20binary%20exploitation%20and%20patching%20using%20mechanical%20shellphish.pdf</a></li>
<li><a href="https://ma3k4h3d.top/2019/01/23/rex-crash/" target="_blank" rel="noopener">https://ma3k4h3d.top/2019/01/23/rex-crash/</a></li>
<li><a href="https://ma3k4h3d.top/2019/03/28/rex-1/" target="_blank" rel="noopener">https://ma3k4h3d.top/2019/03/28/rex-1/</a></li>
<li><a href="https://ma3k4h3d.top/2019/01/17/Rex-stacksmash/" target="_blank" rel="noopener">https://ma3k4h3d.top/2019/01/17/Rex-stacksmash/</a></li>
<li><a href="https://github.com/angr/rex" target="_blank" rel="noopener">https://github.com/angr/rex</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/09/rex-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/09/rex-1/" itemprop="url">在由镜像 shellphish_mechaphish 创建的容器中运行rex的测试程序时候报错</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-09T19:14:18+08:00">
                2020-07-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rex/" itemprop="url" rel="index">
                    <span itemprop="name">Rex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>测试程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> nose</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> archr</span><br><span class="line"><span class="keyword">import</span> rex</span><br><span class="line"><span class="keyword">import</span> colorguard</span><br><span class="line"><span class="keyword">from</span> rex.vulnerability <span class="keyword">import</span> Vulnerability</span><br><span class="line"><span class="keyword">from</span> angr.state_plugins.trace_additions <span class="keyword">import</span> FormatInfoStrToInt, FormatInfoDontConstrain</span><br><span class="line"><span class="keyword">from</span> rex.exploit.cgc.type1.cgc_type1_shellcode_exploit <span class="keyword">import</span> CGCType1ShellcodeExploit</span><br><span class="line"><span class="keyword">from</span> nose.plugins.attrib <span class="keyword">import</span> attr</span><br><span class="line"></span><br><span class="line">bin_location = str(os.path.join(os.path.dirname(os.path.realpath(__file__)), <span class="string">'../binaries'</span>))</span><br><span class="line">cache_location = str(os.path.join(bin_location, <span class="string">'tests_data/rop_gadgets_cache'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_linux_stacksmash_32</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Test exploiting a simple linux program with a stack buffer overflow. We should be able to exploit the test binary by</span></span><br><span class="line">    <span class="comment"># ropping to 'system', calling shellcode in the BSS and calling 'jmpsp' shellcode in the BSS.</span></span><br><span class="line"></span><br><span class="line">    inp = <span class="string">b"A"</span> * <span class="number">227</span></span><br><span class="line">    lib_path = os.path.join(bin_location, <span class="string">"tests/i386"</span>)</span><br><span class="line">    ld_path = os.path.join(lib_path, <span class="string">"ld-linux.so.2"</span>)</span><br><span class="line">    path = os.path.join(lib_path, <span class="string">"vuln_stacksmash"</span>)</span><br><span class="line">    <span class="keyword">with</span> archr.targets.LocalTarget([ld_path, <span class="string">'--library-path'</span>, lib_path, path], path, target_arch=<span class="string">'i386'</span>).build().start() <span class="keyword">as</span> target:</span><br><span class="line">        crash = rex.Crash(target, inp, fast_mode=<span class="literal">True</span>, rop_cache_path=os.path.join(cache_location, <span class="string">'vuln_stacksmash'</span>))</span><br><span class="line"></span><br><span class="line">        exploit = crash.exploit(blacklist_techniques=&#123;<span class="string">'rop_leak_memory'</span>, <span class="string">'rop_set_register'</span>&#125;)</span><br><span class="line">        crash.project.loader.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># make sure we're able to exploit it in all possible ways</span></span><br><span class="line">        <span class="keyword">assert</span> len(exploit.arsenal) == <span class="number">3</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'rop_to_system'</span> <span class="keyword">in</span> exploit.arsenal</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'call_shellcode'</span> <span class="keyword">in</span> exploit.arsenal</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">'call_jmp_sp_shellcode'</span> <span class="keyword">in</span> exploit.arsenal</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    test_linux_stacksmash_32()</span><br></pre></td></tr></table></figure>

<p>报错信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">archr.errors.ArchrError: DataScout failed to get argv from the target process.</span><br><span class="line">stdout: b&#39;&#39;</span><br><span class="line">stderr: b&#39;setarch: failed to set personality to x86_64: Operation not permitted\n&#39;</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run 时增加参数 --privileged</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zyt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zyt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
