<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zyt">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Matrix</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matrix</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/21/Detect_a_use_after_free_vulnerability/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/21/Detect_a_use_after_free_vulnerability/" itemprop="url">Detect a use after free vulnerability</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-21T09:12:51+08:00">
                2020-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Detect-a-use-after-free-vulnerability"><a href="#Detect-a-use-after-free-vulnerability" class="headerlink" title="Detect a use after free vulnerability"></a>Detect a use after free vulnerability</h2><p>污点分析很有用，但主要是用来判断用户能否触发漏洞。接下来，我们会使用模式匹配的方法来检测一些漏洞。</p>
<h3 id="1-Via-obsolete-stack-frame"><a href="#1-Via-obsolete-stack-frame" class="headerlink" title="1 - Via obsolete stack frame"></a>1 - Via obsolete stack frame</h3><p>首先，我们尝试检测那些访问栈指针的 <strong>LOAD</strong>、<strong>STORE</strong>，并判断能否被用户控制。</p>
<p><img src="/2020/07/21/Detect_a_use_after_free_vulnerability/uaf_stack_frame.png" alt="UAF via obsolete stack frame"></p>
<p>为了测试检测过期的 stack frame，我们用以下的代码来进行测试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *ptr1;</span><br><span class="line"><span class="keyword">char</span> *ptr2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">foo2</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> d = buf[<span class="number">0</span>]; <span class="comment">/* 'd' is tainted because buf is controlled by the user */</span></span><br><span class="line">  <span class="keyword">char</span> e = buf[<span class="number">1</span>]; <span class="comment">/* 'e' is tainted because buf is controlled by the user */</span></span><br><span class="line">  <span class="keyword">char</span> f = <span class="number">1</span>;      <span class="comment">/* 'f' is not tainted */</span></span><br><span class="line"></span><br><span class="line">  ptr1 = &amp;e;</span><br><span class="line">  ptr2 = &amp;f;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo1</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> a = *foo2(buf); <span class="comment">/* UAF match          */</span></span><br><span class="line">  <span class="keyword">char</span> b = *ptr1;      <span class="comment">/* UAF match          */</span></span><br><span class="line">  <span class="keyword">char</span> c = *ptr2;      <span class="comment">/* UAF does not match */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码所示，函数 <strong>foo2</strong> 初始化了指针 <strong>ptr1、ptr2</strong>，但是他们指向 <strong>foo2</strong> 的  stack-frame。函数 <strong>foo2</strong> 返回一个指向其 stack-frame 的指针，也即函数 <strong>foo1</strong> 中的变量 <strong>a、b</strong> 指向了过期 stack frame 中的变量 <strong>d、e</strong>。本例中，我们可以控制变量 <strong>a、b</strong>，变量 <strong>c</strong> 是被赋予的常数，不能被用户控制。</p>
<p>下面是函数 <strong>foo1、foo2</strong> 的反汇编代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400614</span> &lt;foo2&gt;:</span><br><span class="line">  <span class="number">400614</span>:   <span class="number">55</span>                      push   rbp</span><br><span class="line">  <span class="number">400615</span>:   <span class="number">48</span> <span class="number">89</span> e5                mov    rbp,rsp</span><br><span class="line">  <span class="number">400618</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">7</span>d e8             mov    QWORD PTR [rbp<span class="number">-0x18</span>],rdi</span><br><span class="line">  <span class="number">40061</span>c:   <span class="number">48</span> <span class="number">8b</span> <span class="number">45</span> e8             mov    rax,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">400620</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">400623</span>:   <span class="number">88</span> <span class="number">45</span> ff                mov    BYTE PTR [rbp<span class="number">-0x1</span>],al</span><br><span class="line">  <span class="number">400626</span>:   <span class="number">48</span> <span class="number">8b</span> <span class="number">45</span> e8             mov    rax,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">40062</span>a:   <span class="number">0f</span> b6 <span class="number">40</span> <span class="number">01</span>             movzx  eax,BYTE PTR [rax+<span class="number">0x1</span>]</span><br><span class="line">  <span class="number">40062</span>e:   <span class="number">88</span> <span class="number">45</span> fe                mov    BYTE PTR [rbp<span class="number">-0x2</span>],al</span><br><span class="line">  <span class="number">400631</span>:   c6 <span class="number">45</span> fd <span class="number">01</span>             mov    BYTE PTR [rbp<span class="number">-0x3</span>],<span class="number">0x1</span></span><br><span class="line">  <span class="number">400635</span>:   <span class="number">48</span> <span class="number">8</span>d <span class="number">45</span> fe             lea    rax,[rbp<span class="number">-0x2</span>]</span><br><span class="line">  <span class="number">400639</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">20</span> <span class="number">0</span>a <span class="number">20</span> <span class="number">00</span>    mov    QWORD PTR [rip+<span class="number">0x200a20</span>],rax # <span class="number">601060</span> &lt;ptr1&gt;</span><br><span class="line">  <span class="number">400640</span>:   <span class="number">48</span> <span class="number">8</span>d <span class="number">45</span> fd             lea    rax,[rbp<span class="number">-0x3</span>]</span><br><span class="line">  <span class="number">400644</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">1</span>d <span class="number">0</span>a <span class="number">20</span> <span class="number">00</span>    mov    QWORD PTR [rip+<span class="number">0x200a1d</span>],rax # <span class="number">601068</span> &lt;ptr2&gt;</span><br><span class="line">  <span class="number">40064b</span>:   <span class="number">48</span> <span class="number">8</span>d <span class="number">45</span> ff             lea    rax,[rbp<span class="number">-0x1</span>]</span><br><span class="line">  <span class="number">40064f</span>:   <span class="number">5</span>d                      pop    rbp</span><br><span class="line">  <span class="number">400650</span>:   c3                      ret</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400651</span> &lt;foo1&gt;:</span><br><span class="line">  <span class="number">400651</span>:   <span class="number">55</span>                      push   rbp</span><br><span class="line">  <span class="number">400652</span>:   <span class="number">48</span> <span class="number">89</span> e5                mov    rbp,rsp</span><br><span class="line">  <span class="number">400655</span>:   <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             sub    rsp,<span class="number">0x18</span></span><br><span class="line">  <span class="number">400659</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">7</span>d e8             mov    QWORD PTR [rbp<span class="number">-0x18</span>],rdi</span><br><span class="line">  <span class="number">40065</span>d:   <span class="number">48</span> <span class="number">8b</span> <span class="number">45</span> e8             mov    rax,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">400661</span>:   <span class="number">48</span> <span class="number">89</span> c7                mov    rdi,rax</span><br><span class="line">  <span class="number">400664</span>:   e8 ab ff ff ff          call   <span class="number">400614</span> &lt;foo2&gt;</span><br><span class="line">  <span class="number">400669</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">40066</span>c:   <span class="number">88</span> <span class="number">45</span> ff                mov    BYTE PTR [rbp<span class="number">-0x1</span>],al</span><br><span class="line">  <span class="number">40066f</span>:   <span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> ea <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    mov    rax,QWORD PTR [rip+<span class="number">0x2009ea</span>] # <span class="number">601060</span> &lt;ptr1&gt;</span><br><span class="line">  <span class="number">400676</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">400679</span>:   <span class="number">88</span> <span class="number">45</span> fe                mov    BYTE PTR [rbp<span class="number">-0x2</span>],al</span><br><span class="line">  <span class="number">40067</span>c:   <span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> e5 <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    mov    rax,QWORD PTR [rip+<span class="number">0x2009e5</span>] # <span class="number">601068</span> &lt;ptr2&gt;</span><br><span class="line">  <span class="number">400683</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">400686</span>:   <span class="number">88</span> <span class="number">45</span> fd                mov    BYTE PTR [rbp<span class="number">-0x3</span>],al</span><br><span class="line">  <span class="number">400689</span>:   c9                      leave  </span><br><span class="line">  <span class="number">40068</span>a:   c3</span><br></pre></td></tr></table></figure>

<p>要检测此问题，可以仅使用当前内存操作的 source 指针来检测当前的 stack 指针。如果当前 stack 指针大于 source 指针，则意味着可能有过期的 stack-frame 的使用。如下所示，当 foo2 返回时，变量 a 指向的是 foo2 中的变量 d，存在对过期 stack frame 的使用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|   f   |</span><br><span class="line">|   e   |</span><br><span class="line">|   d   |</span><br><span class="line">|  ret  |   <span class="comment">// foo2's stack frame</span></span><br><span class="line">|  ebp  |</span><br><span class="line">|  buf  |</span><br><span class="line">|   c   |</span><br><span class="line">|   b   |</span><br><span class="line">|   a   |   <span class="comment">// foo1's stack frame</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sp &gt; addr &amp;&amp; addr &gt; <span class="number">0x700000000000</span>) <span class="comment">//addr &gt; 0x700000000000 保证addr属于栈内存</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr \</span><br><span class="line">    &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>

<p>下面是检测到的使用过期 stack-frame 的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ../../../pin -t ./obj-intel64/Taint.so -- ./test</span><br><span class="line">[TAINT]                   bytes tainted from <span class="number">0x611010</span> to <span class="number">0x611030</span> (via <span class="built_in">read</span>)</span><br><span class="line">[READ in <span class="number">611010</span>]          <span class="number">400620</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is now tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd14495e7]   <span class="number">400623</span>: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x1</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd14495e7 is now tainted</span><br><span class="line">[READ in <span class="number">611011</span>]          <span class="number">40062</span>a: movzx eax, <span class="keyword">byte</span> ptr [rax+<span class="number">0x1</span>]</span><br><span class="line">                          eax is already tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd14495e6]   <span class="number">40062</span>e: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x2</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd14495e6 is now tainted</span><br><span class="line">[READ in <span class="number">7f</span>ffd14495e7]    <span class="number">400669</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is already tainted</span><br><span class="line">[UAF in <span class="number">7f</span>ffd14495e7]     <span class="number">400669</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd144960f]   <span class="number">40066</span>c: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x1</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd144960f is now tainted</span><br><span class="line">[READ in <span class="number">7f</span>ffd14495e6]    <span class="number">400676</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is already tainted</span><br><span class="line">[UAF in <span class="number">7f</span>ffd14495e6]     <span class="number">400676</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd144960e]   <span class="number">400679</span>: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x2</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd144960e is now tainted</span><br><span class="line">[READ in <span class="number">7f</span>ffd14495e5]    <span class="number">400683</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is now freed</span><br></pre></td></tr></table></figure>

<p>如果你向过期 stack-frame 写入数据同理，下面的代码中向过期的 stack-frame 写入了数据。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">foo2</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> d = buf[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">return</span> &amp;d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo1</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *foo2(buf) = <span class="number">1</span>; <span class="comment">/* UAF match */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Pin tool 告诉我们在地址  <code>400644</code> 处向过期的 stack-frame 写入了数据</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ../../../pin -t ./obj-intel64/Taint.so -- ./test</span><br><span class="line">[TAINT]                   bytes tainted from <span class="number">0x19fd010</span> to <span class="number">0x19fd030</span> (via <span class="built_in">read</span>)</span><br><span class="line">[READ in <span class="number">19f</span>d010]         <span class="number">400620</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is now tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd3fd0f37]   <span class="number">400623</span>: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x1</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd3fd0f37 is now tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd3fd0f37]   <span class="number">400644</span>: mov <span class="keyword">byte</span> ptr [rax], <span class="number">0x1</span></span><br><span class="line">                          <span class="number">7f</span>ffd3fd0f37 is now freed</span><br><span class="line">[UAF in <span class="number">7f</span>ffd3fd0f37]     <span class="number">400644</span>: mov <span class="keyword">byte</span> ptr [rax], <span class="number">0x1</span></span><br></pre></td></tr></table></figure>

<p>上述代码、输出并未进行测试，明白其原理即可，例子代码：<code>/PinTools/ObsoleteStackFrameAccessDetection/Taint.cpp</code></p>
<h3 id="2-Classical-use-after-free"><a href="#2-Classical-use-after-free" class="headerlink" title="2 - Classical use after free"></a>2 - Classical use after free</h3><p>若指针被释放后我们还能使用它则会触发UAF漏洞。</p>
<p><img src="/2020/07/21/Detect_a_use_after_free_vulnerability/use_after_free.png" alt="Use after free"></p>
<p> 这个错误在C ++世界中广为人知。想象一个对象具有 public(private) 的方法(变量) 。第一个对象 <strong>A</strong> 被初始化（我们不能控制该对象），然后一段时间后，该对象被释放。在我们有了第二个相同的对象 <strong>B</strong>（我们可以控制它）之后，对象 <strong>B</strong> 会被分配到与 <strong>A</strong> 相同的内存位置。 如果在 <strong>A</strong> 对象中有一些私有、公共数据，则在使用对象 <strong>B</strong> 时会访问到。</p>
<h4 id="2-1-Methodology"><a href="#2-1-Methodology" class="headerlink" title="2.1 - Methodology"></a>2.1 - Methodology</h4><p> 为此，我们需要捕获程序调用的所有的 <strong>malloc、free</strong> 函数。使用 Pin 通过他们的符号可以轻易的捕获这些调用。当一个 <strong>malloc</strong> 发生时，我们将一些信息保存在列表中：chunk块的基地址、size、状态（<strong>ALLOCATE、FREE</strong>）。当 <strong>free</strong> 发生时，设置flag为 <strong>FREE</strong>。</p>
<p><img src="/2020/07/21/Detect_a_use_after_free_vulnerability/struct_mallocarea.png" alt="struct mallocArea"></p>
<p> 然后，当我们遇到 <strong>LOAD、STORE</strong> 操作时，我们检查该地址是否在我们的列表中并检查它的 flag。如果 flag 是 <strong>FREE</strong> 并且对该地址有 <strong>LOAD、STORE</strong> 操作，那么意味着我们找到了一个潜在的 UAF 漏洞。</p>
<h4 id="2-2-Pin-API-Symbols"><a href="#2-2-Pin-API-Symbols" class="headerlink" title="2.2 - Pin API - Symbols"></a>2.2 - Pin API - Symbols</h4><p>使用 Pin 可以当一个符号被触发后执行一个回调函数。因此，当捕获到符号 <strong>malloc、free</strong> 时，我们增加一个回调函数。首先，我们需要初始化 Pin symbols。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PIN_InitSymbols();</span><br><span class="line"><span class="keyword">if</span>(PIN_Init(argc, argv))&#123;</span><br><span class="line">    <span class="keyword">return</span> Usage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，在 image 的处理函数中，我们对特定的符号增加一个回调函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span></span>&#123;</span><br><span class="line">  RTN mallocRtn = RTN_FindByName(img, <span class="string">"malloc"</span>);</span><br><span class="line">  RTN freeRtn = RTN_FindByName(img, <span class="string">"free"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(mallocRtn))&#123;</span><br><span class="line">    RTN_Open(mallocRtn);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeMalloc,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_AFTER, (AFUNPTR)callbackAfterMalloc,</span><br><span class="line">        IARG_FUNCRET_EXITPOINT_VALUE, </span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_Close(mallocRtn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(freeRtn))&#123;</span><br><span class="line">    RTN_Open(freeRtn);</span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        freeRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeFree,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">        IARG_END);</span><br><span class="line">    RTN_Close(freeRtn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这些回调函数中，我们保存、监控所有的 allocations。然后，在访问内存的 <strong>LOAD、STORE</strong> 的回调函数中，检查 des、src 地址是已被分配、还是被释放。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i2 = mallocAreaList.<span class="built_in">begin</span>(); i2 != mallocAreaList.<span class="built_in">end</span>(); i2++)&#123;</span><br><span class="line">  <span class="keyword">if</span> (addr &gt;= i2-&gt;base &amp;&amp; addr &lt; (i2-&gt;base + i2-&gt;<span class="built_in">size</span>) &amp;&amp; i2-&gt;status == FREE)&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> </span><br><span class="line">      &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-Test-on-a-C-based-program"><a href="#2-3-Test-on-a-C-based-program" class="headerlink" title="2.3 - Test on a C based program"></a>2.3 - Test on a C based program</h4><p>在 C 程序上进行测试。在这里，我们分配一个32字节的堆块。第一个和第三个 <strong>STORE</strong> 可以正常操作，因为是在分配 <strong>buf</strong> 之后，但第二个 <strong>STORE</strong> 发生在 <strong>buf</strong> 被释放后，存在 UAF。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> ac, <span class="keyword">char</span> **av)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *buf;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">    <span class="comment">//   printf("BEGIN\n");</span></span><br><span class="line">    <span class="comment">/* （疑问，有时会遇到此种情况）必须在第一个malloc前执行printf，才会按照预期打印结果。反之，最后输出为:</span></span><br><span class="line"><span class="comment">    [INFO]		free(e36010)</span></span><br><span class="line"><span class="comment">    [INFO]		malloc(20) = e36010</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">if</span> (!(buf = <span class="built_in">malloc</span>(<span class="number">32</span>)))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  c = buf[<span class="number">0</span>];           <span class="comment">/* UAF not match */</span></span><br><span class="line">  <span class="built_in">free</span>(buf);  </span><br><span class="line">  c = buf[<span class="number">0</span>];           <span class="comment">/* UAF match     */</span></span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">  c = buf[<span class="number">0</span>];           <span class="comment">/* UAF not match */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-source-code"><a href="#2-4-source-code" class="headerlink" title="2.4 - source code"></a>2.4 - source code</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Jonathan Salwan - Copyright (C) 2013-08</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">//  http://shell-storm.org</span></span><br><span class="line"><span class="comment">//  http://twitter.com/JonathanSalwan</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Note: Example 5 - http://shell-storm.org/blog/Taint-analysis-with-Pin/</span></span><br><span class="line"><span class="comment">//        Detect the classical use after free vulnerability </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCKED    1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOCKED  !LOCKED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALLOCATE  1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE      !ALLOCATE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span>         lastSize;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mallocArea</span>&#123;</span></span><br><span class="line">  ADDRINT  base;</span><br><span class="line">  ADDRINT  <span class="built_in">size</span>;</span><br><span class="line">  BOOL    status;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ADDRINT lockTaint = LOCKED;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;ADDRINT&gt;               addressTainted;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;REG&gt;                  regsTainted;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;struct mallocArea&gt;    mallocAreaList;</span><br><span class="line"></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"Ex 5"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查寄存器是否已被污染</span></span><br><span class="line"><span class="function">BOOL <span class="title">checkAlreadyRegTainted</span><span class="params">(REG reg)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;REG&gt;::iterator i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = regsTainted.<span class="built_in">begin</span>(); i != regsTainted.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (*i == reg)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">removeMemTainted</span><span class="params">(ADDRINT addr)</span></span>&#123;</span><br><span class="line">  addressTainted.<span class="built_in">remove</span>(addr);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; addr &lt;&lt; <span class="string">" is now freed"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">addMemTainted</span><span class="params">(ADDRINT addr)</span></span>&#123;</span><br><span class="line">  addressTainted.push_back(addr);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; addr &lt;&lt; <span class="string">" is now tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">taintReg</span><span class="params">(REG reg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg) == <span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" is already tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(reg)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RAX:  regsTainted.push_front(REG_RAX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EAX:  regsTainted.push_front(REG_EAX); </span><br><span class="line">    <span class="keyword">case</span> REG_AX:   regsTainted.push_front(REG_AX);  <span class="comment">//AX：32位下为低16位</span></span><br><span class="line">    <span class="keyword">case</span> REG_AH:   regsTainted.push_front(REG_AH);  <span class="comment">//AH：32位下为高8位</span></span><br><span class="line">    <span class="keyword">case</span> REG_AL:   regsTainted.push_front(REG_AL);  <span class="comment">//AL：32位下为低8位</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RBX:  regsTainted.push_front(REG_RBX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EBX:  regsTainted.push_front(REG_EBX);</span><br><span class="line">    <span class="keyword">case</span> REG_BX:   regsTainted.push_front(REG_BX);</span><br><span class="line">    <span class="keyword">case</span> REG_BH:   regsTainted.push_front(REG_BH);</span><br><span class="line">    <span class="keyword">case</span> REG_BL:   regsTainted.push_front(REG_BL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RCX:  regsTainted.push_front(REG_RCX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ECX:  regsTainted.push_front(REG_ECX);</span><br><span class="line">    <span class="keyword">case</span> REG_CX:   regsTainted.push_front(REG_CX);</span><br><span class="line">    <span class="keyword">case</span> REG_CH:   regsTainted.push_front(REG_CH);</span><br><span class="line">    <span class="keyword">case</span> REG_CL:   regsTainted.push_front(REG_CL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDX:  regsTainted.push_front(REG_RDX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDX:  regsTainted.push_front(REG_EDX); </span><br><span class="line">    <span class="keyword">case</span> REG_DX:   regsTainted.push_front(REG_DX); </span><br><span class="line">    <span class="keyword">case</span> REG_DH:   regsTainted.push_front(REG_DH); </span><br><span class="line">    <span class="keyword">case</span> REG_DL:   regsTainted.push_front(REG_DL); </span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDI:  regsTainted.push_front(REG_RDI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDI:  regsTainted.push_front(REG_EDI); </span><br><span class="line">    <span class="keyword">case</span> REG_DI:   regsTainted.push_front(REG_DI); </span><br><span class="line">    <span class="comment">// case REG_DIL:  regsTainted.push_front(REG_DIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RSI:  regsTainted.push_front(REG_RSI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ESI:  regsTainted.push_front(REG_ESI); </span><br><span class="line">    <span class="keyword">case</span> REG_SI:   regsTainted.push_front(REG_SI); </span><br><span class="line">    <span class="comment">// case REG_SIL:  regsTainted.push_front(REG_SIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" can't be tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" is now tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">removeRegTainted</span><span class="params">(REG reg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(reg)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RAX:  regsTainted.remove(REG_RAX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EAX:  regsTainted.<span class="built_in">remove</span>(REG_EAX);</span><br><span class="line">    <span class="keyword">case</span> REG_AX:   regsTainted.<span class="built_in">remove</span>(REG_AX);</span><br><span class="line">    <span class="keyword">case</span> REG_AH:   regsTainted.<span class="built_in">remove</span>(REG_AH);</span><br><span class="line">    <span class="keyword">case</span> REG_AL:   regsTainted.<span class="built_in">remove</span>(REG_AL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RBX:  regsTainted.remove(REG_RBX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EBX:  regsTainted.<span class="built_in">remove</span>(REG_EBX);</span><br><span class="line">    <span class="keyword">case</span> REG_BX:   regsTainted.<span class="built_in">remove</span>(REG_BX);</span><br><span class="line">    <span class="keyword">case</span> REG_BH:   regsTainted.<span class="built_in">remove</span>(REG_BH);</span><br><span class="line">    <span class="keyword">case</span> REG_BL:   regsTainted.<span class="built_in">remove</span>(REG_BL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RCX:  regsTainted.remove(REG_RCX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ECX:  regsTainted.<span class="built_in">remove</span>(REG_ECX);</span><br><span class="line">    <span class="keyword">case</span> REG_CX:   regsTainted.<span class="built_in">remove</span>(REG_CX);</span><br><span class="line">    <span class="keyword">case</span> REG_CH:   regsTainted.<span class="built_in">remove</span>(REG_CH);</span><br><span class="line">    <span class="keyword">case</span> REG_CL:   regsTainted.<span class="built_in">remove</span>(REG_CL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDX:  regsTainted.remove(REG_RDX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDX:  regsTainted.<span class="built_in">remove</span>(REG_EDX); </span><br><span class="line">    <span class="keyword">case</span> REG_DX:   regsTainted.<span class="built_in">remove</span>(REG_DX); </span><br><span class="line">    <span class="keyword">case</span> REG_DH:   regsTainted.<span class="built_in">remove</span>(REG_DH); </span><br><span class="line">    <span class="keyword">case</span> REG_DL:   regsTainted.<span class="built_in">remove</span>(REG_DL); </span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDI:  regsTainted.remove(REG_RDI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDI:  regsTainted.<span class="built_in">remove</span>(REG_EDI); </span><br><span class="line">    <span class="keyword">case</span> REG_DI:   regsTainted.<span class="built_in">remove</span>(REG_DI); </span><br><span class="line">    <span class="comment">// case REG_DIL:  regsTainted.remove(REG_DIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RSI:  regsTainted.remove(REG_RSI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ESI:  regsTainted.<span class="built_in">remove</span>(REG_ESI); </span><br><span class="line">    <span class="keyword">case</span> REG_SI:   regsTainted.<span class="built_in">remove</span>(REG_SI); </span><br><span class="line">    <span class="comment">// case REG_SIL:  regsTainted.remove(REG_SIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" is now freed"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  操作数大于1个，当前指令为读操作，第一个操作数为寄存器</span></span><br><span class="line"><span class="comment">  ins: mov eax, dword ptr [esi]</span></span><br><span class="line"><span class="comment">  ins: mov esi, dword ptr [esi+0x34]</span></span><br><span class="line"><span class="comment">  ins: mov eax, dword ptr [esp+0xc]</span></span><br><span class="line"><span class="comment">  ins: pop ebx</span></span><br><span class="line"><span class="comment">  ins: pop esi</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  若不限定第一个操作数为寄存器，可能出现的指令为：</span></span><br><span class="line"><span class="comment">  ins: add dword ptr [eax+0x4], 0x1</span></span><br><span class="line"><span class="comment">  ins: cmp dword ptr [eax+0x14], eax</span></span><br><span class="line"><span class="comment">  ins: test byte ptr [ebx-0x2e0], 0x8</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID <span class="title">ReadMem</span><span class="params">(ADDRINT insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, ADDRINT opCount, REG reg_r, ADDRINT memOp, ADDRINT sp)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;ADDRINT&gt;::iterator i;</span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i2;</span><br><span class="line">  ADDRINT addr = memOp; <span class="comment">//内存读取操作的地址</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (opCount != <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span>(i2 = mallocAreaList.<span class="built_in">begin</span>(); i2 != mallocAreaList.<span class="built_in">end</span>(); i2++)&#123;</span><br><span class="line">    <span class="comment">//UAF：读取了标志为FREE状态的内存</span></span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= i2-&gt;base &amp;&amp; addr &lt; (i2-&gt;base + i2-&gt;<span class="built_in">size</span>) &amp;&amp; i2-&gt;status == FREE)&#123; </span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//若read读取的地址被污染，则将污点信息传播至寄存器</span></span><br><span class="line">  <span class="keyword">for</span>(i = addressTainted.<span class="built_in">begin</span>(); i != addressTainted.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (addr == *i)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[READ in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        taintReg(reg_r); <span class="comment">//将该寄存器标记为被污染</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (sp &gt; addr &amp;&amp; addr &gt; <span class="number">0x700000000000</span>) <span class="comment">//检测栈变量的UAF</span></span><br><span class="line">          <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//若read读取的地址未被污染，则会覆盖目标寄存器的污点信息</span></span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg_r))&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[READ in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    removeRegTainted(reg_r);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esi+0x4c], 0xffffffff</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esp+0x8], eax</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esp+0xc], 0x0</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esp], esi</span></span><br><span class="line"><span class="comment">  ins: call 0xb5d8bbe0</span></span><br><span class="line"><span class="comment">  ins: push esi</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID <span class="title">WriteMem</span><span class="params">(ADDRINT insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, ADDRINT opCount, REG reg_r, ADDRINT memOp, ADDRINT sp)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;ADDRINT&gt;::iterator i;</span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i2;</span><br><span class="line">  ADDRINT addr = memOp;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (opCount != <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span>(i2 = mallocAreaList.<span class="built_in">begin</span>(); i2 != mallocAreaList.<span class="built_in">end</span>(); i2++)&#123;</span><br><span class="line">    <span class="comment">//UAF：向标志为FREE状态的内存写入数据</span></span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= i2-&gt;base &amp;&amp; addr &lt; (i2-&gt;base + i2-&gt;<span class="built_in">size</span>) &amp;&amp; i2-&gt;status == FREE)&#123;  </span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//若write写入的地址已被污染，且寄存器未被污染，那么write操作会覆盖目标地址的污点信息</span></span><br><span class="line">  <span class="keyword">for</span>(i = addressTainted.<span class="built_in">begin</span>(); i != addressTainted.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (addr == *i)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[WRITE in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">if</span> (!REG_valid(reg_r) || !checkAlreadyRegTainted(reg_r))</span><br><span class="line">          removeMemTainted(addr);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sp &gt; addr &amp;&amp; addr &gt; <span class="number">0x700000000000</span>)</span><br><span class="line">          <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//若write写入的地址未被污染，且寄存器已被污染，那么write操作会将寄存器的污点信息传播至目标地址</span></span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg_r))&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[WRITE in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    addMemTainted(addr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  操作数大于1个，第一个操作数是寄存器</span></span><br><span class="line"><span class="comment">  ins: mov esi, eax</span></span><br><span class="line"><span class="comment">  ins: mov ebp, esp</span></span><br><span class="line"><span class="comment">  ins: sub esp, 0x8</span></span><br><span class="line"><span class="comment">  ins: mov eax, 0x804a02b</span></span><br><span class="line"><span class="comment">  ins: sub eax, 0x804a028</span></span><br><span class="line"><span class="comment">  ins: cmp eax, 0x6</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  ins: mov eax, 0x467 reg_r: 0 reg_w: a</span></span><br><span class="line"><span class="comment">  ins: mov edx, eax reg_r: a reg_w: 8</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID <span class="title">spreadRegTaint</span><span class="params">(ADDRINT *insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, ADDRINT opCount, REG reg_r, REG reg_w)</span></span>&#123;</span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; "ins: " &lt;&lt; insDis &lt;&lt; " reg_r: " &lt;&lt; reg_r &lt;&lt; " reg_w: " &lt;&lt; reg_w &lt;&lt; "\n";</span></span><br><span class="line">  <span class="keyword">if</span> (opCount != <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (REG_valid(reg_w))&#123;</span><br><span class="line">    <span class="comment">//被写入的寄存器已被污染且读取的不是寄存器 或者 读取的寄存器未被污染，此时需要移除被写入寄存器的污点信息</span></span><br><span class="line">    <span class="keyword">if</span> (checkAlreadyRegTainted(reg_w) &amp;&amp; (!REG_valid(reg_r) || !checkAlreadyRegTainted(reg_r)))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[SPREAD]\t\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\toutput: "</span>&lt;&lt; REG_StringShort(reg_w) &lt;&lt; <span class="string">" | input: "</span> &lt;&lt; (REG_valid(reg_r) ? REG_StringShort(reg_r) : <span class="string">"constant"</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      removeRegTainted(reg_w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 被写入的寄存器未被污染，读取的寄存器被污染，传播污点信息至被写入的寄存器</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!checkAlreadyRegTainted(reg_w) &amp;&amp; checkAlreadyRegTainted(reg_r))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[SPREAD]\t\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\toutput: "</span> &lt;&lt; REG_StringShort(reg_w) &lt;&lt; <span class="string">" | input: "</span>&lt;&lt; REG_StringShort(reg_r) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      taintReg(reg_w);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">followData</span><span class="params">(ADDRINT *insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, REG reg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!REG_valid(reg))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[FOLLOW]\t\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span>&#123;</span><br><span class="line">  <span class="comment">//将数据读取到寄存器中</span></span><br><span class="line">  <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_MemoryOperandIsRead(ins, <span class="number">0</span>) &amp;&amp; INS_OperandIsReg(ins, <span class="number">0</span>))&#123; </span><br><span class="line">     INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)ReadMem,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins), </span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)), </span><br><span class="line">        IARG_ADDRINT, INS_OperandCount(ins), </span><br><span class="line">        IARG_ADDRINT, INS_OperandReg(ins, <span class="number">0</span>), </span><br><span class="line">        IARG_MEMORYOP_EA, <span class="number">0</span>,</span><br><span class="line">        IARG_REG_VALUE, REG_STACK_PTR,</span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_MemoryOperandIsWritten(ins, <span class="number">0</span>))&#123;</span><br><span class="line">    INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)WriteMem,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">        IARG_ADDRINT, INS_OperandCount(ins),</span><br><span class="line">        IARG_ADDRINT, INS_OperandReg(ins, <span class="number">1</span>),</span><br><span class="line">        IARG_MEMORYOP_EA, <span class="number">0</span>,</span><br><span class="line">        IARG_REG_VALUE, REG_STACK_PTR, </span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_OperandIsReg(ins, <span class="number">0</span>))&#123;</span><br><span class="line">    INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)spreadRegTaint,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">        IARG_ADDRINT, INS_OperandCount(ins),</span><br><span class="line">        IARG_ADDRINT, INS_RegR(ins, <span class="number">0</span>),</span><br><span class="line">        IARG_ADDRINT, INS_RegW(ins, <span class="number">0</span>),</span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_OperandIsReg(ins, <span class="number">0</span>))&#123;</span><br><span class="line">    INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)followData,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">        IARG_ADDRINT, INS_RegR(ins, <span class="number">0</span>),</span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">callbackBeforeMalloc</span><span class="params">(ADDRINT <span class="built_in">size</span>, ADDRINT ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PIN_LockClient();</span><br><span class="line">  IMG img = IMG_FindByAddress(ret);</span><br><span class="line">  PIN_UnlockClient(); </span><br><span class="line">  <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">    <span class="keyword">if</span> (IMG_IsMainExecutable(img))&#123; <span class="comment">//仅监控main函数中的malloc信息</span></span><br><span class="line">      lastSize = <span class="built_in">size</span>; <span class="comment">//全局变量lastSize保存的是malloc()函数的参数，也即申请分配的chunk大小</span></span><br><span class="line">      <span class="comment">// std::cout &lt;&lt; "image's name: " &lt;&lt; IMG_Name(img) &lt;&lt; "\n";</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">callbackBeforeFree</span><span class="params">(ADDRINT addr)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[INFO]\t\tfree("</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; addr &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="comment">//若释放的chunk在mallocAreaList中，将其status设置为 FREE</span></span><br><span class="line">  <span class="keyword">for</span>(i = mallocAreaList.<span class="built_in">begin</span>(); i != mallocAreaList.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr == i-&gt;base)&#123;</span><br><span class="line">      i-&gt;status = FREE;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">callbackAfterMalloc</span><span class="params">(ADDRINT ret)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mallocArea</span> <span class="title">elem</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lastSize == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[INFO]\t\tmalloc("</span> &lt;&lt; lastSize &lt;&lt; <span class="string">") = 0x"</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; ret &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">if</span> (ret)&#123;</span><br><span class="line">    <span class="comment">//若该chunk已在list中保存，更新其size、status信息</span></span><br><span class="line">    <span class="keyword">for</span>(i = mallocAreaList.<span class="built_in">begin</span>(); i != mallocAreaList.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (ret == i-&gt;base)&#123;</span><br><span class="line">        i-&gt;status = ALLOCATE;</span><br><span class="line">        i-&gt;<span class="built_in">size</span> = lastSize;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//该chunk尚未记录，初始化elem并将其加入mallocAreaList中</span></span><br><span class="line">    elem.base = ret;</span><br><span class="line">    elem.<span class="built_in">size</span> = lastSize;</span><br><span class="line">    elem.status = ALLOCATE;</span><br><span class="line">    mallocAreaList.push_front(elem);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span></span>&#123;</span><br><span class="line">  RTN mallocRtn = RTN_FindByName(img, <span class="string">"malloc"</span>);</span><br><span class="line">  RTN freeRtn = RTN_FindByName(img, <span class="string">"free"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(mallocRtn))&#123;</span><br><span class="line">    RTN_Open(mallocRtn);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeMalloc,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, <span class="comment">//获取malloc()函数的参数</span></span><br><span class="line">        IARG_RETURN_IP,</span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_AFTER, (AFUNPTR)callbackAfterMalloc,</span><br><span class="line">        IARG_FUNCRET_EXITPOINT_VALUE,   <span class="comment">//malloc()函数的返回值</span></span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_Close(mallocRtn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(freeRtn))&#123;</span><br><span class="line">    RTN_Open(freeRtn);</span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        freeRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeFree,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, <span class="comment">//free()函数的参数</span></span><br><span class="line">        IARG_END);</span><br><span class="line">    RTN_Close(freeRtn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>(PIN_Init(argc, argv))&#123;</span><br><span class="line">        <span class="keyword">return</span> Usage();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PIN_SetSyntaxIntel();</span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ol>
<li>对32位程序进行的测试，源码中部分类型为UINT64的变量需要将其改为UINT32或者ADDRINT</li>
</ol>
<p><strong>参数解释：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IARG_ADDRINT, INS_Address(ins), <span class="comment">//被插桩指令的地址</span></span><br><span class="line">IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)), <span class="comment">//指令的可打印字符串</span></span><br><span class="line">IARG_ADDRINT, INS_OperandCount(ins), <span class="comment">//指令操作数的个数</span></span><br><span class="line">IARG_ADDRINT, INS_OperandReg(ins, <span class="number">0</span>),  <span class="comment">//返回该操作数所对应的寄存器</span></span><br><span class="line">IARG_MEMORYOP_EA, <span class="number">0</span>,  <span class="comment">//Type: ADDRINT. 内存操作的有效地址（内存操作索引是下一个参数）仅在设置IPOINT_BEFORE时有效</span></span><br><span class="line">IARG_REG_VALUE, REG_STACK_PTR,<span class="comment">//REG_STACK_PTR：esp、rsp；IARG_REG_VALUE：ADDRINT，寄存器的值，需额外的寄存器作为参数</span></span><br></pre></td></tr></table></figure>

<p><strong>API：INS_RegR()、INS_REGW()</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">REG <span class="title">LEVEL_CORE::INS_RegR</span><span class="params">(INS x, UINT32 k)</span>		</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	指令x的第k个read操作的寄存器，包含隐式read（如：32位系统中的push esp）</span><br><span class="line">    </span><br><span class="line"><span class="function">REG <span class="title">LEVEL_CORE::INS_RegW</span><span class="params">(INS x, UINT32 k)</span>		</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	指令x的第k个write操作的寄存器，包含隐式write（如：32位系统中的push esp）</span><br></pre></td></tr></table></figure>

<p><strong>输出：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:ClassicalUseAfterFreePatternMatching# /<span class="built_in">home</span>/vuzzer/pin/pin -t ./obj-ia32/Taint.so -- ./test</span><br><span class="line">[INFO]		<span class="built_in">malloc</span>(<span class="number">0x32</span>) = <span class="number">0x936b008</span></span><br><span class="line">[INFO]		<span class="built_in">malloc</span>(<span class="number">0x20</span>) = <span class="number">0x936b008</span></span><br><span class="line">[INFO]		<span class="built_in">free</span>(<span class="number">936b</span>008)</span><br><span class="line">[UAF in <span class="number">936b</span>008]	b5cebcb5: mov dword ptr [esi+<span class="number">0x8</span>], ecx</span><br><span class="line">[UAF in <span class="number">936b</span>008]	<span class="number">804848f</span>: movzx eax, <span class="keyword">byte</span> ptr [eax]</span><br><span class="line">[UAF in <span class="number">936b</span>008]	b5cec92f: mov ecx, dword ptr [edi+<span class="number">0x8</span>]</span><br><span class="line">[INFO]		<span class="built_in">malloc</span>(<span class="number">0x20</span>) = <span class="number">0x936b008</span></span><br></pre></td></tr></table></figure>

<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><blockquote>
<ol>
<li><a href="http://shell-storm.org/blog/Taint-analysis-and-pattern-matching-with-Pin/#5.2" target="_blank" rel="noopener">http://shell-storm.org/blog/Taint-analysis-and-pattern-matching-with-Pin/#5.2</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/18/Glibc%E4%B8%ADmalloc%E5%88%86%E9%85%8Dchunk%E5%A4%A7%E5%B0%8F%E3%80%81%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/18/Glibc%E4%B8%ADmalloc%E5%88%86%E9%85%8Dchunk%E5%A4%A7%E5%B0%8F%E3%80%81%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98/" itemprop="url">Glibc中malloc分配chunk大小、对齐问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-18T18:47:04+08:00">
                2020-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn/" itemprop="url" rel="index">
                    <span itemprop="name">Pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Glibc中malloc分配chunk大小、对齐问题"><a href="#Glibc中malloc分配chunk大小、对齐问题" class="headerlink" title="Glibc中malloc分配chunk大小、对齐问题"></a>Glibc中malloc分配chunk大小、对齐问题</h2><p>用户最小申请的内存大小必须是<code>2 * SIZE_SZ</code>的最小整数倍。如果申请的内存大小不<code>2 * SIZE_SZ</code>的整数倍，会被转换满足大小的最小的<code>2 * SIZE_SZ</code>的倍数。</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>32bit</th>
<th>64bit</th>
</tr>
</thead>
<tbody><tr>
<td>SIZE_SZ</td>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td>MIN_CHUNK_SIZE</td>
<td>16</td>
<td>32</td>
</tr>
<tr>
<td>MINSIZE</td>
<td>16</td>
<td>32</td>
</tr>
</tbody></table>
<h3 id="将用户请求内存大小转为实际分配内存大小"><a href="#将用户请求内存大小转为实际分配内存大小" class="headerlink" title="将用户请求内存大小转为实际分配内存大小"></a>将用户请求内存大小转为实际分配内存大小</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MALLOC_ALIGN_MASK &#x3D; 2 * SIZE_SZ -1</span><br><span class="line">#define request2size(req)                                                      \</span><br><span class="line">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span><br><span class="line">         ? MINSIZE                                                             \</span><br><span class="line">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br></pre></td></tr></table></figure>

<p><code>((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)：（MALLOC_ALIGN_MASK+1）的倍数中，是（req+SIZE_SZ）的最小上界的那个数，此处最后求解的size包括chunk头</code></p>
<h3 id="检查分配给用户的内存是否对齐"><a href="#检查分配给用户的内存是否对齐" class="headerlink" title="检查分配给用户的内存是否对齐"></a>检查分配给用户的内存是否对齐</h3><p><code>2 * SIZE_SZ</code>大小对齐。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; MALLOC_ALIGN_MASK &#x3D; 2 * SIZE_SZ -1</span><br><span class="line">#define aligned_OK(m) (((unsigned long) (m) &amp; MALLOC_ALIGN_MASK) &#x3D;&#x3D; 0)</span><br></pre></td></tr></table></figure>

<p>malloc(27) -&gt; (27 + 4 + 7) &amp;~ (7) -&gt; 32，减去chunk头实际分配的堆内存大小为24字节：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;20wx 0x804b018 - 0x10</span><br><span class="line">0x804b008:	0x00000000	0x00000000	0x00000000	0x00000021</span><br><span class="line">0x804b018:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804b028:	0x00000000	0x00000000	0x00000000	0x00020fd1</span><br></pre></td></tr></table></figure>

<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><h4 id="逻辑表达式-a-b-amp-b-的含义"><a href="#逻辑表达式-a-b-amp-b-的含义" class="headerlink" title="逻辑表达式 (a+b) &amp;~b 的含义"></a>逻辑表达式 (a+b) &amp;~b 的含义</h4><p> 例1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a &#x3D; 7,b &#x3D; 3</span><br><span class="line">(7 + 3) &amp; (~3) &#x3D; (0111 + 0011) &amp; (~0011)</span><br><span class="line">&#x3D; (1010) &amp; (1100) &#x3D; 1000 &#x3D; 8</span><br></pre></td></tr></table></figure>

<p>得到的结果是8</p>
<p>例2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a &#x3D; 21,b &#x3D; 7</span><br><span class="line">(21 + 7) &amp; (~7) &#x3D; (010101 + 000111) &amp; (111000) </span><br><span class="line">&#x3D; (011100) &amp; (111000) &#x3D; (011000) &#x3D; 24</span><br></pre></td></tr></table></figure>

<p>由上可知，8 是 4（b+1)的倍数中7的最小上界，</p>
<p>24是8（7 + 1）的倍数中21的最小上界。</p>
<p>逻辑表达式的作用是求出在b + 1的倍数中a的最小上界</p>
<blockquote>
<ol>
<li><a href="https://zhidao.baidu.com/question/1704099990419179620.html" target="_blank" rel="noopener">https://zhidao.baidu.com/question/1704099990419179620.html</a> </li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/17/Using%20PIN_SafeCopy()/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/17/Using%20PIN_SafeCopy()/" itemprop="url">九、Using PIN_SafeCopy()</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-17T10:06:58+08:00">
                2020-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Using-PIN-SafeCopy"><a href="#Using-PIN-SafeCopy" class="headerlink" title="Using PIN_SafeCopy()"></a>Using PIN_SafeCopy()</h2><p><code>PIN_SafeCopy</code>用于将指定数量的字节从<code>source</code>内存区域复制到<code>destination</code>内存区域。即使<code>source</code>或<code>destination</code>区域不能被访问（部分或完全），此函数也会保证安全的返回到调用方。</p>
<p>使用此函数还可以保证tool读取或写入那些被程序使用的值。例如，在Windows上，Pin会在运行tool的分析代码时替换某些TEB字段。如果tool直接访问这些字段，它将看到修改后的值而不是原始值。使用PIN_SafeCopy（）可使tool读取或写入这些字段的应用程序值。</p>
<p>每当tool读取或写入应用程序内存时可以使用此API。</p>
<p>首先进行编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># make obj-ia32&#x2F;safecopy.so TARGET&#x3D;ia32</span><br><span class="line"></span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER&#x3D;1 -Wall -Werror -Wno-unknown-pragmas -fno-stack-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;gen -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;components&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;tools&#x2F;InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32&#x2F;safecopy.o safecopy.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style&#x3D;sysv -Wl,-Bsymbolic -Wl,--version-script&#x3D;..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;pintool.ver    -o obj-ia32&#x2F;safecopy.so obj-ia32&#x2F;safecopy.o  -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib-ext -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;runtime&#x2F;glibc -L..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;lib -lpin -lxed -ldwarf -lelf -ldl</span><br></pre></td></tr></table></figure>

<p>测试程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test<span class="meta"># cat hello.c </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Hello World!\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行它并显示它的输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# /<span class="built_in">home</span>/vuzzer/pin/pin -t ../obj-ia32/safecopy.so -- ./hello</span><br><span class="line">Hello World!</span><br><span class="line"></span><br><span class="line">root@ubuntu:test<span class="meta"># cat safecopy.out </span></span><br><span class="line"><span class="number">0x8048350</span> mov ebx, dword ptr [esp] Emulate loading from addr <span class="number">0xbfc869e8</span> to ebx</span><br><span class="line"><span class="number">0x8048454</span> mov ebp, dword ptr [esp+<span class="number">0x30</span>] Emulate loading from addr <span class="number">0xbfc86a00</span> to ebp</span><br><span class="line"><span class="number">0x8048350</span> mov ebx, dword ptr [esp] Emulate loading from addr <span class="number">0xbfc869bc</span> to ebx</span><br><span class="line"><span class="number">0x80482bf</span> mov eax, dword ptr [ebx<span class="number">-0x4</span>] Emulate loading from addr <span class="number">0x8049ffc</span> to eax</span><br><span class="line"><span class="number">0x8048478</span> mov eax, dword ptr [esp+<span class="number">0x38</span>] Emulate loading from addr <span class="number">0xbfc86a08</span> to eax</span><br><span class="line"><span class="number">0x8048483</span> mov eax, dword ptr [esp+<span class="number">0x34</span>] Emulate loading from addr <span class="number">0xbfc86a04</span> to eax</span><br><span class="line"><span class="number">0x80483f0</span> mov eax, dword ptr [<span class="number">0x8049f10</span>] Emulate loading from addr <span class="number">0x8049f10</span> to eax</span><br><span class="line"><span class="number">0x8048350</span> mov ebx, dword ptr [esp] Emulate loading from addr <span class="number">0xbfc8690c</span> to ebx</span><br></pre></td></tr></table></figure>

<p>本例源码在<code>source/tools/ManualExamples/safecopy.cpp.</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cerr</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">std</span>::ofstream* out = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="comment">//  Analysis routines</span></span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="comment">// Move from memory to register</span></span><br><span class="line"><span class="function">ADDRINT <span class="title">DoLoad</span><span class="params">(REG reg, ADDRINT * addr, <span class="built_in">std</span>::<span class="built_in">string</span> ins_str, ADDRINT *ip)</span></span>&#123;</span><br><span class="line">    *out &lt;&lt; ip &lt;&lt; <span class="string">" "</span> &lt;&lt; ins_str.c_str() &lt;&lt; <span class="string">" Emulate loading from addr "</span> &lt;&lt; addr </span><br><span class="line">      		&lt;&lt; <span class="string">" to "</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ADDRINT value;</span><br><span class="line">    PIN_SafeCopy(&amp;value, addr, <span class="keyword">sizeof</span>(ADDRINT)); <span class="comment">//将内存中的值读取到 value 中，并返回</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="comment">// Instrumentation routines</span></span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="function">VOID <span class="title">EmulateLoad</span><span class="params">(INS ins, VOID* v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (INS_Address(ins) &lt;= <span class="number">0x8048000</span> || INS_Address(ins) &gt;= <span class="number">0x80000000</span>)&#123;<span class="comment">// 仅打印main中的指令</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Find the instructions that move a value from memory to a register</span></span><br><span class="line">    <span class="keyword">if</span> (INS_Opcode(ins) == XED_ICLASS_MOV &amp;&amp;</span><br><span class="line">        INS_IsMemoryRead(ins) &amp;&amp;</span><br><span class="line">        INS_OperandIsReg(ins, <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        INS_OperandIsMemory(ins, <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// op0 &lt;- *op1</span></span><br><span class="line">        INS_InsertCall(ins,</span><br><span class="line">                       IPOINT_BEFORE,</span><br><span class="line">                       AFUNPTR(DoLoad),</span><br><span class="line">                       IARG_UINT32,	REG(INS_OperandReg(ins, <span class="number">0</span>)),<span class="comment">// REG reg</span></span><br><span class="line">                       IARG_MEMORYREAD_EA, <span class="comment">//ADDRINT * addr</span></span><br><span class="line">                       <span class="comment">//因为删除了指令，所以需要把读取内存中的数据存入寄存器使用函数 PIN_SafeCopy 自己实现，</span></span><br><span class="line">                       <span class="comment">//最后将返回值存入到第一个操作数对应的寄存器中</span></span><br><span class="line">                       IARG_RETURN_REGS, INS_OperandReg(ins, <span class="number">0</span>), </span><br><span class="line">                       IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)), <span class="comment">//std::string ins_str</span></span><br><span class="line">                       IARG_INST_PTR, <span class="comment">//ADDRINT *ip</span></span><br><span class="line">                       IARG_END);</span><br><span class="line">        <span class="comment">// 删除该指令，需要模拟该指令的功能</span></span><br><span class="line">        INS_Delete(ins);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool demonstrates the use of SafeCopy"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    out = <span class="keyword">new</span> <span class="built_in">std</span>::ofstream(<span class="string">"safecopy.out"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Initialize pin &amp; symbol manager</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Register EmulateLoad to be called to instrument instructions</span></span><br><span class="line">    INS_AddInstrumentFunction(EmulateLoad, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>INS_InsertCall参数解释：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IARG_UINT32：Type: UINT32. 常量值 (需要额外的整型参数)</span><br><span class="line">IARG_RETURN_REGS：保存分析函数返回值的寄存器 (需要额外的寄存器作为参数)</span><br><span class="line">IARG_PTR：Type: &quot;VOID *&quot;. 常量值 (需要额外的指针类型数据作为参数)</span><br><span class="line">IARG_INST_PTR：Type: ADDRINT. 被插桩指令的地址。该值在IPOINT_AFTER不会改变，是IARG_ADDRINT和INS_Address（ins）的简写</span><br><span class="line">IARG_MEMORYREAD_EA：有效内存读的地址，仅当INS_IsMemoryRead时True，且设置了IPOINT_BEFORE</span><br></pre></td></tr></table></figure>

<p><strong>API：INS_OperandReg(INS ins, UINT32 n)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">REG <span class="title">LEVEL_CORE::INS_OperandReg</span><span class="params">(INS ins, UINT32 n)</span>		</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">  返回此操作数对应的寄存器"名字"(返回的其实是一个数字，REG是一个枚举类型，代表不同的寄存器)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">enum  	LEVEL_BASE::REG &#123;</span></span><br><span class="line"><span class="comment">  REG_INVALID_ = 0,</span></span><br><span class="line"><span class="comment">  REG_GR_BASE = REG_RBASE,</span></span><br><span class="line"><span class="comment">  REG_EDI = REG_GR_BASE,</span></span><br><span class="line"><span class="comment">  REG_GDI = REG_EDI,</span></span><br><span class="line"><span class="comment">  REG_ESI,</span></span><br><span class="line"><span class="comment">  REG_GSI = REG_ESI,</span></span><br><span class="line"><span class="comment">  REG_EBP,</span></span><br><span class="line"><span class="comment">  REG_GBP = REG_EBP,</span></span><br><span class="line"><span class="comment">  REG_ESP,</span></span><br><span class="line"><span class="comment">  ......</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>API：REG_StringShort(REG reg)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">LEVEL_BASE::REG_StringShort</span><span class="params">(REG reg)</span>	</span></span><br><span class="line"><span class="function">	<span class="comment">//将一个REG转换成可打印的字符串</span></span></span><br></pre></td></tr></table></figure>

<p><strong>API：INS_IsMemoryRead(INS ins)</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_CORE::INS_IsMemoryRead</span>	<span class="params">(	INS 	ins	)</span>	</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">	若该指令读取内存返回 true（有的系统的指令读取gs、fs中的值不会被视为访问内存）</span><br></pre></td></tr></table></figure>

<p><strong>API：INS_OperandIsReg(INS ins, UINT32 n )</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_CORE::INS_OperandIsReg</span><span class="params">(INS ins, UINT32 n)</span>		</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">	若该操作数是一个寄存器则返回true</span><br></pre></td></tr></table></figure>

<p><strong>API：INS_OperandIsMemory(INS ins, UINT32 n)</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_CORE::INS_OperandIsMemory</span><span class="params">(INS ins, UINT32 n)</span>		</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">	若该操作数是一个内存的引用则返回true。注意：不包括LEA操作数</span><br></pre></td></tr></table></figure>

<p><strong>API：PIN_SafeCopy(VOID *dst，const VOID *src，size_t size)：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">LEVEL_PINCLIENT::PIN_SafeCopy</span><span class="params">(VOID *dst, <span class="keyword">const</span> VOID *src, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span>		</span></span><br><span class="line"><span class="function"><span class="comment">/*</span></span></span><br><span class="line"><span class="function"><span class="comment">将指定数量的字节从 source 内存区域复制到 destination 内存区域。即使 source 或 destination </span></span></span><br><span class="line"><span class="function"><span class="comment">区域不能被访问（部分或完全），此函数也会保证安全的返回到调用方。</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">Pintool 应使用此函数来确保安全访问应用程序内存的原始内容。例如，在Windows上，在tool中运行分析例程时，</span></span></span><br><span class="line"><span class="function"><span class="comment">Pin会替换某些TEB字段。 如果tool直接访问这些字段，它将看到由Pin分配的值而不是原始值。相反，PIN_SafeCopy() </span></span></span><br><span class="line"><span class="function"><span class="comment">始终读取和修改这些字段的原始应用程序值。</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">此函数可以在任何线程中使用，包括tool产生的任何内部线程。</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line">    [out]	dst	destination region</span><br><span class="line">    [in]	src	region to copy from</span><br><span class="line">    [in]	<span class="built_in">size</span>	number of bytes to copy</span><br><span class="line">Returns:</span><br><span class="line">		Number of bytes successfully copied from the source to the destination region.</span><br><span class="line">Note:</span><br><span class="line">		PIN_SafeCopy() should <span class="keyword">not</span> be called before the application has been started. For instance, </span><br><span class="line">		it cannot be called in an Image load callback. Unexpected results will occur.</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/15/Finding-the-Value-of-Function-Arguments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/15/Finding-the-Value-of-Function-Arguments/" itemprop="url">十一、Finding the Value of Function Arguments</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-15T10:43:22+08:00">
                2020-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Finding-the-Value-of-Function-Arguments"><a href="#1-Finding-the-Value-of-Function-Arguments" class="headerlink" title="1. Finding the Value of Function Arguments"></a>1. Finding the Value of Function Arguments</h2><p>有时候我们需要得到函数的参数，或者返回值。可以使用Pin来获取这些信息，使用<a href="https://software.intel.com/sites/landingpage/pintool/docs/98223/Pin/html/group__RTN__BASIC__API.html#ga76bde295a78d1232fd6ff98a5ff011cf" target="_blank" rel="noopener">RTN_InsertCall()</a>函数可以获取感兴趣的参数。</p>
<p>下面的例子打印出函数<code>malloc()、free()</code>的参数和函数<code>malloc()</code>的返回值。</p>
<p>编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make .&#x2F;obj-ia32&#x2F;malloctrace.so TARGET&#x3D;ia32</span><br></pre></td></tr></table></figure>

<p>被测程序<code>malloc.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *a = <span class="built_in">malloc</span>(<span class="number">0x100</span><span class="number">-8</span>);</span><br><span class="line">	a[<span class="number">0</span>] = <span class="string">'h'</span>;</span><br><span class="line">	a[<span class="number">1</span>] = <span class="string">'e'</span>;</span><br><span class="line">	a[<span class="number">2</span>] = <span class="string">'l'</span>;</span><br><span class="line">	a[<span class="number">3</span>] = <span class="string">'l'</span>;</span><br><span class="line">	a[<span class="number">4</span>] = <span class="string">'o'</span>;</span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>RTN_InsertCall</code>中增加一个参数<code>IARG_RETURN_IP</code>，以此来获得<code>malloc</code>函数的返回值地址</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RTN_InsertCall(mallocRtn, IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">              IARG_ADDRINT, MALLOC,</span><br><span class="line">              IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, IARG_RETURN_IP,</span><br><span class="line">              IARG_END);</span><br></pre></td></tr></table></figure>

<p>将返回地址打印出的结果为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># /<span class="built_in">home</span>/vuzzer/pin/pin -t ../../obj-ia32/malloctrace.so -- ./<span class="built_in">malloc</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77469a0</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7751ee1</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb774bcec</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb774bd26</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7749196</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb774ead3</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7750d3d</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7750f1e</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x8048462</span>	<span class="comment">//malloc.c</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb5e3eaaf</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x206</span></span><br></pre></td></tr></table></figure>

<p>由上可知，Pin监控到了多个<code>malloc</code>函数，其中只有返回地址为<code>0x8048462</code>属于<code>malloc.c</code>。</p>
<p>将函数<code>Arg1Before</code>修改为如下形式，可以打印出<code>image</code>的名字</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Arg1Before</span><span class="params">(CHAR * name, ADDRINT <span class="built_in">size</span>, ADDRINT ret_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ret_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"IMG_Name: %s\n"</span>, IMG_Name(img).c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    TraceFile &lt;&lt; name &lt;&lt; <span class="string">"("</span> &lt;&lt; <span class="built_in">size</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc's ret_addr: 0x%x\n"</span>, ret_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># /<span class="built_in">home</span>/vuzzer/pin/pin -t ../../obj-ia32/malloctrace.so -- ./<span class="built_in">malloc</span></span><br><span class="line">IMG_Name: /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77c0871</span></span><br><span class="line">IMG_Name: /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77c0871</span></span><br><span class="line">IMG_Name: /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77ad9a0</span></span><br><span class="line">......</span><br><span class="line">IMG_Name: ManualExamples/test/heapview/<span class="built_in">malloc</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x8048462</span></span><br><span class="line">IMG_Name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb5ea5aaf</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x206</span></span><br></pre></td></tr></table></figure>

<p>表明，Pin除了监控到<code>image malloc</code>，还监控到<code>ld-linux.so.2、libc.so.6</code>。再次对<code>Arg1Before</code>进行修改，去除对<code>image ld-linux.so.2、libc.so.6</code>的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># /<span class="built_in">home</span>/vuzzer/pin/pin -t ../../obj-ia32/malloctrace.so -- ./<span class="built_in">malloc</span></span><br><span class="line">IMG_Name: ManualExamples/test/heapview/<span class="built_in">malloc</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x8048462</span></span><br></pre></td></tr></table></figure>

<p>本例的源码在<code>pin/source/tools/ManualExamples/malloctrace.cpp</code>中，修改后为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::hex;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cerr</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ios;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Names of malloc and free */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(TARGET_MAC)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC <span class="meta-string">"_malloc"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE <span class="meta-string">"_free"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC <span class="meta-string">"malloc"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE <span class="meta-string">"free"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Global Variables */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="built_in">std</span>::ofstream TraceFile;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Commandline Switches */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">KNOB&lt;<span class="built_in">string</span>&gt; <span class="title">KnobOutputFile</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"o"</span>, <span class="string">"malloctrace.out"</span>, <span class="string">"specify trace file name"</span>)</span></span>;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Analysis routines                                                     */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"> </span><br><span class="line"><span class="function">VOID <span class="title">Arg1Before</span><span class="params">(CHAR * name, ADDRINT <span class="built_in">size</span>, ADDRINT ret_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ret_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="keyword">if</span> (IMG_Name(img).<span class="built_in">find</span>(<span class="string">".so."</span>) == <span class="built_in">string</span>::npos)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"IMG_Name: %s\n"</span>, IMG_Name(img).c_str());</span><br><span class="line">            TraceFile &lt;&lt; name &lt;&lt; <span class="string">"("</span> &lt;&lt; <span class="built_in">size</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"malloc's ret_addr: 0x%x\n"</span>, ret_addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">MallocAfter</span><span class="params">(ADDRINT ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TraceFile &lt;&lt; <span class="string">"  returns "</span> &lt;&lt; ret &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Instrumentation routines                                              */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line">   </span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Instrument the malloc() and free() functions.  Print the input argument</span></span><br><span class="line">    <span class="comment">// of each malloc() or free(), and the return value of malloc().</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Find the malloc() function.</span></span><br><span class="line">    RTN mallocRtn = RTN_FindByName(img, MALLOC);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(mallocRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(mallocRtn);</span><br><span class="line">        <span class="comment">// Instrument malloc() to print the input argument value and the return value.</span></span><br><span class="line">        RTN_InsertCall(mallocRtn, IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, MALLOC,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, IARG_RETURN_IP，</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_InsertCall(mallocRtn, IPOINT_AFTER, (AFUNPTR)MallocAfter,</span><br><span class="line">                       IARG_FUNCRET_EXITPOINT_VALUE, IARG_END);</span><br><span class="line">        RTN_Close(mallocRtn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Find the free() function.</span></span><br><span class="line">    RTN freeRtn = RTN_FindByName(img, FREE);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(freeRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(freeRtn);</span><br><span class="line">        <span class="comment">// Instrument free() to print the input argument value.</span></span><br><span class="line">        RTN_InsertCall(freeRtn, IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, FREE,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_Close(freeRtn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TraceFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line">   </span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool produces a trace of calls to malloc."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize pin &amp; symbol manager</span></span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>( PIN_Init(argc,argv) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Usage();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    TraceFile.<span class="built_in">open</span>(KnobOutputFile.Value().c_str());</span><br><span class="line">    TraceFile &lt;&lt; hex;</span><br><span class="line">    TraceFile.setf(ios::showbase);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Register Image to be called to instrument functions.</span></span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* eof */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br></pre></td></tr></table></figure>

<h2 id="2-使用IMG-IsMainExecutable来判断是否对malloc的调用属于main"><a href="#2-使用IMG-IsMainExecutable来判断是否对malloc的调用属于main" class="headerlink" title="2. 使用IMG_IsMainExecutable来判断是否对malloc的调用属于main"></a>2. 使用IMG_IsMainExecutable来判断是否对malloc的调用属于main</h2><p>将有谁调用<code>malloc()</code>函数的信息添加到回调函数中，最简单的方法是将<code>IARG_RETURN_IP</code>添加到<code>RTN_InsertCall()</code>的调用中，并相应地更改函数<code>Arg1Before</code>。在<code>Arg1Before</code>中对<code>ret_addr</code>使用<code>IMG_IsMainExecutable(IMG_FindByAddress(ret_addr))</code>进行判断，以查看此调用是否来自<code>main</code>可执行文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Arg1Before</span><span class="params">(CHAR * name, ADDRINT <span class="built_in">size</span>, ADDRINT ret_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ret_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="keyword">if</span> (IMG_IsMainExecutable(img))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"IMG_Name: %s\n"</span>, IMG_Name(img).c_str());</span><br><span class="line">            TraceFile &lt;&lt; name &lt;&lt; <span class="string">"("</span> &lt;&lt; <span class="built_in">size</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"malloc's ret_addr: 0x%x\n"</span>, ret_addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-获取函数的多个参数"><a href="#3-获取函数的多个参数" class="headerlink" title="3. 获取函数的多个参数"></a>3. 获取函数的多个参数</h2><p>假设需要获取下面函数的多个参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">funcA</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Actual: %i %i %i\n"</span>, a,b,c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">funcHandler</span><span class="params">(CHAR* name, <span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"Pin: %s %i %i %i\n"</span>, name, a, b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span> </span>&#123;</span><br><span class="line">    RTN funcRtn = RTN_FindByName(img, <span class="string">"funcA"</span>);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(funcRtn)) &#123;</span><br><span class="line">        RTN_Open(funcRtn);</span><br><span class="line">				RTN_InsertCall(funcRtn, IPOINT_BEFORE, (AFUNPTR)funcHandler, </span><br><span class="line">    									IARG_ADDRINT, <span class="string">"funcA"</span>, </span><br><span class="line">                      IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>，IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">1</span>,</span><br><span class="line">    									IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">2</span>, IARG_END);</span><br><span class="line">        RTN_Close(funcRtn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在获取第0个参数之后，再添加几个带有1和2的<code>IARG_FUNCARG_ENTRYPOINT_VALUE</code>以获取第1和第2个参数。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://stackoverflow.com/questions/7896581/intel-pin-rtn-insertcall-multiple-function-arguments" target="_blank" rel="noopener">https://stackoverflow.com/questions/7896581/intel-pin-rtn-insertcall-multiple-function-arguments</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/14/INS_Address()%20%E5%92%8C%20IARG_INST_PTR%20%E7%9A%84%E4%B8%8D%E5%90%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/14/INS_Address()%20%E5%92%8C%20IARG_INST_PTR%20%E7%9A%84%E4%B8%8D%E5%90%8C/" itemprop="url">INS_Address()和IARG_INST_PTR的不同</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-14T17:35:45+08:00">
                2020-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、INS-Address-和-IARG-INST-PTR-的地址可能不一样"><a href="#一、INS-Address-和-IARG-INST-PTR-的地址可能不一样" class="headerlink" title="一、INS_Address() 和 IARG_INST_PTR 的地址可能不一样"></a>一、INS_Address() 和 IARG_INST_PTR 的地址可能不一样</h2><p>INS_Address（ins）：在<code>image</code>加载的时加载到当前指令时，打印该指令的地址</p>
<p>IARG_INST_PTR：执行指令时给出指令的地址。<code>image</code>的重定位在运行时发生，因此地址可能不同。</p>
<h2 id="二、同样的代码静态编译、动态编译，执行的地址不一样"><a href="#二、同样的代码静态编译、动态编译，执行的地址不一样" class="headerlink" title="二、同样的代码静态编译、动态编译，执行的地址不一样"></a>二、同样的代码静态编译、动态编译，执行的地址不一样</h2><p>由于动态链接程序不会直接以二进制开始执行：在控制权转移到可执行文件main中的_start之前，前几千条指令在动态链接器（ld-linux）中执行。</p>
<p>动态链接的<code>hello</code>的执行地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# gcc -o hello hello.c -m32</span><br><span class="line">root@ubuntu:test# file hello</span><br><span class="line">hello: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU&#x2F;Linux 2.6.24, BuildID[sha1]&#x3D;141cdcbf96da50c2e5b37f2f8b933a971d1a4f63, not stripped</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;itrace.so -- .&#x2F;hello</span><br><span class="line">Hello World!</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# head -10 itrace.out </span><br><span class="line">0xb76e8030</span><br><span class="line">0xb76e8032</span><br><span class="line">0xb76e86a0</span><br><span class="line">0xb76e86a1</span><br><span class="line">0xb76e86a3</span><br><span class="line">0xb76e86a4</span><br><span class="line">0xb76e86a5</span><br><span class="line">0xb76e86a6</span><br><span class="line">0xb76e86a9</span><br><span class="line">0xb76ff978</span><br></pre></td></tr></table></figure>

<p>静态链接的<code>hello</code>的执行地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# gcc -o hello hello.c -m32 -static</span><br><span class="line">root@ubuntu:test# file hello</span><br><span class="line">hello: ELF 32-bit LSB  executable, Intel 80386, version 1 (GNU&#x2F;Linux), statically linked, for GNU&#x2F;Linux 2.6.24, BuildID[sha1]&#x3D;800af8cbd98ee14dfc12aa4264dcc80e4727b333, not stripped</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;itrace.so -- .&#x2F;hello</span><br><span class="line">Hello World!</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# head -10 itrace.out </span><br><span class="line">0x8048d2a</span><br><span class="line">0x8048d2c</span><br><span class="line">0x8048d2d</span><br><span class="line">0x8048d2f</span><br><span class="line">0x8048d32</span><br><span class="line">0x8048d33</span><br><span class="line">0x8048d34</span><br><span class="line">0x8048d35</span><br><span class="line">0x8048d3a</span><br><span class="line">0x8048d3f</span><br></pre></td></tr></table></figure>

<p>动态链接的程序在运行时的步骤是：</p>
<ol>
<li><p>内核创建一个新进程“ shell”，并将可执行文件映射到其中。</p>
</li>
<li><p>内核观察到该可执行文件具有<code>PT_INTERP</code>段，并将其中引用的文件映射到进程中。此处，<code>PT_INTERP</code>的内容是<code>/lib64/ld-linux-x86-64.so.2</code>，又名动态加载程序，不要与<code>/usr/bin/ld</code>（又名静态链接器）混淆。此外，因为需要程序解释器，所以内核将控制权转移给它（而不是main文件中的_start，因为main文件尚未准备好运行）。</p>
</li>
<li><p>当<code>ld-linux</code>开始运行时，它会首先对自己重定位，然后映射main文件链接到的所有库。可以使用<code>readelf -d a.out |grep NEEDED</code>查看这些库。</p>
<p>注意：由于这些库中的每个库本身可能直接依赖于其他库，因此将以递归方式重复此过程。</p>
</li>
<li><p>库被初始化（通过调用其构造函数，该函数通常称为<em>init，但也可以具有不同的名称）</em></p>
</li>
<li><p>加载并初始化所有库后，<code>ld-linux</code>最终调用_start，最终将调用main。</p>
</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://stackoverflow.com/questions/62050627/pin-tool-the-static-ins-address-ins-addressins-is-different-from-the-address" target="_blank" rel="noopener">https://stackoverflow.com/questions/62050627/pin-tool-the-static-ins-address-ins-addressins-is-different-from-the-address</a></li>
<li><a href="https://stackoverflow.com/questions/62125651/instruction-point-value-of-dynamic-linking-and-static-linking" target="_blank" rel="noopener">https://stackoverflow.com/questions/62125651/instruction-point-value-of-dynamic-linking-and-static-linking</a></li>
<li><a href="https://stackoverflow.com/questions/61789860/how-to-set-breakpoint-on-entry-of-dynamically-opened-shared-library/61790355#61790355" target="_blank" rel="noopener">https://stackoverflow.com/questions/61789860/how-to-set-breakpoint-on-entry-of-dynamically-opened-shared-library/61790355#61790355</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/14/Instruction-Address-Trace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/14/Instruction-Address-Trace/" itemprop="url">二、Instruction Address Trace (Instruction Instrumentation)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-14T16:59:23+08:00">
                2020-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Instruction-Address-Trace-Instruction-Instrumentation"><a href="#Instruction-Address-Trace-Instruction-Instrumentation" class="headerlink" title="Instruction Address Trace (Instruction Instrumentation)"></a>Instruction Address Trace (Instruction Instrumentation)</h2><p>在上一个例子中，我们没有给分析函数<code>docount</code>传递任何参数。在本例中，将展示如何进行参数传递。当调用分析函数时候，Pin允许传入指令指针、当前寄存器的值、内存操作的有效地址、常量等。具体可见<a href="https://software.intel.com/sites/landingpage/pintool/docs/98223/Pin/html/group__INST__ARGS.html#ga089c27ca15e9ff139dd3a3f8a6f8451d" target="_blank" rel="noopener">IARG_TYPE</a>。</p>
<p>在之前的例子上稍作改动，我们将指令计数的例子转化为打印每条执行过的指令地址的Pintool。这有助于调试时理解程序的控制流，或益于模拟指令缓存时的处理器设计中。</p>
<p>我们改变函数<code>INS_InsertCall</code>的参数，将被执行过的指令的地址作为参数。将<code>docount</code>替换为<code>printip</code>，打印指令的地址。将输出写入文件<code>itrace.out</code>中。</p>
<p>首先进行编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cd source&#x2F;tools&#x2F;ManualExamples</span><br><span class="line"></span><br><span class="line"># make obj-ia32&#x2F;itrace.so TARGET&#x3D;ia32</span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER&#x3D;1 -Wall -Werror -Wno-unknown-pragmas -fno-stack-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;gen -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;components&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;tools&#x2F;InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32&#x2F;itrace.o itrace.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style&#x3D;sysv -Wl,-Bsymbolic -Wl,--version-script&#x3D;..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;pintool.ver    -o obj-ia32&#x2F;itrace.so obj-ia32&#x2F;itrace.o  -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib-ext -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;runtime&#x2F;glibc -L..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;lib -lpin -lxed -ldwarf -lelf -ldl</span><br></pre></td></tr></table></figure>

<p>下面是如何运行它并显示它的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;itrace.so -- &#x2F;bin&#x2F;ls</span><br><span class="line">2comp  hello.txt  inscount0.log  inscount.out  itrace.out  pinatrace.out  pin.log  tmp_res.out</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# head -10 itrace.out </span><br><span class="line">0x804c041</span><br><span class="line">0x804c043</span><br><span class="line">0x804c044</span><br><span class="line">0x804c046</span><br><span class="line">0x804c049</span><br><span class="line">0x804c04a</span><br><span class="line">0x804c04b</span><br><span class="line">0x804c04c</span><br><span class="line">0x804c051</span><br><span class="line">0x804c056</span><br></pre></td></tr></table></figure>

<p>Pintool 运行在 32 位系统上，发现打印出很多以 0xb 开头的指令地址，所以加了判断，限定仅分析二进制属于范围：0x8048000 - 0x8800000 中的指令，结果如上所示。</p>
<p>本例的源码在<code>source/tools/ManualExamples/itrace.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line">FILE * trace;</span><br><span class="line"><span class="comment">// This function is called before every instruction is executed</span></span><br><span class="line"><span class="comment">// and prints the IP</span></span><br><span class="line"><span class="function">VOID <span class="title">printip</span><span class="params">(VOID *ip)</span> </span>&#123; <span class="built_in">fprintf</span>(trace, <span class="string">"%p\n"</span>, ip); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin calls this function every time a new instruction is encountered</span></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Insert a call to printip before every instruction, and pass it the IP</span></span><br><span class="line">  	<span class="comment">// IARG_INST_PTR：被插桩指令的地址</span></span><br><span class="line">    <span class="comment">// INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)printip, IARG_INST_PTR, IARG_END);</span></span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">if</span> (INS_Address(ins) &gt; <span class="number">0x8048000</span> &amp;&amp; INS_Address(ins) &lt; <span class="number">0x8800000</span>)&#123;</span><br><span class="line">        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)printip, IARG_INST_PTR, IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(trace, <span class="string">"#eof\n"</span>);</span><br><span class="line">    fclose(trace);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_ERROR(<span class="string">"This Pintool prints the IPs of every instruction executed\n"</span> </span><br><span class="line">              + KNOB_BASE::StringKnobSummary() + <span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    trace = fopen(<span class="string">"itrace.out"</span>, <span class="string">"w"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本例使用的API：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INS_Address（INS ins）</span><br><span class="line">返回值：指令的地址</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/14/Simple-Instruction-Count/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/14/Simple-Instruction-Count/" itemprop="url">一、Simple Instruction Count (Instruction Instrumentation)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-14T16:58:05+08:00">
                2020-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Simple-Instruction-Count-Instruction-Instrumentation"><a href="#Simple-Instruction-Count-Instruction-Instrumentation" class="headerlink" title="Simple Instruction Count (Instruction Instrumentation)"></a>Simple Instruction Count (Instruction Instrumentation)</h2><p><strong>动态插桩基本流程：</strong>  </p>
<p>动态插桩(Dynamic Instrumentation)就是在程序运行中对其插入一定分析代码，主要流程包含两个部分：</p>
<ul>
<li>确定插桩代码插入的位置和插入的代码</li>
<li>确定在插入点需要执行的分析代码</li>
</ul>
<p>这两个组件是 instrumentation 代码和 analysis 代码。 这两个组件都位于一个可执行文件Pintool中。 Pintools可以看作是可以修改Pin内部代码生成过程的插件。</p>
<p>Pintool会在需要生成新代码的情况下调用Pin来注册 instrumentation 回调函数。 该 instrumentation 回调函数表示 instrumentation 组件。 它检查要生成的代码，提取其静态属性，并确定是否以及在何处插入 analysis 函数。</p>
<p>analysis 函数会收集有关应用程序的数据。 Pin 确保整数和浮点寄存器的状态在必要时得以保存和恢复，并允许将参数传递给函数。</p>
<p>Pintool还可以为诸如线程创建或派生之类的事件注册回调函数。 这些回调函数通常用于收集数据或工具初始化或清理。</p>
<p>编写 Pintool 时，调整 analysis 代码比 instrumentation 代码更重要。 这是因为 instrumentation 仅执行一次，但是 analysis 代码却被多次调用。</p>
<p><strong>Pintool 包含的内容：</strong>  </p>
<p>Instrumentation routines：仅当事件第一次发生时被调用<br>Analysis routines：某对象每次被访问时都调用<br>Callbacks routines：无论何时当特定事件发生时都调用</p>
<p>当尚未重新编译的代码将要被执行时，将调用 Instrumentation routines，并允许插入 Analysis routines。当运行与 Analysis routines 相关的代码时，将调用这些 Analysis routines。 仅当满足特定条件或发生特定事件时，才调用 Callbacks routines。 Pin提供了广泛的应用程序编程接口（API），可用于从对单条指令到整个二进制模块的不同抽象级别的插桩。它还支持许多事件的回调 Callbacks，例如库加载，系统调用，信号/异常和线程创建事件。</p>
<blockquote>
<ol>
<li><a href="https://en.wikipedia.org/wiki/Pin_(computer_program)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Pin_(computer_program)</a></li>
<li><a href="https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/" target="_blank" rel="noopener">https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/</a></li>
</ol>
</blockquote>
<p><strong>例子程序：</strong>  </p>
<p>下面的例子对程序进行插桩，统计其指令数目。在每一条指令前插入函数<code>docount</code>。当程序退出的时候，将<code>count</code>保存在文件<code>iscount.pout</code>中。</p>
<p>首先进行编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cd source&#x2F;tools&#x2F;ManualExamples</span><br><span class="line"></span><br><span class="line"># make obj-ia32&#x2F;inscount0.so TARGET&#x3D;ia32</span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER&#x3D;1 -Wall -Werror -Wno-unknown-pragmas -fno-stack-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;gen -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;components&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;tools&#x2F;InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32&#x2F;inscount0.o inscount0.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style&#x3D;sysv -Wl,-Bsymbolic -Wl,--version-script&#x3D;..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;pintool.ver    -o obj-ia32&#x2F;inscount0.so obj-ia32&#x2F;inscount0.o  -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib-ext -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;runtime&#x2F;glibc -L..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;lib -lpin -lxed -ldwarf -lelf -ldl</span><br><span class="line"></span><br><span class="line"># ls .&#x2F;obj-ia32&#x2F;</span><br><span class="line">inscount0.o  inscount0.so</span><br></pre></td></tr></table></figure>

<p>pin的使用方式为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pin [OPTION] [-t &lt;tool&gt; [&lt;toolargs&gt;]] -- &lt;command line&gt;</span><br></pre></td></tr></table></figure>

<p><code>-t</code>之后接 pintool 的so文件，之后接传递给pintool的参数，在–之后接需要进行分析的程序以及它的参数。</p>
<p>下面是如何运行它并显示它的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;inscount0.so -- &#x2F;bin&#x2F;ls</span><br><span class="line">2comp  hello.txt  inscount.out	pinatrace.out  pin.log	tmp_res.out</span><br><span class="line"></span><br><span class="line"># cat inscount.out </span><br><span class="line">Count 454790</span><br></pre></td></tr></table></figure>

<p><code>KNOB</code>可以覆盖默认的输出文件的名字，在命令行中增加<code>-o &lt;file_name&gt;</code>即可使用。工具的命令行选项应当插入在<code>pintool_name</code>和<code>--</code>之间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;inscount0.so -o inscount0.log -- &#x2F;bin&#x2F;ls</span><br><span class="line">2comp  hello.txt  inscount0.log  inscount.out  pinatrace.out  pin.log  tmp_res.out</span><br><span class="line"></span><br><span class="line"># cat inscount0.log </span><br><span class="line">Count 463404</span><br></pre></td></tr></table></figure>

<p>本例的源码在<code>source/tools/ManualExamples/inscount0.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"></span><br><span class="line">ofstream OutFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The running count of instructions is kept here</span></span><br><span class="line"><span class="comment">// make it static to help the compiler optimize docount</span></span><br><span class="line"><span class="keyword">static</span> UINT64 icount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called before every instruction is executed </span></span><br><span class="line"><span class="comment">// 每一条指令被执行前调用此函数</span></span><br><span class="line"><span class="function">VOID <span class="title">docount</span><span class="params">()</span> </span>&#123; icount++; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin calls this function every time a new instruction is encountered </span></span><br><span class="line"><span class="comment">// 每当遇到新的指令时调用此函数</span></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Insert a call to docount before every instruction, no arguments are passed</span></span><br><span class="line">    INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)docount, IARG_END);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;<span class="built_in">string</span>&gt; <span class="title">KnobOutputFile</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"o"</span>, <span class="string">"inscount.out"</span>, <span class="string">"specify output file name"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    OutFile.setf(ios::showbase);</span><br><span class="line">    OutFile &lt;&lt; <span class="string">"Count "</span> &lt;&lt; icount &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    OutFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool counts the number of dynamic instructions executed"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/*   argc, argv are the entire command line: pin -t &lt;toolname&gt; -- ...    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line"></span><br><span class="line">    OutFile.<span class="built_in">open</span>(KnobOutputFile.Value().c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">    <span class="comment">// 对指令进行插桩</span></span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    <span class="comment">// 程序退出时的回调函数</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子程序给出了一般pintool的基本框架，在main函数中首先调用函数<code>PIN_Init</code>初始化，之后就可以使用<code>INS_AddInstrumentFunction</code>注册一个插桩函数，当原始程序执行到一条新的指令时，都会执行函数<code>Instruction</code>，其第2个参数为一个额外传递给<code>Instruction</code>的参数，即对应<code>VOID *v</code>这个参数，这里没有使用。而<code>Instruction</code>接受的第一个参数为<code>INS</code>，用来表示一条指令。</p>
<p>最后又注册了一个程序退出时的函数Fini，接着就可以使用PIN_StartProgram启动程序了。</p>
<p><strong>回调函数模式:</strong>  </p>
<p>可以看到，上面 inscount0.cpp 这个pintool插桩的对象就是所有指令。pintool在编写中将比较多的使用回调函数的机制，譬如<code>每当遇见新的指令</code>时会调Instruction函数。而在Instruction函数的内部又使用INS_InsertCall注册了一个函数docount，意为在<code>每条指令执行之前</code>插入一个对docount函数的调用。</p>
<p>注意INS_InsertCall是一个变参函数，前3个参数分别为指令，插入的时机（这里IPOINT_BEFORE表示之前）以及函数指针（转为AFUNPTR类型），在之后就可以指定传给函数的参数，并以IARG_END结尾，这里没有指定参数，直接调用。而docount的作用即是将一个全局变量加1，以达到统计执行指令条数的目的。</p>
<p><strong>指令插桩的位置：</strong>  </p>
<p>最简单的情况是直接针对所有指令插桩，INS模块中提供了很多API来判断当前指令的类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INS_IsMemoryRead (INS ins)</span><br><span class="line">INS_IsMemoryWrite (INS ins)</span><br><span class="line">INS_IsLea (INS ins)</span><br><span class="line">INS_IsNop (INS ins)</span><br><span class="line">INS_IsBranch (INS ins)</span><br><span class="line">INS_IsDirectBranch (INS ins)</span><br><span class="line">INS_IsDirectCall (INS ins)</span><br><span class="line">INS_IsDirectBranchOrCall (INS ins)</span><br><span class="line">INS_IsBranchOrCall (INS ins)</span><br><span class="line">INS_IsCall (INS ins)</span><br><span class="line">INS_IsRet (INS ins)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>还有种更加直接、具体的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (INS_Opcode(ins) &#x3D;&#x3D; XED_ICLASS_MOV &amp;&amp;</span><br><span class="line">    INS_IsMemoryRead(ins) &amp;&amp;</span><br><span class="line">    INS_OperandIsReg(ins, 0) &amp;&amp;</span><br><span class="line">    INS_OperandIsMemory(ins, 1))</span><br></pre></td></tr></table></figure>

<p>上面的代码来自safecopy.cpp，直接通过Opcode来识别mov指令，并且是一条内存读指令，指令的第一个操作数是寄存器,第二个操作数是内存。通过组合这些API就可以非常精确地筛选出想要插桩的指令。</p>
<p>指令插桩的API:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">LEVEL_PINCLIENT::INS_InsertCall</span>	<span class="params">(	INS ins, IPOINT action, AFUNPTR funptr, ... )</span>		</span></span><br><span class="line">对于指令ins插入函数调用funptr。</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">ins			被插桩的指令</span><br><span class="line">action	特指 before, after等等</span><br><span class="line">				IPOINT_BEFORE 对所有指令永久有效</span><br><span class="line">				IPOINT_AFTER 仅当存在`fall-through`时才有效(i.e. call指令和无条件跳转指令将失败).</span><br><span class="line">				IPOINT_TAKEN_BRANCH 对非分支指令无效</span><br><span class="line">funptr	插入的函数</span><br><span class="line">...			传给函数 funptr 的参数列表，以 IARG_END 结束</span><br><span class="line">  </span><br><span class="line">若对同一指令插入了多个函数调用，那么函数调用的顺序取决于IARG_CALL_ORDER</span><br></pre></td></tr></table></figure>

<p><strong>插桩分析代码：</strong></p>
<p>inscount0中的分析代码写的非常简略，再之后还有一个例子itrace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; This function is called before every instruction is executed</span><br><span class="line">&#x2F;&#x2F; and prints the IP</span><br><span class="line">VOID printip(VOID *ip) &#123; fprintf(trace, &quot;%p\n&quot;, ip); &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Pin calls this function every time a new instruction is encountered</span><br><span class="line">VOID Instruction(INS ins, VOID *v)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Insert a call to printip before every instruction, and pass it the IP</span><br><span class="line">    INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)printip, IARG_INST_PTR, IARG_END);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里传递给printip的是一个IARG_INST_PTR参数，实际对应的类型是VOID *，指示了当前指令的位置，而printip则是把它输出出来，所以itrace的作用即是输出所有指令的地址。</p>
<p>实际来说<code>Instrumentation arguments</code>中给出了很多可以传递给回调函数的参数，包括当前指令读取的有效内存地址、相关寄存器的值等等，能够对程序的运行状态有很全面的描述，便于回调函数的进一步分析。</p>
<p><strong>程序运行状态监控 &amp; 修改:</strong><br><strong>寄存器:</strong>  </p>
<p>想要获得当前某个寄存器的值，可以传递<code>...IARG_REG_VALUE</code>, <code>REG_RAX...</code>参数，实际对应的类型是ADDRINT，将寄存器当前的值传给回调函数。或者可以通过INS_OperandReg函数首先提取出指令中的寄存器操作数，然后再用IARG_REG_VALUE传递给回调函数。</p>
<p>想要修改寄存器的值，可以传递…IARG_REG_REFERENCE, REG_RAX…这种参数，实际对应的类型是PIN_REGISTER *指针，指向一个表示寄存器值的union类型，在64位中，可以使用reg-&gt;qword[0]来访问RAX，reg-&gt;dword[0]来访问EAX，以达到修改寄存器值的目的。</p>
<p><strong>内存:</strong>  </p>
<p>关于内存数据的获取和写入，可以参考safecopy，其中使用到了PIN_SafeCopy函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F;  Analysis routines</span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Move from memory to register</span><br><span class="line">ADDRINT DoLoad(REG reg, ADDRINT * addr)</span><br><span class="line">&#123;</span><br><span class="line">    *out &lt;&lt; &quot;Emulate loading from addr &quot; &lt;&lt; addr &lt;&lt; &quot; to &quot; &lt;&lt; REG_StringShort(reg) &lt;&lt; endl;</span><br><span class="line">    ADDRINT value;</span><br><span class="line">    PIN_SafeCopy(&amp;value, addr, sizeof(ADDRINT));</span><br><span class="line">    return value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F; Instrumentation routines</span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">VOID EmulateLoad(INS ins, VOID* v)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Find the instructions that move a value from memory to a register</span><br><span class="line">    if (INS_Opcode(ins) &#x3D;&#x3D; XED_ICLASS_MOV &amp;&amp;</span><br><span class="line">        INS_IsMemoryRead(ins) &amp;&amp;</span><br><span class="line">        INS_OperandIsReg(ins, 0) &amp;&amp;</span><br><span class="line">        INS_OperandIsMemory(ins, 1))</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; op0 &lt;- *op1</span><br><span class="line">        INS_InsertCall(ins,</span><br><span class="line">                       IPOINT_BEFORE,</span><br><span class="line">                       AFUNPTR(DoLoad),</span><br><span class="line">                       IARG_UINT32, REG(INS_OperandReg(ins, 0)),</span><br><span class="line">                       IARG_MEMORYREAD_EA,</span><br><span class="line">                       IARG_RETURN_REGS, INS_OperandReg(ins, 0),</span><br><span class="line">                       IARG_END);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Delete the instruction</span><br><span class="line">        INS_Delete(ins);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>safecopy实际模拟了mov指令内存读的过程，将寄存器和指令操作的内存地址传递给分析函数DoLoad，并在最后用IARG_RETURN_REGS指定将分析函数的返回值写入到指令的操作寄存器中，实际指令的语义没有改变。</p>
<p>而在DoLoad函数中，实际调用了PIN_SafeCopy(&amp;value, addr, sizeof(ADDRINT));将对应地址的内容模拟装载并返回。由此就可以看出在程序实际运行时pintool和原始程序位于同一地址空间，因而PIN_SafeCopy既可以从内存中读取数据，亦可以写入数据。</p>
<p><strong>更粗粒度的插桩:</strong>  </p>
<p>有时我们并不需要在指令级的插桩，pin也可以实现基于Basic Block，Routine或Image的插桩函数，以例子中的malloctrace来说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">VOID Image(IMG img, VOID *v)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Instrument the malloc() and free() functions.  Print the input argument</span><br><span class="line">    &#x2F;&#x2F; of each malloc() or free(), and the return value of malloc().</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F;  Find the malloc() function.</span><br><span class="line">    RTN mallocRtn &#x3D; RTN_FindByName(img, MALLOC);</span><br><span class="line">    if (RTN_Valid(mallocRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(mallocRtn);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Instrument malloc() to print the input argument value and the return value.</span><br><span class="line">        RTN_InsertCall(mallocRtn, </span><br><span class="line">                       IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, MALLOC,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, 0,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_InsertCall(mallocRtn, </span><br><span class="line">                       IPOINT_AFTER, (AFUNPTR)MallocAfter,</span><br><span class="line">                       IARG_FUNCRET_EXITPOINT_VALUE, </span><br><span class="line">                       IARG_END);</span><br><span class="line"></span><br><span class="line">        RTN_Close(mallocRtn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Find the free() function.</span><br><span class="line">    RTN freeRtn &#x3D; RTN_FindByName(img, FREE);</span><br><span class="line">    if (RTN_Valid(freeRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(freeRtn);</span><br><span class="line">        &#x2F;&#x2F; Instrument free() to print the input argument value.</span><br><span class="line">        RTN_InsertCall(freeRtn, </span><br><span class="line">                       IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, FREE,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, 0,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_Close(freeRtn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>使用 IMG_AddInstrumentFunction 来注册一个在Image载入时插桩的函数，随后在Image里面使用RTN_FindByName来找到模块里的malloc和free两个符号，注意在pintool开头除了PIN_Init之外还要用PIN_InitSymbols来初始化symbol manager。在找到相应的函数之后，可以使用RTN_InsertCall来插入分析代码Arg1Before，并将此时函数的参数传递给分析函数。最后这个pintool完成的作用就是追踪malloc/free的调用，并输出它们的参数与返回值。</p>
<blockquote>
<ol>
<li><a href="http://brieflyx.me/2017/binary-analysis/intel-pin-intro/" target="_blank" rel="noopener">http://brieflyx.me/2017/binary-analysis/intel-pin-intro/</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/11/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/11/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/" itemprop="url">Hexo博客中图片显示问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-11T12:17:16+08:00">
                2020-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo博客搭建</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hexo 提供了一种更方便管理 Asset 的设定：post_asset_folder 当您设置 post_asset_folder 为true参数后，在建立文件时，Hexo会自动建立一个与文章同名的文件夹，您可以把与该文章相关的所有资源都放到那个文件夹。</p>
<h2 id="修改博客配置"><a href="#修改博客配置" class="headerlink" title="修改博客配置"></a>修改博客配置</h2><p>修改博客根目录中<code>_config.yml</code>文件的配置项<code>post_asset_folder</code>为<code>true</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true</span><br></pre></td></tr></table></figure>

<p>完成此设置后，当你通过<code>hexo new 文件名</code>新建博客后，会产生一个和文件同名的文件夹。</p>
<p><img src="/2020/07/11/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/image-20200711122009203.png" alt="image-20200711122009203"></p>
<h2 id="下载插件"><a href="#下载插件" class="headerlink" title="下载插件"></a>下载插件</h2><p>在博客根目录中下使用npm安装插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install https:&#x2F;&#x2F;github.com&#x2F;CodeFalling&#x2F;hexo-asset-image --save</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>当文章需要添加图片时，将需要添加的图片放入同名的文件夹中，同时通过相对路径索引到该图片。</p>
<p>例如我在上方修改博客配置中展示的那张图片的md源码为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![image-20200711122009203](.&#x2F;Hexo博客中图片显示问题&#x2F;image-20200711122009203.png)</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://blog.csdn.net/DreamHome_S/article/details/90142578" target="_blank" rel="noopener">https://blog.csdn.net/DreamHome_S/article/details/90142578</a></li>
<li><a href="https://www.jianshu.com/p/ea78bdd0551f" target="_blank" rel="noopener">https://www.jianshu.com/p/ea78bdd0551f</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/" itemprop="url">MacOS 配置 LaTeX（MacTeX + VSCode + Skim）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-11T11:33:09+08:00">
                2020-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Latex/" itemprop="url" rel="index">
                    <span itemprop="name">Latex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、安装准备"><a href="#一、安装准备" class="headerlink" title="一、安装准备"></a>一、安装准备</h2><h3 id="1-安装-MacTeX"><a href="#1-安装-MacTeX" class="headerlink" title="1 安装 MacTeX"></a>1 安装 MacTeX</h3><p>从 <a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.tug.org%2Fmactex%2Fmactex-download.html" target="_blank" rel="noopener">Downloading MacTeX 2019 </a>中下载最新版本的 MacTeX 并安装。</p>
<h3 id="2-安装-VSCode-及相关插件"><a href="#2-安装-VSCode-及相关插件" class="headerlink" title="2 安装 VSCode 及相关插件"></a>2 安装 VSCode 及相关插件</h3><p>从 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fcode.visualstudio.com%2Fdownload" target="_blank" rel="noopener">Download Visual Studio Code</a> 中下载最新版本的 VSCode 并安装。打开 VSCode，在 <code>Extensions</code> 搜索框中输入 LaTeX, 选择 <code>LaTeX WorkShop</code> 插件并安装。本次测试VSCode版本信息：<code>Version: 1.47.0-insider</code></p>
<h2 id="二、LaTeX-WorkShop-插件配置中文环境"><a href="#二、LaTeX-WorkShop-插件配置中文环境" class="headerlink" title="二、LaTeX WorkShop 插件配置中文环境"></a>二、LaTeX WorkShop 插件配置中文环境</h2><p>LaTeX WorkShop 插件默认只提供<code>PDFLaTeX</code>，而中文编译需要<code>XeFLaTeX</code>，所以还需另行配置。进入 Settings 的 JSON 文件，加入以下配置：</p>
<ol>
<li><p>在latex-workshop.latex.tools配置中，增加xelatex项，具体如下。这一项的作用是在工具集中定义xelatex项，以便下一项配置能找到。在setting搜索框中搜索<code>latex-workshop.latex.tools</code>，打开进行编辑</p>
<p><img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711114101327.png" alt="image-20200711114101327"></p>
<p>增加的内容为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">    <span class="attr">"command"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: [</span><br><span class="line">        <span class="string">"-synctex=1"</span>,</span><br><span class="line">        <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">        <span class="string">"-file-line-error"</span>,</span><br><span class="line">        <span class="string">"-pdf"</span>,</span><br><span class="line">        <span class="string">"%DOC%"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>在latex-workshop.latex.recipes配置中，将第一项的latexmk改为xelatex。这里定义的是编译时调用的工具顺序，默认第一个为latexmk，因为我们要支持中文，所以替换为xelatex。在setting搜索框中搜索<code>latex-workshop.latex.tools</code>，打开进行编辑：</p>
<p><img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711114358156.png" alt="image-20200711114358156"></p>
<p>增加的内容为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">    <span class="attr">"tools"</span>: [</span><br><span class="line">    		<span class="string">"xelatex"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改后的<code>settings.json</code>文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"editor.fontSize"</span>: <span class="number">13</span>,</span><br><span class="line">    <span class="attr">"workbench.startupEditor"</span>: <span class="string">"newUntitledFile"</span>,</span><br><span class="line">    <span class="attr">"editor.renderControlCharacters"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"files.autoSave"</span>: <span class="string">"off"</span>,</span><br><span class="line">    <span class="attr">"python.analysis.memory.keepLibraryLocalVariables"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"window.zoomLevel"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"latex-workshop.latex.tools"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"-pdf"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"-pdf"</span>,</span><br><span class="line">                <span class="string">"-outdir=%OUTDIR%"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"lualatexmk"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"-lualatex"</span>,</span><br><span class="line">                <span class="string">"-outdir=%OUTDIR%"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk_rconly"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"latexmk"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"pdflatex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"pdflatex"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-synctex=1"</span>,</span><br><span class="line">                <span class="string">"-interaction=nonstopmode"</span>,</span><br><span class="line">                <span class="string">"-file-line-error"</span>,</span><br><span class="line">                <span class="string">"%DOC%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"bibtex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"bibtex"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"%DOCFILE%"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"rnw2tex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"Rscript"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-e"</span>,</span><br><span class="line">                <span class="string">"knitr::opts_knit$set(concordance = TRUE); knitr::knit('%DOCFILE_EXT%')"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"jnw2tex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"julia"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-e"</span>,</span><br><span class="line">                <span class="string">"using Weave; weave(\"%DOC_EXT%\", doctype=\"tex\")"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"jnw2texmintex"</span>,</span><br><span class="line">            <span class="attr">"command"</span>: <span class="string">"julia"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [</span><br><span class="line">                <span class="string">"-e"</span>,</span><br><span class="line">                <span class="string">"using Weave; weave(\"%DOC_EXT%\", doctype=\"texminted\")"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"env"</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"latex-workshop.latex.recipes"</span>: [  </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"xelatex"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"xelatex"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk 🔃"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk (latexmkrc)"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"latexmk_rconly"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"latexmk (lualatex)"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"lualatexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"pdflatex ➞ bibtex ➞ pdflatex × 2"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"pdflatex"</span>,</span><br><span class="line">                <span class="string">"bibtex"</span>,</span><br><span class="line">                <span class="string">"pdflatex"</span>,</span><br><span class="line">                <span class="string">"pdflatex"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Compile Rnw files"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"rnw2tex"</span>,</span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Compile Jnw files"</span>,</span><br><span class="line">            <span class="attr">"tools"</span>: [</span><br><span class="line">                <span class="string">"jnw2tex"</span>,</span><br><span class="line">                <span class="string">"latexmk"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个.tex文件，编码为utf8，输入以下内容。保存，<code>option + command + B</code>编译，自动编译产生对应的pdf。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">\<span class="name">documentclass</span><span class="string">[UTF8]</span><span class="string">&#123;ctexart&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">title</span><span class="string">&#123;你好，world!&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">author</span><span class="string">&#123;李明&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">date</span><span class="string">&#123;\today&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">begin</span><span class="string">&#123;document&#125;</span></span></span><br><span class="line"><span class="tag">\<span class="name">maketitle</span></span></span><br><span class="line">你好，world!</span><br><span class="line"><span class="tag">\<span class="name">end</span><span class="string">&#123;document&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>得到的结果为：</p>
<p><img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711115109103.png" alt="image-20200711115109103"></p>
</li>
</ol>
<h2 id="三、配置VSCode与Skim的LaTeX正反跳转"><a href="#三、配置VSCode与Skim的LaTeX正反跳转" class="headerlink" title="三、配置VSCode与Skim的LaTeX正反跳转"></a>三、配置VSCode与Skim的LaTeX正反跳转</h2><ol>
<li>安装 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fskim-app.sourceforge.io%2F" target="_blank" rel="noopener">Skim</a> PDF 阅读器</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install skim</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>正向跳转</li>
</ol>
<p>正向跳转指的是从 .tex 源文件向编译生成的 PDF 文件的跳转。这部分我们主要需要寻找到合适的方式，在命令行状态打开 Skim 应用。</p>
<p>根据 Skim 官网的介绍，Skim 提供了名为 displayline 的脚本，用于和 TeX 正反同步协同工作。其脚本位于:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Skim.app&#x2F;Contents&#x2F;SharedSupport&#x2F;displayline</span><br></pre></td></tr></table></figure>

<p>具体用法是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Skim.app&#x2F;Contents&#x2F;SharedSupport&#x2F;displayline %line &quot;%pdffile&quot; &quot;%texfile&quot;</span><br></pre></td></tr></table></figure>

<p>此处 <strong><code>%line</code></strong> 表示 <strong><code>.tex</code></strong> 文件的行号，<strong><code>%pdffile</code></strong> 表示编译生成的 PDF 文件的完整路径，<strong><code>%texfile</code></strong>则是对应的 .tex 源文件。考虑到我们对反向搜索也有需求，按照官方文档，我们还需要加上<strong><code>-r</code></strong>参数。</p>
<p>因此，在 VSCode 的配置里，我们需要给出这样的 <strong><code>JSON 配置</code></strong>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">"latex-workshop.view.pdf.viewer": "external",</span><br><span class="line">"latex-workshop.view.pdf.external.synctex": &#123;</span><br><span class="line">    "command": "/Applications/Skim.app/Contents/SharedSupport/displayline",</span><br><span class="line">    "args": [</span><br><span class="line">        "-r",</span><br><span class="line">        "%LINE%",</span><br><span class="line">        "%PDF%",</span><br><span class="line">        <span class="string">"%TEX%"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><strong><code>LaTeX workshop</code></strong>插件的配置中，除了 <strong><code>latex-workshop.view.pdf.external.synctex</code></strong>，还有一项也和打开外部 PDF 浏览器有关。它是 <strong><code>latex-workshop.view.pdf.external.command</code></strong>，表示简单地打开 PDF 文件，而忽略正向搜索功能。<strong><code>Skim</code></strong>提供的命令行脚本默认不支持这样的操作，我们需要根据<strong><code>displayline</code></strong>脚本自行修改。</p>
<p><strong><code>displayline</code></strong>脚本调用了 <strong><code>Apple Script</code></strong> 来实现与 <strong><code>Skim.app</code></strong> 的交互，此处我们照葫芦画瓢，模拟一个即可。我们可以将如下脚本保存为 <strong><code>displayfile</code></strong> 并以 <strong><code>chmod u+x displayfile</code></strong> 使其变为可执行脚本，而后将其放在<strong><code>环境变量 PATH</code></strong> 包含的目录中，如：<code>/usr/local/bin</code>。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># displayfile (Skim)</span><br><span class="line">#</span><br><span class="line"># Usage: displayfile [-r] [-g] PDFFILE</span><br><span class="line">#</span><br><span class="line"># Modified from "displayline" to only revert the file, not jump to a given line</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">if [ $# == 0 -o "$1" == "-h" -o "$1" == "-help" ]; then</span><br><span class="line">  echo "Usage: displayfile [-r] [-g] PDFFILE</span><br><span class="line">Options:</span><br><span class="line">-r, -revert      Revert the file from disk if it was open</span><br><span class="line">-g, -background  Do not bring Skim to the foreground"</span><br><span class="line">  exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># get arguments</span><br><span class="line">revert=false</span><br><span class="line">activate=true</span><br><span class="line">while [ "$&#123;1:0:1&#125;" == "-" ]; do</span><br><span class="line">  if [ "$1" == "-r" -o "$1" == "-revert" ]; then</span><br><span class="line">    revert=true</span><br><span class="line">  elif [ "$1" == "-g" -o "$1" == "-background" ]; then</span><br><span class="line">    activate=false</span><br><span class="line">  fi</span><br><span class="line">  shift</span><br><span class="line">done</span><br><span class="line">file="$1"</span><br><span class="line">#shopt -s extglob</span><br><span class="line">#[ $# -gt 2 ] &amp;&amp; source="$3" || source="$&#123;file%.@(pdf|dvi|xdv)&#125;.tex"</span><br><span class="line"></span><br><span class="line"># expand relative paths</span><br><span class="line">[ "$&#123;file:0:1&#125;" == "/" ] || file="$&#123;PWD&#125;/$&#123;file&#125;"</span><br><span class="line"></span><br><span class="line"># pass file arguments as NULL-separated string to osascript</span><br><span class="line"># pass through cat to get them as raw bytes to preserve non-ASCII characters</span><br><span class="line">/usr/bin/osascript \</span><br><span class="line">  -e "set theFile to POSIX file \"$file\"" \</span><br><span class="line">  -e "set thePath to POSIX path of (theFile as alias)" \</span><br><span class="line">  -e "tell application \"Skim\"" \</span><br><span class="line">  -e "  if $activate then activate" \</span><br><span class="line">  -e "  if $revert then" \</span><br><span class="line">  -e "    try" \</span><br><span class="line">  -e "      set theDocs to get documents whose path is thePath" \</span><br><span class="line">  -e "      if (count of theDocs) &gt; 0 then revert theDocs" \</span><br><span class="line">  -e "    end try" \</span><br><span class="line">  -e "  end if" \</span><br><span class="line">  -e "  open theFile" \</span><br><span class="line">  -e "end tell"</span><br></pre></td></tr></table></figure>

<p>至此，需要更新 VSCode 的配置。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"latex-workshop.view.pdf.external.command": &#123;</span><br><span class="line">    "command": "displayfile",</span><br><span class="line">    "args": [</span><br><span class="line">        "-r",</span><br><span class="line">        <span class="string">"%PDF%"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><strong>配置完成后,可以从 TeX 源码跳转到 Skim 中对应的 PDF 文件位置(有圆点醒目位置提醒)，快捷键为: <code>option+command+j</code> ；</strong></p>
<h3 id="反向搜索"><a href="#反向搜索" class="headerlink" title="反向搜索"></a>反向搜索</h3><p>在反向搜索中，我们需要让 Skim 能够打开 VSCode，并将文件名和相应的行号正确地传给 VSCode。根据 Skim 官网的介绍，它只会从<strong><code>/usr/bin</code></strong>和 <strong><code>/usr/local/bin</code></strong> 中检索可执行程序。为此，我们需要将 VSCode 的可执行程序软链到这两个目录中的一个当中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf &#x2F;Applications&#x2F;Visual\ Studio\ Code.app&#x2F;Contents&#x2F;MacOS&#x2F;Electron &#x2F;usr&#x2F;local&#x2F;bin&#x2F;vscode</span><br></pre></td></tr></table></figure>

<p>至此，我们在命令行中执行 <strong><code>vscode -g &quot;%file&quot;:%line</code></strong> 即可打开 <strong><code>%file</code></strong> 文件并定位到第 <strong><code>%line</code></strong> 行。于是，我们只需要在 Skim 的同步配置中将预设改为「自定义」(必须改为自动以才可以使用后向跳转)，并将命令和参数分别设置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Command: vscode</span><br><span class="line">Arguments: -g &quot;%file&quot;:%line</span><br></pre></td></tr></table></figure>

<img src="/2020/07/11/MacOS%E4%B8%8B%E9%85%8D%E7%BD%AELatex/image-20200711115731991.png" alt="image-20200711115109103" style="zoom:50%;">

<p>如此即完成了配置。</p>
<p><strong>在 Skim 中跳转到TeX源码对应的位置的快捷键: <code>command + shift + click</code></strong></p>
<h2 id="四、vscode-配置-Latex-编译后自动清理多余文件-log-out等文件"><a href="#四、vscode-配置-Latex-编译后自动清理多余文件-log-out等文件" class="headerlink" title="四、vscode 配置 Latex 编译后自动清理多余文件(.log .out等文件)"></a>四、vscode 配置 Latex 编译后自动清理多余文件(.log .out等文件)</h2><p>在使用VSCode配置Latex时我们都会安装一个环境，就是：Latex Wordshop，在setting中是可以设置生成pdf后清理这些文件，但是版本不同的设置的方法也不同，因此：</p>
<p>新版VSCode中的setting配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">"latex-workshop.latex.autoClean.run": "onBuilt", //注意结尾是 t 不是 d</span><br><span class="line">"latex-workshop.latex.clean.fileTypes": [</span><br><span class="line">  "*.aux",</span><br><span class="line">  "*.bbl",</span><br><span class="line">  "*.blg",</span><br><span class="line">  "*.idx",</span><br><span class="line">  "*.ind",</span><br><span class="line">  "*.lof",</span><br><span class="line">  "*.lot",</span><br><span class="line">  "*.out",</span><br><span class="line">  "*.toc",</span><br><span class="line">  "*.acn",</span><br><span class="line">  "*.acr",</span><br><span class="line">  "*.alg",</span><br><span class="line">  "*.glg",</span><br><span class="line">  "*.glo",</span><br><span class="line">  "*.gls",</span><br><span class="line">  "*.ist",</span><br><span class="line">  "*.fls",</span><br><span class="line">  "*.log",</span><br><span class="line">  "*.fdb_latexmk",</span><br><span class="line">],</span><br></pre></td></tr></table></figure>


<p>一般来说建议保留.synctex.gz 文件，如果希望把这个文件也清理掉，可以在 latex-wordshop.latex.clean.fileTypes 中添加”*.gz”</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://www.jianshu.com/p/4aee83e66ab8" target="_blank" rel="noopener">https://www.jianshu.com/p/4aee83e66ab8</a></li>
<li><a href="https://www.jianshu.com/p/29adf0eadd30" target="_blank" rel="noopener">https://www.jianshu.com/p/29adf0eadd30</a></li>
<li><a href="https://liam.page/2018/04/24/Working-with-VSCode-on-macOS-configuration-LaTeX-workshop-and-Skim/" target="_blank" rel="noopener">https://liam.page/2018/04/24/Working-with-VSCode-on-macOS-configuration-LaTeX-workshop-and-Skim/</a></li>
<li><a href="https://blog.csdn.net/weixin_35757704/article/details/90597405" target="_blank" rel="noopener">https://blog.csdn.net/weixin_35757704/article/details/90597405</a></li>
</ol>
<h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>1.<a href="https://zhuanlan.zhihu.com/p/108095566" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/108095566</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/10/REX%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/10/REX%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B/" itemprop="url">REX漏洞利用流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-10T12:21:31+08:00">
                2020-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rex/" itemprop="url" rel="index">
                    <span itemprop="name">Rex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、crash分析"><a href="#一、crash分析" class="headerlink" title="一、crash分析"></a>一、crash分析</h2><h3 id="路径重现（收集trace）"><a href="#路径重现（收集trace）" class="headerlink" title="路径重现（收集trace）"></a>路径重现（收集trace）</h3><ol>
<li>利用QEMU具体化执行获取基本块执行序列：tarce</li>
<li>利用trace引导angr进行符号执行，收集路径约束，到达崩溃时记录崩溃的 State 和前一个 State</li>
</ol>
<h3 id="符号化内存写"><a href="#符号化内存写" class="headerlink" title="符号化内存写"></a>符号化内存写</h3><p>符号执行中收集所有可以符号化内存写的地址，为后面利用时布置shellcode做准备</p>
<h3 id="漏洞分类"><a href="#漏洞分类" class="headerlink" title="漏洞分类"></a>漏洞分类</h3><ol>
<li><p>ip 是否符号化，并根据可控的大小将漏洞分为 IP_OVERWRITE / PARTIAL_IP_OVERWRITE。</p>
</li>
<li><p>bp 是否符号化，并根据可控的大小将漏洞判定为 BP_OVERWRITE / PARTIAL_BP_OVERWRITE</p>
</li>
<li><p>检查崩溃时前一个 State，筛选出可以控制内存读、写目标地址的操作：</p>
<ul>
<li><p>如果符号化操作中有内存写，根据写的内容是否可控将漏洞判定为 WRITE_WHAT_WHERE / WRITE_X_WHERE 。</p>
</li>
<li><p>如果符号化操作中有内存读，将漏洞判定为 ARBITRARY_READ 。</p>
</li>
</ul>
</li>
</ol>
<h2 id="二、可利用性判断"><a href="#二、可利用性判断" class="headerlink" title="二、可利用性判断"></a>二、可利用性判断</h2><p>能被利用的漏洞类型有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exploitables &#x3D; [Vulnerability.IP_OVERWRITE, Vulnerability.PARTIAL_IP_OVERWRITE, Vulnerability.BP_OVERWRITE,</span><br><span class="line">            Vulnerability.PARTIAL_BP_OVERWRITE, Vulnerability.WRITE_WHAT_WHERE, Vulnerability.WRITE_X_WHERE]</span><br></pre></td></tr></table></figure>

<p>若崩溃时属于其中的类型则可以被利用，但是在REX现有的利用技术中，仅当满足<code>IP_OVERWRITE、PARTIAL_IP_OVERWRITE</code>时候，才可以进行利用。若漏洞类型是<code>WRITE_WHAT_WHERE、WRITE_X_WHERE、ARBITRARY_READ</code>，可以调用函数<code>explore</code>对当前漏洞再次进行探索，看最终能否控制<code>ip</code>。</p>
<h2 id="三、进行利用"><a href="#三、进行利用" class="headerlink" title="三、进行利用"></a>三、进行利用</h2><p>在Rex中，漏洞利用手段的父类是 Technique，每一种利用技术 technique 都是它的子类，需要对父类中 check、apply 这两个函数进行重写：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">check: 检查利用技术能否应用到 binary 上，主要是判断能否控制 ip（完全控制和部分控制）</span><br><span class="line">apply: 对崩溃时的 state 进行利用，成功则返回 Exploit 对象</span><br></pre></td></tr></table></figure>

<p>现有的支持 Linux 平台的利用技术：</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">限定漏洞类型</th>
<th align="left">其他条件</th>
<th align="left">平台</th>
</tr>
</thead>
<tbody><tr>
<td align="left">call_jmp_sp_shellcode</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">栈可执行</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">call_shellcode</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">栈可执行</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_register_control</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left"></td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_accept_system</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">存在 accept &amp; read函数</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_execl</td>
<td align="left">IP_OVERWRITE/ PARTIAL_IP_OVERWRITE</td>
<td align="left">存在 execl &amp; dup2 函数</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_system</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">存在 system 函数</td>
<td align="left">unix</td>
</tr>
<tr>
<td align="left">rop_to_system_complicated</td>
<td align="left">IP_OVERWRITE / PARTIAL_IP_OVERWRITE</td>
<td align="left">libc被加载 &amp; system 函数 &amp; plt</td>
<td align="left">unix</td>
</tr>
</tbody></table>
<p>进行利用时候可能需要实现的一些公共的功能：</p>
<ul>
<li><strong>_write_global_data() :</strong> 对我们能控制的内存进行约束求解，目的在于判断是否可以写入指定的内容，如：gadget</li>
<li><strong>_read_in_global_data()：</strong>若上述判断为True，则构建rop_chain将数据写到相应的地址：<ul>
<li><strong>_read_in_global_data_with_read(data)：</strong>调用read函数上传数据</li>
<li><strong>_read_in_global_data_with_gets(data)：</strong>调用gets函数上传数据</li>
</ul>
</li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://xz.aliyun.com/t/7179" target="_blank" rel="noopener">https://xz.aliyun.com/t/7179</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zyt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zyt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
