<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zyt">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Matrix</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matrix</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/30/%E7%9B%91%E6%8E%A7%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E7%89%B9%E5%AE%9A%E7%9A%84%E6%8C%87%E4%BB%A4%E6%97%B6%E6%89%80%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/30/%E7%9B%91%E6%8E%A7%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E7%89%B9%E5%AE%9A%E7%9A%84%E6%8C%87%E4%BB%A4%E6%97%B6%E6%89%80%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" itemprop="url">监控重复执行特定的指令时所遇到的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-30T15:38:50+08:00">
                2020-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="监控重复执行特定的指令时所遇到的问题"><a href="#监控重复执行特定的指令时所遇到的问题" class="headerlink" title="监控重复执行特定的指令时所遇到的问题"></a>监控重复执行特定的指令时所遇到的问题</h1><h2 id="一、Instrumentation-Granularity（插桩的粒度）"><a href="#一、Instrumentation-Granularity（插桩的粒度）" class="headerlink" title="一、Instrumentation Granularity（插桩的粒度）"></a>一、Instrumentation Granularity（插桩的粒度）</h2><p>Pin的插桩是采取及时编译的方式（JIT）。在第一次执行代码序列之前进行插桩，我们将这种操作称为 <em>trace instrumentation</em> 模式。</p>
<p><em>trace instrumention</em> 使得 Pintool 可以监控、插桩每一个 <code>tarce</code>。Trace 开始于一个分支的目标位置（target of a taken branch），结束于非条件跳转分支，包括 call 和 ret。Pin 保证 Trace 在顶部仅有一个入口，但是它可以有多个出口。如果一个分支跳转到一个 Trace 的中间，Pin 会从该分支跳转的目标位置开始构建出一个新的 Trace。Pin 将 trace 分为基本块序列，BBLs。一个 BBL 是一个指令序列，包含唯一的入口和出口。分支的跳转目标若属于一个 BBL，那么会产生一个新的 trace 和 BBL。通常可以为 BBL 插入一个分析函数，而不是为每个指令插入一个分析函数。减少分析函数调用的数量可以提高检测效率。<code>Trace instrumentation</code> 使用 API TRACE_AddInstrumentFunction API 来实现。</p>
<p>Trace的特征：</p>
<ul>
<li>起始：trace由一个branch的目标代码处起始</li>
<li>结束：遇到非条件的jmp指令，call指令，以及ret指令结束。</li>
</ul>
<p>因此trace可以包含jcc指令，代表着一个trace可以有多个出口，即trace中的代码可能会有多条执行路径，即手册中所说的“一个入口，多个出口”。trace会在实际执行中不断地划分，如果trace中包含了子trace，即有其他代码跳转到trace中的某个位置，这时需要细分trace。BBL是比trace再小一个级别的代码块，它符合“一个入口，一个出口”的特点。因此，我们可以在实际使用中，将BBL作为代码块的最小单位，以减少插桩的次数。</p>
<p>但是，由于Pin在执行程序时会动态发现程序的控制流，因此 Pin 的 BBL 可能不同于在编译原理中对于 BBL 的定义。例如，考虑下面switch 语句的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(i)&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>: total++;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>: total++;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>: total++;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>: total++;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">  <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 生成的指令可能如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.L7:</span><br><span class="line">        addl    $<span class="number">1</span>, <span class="number">-4</span>(%ebp)</span><br><span class="line">.L6:</span><br><span class="line">        addl    $<span class="number">1</span>, <span class="number">-4</span>(%ebp)</span><br><span class="line">.L5:</span><br><span class="line">        addl    $<span class="number">1</span>, <span class="number">-4</span>(%ebp)</span><br><span class="line">.L4:</span><br><span class="line">        addl    $<span class="number">1</span>, <span class="number">-4</span>(%ebp)</span><br></pre></td></tr></table></figure>

<p>上述代码对应的基本块可能为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/image-20200930121146144.png" alt></p>
<p>就经典基本块定义而言，每个addl指令都在单个基本块中。但是，由于 switch 会执行不同的情况，Pin会生成BBL，可能包含所有的四条指令（当 .L7 为入口时），包含三条指令（当 .L6 为入口时），等等。这意味着如果认为 Pin BBL与课本中的基本块相同，那么对 Pin 中BBL 进行计数就不太可能得到所期望的计数。例如，执行了分支 .L7，只会得到一个Pin BBL，但是实际上执行了四个经典的基本块。</p>
<p>当 Pin 遇到某些可能无法预料的指令时会“打碎”BBL。例如，cpuid，popf和REP前缀的指令会终止所有trace和BBL。由于REP前缀指令被视为隐式循环。因此，如果REP前缀指令多次迭代，则在第一条指令之后的迭代将导致生成一个单独的BBL，因此在这种情况下，将得到比预期更多的基本块。</p>
<p>为了方便 Pintool 的编写，Pin 还提供了一种指令插桩模式，该模式可使 Pintool 一次仅对一条可执行的指令进行检查和插桩。这本质上与trace instrumentation 相同。但是在 trace instrumentation中，Pintool 不必要迭代处理一个 trace 中的所有指令。如在  trace instrumentation 中所述，某些BBL及其内部的指令可能会多次生成（并因此被插桩）。指令插桩使用的 API 是 INS_AddInstrumentFunction。</p>
<p>但是，除了 trace 之外，对不同的粒度进行插桩可能会很有用。为此，Pin提供了两种附加模式：对 image 和 routine 进行插桩。这些模式是通过“缓存”插桩请求来实现的，因此会产生空间开销，这些模式也被称为  ahead-of-time instrumentation。</p>
<p>Image instrumentation 使 Pintool 在首次加载 image（IMG） 时对其进行检测和插桩。Pintool可以遍历 image 的 sections（SEC），section 的 routines（RTN），routine 的 instruction（INS）。插桩代码可以在执行 routines 之前或之后、在执行指令之前或之后被执行它。Image instrumentation 使用的 API 是 IMG_AddInstrumentFunction API。Image instrumentation 取决于符号信息来确定 routine 的边界，因此必须在 PIN_Init 之前调用 PIN_InitSymbol。</p>
<p>routine instrumentation 使得 Pintool 在 image 刚被加载的时候来检测、插桩一个完整的 routine。Pintool 可以遍历 routine 中的指令。目前没有足够的信息来将指令分解为BBL。插桩代码可以在执行 routine 之前或之后、在执行指令之前或之后被执行。如上一段所述，提供了 routine instrumentation 来检测程序，以便在对 Image 插桩时遍历 image 中的 sections 和 routines。Routine instrumentation 使用的 API 是 RTN_AddInstrumentFunction。在存在尾部调用或无法检测到返回指令的情况下，routine instrumentation 会退出。</p>
<p>请注意，在对 Image和Routine 的插桩中，不可能知道 routine 是否会被实际执行（因为这些插桩代码是在 image 加载时完成的）。通过标识作为 routine 开始的指令，可以仅跟踪在Trace或Instruction工具例程中执行的例程的指令。请参阅工具Tests / parse_executed_rtns.cpp。</p>
<h2 id="二、四种粒度的插桩"><a href="#二、四种粒度的插桩" class="headerlink" title="二、四种粒度的插桩"></a>二、四种粒度的插桩</h2><ol>
<li>IMG 粒度的插桩：Pintool 在首次加载 image（IMG） 时对其进行检测和插桩（主要的 main 程序、库函数的加载）</li>
<li>RTN 粒度的插桩：检测、插桩一个完整的 routine</li>
<li>TRACE 粒度的插桩：Trace是BBL的一个进阶概念（基本块：单个入口，单个出口的指令序列）。可将 TRACE 从头到尾视为 BBL 的序列，如下所示：</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20200930145327.png" style="zoom:50%;">

<ol start="4">
<li>INS 粒度的插桩：对每条指令进行检测</li>
</ol>
<h2 id="三、例子"><a href="#三、例子" class="headerlink" title="三、例子"></a>三、例子</h2><h3 id="目标程序源代码："><a href="#目标程序源代码：" class="headerlink" title="目标程序源代码："></a>目标程序源代码：</h3><p>应用场景：使用 PIN 来做污点分析，目标程序读取数据的方式是使用 getc() 函数，每次从打开的文件中读取一个字节，为了将读取的数据标记为污点源，可行的方法是截取到 call getc 指令结束后将返回值从 eax 移动到目标地址的指令：mov   BYTE PTR [ebp-0xd], al。将目标地址内的值污点化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">parse_getc</span><span class="params">(FILE *fd)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span> ch;</span><br><span class="line">        <span class="keyword">while</span>((ch = getc(fd)) != EOF)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"char is %d\n"</span>, ch);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"location is %d\n"</span>, ftell(fd));</span><br><span class="line">                sum += (<span class="keyword">int</span>)ch;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        FILE *fd = fopen(<span class="string">"./PoC"</span>, <span class="string">"r"</span>);</span><br><span class="line">        <span class="keyword">int</span> sum = parse_getc(fd);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"sum is %d\n"</span>, sum);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述程序是利用 getc() 函数重复的从文件中读取一个字符。其中，函数 parse_getc 对应的汇编代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">080484</span>cd &lt;parse_getc&gt;:</span><br><span class="line"> <span class="number">80484</span>cd:	<span class="number">55</span>                   	push   ebp</span><br><span class="line"> <span class="number">80484</span>ce:	<span class="number">89</span> e5                	mov    ebp,esp</span><br><span class="line"> <span class="number">80484</span>d0:	<span class="number">83</span> ec <span class="number">28</span>             	sub    esp,<span class="number">0x28</span></span><br><span class="line"> <span class="number">80484</span>d3:	c7 <span class="number">45</span> f4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    DWORD PTR [ebp<span class="number">-0xc</span>],<span class="number">0x0</span></span><br><span class="line"> <span class="number">80484</span>da:	eb <span class="number">36</span>                	jmp    <span class="number">8048512</span> &lt;parse_getc+<span class="number">0x45</span>&gt;</span><br><span class="line"> <span class="number">80484</span>dc:	<span class="number">0f</span> be <span class="number">45</span> f3          	movsx  eax,BYTE PTR [ebp<span class="number">-0xd</span>]</span><br><span class="line"> ......</span><br><span class="line"> <span class="number">8048515</span>:	<span class="number">89</span> <span class="number">04</span> <span class="number">24</span>             	mov    DWORD PTR [esp],eax</span><br><span class="line"> <span class="number">8048518</span>:	e8 <span class="number">63</span> fe ff ff       	call   <span class="number">8048380</span> &lt;_IO_getc@plt&gt;</span><br><span class="line"> <span class="number">804851</span>d:	<span class="number">88</span> <span class="number">45</span> f3             	mov    BYTE PTR [ebp<span class="number">-0xd</span>],al</span><br><span class="line"> <span class="number">8048520</span>:	<span class="number">80</span> <span class="number">7</span>d f3 ff          	cmp    BYTE PTR [ebp<span class="number">-0xd</span>],<span class="number">0xff</span></span><br><span class="line"> <span class="number">8048524</span>:	<span class="number">75</span> b6                	jne    <span class="number">80484</span>dc &lt;parse_getc+<span class="number">0xf</span>&gt; <span class="comment">// 循环，继续执行函数 getc()</span></span><br><span class="line"> <span class="number">8048526</span>:	<span class="number">8b</span> <span class="number">45</span> f4             	mov    eax,DWORD PTR [ebp<span class="number">-0xc</span>]</span><br><span class="line"> <span class="number">8048529</span>:	c9                   	leave</span><br><span class="line"> <span class="number">804852</span>a:	c3                   	ret</span><br></pre></td></tr></table></figure>

<p>PoC文件中的内容为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test<span class="meta"># cat PoC</span></span><br><span class="line">ABCD</span><br></pre></td></tr></table></figure>

<h3 id="Pintool-代码："><a href="#Pintool-代码：" class="headerlink" title="Pintool 代码："></a>Pintool 代码：</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cerr</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ofstream;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ios;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该函数在每条指令被执行前调用</span></span><br><span class="line"><span class="function">VOID <span class="title">track_mov</span><span class="params">(ADDRINT insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> ins, CONTEXT* ctxt)</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; insAddr &lt;&lt; <span class="string">" ins: "</span> &lt;&lt; ins.c_str() &lt;&lt; <span class="string">" eax: "</span> &lt;&lt;  PIN_GetContextReg(ctxt, LEVEL_BASE::REG_EAX) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin 每当遇见新的指令时候就会调用该函数</span></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span>&#123;</span><br><span class="line">   PIN_LockClient();</span><br><span class="line">   IMG img = IMG_FindByAddress(INS_Address(ins));</span><br><span class="line">   PIN_UnlockClient();</span><br><span class="line">   <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">       <span class="keyword">if</span> (IMG_IsMainExecutable(img))&#123;</span><br><span class="line">           <span class="keyword">if</span> (INS_IsMov(ins))&#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"image's name: "</span> &lt;&lt; IMG_Name(img).c_str() &lt;&lt; <span class="string">" ins_addr: "</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; INS_Address(ins) &lt;&lt; <span class="string">" "</span> &lt;&lt; INS_Disassemble(ins) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">             		<span class="comment">// analysis code</span></span><br><span class="line">                INS_InsertCall(ins,</span><br><span class="line">                    IPOINT_BEFORE, (AFUNPTR)track_mov,</span><br><span class="line">                    IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">                    IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">                    IARG_CONTEXT,</span><br><span class="line">                    IARG_END);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool counts the number of dynamic instructions executed"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/*   argc, argv are the entire command line: pin -t &lt;toolname&gt; -- ...    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line">    OutFile.<span class="built_in">open</span>(KnobOutputFile.Value().c_str());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">  	<span class="comment">// instruction code</span></span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注释掉 analysis code：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# /<span class="built_in">home</span>/hpfuzzer/pin/pin -t ../pintool/obj-ia32/inscounts.so -- ./getc_test | grep <span class="number">804851</span>d</span><br><span class="line"><span class="built_in">image</span><span class="number">'</span>s name: /<span class="built_in">home</span>/my_pintools/ins_count/test/getc_test ins_addr: <span class="number">804851</span>d mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al</span><br></pre></td></tr></table></figure>

<p>由上可知，仅会输出一个 804851d。</p>
<p><strong>使用 analysis code：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# /<span class="built_in">home</span>/hpfuzzer/pin/pin -t ../pintool/obj-ia32/inscounts.so -- ./getc_test | grep <span class="number">804851</span>d</span><br><span class="line"><span class="built_in">image</span><span class="number">'</span>s name: /<span class="built_in">home</span>/my_pintools/ins_count/test/getc_test ins_addr: <span class="number">804851</span>d mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al</span><br><span class="line"><span class="number">804851</span>d ins: mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al eax: <span class="number">41</span></span><br><span class="line"><span class="number">804851</span>d ins: mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al eax: <span class="number">42</span></span><br><span class="line"><span class="number">804851</span>d ins: mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al eax: <span class="number">43</span></span><br><span class="line"><span class="number">804851</span>d ins: mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al eax: <span class="number">44</span></span><br><span class="line"><span class="number">804851</span>d ins: mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al eax: a</span><br><span class="line"><span class="number">804851</span>d ins: mov <span class="keyword">byte</span> ptr [ebp<span class="number">-0xd</span>], al eax: ffffffff</span><br></pre></td></tr></table></figure>

<p>由上可知，会截取到每一个 804851d，进而可以得到 getc() 函数读取的内容究竟是什么，进一步进行污点分析。</p>
<h2 id="四、Instrumentation-vs-Analysis"><a href="#四、Instrumentation-vs-Analysis" class="headerlink" title="四、Instrumentation vs. Analysis"></a>四、Instrumentation vs. Analysis</h2><p>Pintool会在需要生成新代码的情况下调用Pin来注册 instrumentation 回调函数。它会检查生成的代码，提取其静态属性，并确定是否以及在何处插入 analysis 函数。analysis 函数会收集有关应用程序的数据。Pin 确保整数和浮点寄存器的状态在必要时得以保存和恢复，并允许将参数传递给函数。</p>
<p>编写 Pintool 时，调整 analysis 代码比 instrumentation 代码更重要。 这是因为 instrumentation 仅执行一次，但是 analysis 代码却被多次调用。</p>
<p>上述 Pintool 的代码中，instrumentation 函数 Instruction() 只是在遇到新的指令时候回被调用。但是 analysis 函数 track_mov 在每条指令被执行之前都会被调用。</p>
<p><strong>总结：</strong></p>
<p>使用 INS_AddInstrumentFunction()、TRACE_AddInstrumentFunction() 等进行插桩是类似的，都是遇见新的指令、trace才会调用插桩函数，但分析函数会在执行每一条指令、trace的时候调用。这样才能监控到每一条 mov 指令，从而得到 getc() 函数从文件中读取到的内容，方便进行下一步的分析。</p>
<blockquote>
<ol>
<li><a href="https://www.cnblogs.com/long123king/p/3635408.html" target="_blank" rel="noopener">https://www.cnblogs.com/long123king/p/3635408.html</a></li>
<li><a href="https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/" target="_blank" rel="noopener">https://software.intel.com/sites/landingpage/pintool/docs/71313/Pin/html/</a></li>
<li><a href="https://reverseengineering.stackexchange.com/questions/19309/i-want-to-trace-all-instructions-with-pintool-strange-behaviour" target="_blank" rel="noopener">https://reverseengineering.stackexchange.com/questions/19309/i-want-to-trace-all-instructions-with-pintool-strange-behaviour</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/10/PIN-InitSymbolsAlt%E4%B8%8EPIN-InitSymbols/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/10/PIN-InitSymbolsAlt%E4%B8%8EPIN-InitSymbols/" itemprop="url">PIN_InitSymbolsAlt与PIN_InitSymbols</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-10T11:40:18+08:00">
                2020-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、API介绍"><a href="#一、API介绍" class="headerlink" title="一、API介绍"></a>一、API介绍</h2><p><strong>PIN_InitSymbols（）</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">LEVEL_PINCLIENT::PIN_InitSymbols</span>	<span class="params">(	)</span>	</span></span><br><span class="line">  初始化符号表。Pin不会读取任何符号，除非调用此函数，并且应当在调用函数PIN_StartProgram之前调用它。</span><br></pre></td></tr></table></figure>

<p><strong>PIN_InitSymbolsAlt（）</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_PINCLIENT::PIN_InitSymbolsAlt</span><span class="params">(SYMBOL_INFO_MODE mode)</span>	</span></span><br><span class="line">  使用一些指定的模式来更明确的初始化符号表。Pin不会读取任何符号，除非调用此函数，并且应当在调用函数PIN_StartProgram之前调用它。在 Windows和Linux 上函数PIN_InitSymbolsAlt和PIN_InitSymbols 不同，但是在MacOS上和PIN_InitSymbols一样。</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">[in]	mode	支持的不同模式：</span><br><span class="line">    EXPORT_SYMBOLS 仅读取<span class="keyword">export</span> table中的符号，不包括行号信息 (Windows only).</span><br><span class="line">    DEBUG_SYMBOLS 与DEBUG_OR_EXPORT_SYMBOLS一样 (Windows only).</span><br><span class="line">    IFUNC_SYMBOLS 间接调用的函数 (Linux only).</span><br><span class="line">    DEBUG_OR_EXPORT_SYMBOLS 如有debug的符号则读取，否则读取<span class="keyword">export</span> table 的符号。PIN_InitSymbols() 实际上是设置的此种模式(Windows only)</span><br><span class="line">这个参数除了在操作系统 Windows &amp; Linux 外可被忽略</span><br><span class="line"></span><br><span class="line">Returns:</span><br><span class="line">操作成功返回<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="二、代码测试"><a href="#二、代码测试" class="headerlink" title="二、代码测试"></a>二、代码测试</h2><h3 id="测试源代码："><a href="#测试源代码：" class="headerlink" title="测试源代码："></a>测试源代码：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *arg1 = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(arg1) == <span class="number">8</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Correct len\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">"password"</span>, arg1) == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Win!\n"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Loose\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Len is not correct\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试pintool代码（pin-2-13）"><a href="#测试pintool代码（pin-2-13）" class="headerlink" title="测试pintool代码（pin-2.13）"></a>测试pintool代码（pin-2.13）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">strlenTriggered</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strlen triggered"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">strcmpTriggered</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strcmp triggered"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span> </span>&#123;</span><br><span class="line">    RTN strlenRTN = RTN_FindByName(img, <span class="string">"strlen"</span>);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(strlenRTN))&#123;</span><br><span class="line">      RTN_Open(strlenRTN);</span><br><span class="line">      RTN_InsertCall(strlenRTN, IPOINT_BEFORE, (AFUNPTR)strlenTriggered, IARG_END);</span><br><span class="line">      RTN_Close(strlenRTN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RTN strcmpRTN = RTN_FindByName(img, <span class="string">"strcmp"</span>);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(strcmpRTN))&#123;</span><br><span class="line">      RTN_Open(strcmpRTN);</span><br><span class="line">      RTN_InsertCall(strcmpRTN, IPOINT_BEFORE, (AFUNPTR)strcmpTriggered, IARG_END);</span><br><span class="line">      RTN_Close(strcmpRTN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>(PIN_Init(argc,argv)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、测试结果："><a href="#三、测试结果：" class="headerlink" title="三、测试结果："></a>三、测试结果：</h2><p>由测试源码可知，函数即调用了<strong>strcmp</strong>、也调用了<strong>strlen</strong>，但是最终却只捕获到了<strong>strlen</strong>。（调用<strong>strlen</strong>的次数比较多，可能是其他函数最终也调用了<strong>strlen</strong>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ..&#x2F;..&#x2F;..&#x2F;pin -t .&#x2F;obj-ia32&#x2F;strcmp.so -- .&#x2F;test &quot;password&quot;</span><br><span class="line">Correct len</span><br><span class="line">Win!</span><br></pre></td></tr></table></figure>

<p>输出的所有 <strong>IMG</strong> 所对应的 <strong>RTN</strong> 的信息为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .init RTN name: _init</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .plt RTN name: .plt</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: _start</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __x86.get_pc_thunk.bx</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: deregister_tm_clones</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: register_tm_clones</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __do_global_dtors_aux</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: frame_dummy</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: main</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __libc_csu_init</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __libc_csu_fini</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .fini RTN name: _fini</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __strcat_g</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __strncat_g</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __strcmp_gg</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __strncmp_g</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __strlen_g</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>如上所示，<strong>strlen</strong>、<strong>strcmp</strong>在目标程序的 <strong>IMG test</strong> 中没有，在 <strong>libc.so.6</strong> 的 *<em>IMG *</em>中也没有。有两种修改方法</p>
<h2 id="四、解决方法"><a href="#四、解决方法" class="headerlink" title="四、解决方法"></a>四、解决方法</h2><h3 id="方法一：（需要知道strcmp、strlen在-plt中的地址）"><a href="#方法一：（需要知道strcmp、strlen在-plt中的地址）" class="headerlink" title="方法一：（需要知道strcmp、strlen在.plt中的地址）"></a>方法一：（需要知道<strong>strcmp</strong>、<strong>strlen</strong>在<strong>.plt</strong>中的地址）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08048330</span> &lt;<span class="built_in">strcmp</span>@plt&gt;:</span><br><span class="line"> <span class="number">8048330</span>:       ff <span class="number">25</span> <span class="number">0</span>c a0 <span class="number">04</span> <span class="number">08</span>       jmp    *<span class="number">0x804a00c</span></span><br><span class="line"> <span class="number">8048336</span>:       <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">804833b</span>:       e9 e0 ff ff ff          jmp    <span class="number">8048320</span> &lt;_init+<span class="number">0x2c</span>&gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="number">08048360</span> &lt;<span class="built_in">strlen</span>@plt&gt;:</span><br><span class="line"> <span class="number">8048360</span>:       ff <span class="number">25</span> <span class="number">18</span> a0 <span class="number">04</span> <span class="number">08</span>       jmp    *<span class="number">0x804a018</span></span><br><span class="line"> <span class="number">8048366</span>:       <span class="number">68</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x18</span></span><br><span class="line"> <span class="number">804836b</span>:       e9 b0 ff ff ff          jmp    <span class="number">8048320</span> &lt;_init+<span class="number">0x2c</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>strcmp</strong>：08048330；<strong>strlen</strong>：08048360</p>
<p>修改<strong>pintool</strong>的代码为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">strcmpTriggered</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strcmp triggered"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// call 0x8048aa0 --&gt; call strcmp</span></span><br><span class="line"><span class="function">VOID <span class="title">contextDbg</span><span class="params">(ADDRINT insAddr, <span class="keyword">const</span> CONTEXT *ctxt , <span class="built_in">std</span>::<span class="built_in">string</span> insDis)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (insDis.<span class="built_in">find</span>(<span class="string">"0x8048aa0"</span>) != <span class="built_in">string</span>::npos)&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    RTN strcmpRtn = RTN_FindByAddress(<span class="number">0x8048aa0</span>);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(strcmpRtn))&#123;</span><br><span class="line">      RTN_Open(strcmpRtn);</span><br><span class="line">      RTN_InsertCall(</span><br><span class="line">          strcmpRtn,</span><br><span class="line">          IPOINT_BEFORE, (AFUNPTR)strcmpTriggered,</span><br><span class="line">          IARG_END);</span><br><span class="line">      RTN_Close(strcmpRtn);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span>&#123;</span><br><span class="line">  <span class="keyword">xed_iclass_enum_t</span> ins_indx = (<span class="keyword">xed_iclass_enum_t</span>)INS_Opcode(ins);</span><br><span class="line">  <span class="keyword">switch</span> (ins_indx) &#123;</span><br><span class="line">    <span class="keyword">case</span> XED_ICLASS_CALL_FAR:</span><br><span class="line">    <span class="keyword">case</span> XED_ICLASS_CALL_NEAR:</span><br><span class="line">        INS_InsertCall( ins,</span><br><span class="line">            IPOINT_BEFORE,</span><br><span class="line">            (AFUNPTR)contextDbg,</span><br><span class="line">            IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">            IARG_CONST_CONTEXT,<span class="comment">//获取上下文，可以得到此时的寄存器值</span></span><br><span class="line">            IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">            IARG_END );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上是截取调用 <strong>strcmp</strong> 函数的<strong>call</strong>指令，如：call 8048aa0，然后利用其来寻找 <strong>RTN</strong>对象（RTN_FindByAddress()）。在之前一个项目中确实是成功了，但是复现失败。具体原因不知道，留待后续研究。</p>
<h3 id="方法二（使用PIN-InitSymbolsAlt）"><a href="#方法二（使用PIN-InitSymbolsAlt）" class="headerlink" title="方法二（使用PIN_InitSymbolsAlt）"></a>方法二（使用PIN_InitSymbolsAlt）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">strlenTriggered</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strlen triggered"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">strcmpTriggered</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strcmp triggered"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SEC sec = IMG_SecHead(img); SEC_Valid(sec); sec = SEC_Next(sec))&#123; <span class="comment">//获取程序的section</span></span><br><span class="line">      <span class="keyword">for</span> (RTN rtn = SEC_RtnHead(sec); RTN_Valid(rtn); rtn = RTN_Next(rtn))&#123;<span class="comment">//获取section的RTN对象</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> ans = RTN_Name(rtn);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"IMG name: "</span> &lt;&lt; IMG_Name(img) &lt;&lt; <span class="string">" SEC name: "</span> &lt;&lt; SEC_Name(sec) </span><br><span class="line">                &lt;&lt; <span class="string">" RTN name: "</span> &lt;&lt; RTN_Name(rtn) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RTN strlenRTN = RTN_FindByName(img, <span class="string">"strlen"</span>);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(strlenRTN))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strlenRTN: "</span> &lt;&lt; RTN_Name(strlenRTN) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">      RTN_Open(strlenRTN);</span><br><span class="line">      RTN_InsertCall(strlenRTN, IPOINT_BEFORE, (AFUNPTR)strlenTriggered, IARG_END);</span><br><span class="line">      RTN_Close(strlenRTN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RTN strcmpRTN = RTN_FindByName(img, <span class="string">"strcmp"</span>);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(strcmpRTN))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"strcmpRTN: "</span> &lt;&lt; RTN_Name(strcmpRTN) &lt;&lt; <span class="string">" "</span> &lt;&lt; RTN_Address(strcmpRTN)  &lt;&lt; <span class="string">"\n"</span>; </span><br><span class="line">      RTN_Open(strcmpRTN);</span><br><span class="line">      RTN_InsertCall(strcmpRTN, IPOINT_BEFORE, (AFUNPTR)strcmpTriggered, IARG_END);</span><br><span class="line">      RTN_Close(strcmpRTN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// PIN_InitSymbols();</span></span><br><span class="line">    PIN_InitSymbolsAlt(SYMBOL_INFO_MODE(UINT32(IFUNC_SYMBOLS) | UINT32(DEBUG_OR_EXPORT_SYMBOLS)));</span><br><span class="line">    <span class="keyword">if</span>(PIN_Init(argc,argv)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的结果如下，可以截取到<strong>strcmp</strong>、<strong>strlen</strong>函数。说明<strong>PIN_InitSymbolsAlt</strong>、<strong>PIN_InitSymbols</strong>两个初始化符号的函数还是有明显区别的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">strlenRTN: strlen</span><br><span class="line">strcmpRTN: strcmp 3061247472 （0xb676edf0）</span><br><span class="line">strlen triggered</span><br><span class="line">strcmp triggered</span><br><span class="line">Correct len</span><br><span class="line">Win!</span><br></pre></td></tr></table></figure>

<p><strong>RTN</strong> 对象详情：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .init RTN name: _init</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .plt RTN name: .plt</span><br><span class="line">IMG name: source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: _start</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __x86.get_pc_thunk.bx</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: deregister_tm_clones</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: register_tm_clones</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __do_global_dtors_aux</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: frame_dummy</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: main</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __libc_csu_init</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .<span class="built_in">text</span> RTN name: __libc_csu_fini</span><br><span class="line">IMG name: /source/tools/ManualExamples/test SEC name: .fini RTN name: _fini</span><br><span class="line">IMG name: /lib/ld-linux.so<span class="number">.2</span> SEC name: .plt RTN name: .plt</span><br><span class="line"></span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __memcpy_chk</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: <span class="built_in">memcpy</span></span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __mempcpy_chk</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __mempcpy</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __memmove_chk</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: memmove</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: bcopy</span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: <span class="built_in">strcmp</span></span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: <span class="built_in">strncmp</span></span><br><span class="line">IMG name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span> SEC name: .<span class="built_in">text</span> RTN name: __strcas</span><br></pre></td></tr></table></figure>

<p>由上可知，截取的<strong>strcmp</strong>是来自于 <strong>libc.so.6</strong> 的 <strong>IMG</strong>，不是主程序 test。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/21/More%20Efficient%20Instruction%20Counting%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/21/More%20Efficient%20Instruction%20Counting%20/" itemprop="url">五、More Efficient Instruction Counting (Trace Instrumentation)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-21T18:18:46+08:00">
                2020-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>例子 <code>Simple Instruction Count (Instruction Instrumentation)</code>通过在每条指令之前插入一个函数调用来计算已执行指令的数量。在此示例中，我们通过对BBL进行插桩来统计基本块中的指令数，每个BBL的计数器增加一次，而不是对每条指令增加一次，来提高效率。</p>
<p>该示例可在<code>source/tools/ManualExamples/inscount1.cpp</code>中找到</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cerr</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ofstream;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ios;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">ofstream OutFile;</span><br><span class="line"><span class="comment">// The running count of instructions is kept here</span></span><br><span class="line"><span class="comment">// make it static to help the compiler optimize docount</span></span><br><span class="line"><span class="keyword">static</span> UINT64 icount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// This function is called before every block</span></span><br><span class="line"><span class="function">VOID <span class="title">docount</span><span class="params">(UINT32 c)</span> </span>&#123; icount += c; &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// Pin calls this function every time a new basic block is encountered</span></span><br><span class="line"><span class="comment">// It inserts a call to docount</span></span><br><span class="line"><span class="function">VOID <span class="title">Trace</span><span class="params">(TRACE trace, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Visit every basic block  in the trace</span></span><br><span class="line">    <span class="keyword">for</span> (BBL bbl = TRACE_BblHead(trace); BBL_Valid(bbl); bbl = BBL_Next(bbl))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Insert a call to docount before every bbl, passing the number of instructions</span></span><br><span class="line">        BBL_InsertCall(bbl, IPOINT_BEFORE, (AFUNPTR)docount, IARG_UINT32, BBL_NumIns(bbl), IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">KNOB&lt;<span class="built_in">string</span>&gt; <span class="title">KnobOutputFile</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"o"</span>, <span class="string">"inscount.out"</span>, <span class="string">"specify output file name"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    OutFile.setf(ios::showbase);</span><br><span class="line">    OutFile &lt;&lt; <span class="string">"Count "</span> &lt;&lt; icount &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    OutFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool counts the number of dynamic instructions executed"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line">    OutFile.<span class="built_in">open</span>(KnobOutputFile.Value().c_str());</span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">    TRACE_AddInstrumentFunction(Trace, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行编译：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:ManualExamples<span class="meta"># make obj-ia32/inscount1.so TARGET=ia32</span></span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER=<span class="number">1</span> -Wall -Werror -Wno-unknown-pragmas -fno-<span class="built_in">stack</span>-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I../../../source/include/pin -I../../../source/include/pin/gen -I../../../extras/components/include -I../../../extras/xed2-ia32/include -I../../../source/tools/InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32/inscount1.o inscount1.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style=sysv -Wl,-Bsymbolic -Wl,--version-script=../../../source/include/pin/pintool.ver    -o obj-ia32/inscount1.so obj-ia32/inscount1.o  -L../../../ia32/lib -L../../../ia32/lib-ext -L../../../ia32/runtime/glibc -L../../../extras/xed2-ia32/lib -lpin -lxed -ldwarf -lelf -ldl</span><br><span class="line"></span><br><span class="line">root@ubuntu:ManualExamples# ls obj-ia32/</span><br><span class="line">inscount1.o    inscount1.so</span><br></pre></td></tr></table></figure>

<p>下面是如何运行它并显示它的输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:tmp# /<span class="built_in">home</span>/vuzzer/pin/pin -t ../obj-ia32/inscount1.so -- /bin/ls</span><br><span class="line">inscount.out</span><br><span class="line"></span><br><span class="line">root@ubuntu:tmp<span class="meta"># cat inscount.out </span></span><br><span class="line">Count <span class="number">430267</span></span><br></pre></td></tr></table></figure>

<h4 id="TRACE-BblHead"><a href="#TRACE-BblHead" class="headerlink" title="TRACE_BblHead"></a>TRACE_BblHead</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BBL <span class="title">LEVEL_PINCLIENT::TRACE_BblHead</span><span class="params">(TRACE trace)</span>	</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	tarce的第一个基本块</span><br></pre></td></tr></table></figure>

<h4 id="BBL-Valid"><a href="#BBL-Valid" class="headerlink" title="BBL_Valid"></a>BBL_Valid</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_PINCLIENT::BBL_Valid</span><span class="params">(BBL x)</span>	</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	若 x 不是 BBL_INVALID()，返回True</span><br></pre></td></tr></table></figure>

<h4 id="BBL-Next"><a href="#BBL-Next" class="headerlink" title="BBL_Next"></a>BBL_Next</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BBL <span class="title">LEVEL_PINCLIENT::BBL_Next</span><span class="params">(BBL x)</span>	</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	下一个基本块或BBL_INVALID() if this is the end of trace or rtn</span><br></pre></td></tr></table></figure>

<h4 id="BBL-Address"><a href="#BBL-Address" class="headerlink" title="BBL_Address"></a>BBL_Address</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ADDRINT <span class="title">LEVEL_PINCLIENT::BBL_Address</span><span class="params">(BBL bbl)</span>	</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	基本块的地址</span><br></pre></td></tr></table></figure>

<h4 id="BBL-InsTail"><a href="#BBL-InsTail" class="headerlink" title="BBL_InsTail"></a>BBL_InsTail</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INS <span class="title">LEVEL_PINCLIENT::BBL_InsTail</span><span class="params">(BBL x)</span>	</span></span><br><span class="line"><span class="function">Returns:	</span></span><br><span class="line">	基本块的最后一条指令</span><br></pre></td></tr></table></figure>

<h4 id="BBL-InsertCall"><a href="#BBL-InsertCall" class="headerlink" title="BBL_InsertCall"></a>BBL_InsertCall</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">LEVEL_PINCLIENT::BBL_InsertCall</span><span class="params">(BBL bbl, IPOINT action, AFUNPTR funptr,	... )</span>		</span></span><br><span class="line">对相关的基本块进行插桩</span><br><span class="line">参数:</span><br><span class="line">bbl	BBL to instrument</span><br><span class="line">action	Specifies before, after, etc.</span><br><span class="line">  IPOINT_BEFORE is always valid <span class="keyword">for</span> all instructions.</span><br><span class="line">  IPOINT_AFTER is valid only when a fall-through exists (i.e. Calls and unconditional branches will fail).</span><br><span class="line">  IPOINT_ANYWHERE will <span class="built_in">put</span> the instrumentation at a place inside the bbl <span class="keyword">for</span> best performance</span><br><span class="line">  IPOINT_TAKEN_BRANCH is invalid <span class="keyword">for</span> non-branches.</span><br><span class="line">funptr	Analysis function to call</span><br><span class="line">...	IARG_TYPE. Arguments to pass to funptr</span><br></pre></td></tr></table></figure>

<h4 id="BBL-NumIns"><a href="#BBL-NumIns" class="headerlink" title="BBL_NumIns"></a>BBL_NumIns</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT32 <span class="title">LEVEL_CORE::BBL_NumIns</span>	<span class="params">(	BBL 	bbl	)</span>	</span></span><br><span class="line">	一个基本块内的指令数量</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/08/%E6%89%93%E5%BC%80%E3%80%81%E5%85%B3%E9%97%AD%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%20NX%20%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/08/%E6%89%93%E5%BC%80%E3%80%81%E5%85%B3%E9%97%AD%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%20NX%20%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD/" itemprop="url">打开、关闭二进制文件的 NX 保护措施</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-08T19:29:05+08:00">
                2020-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ELF/" itemprop="url" rel="index">
                    <span itemprop="name">ELF</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="打开、关闭二进制文件的-NX-保护措施"><a href="#打开、关闭二进制文件的-NX-保护措施" class="headerlink" title="打开、关闭二进制文件的 NX 保护措施"></a>打开、关闭二进制文件的 NX 保护措施</h2><h3 id="一、-checksec中检查-NX-的代码部分"><a href="#一、-checksec中检查-NX-的代码部分" class="headerlink" title="一、 checksec中检查 NX 的代码部分"></a>一、 checksec中检查 NX 的代码部分</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check for NX support</span></span><br><span class="line"><span class="variable">$&#123;debug&#125;</span> &amp;&amp; <span class="built_in">echo</span> -e <span class="string">"\n***function filecheck-&gt;nx"</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">$&#123;readelf&#125;</span> -l <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> 2&gt;/dev/null | grep -q <span class="string">'GNU_STACK'</span>; <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> <span class="variable">$&#123;readelf&#125;</span> -l <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> 2&gt;/dev/null | grep <span class="string">'GNU_STACK'</span> | grep -q <span class="string">'RWE'</span>; <span class="keyword">then</span></span><br><span class="line">		echo_message <span class="string">'\033[31mNX disabled\033[m   '</span> <span class="string">'NX disabled,'</span> <span class="string">' nx="no"'</span> <span class="string">'"nx":"no",'</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		echo_message <span class="string">'\033[32mNX enabled \033[m   '</span> <span class="string">'NX enabled,'</span> <span class="string">' nx="yes"'</span> <span class="string">'"nx":"yes",'</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	echo_message <span class="string">'\033[31mNX disabled\033[m   '</span> <span class="string">'NX disabled,'</span> <span class="string">' nx="no"'</span> <span class="string">'"nx":"no",'</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>本质上调用了<code>readelf -l</code>来进行判断的：</p>
<ul>
<li>不开启栈执行</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~ <span class="meta"># gcc -w -z noexecstack -o test test.c -m32</span></span><br><span class="line">root@ubuntu:~ <span class="meta"># readelf -l test</span></span><br><span class="line"></span><br><span class="line"><span class="function">Elf file type is <span class="title">EXEC</span> <span class="params">(Executable file)</span></span></span><br><span class="line"><span class="function">Entry <span class="built_in">point</span> 0x80482e0</span></span><br><span class="line">There are 9 program headers, starting at offset 52</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span><br><span class="line">  PHDR           <span class="number">0x000034</span> <span class="number">0x08048034</span> <span class="number">0x08048034</span> <span class="number">0x00120</span> <span class="number">0x00120</span> R E <span class="number">0x4</span></span><br><span class="line">  INTERP         <span class="number">0x000154</span> <span class="number">0x08048154</span> <span class="number">0x08048154</span> <span class="number">0x00013</span> <span class="number">0x00013</span> R   <span class="number">0x1</span></span><br><span class="line">      [Requesting program interpreter: /lib/ld-linux.so<span class="number">.2</span>]</span><br><span class="line">  LOAD           <span class="number">0x000000</span> <span class="number">0x08048000</span> <span class="number">0x08048000</span> <span class="number">0x00588</span> <span class="number">0x00588</span> R E <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x000f08</span> <span class="number">0x08049f08</span> <span class="number">0x08049f08</span> <span class="number">0x00169</span> <span class="number">0x0016c</span> RW  <span class="number">0x1000</span></span><br><span class="line">  DYNAMIC        <span class="number">0x000f14</span> <span class="number">0x08049f14</span> <span class="number">0x08049f14</span> <span class="number">0x000e8</span> <span class="number">0x000e8</span> RW  <span class="number">0x4</span></span><br><span class="line">  NOTE           <span class="number">0x000168</span> <span class="number">0x08048168</span> <span class="number">0x08048168</span> <span class="number">0x00044</span> <span class="number">0x00044</span> R   <span class="number">0x4</span></span><br><span class="line">  GNU_EH_FRAME   <span class="number">0x000490</span> <span class="number">0x08048490</span> <span class="number">0x08048490</span> <span class="number">0x0002c</span> <span class="number">0x0002c</span> R   <span class="number">0x4</span></span><br><span class="line">  GNU_STACK      <span class="number">0x000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000</span> <span class="number">0x00000</span> RW  <span class="number">0x10</span></span><br><span class="line">  GNU_RELRO      <span class="number">0x000f08</span> <span class="number">0x08049f08</span> <span class="number">0x08049f08</span> <span class="number">0x000f8</span> <span class="number">0x000f8</span> R   <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span>     </span><br><span class="line">   <span class="number">01</span>     .interp </span><br><span class="line">   <span class="number">02</span>     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .plt.got .<span class="built_in">text</span> .fini .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   <span class="number">03</span>     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss </span><br><span class="line">   <span class="number">04</span>     .dynamic </span><br><span class="line">   <span class="number">05</span>     .note.ABI-tag .note.gnu.build-id </span><br><span class="line">   <span class="number">06</span>     .eh_frame_hdr </span><br><span class="line">   <span class="number">07</span>     </span><br><span class="line">   <span class="number">08</span>     .init_array .fini_array .jcr .dynamic .got</span><br></pre></td></tr></table></figure>

<ul>
<li>开启栈执行</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~ <span class="meta"># gcc -w -z execstack -o test test.c -m32</span></span><br><span class="line">root@ubuntu:~ <span class="meta"># readelf -l test</span></span><br><span class="line"></span><br><span class="line"><span class="function">Elf file type is <span class="title">EXEC</span> <span class="params">(Executable file)</span></span></span><br><span class="line"><span class="function">Entry <span class="built_in">point</span> 0x80482e0</span></span><br><span class="line">There are 9 program headers, starting at offset 52</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span><br><span class="line">  PHDR           <span class="number">0x000034</span> <span class="number">0x08048034</span> <span class="number">0x08048034</span> <span class="number">0x00120</span> <span class="number">0x00120</span> R E <span class="number">0x4</span></span><br><span class="line">  INTERP         <span class="number">0x000154</span> <span class="number">0x08048154</span> <span class="number">0x08048154</span> <span class="number">0x00013</span> <span class="number">0x00013</span> R   <span class="number">0x1</span></span><br><span class="line">      [Requesting program interpreter: /lib/ld-linux.so<span class="number">.2</span>]</span><br><span class="line">  LOAD           <span class="number">0x000000</span> <span class="number">0x08048000</span> <span class="number">0x08048000</span> <span class="number">0x00588</span> <span class="number">0x00588</span> R E <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x000f08</span> <span class="number">0x08049f08</span> <span class="number">0x08049f08</span> <span class="number">0x00169</span> <span class="number">0x0016c</span> RW  <span class="number">0x1000</span></span><br><span class="line">  DYNAMIC        <span class="number">0x000f14</span> <span class="number">0x08049f14</span> <span class="number">0x08049f14</span> <span class="number">0x000e8</span> <span class="number">0x000e8</span> RW  <span class="number">0x4</span></span><br><span class="line">  NOTE           <span class="number">0x000168</span> <span class="number">0x08048168</span> <span class="number">0x08048168</span> <span class="number">0x00044</span> <span class="number">0x00044</span> R   <span class="number">0x4</span></span><br><span class="line">  GNU_EH_FRAME   <span class="number">0x000490</span> <span class="number">0x08048490</span> <span class="number">0x08048490</span> <span class="number">0x0002c</span> <span class="number">0x0002c</span> R   <span class="number">0x4</span></span><br><span class="line">  GNU_STACK      <span class="number">0x000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x00000</span> <span class="number">0x00000</span> RWE <span class="number">0x10</span></span><br><span class="line">  GNU_RELRO      <span class="number">0x000f08</span> <span class="number">0x08049f08</span> <span class="number">0x08049f08</span> <span class="number">0x000f8</span> <span class="number">0x000f8</span> R   <span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span>     </span><br><span class="line">   <span class="number">01</span>     .interp </span><br><span class="line">   <span class="number">02</span>     .interp .note.ABI-tag .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .plt.got .<span class="built_in">text</span> .fini .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   <span class="number">03</span>     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss </span><br><span class="line">   <span class="number">04</span>     .dynamic </span><br><span class="line">   <span class="number">05</span>     .note.ABI-tag .note.gnu.build-id </span><br><span class="line">   <span class="number">06</span>     .eh_frame_hdr </span><br><span class="line">   <span class="number">07</span>     </span><br><span class="line">   <span class="number">08</span>     .init_array .fini_array .jcr .dynamic .got</span><br></pre></td></tr></table></figure>

<h3 id="二、Program-header"><a href="#二、Program-header" class="headerlink" title="二、Program header"></a>二、Program header</h3><img src="/2020/08/08/%E6%89%93%E5%BC%80%E3%80%81%E5%85%B3%E9%97%AD%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%20NX%20%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD/program header && section header.png" alt="image-20200808192343332" style="zoom:50%;">

<p><code>program header</code>表告诉系统如何创建一个进程镜像。他在文件中的偏移由字段<code>e_phoff</code>指定，包含<code>e_phnum</code>个实体，每一个的大小为<code>e_phentsize</code>。32位和64位的数据结构略有不同，由于对齐的原因，字段<code>p_flags</code>在结构体中的位置不同，每一个实体的结构为：</p>
<table>
<thead>
<tr>
<th align="center">Offset</th>
<th align="center">Offset</th>
<th align="center">Size (bytes)</th>
<th align="center">Size (bytes)</th>
<th>Field</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td align="center">32-bit</td>
<td align="center">64-bit</td>
<td align="center">32-bit</td>
<td align="center">64-bit</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">0x00</td>
<td align="center">0x00</td>
<td align="center">4</td>
<td align="center">4</td>
<td><code>p_type</code></td>
<td>Identifies the type of the segment. <br>Value            Name            Meaning<br>0x00000000<code>PT_NULL</code>Program header table entry unused<br>0x00000001<code>PT_LOAD</code>Loadable segment<br>0x00000002<code>PT_DYNAMIC</code>Dynamic linking information<br>0x00000003<code>PT_INTERP</code>Interpreter information<br>0x00000004<code>PT_NOTE</code>Auxiliary information<br>0x00000005<code>PT_SHLIB</code>reserved<br>0x00000006<code>PT_PHDR</code>segment containing program header table itself<br>0x00000007<code>PT_TLS</code>Thread-Local Storage template<br>0x60000000<code>PT_LOOS</code>see below<br>0x6FFFFFFF<code>PT_HIOS</code><br>0x70000000<code>PT_LOPROC</code><br>0x7FFFFFFF<code>PT_HIPROC</code><br><code>PT_LOOS</code> to <code>PT_HIOS</code> (<code>PT_LOPROC</code> to <code>PT_HIPROC</code>) is an inclusive reserved ranges for operating system (processor) specific semantics.</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">0x04</td>
<td align="center"></td>
<td align="center">4</td>
<td><code>p_flags</code></td>
<td>Segment-dependent flags (position for 64-bit structure).</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">0x08</td>
<td align="center">4</td>
<td align="center">8</td>
<td><code>p_offset</code></td>
<td>Offset of the segment in the file image.</td>
</tr>
<tr>
<td align="center">0x08</td>
<td align="center">0x10</td>
<td align="center">4</td>
<td align="center">8</td>
<td><code>p_vaddr</code></td>
<td>Virtual address of the segment in memory.</td>
</tr>
<tr>
<td align="center">0x0C</td>
<td align="center">0x18</td>
<td align="center">4</td>
<td align="center">8</td>
<td><code>p_paddr</code></td>
<td>On systems where physical address is relevant, reserved for segment’s physical address.</td>
</tr>
<tr>
<td align="center">0x10</td>
<td align="center">0x20</td>
<td align="center">4</td>
<td align="center">8</td>
<td><code>p_filesz</code></td>
<td>Size in bytes of the segment in the file image. May be 0.</td>
</tr>
<tr>
<td align="center">0x14</td>
<td align="center">0x28</td>
<td align="center">4</td>
<td align="center">8</td>
<td><code>p_memsz</code></td>
<td>Size in bytes of the segment in memory. May be 0.</td>
</tr>
<tr>
<td align="center">0x18</td>
<td align="center"></td>
<td align="center">4</td>
<td align="center"></td>
<td><code>p_flags</code></td>
<td>Segment-dependent flags (position for 32-bit structure).</td>
</tr>
<tr>
<td align="center">0x1C</td>
<td align="center">0x30</td>
<td align="center">4</td>
<td align="center">8</td>
<td><code>p_align</code></td>
<td><code>0</code> and <code>1</code> specify no alignment. Otherwise should be a positive, integral power of 2, with <code>p_vaddr</code> equating <code>p_offset</code> modulus <code>p_align</code>.</td>
</tr>
<tr>
<td align="center">0x20</td>
<td align="center">0x38</td>
<td align="center"></td>
<td align="center">End of Program Header (size)</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>由上可知：</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="left">32位</th>
<th>64位</th>
</tr>
</thead>
<tbody><tr>
<td align="center">size of entry</td>
<td align="left">32B</td>
<td>64B</td>
</tr>
<tr>
<td align="center">offset of p_flags</td>
<td align="left">0x18</td>
<td>0x4</td>
</tr>
</tbody></table>
<p>在 program header 表中有一项 GNU_STACK，他的 flag 是 RWE，那么只要把它的 flag 改为 RW 就行了。 由上图可知 program header 的偏移是64，表中每一项的大小为0x20(32位）或0x38(64位）， p_flags字段的偏移是0x18（32位），0x4(64位）用 hexedit 手动把把那里的 7(RWX) 改为6 (RW) 就可以了。</p>
<h3 id="三、修改实例"><a href="#三、修改实例" class="headerlink" title="三、修改实例"></a>三、修改实例</h3><ul>
<li>开启的保护信息</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~ <span class="meta"># checksec test</span></span><br><span class="line">[*] '/root/test'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br><span class="line"><span class="function">    RWX:      Has RWX segments</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>ELF header 和 Program header</p>
<p>32位下，ELF header的大小为52B，后面是 Program header，</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span>: <span class="number">7f</span>45 <span class="number">4</span>c46 <span class="number">0101</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>  .ELF............</span><br><span class="line"><span class="number">00000010</span>: <span class="number">0200</span> <span class="number">0300</span> <span class="number">0100</span> <span class="number">0000</span> e082 <span class="number">0408</span> <span class="number">3400</span> <span class="number">0000</span>  ...........<span class="number">.4</span>...</span><br><span class="line"><span class="number">00000020</span>: <span class="number">2818</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">3400</span> <span class="number">2000</span> <span class="number">0900</span> <span class="number">2800</span>  (......<span class="number">.4</span>. ...(.</span><br><span class="line"><span class="number">00000030</span>: <span class="number">1f</span>00 <span class="number">1</span>c00                                                   </span><br><span class="line">                   	<span class="number">0600</span> <span class="number">0000</span> <span class="number">3400</span> <span class="number">0000</span> <span class="number">3480</span> <span class="number">0408</span>  .......<span class="number">.4</span>..<span class="number">.4</span>...</span><br><span class="line"><span class="number">00000040</span>: <span class="number">3480</span> <span class="number">0408</span> <span class="number">2001</span> <span class="number">0000</span> <span class="number">2001</span> <span class="number">0000</span> <span class="number">0500</span> <span class="number">0000</span>  <span class="number">4.</span>.. ... .......</span><br><span class="line"><span class="number">00000050</span>: <span class="number">0400</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">0300</span> <span class="number">0000</span> <span class="number">5401</span> <span class="number">0000</span> <span class="number">5481</span> <span class="number">0408</span>  ........T...T...</span><br><span class="line"><span class="number">00000060</span>: <span class="number">5481</span> <span class="number">0408</span> <span class="number">1300</span> <span class="number">0000</span> <span class="number">1300</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">0000</span>  T...............</span><br><span class="line"><span class="number">00000070</span>: <span class="number">0100</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">0100</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0080</span> <span class="number">0408</span>  ................</span><br><span class="line"><span class="number">00000080</span>: <span class="number">0080</span> <span class="number">0408</span> <span class="number">8805</span> <span class="number">0000</span> <span class="number">8805</span> <span class="number">0000</span> <span class="number">0500</span> <span class="number">0000</span>  ................</span><br><span class="line"><span class="number">00000090</span>: <span class="number">0010</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">0100</span> <span class="number">0000</span> <span class="number">080f</span> <span class="number">0000</span> <span class="number">089f</span> <span class="number">0408</span>  ................</span><br><span class="line"><span class="number">000000</span>a0: <span class="number">089f</span> <span class="number">0408</span> <span class="number">6901</span> <span class="number">0000</span> <span class="number">6</span>c01 <span class="number">0000</span> <span class="number">0600</span> <span class="number">0000</span>  ....i...l.......</span><br><span class="line"><span class="number">000000b</span>0: <span class="number">0010</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">0200</span> <span class="number">0000</span> <span class="number">140f</span> <span class="number">0000</span> <span class="number">149f</span> <span class="number">0408</span>  ................</span><br><span class="line"><span class="number">000000</span>c0: <span class="number">149f</span> <span class="number">0408</span> e800 <span class="number">0000</span> e800 <span class="number">0000</span> <span class="number">0600</span> <span class="number">0000</span>  ................</span><br><span class="line"><span class="number">000000</span>d0: <span class="number">0400</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">0400</span> <span class="number">0000</span> <span class="number">6801</span> <span class="number">0000</span> <span class="number">6881</span> <span class="number">0408</span>  ........h...h...</span><br><span class="line"><span class="number">000000e0</span>: <span class="number">6881</span> <span class="number">0408</span> <span class="number">4400</span> <span class="number">0000</span> <span class="number">4400</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">0000</span>  h...D...D.......</span><br><span class="line"><span class="number">000000f</span>0: <span class="number">0400</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">50e5</span> <span class="number">7464</span> <span class="number">9004</span> <span class="number">0000</span> <span class="number">9084</span> <span class="number">0408</span>  ....P.td........</span><br><span class="line"><span class="number">00000100</span>: <span class="number">9084</span> <span class="number">0408</span> <span class="number">2</span>c00 <span class="number">0000</span> <span class="number">2</span>c00 <span class="number">0000</span> <span class="number">0400</span> <span class="number">0000</span>  ....,...,.......</span><br><span class="line"><span class="number">00000110</span>: <span class="number">0400</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">51e5</span> <span class="number">7464</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span>  ....Q.td........		<span class="comment">//GNU_STACK，将对应的0700改为0600后，程序</span></span><br><span class="line"><span class="number">00000120</span>: <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0700</span> <span class="number">0000</span>  ................		<span class="comment">//打开NX保护，栈不可执行</span></span><br><span class="line"><span class="number">00000130</span>: <span class="number">1000</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">52e5</span> <span class="number">7464</span> <span class="number">080f</span> <span class="number">0000</span> <span class="number">089f</span> <span class="number">0408</span>  ....R.td........</span><br><span class="line"><span class="number">00000140</span>: <span class="number">089f</span> <span class="number">0408</span> f800 <span class="number">0000</span> f800 <span class="number">0000</span> <span class="number">0400</span> <span class="number">0000</span>  ................</span><br><span class="line"><span class="number">00000150</span>: <span class="number">0100</span> <span class="number">0000</span> </span><br><span class="line">                    <span class="number">2f</span>6c <span class="number">6962</span> <span class="number">2f</span>6c <span class="number">642</span>d <span class="number">6</span>c69 <span class="number">6e75</span>  ..../lib/ld-linu</span><br><span class="line"><span class="number">00000160</span>: <span class="number">782</span>e <span class="number">736f</span> <span class="number">2e32</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0000</span>  x.so<span class="number">.2</span>..........</span><br><span class="line"><span class="number">00000170</span>: <span class="number">0100</span> <span class="number">0000</span> <span class="number">474</span>e <span class="number">5500</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0200</span> <span class="number">0000</span>  ....GNU.........</span><br><span class="line"><span class="number">00000180</span>: <span class="number">0600</span> <span class="number">0000</span> <span class="number">2000</span> <span class="number">0000</span> <span class="number">0400</span> <span class="number">0000</span> <span class="number">1400</span> <span class="number">0000</span>  .... ...........</span><br><span class="line"><span class="number">00000190</span>: <span class="number">0300</span> <span class="number">0000</span> <span class="number">474</span>e <span class="number">5500</span> <span class="number">5915</span> <span class="number">9255</span> <span class="number">2338</span> <span class="number">74b</span>2  ....GNU.Y..U#<span class="number">8</span>t.</span><br><span class="line"><span class="number">000001</span>a0: <span class="number">8b</span>23 <span class="number">9</span>ecd <span class="number">43</span>ea <span class="number">0e25</span> <span class="number">0498</span> cc46 <span class="number">0200</span> <span class="number">0000</span>  .#..C..%...F....</span><br><span class="line"><span class="number">000001b</span>0: <span class="number">0300</span> <span class="number">0000</span> <span class="number">0100</span> <span class="number">0000</span> <span class="number">0500</span> <span class="number">0000</span> <span class="number">0020</span> <span class="number">0020</span>  ............. . </span><br><span class="line"><span class="number">000001</span>c0: <span class="number">0000</span> <span class="number">0000</span> <span class="number">0300</span> <span class="number">0000</span> ad4b e3c0 <span class="number">0000</span> <span class="number">0000</span>  .........K......</span><br></pre></td></tr></table></figure>

<ul>
<li>修改后</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~ <span class="meta"># checksec test</span></span><br><span class="line">[*] '/root/test'</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="四、ELF文件格式简图"><a href="#四、ELF文件格式简图" class="headerlink" title="四、ELF文件格式简图"></a>四、ELF文件格式简图</h3><p><img src="https://raw.githubusercontent.com/corkami/pics/28cb0226093ed57b348723bc473cea0162dad366/binary/elf101/elf101.svg" alt="ELF文件格式简图"></p>
<p><img src="/2020/08/08/%E6%89%93%E5%BC%80%E3%80%81%E5%85%B3%E9%97%AD%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9A%84%20NX%20%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD/elf32_bit.svg" alt="ELF文件格式简图"></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://github.com/corkami/pics/tree/28cb0226093ed57b348723bc473cea0162dad366/binary/elf101" target="_blank" rel="noopener">https://github.com/corkami/pics/tree/28cb0226093ed57b348723bc473cea0162dad366/binary/elf101</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/21/Detect_a_use_after_free_vulnerability/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/21/Detect_a_use_after_free_vulnerability/" itemprop="url">Detect a use after free vulnerability</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-21T09:12:51+08:00">
                2020-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Detect-a-use-after-free-vulnerability"><a href="#Detect-a-use-after-free-vulnerability" class="headerlink" title="Detect a use after free vulnerability"></a>Detect a use after free vulnerability</h2><p>污点分析很有用，但主要是用来判断用户能否触发漏洞。接下来，我们会使用模式匹配的方法来检测一些漏洞。</p>
<h3 id="1-Via-obsolete-stack-frame"><a href="#1-Via-obsolete-stack-frame" class="headerlink" title="1 - Via obsolete stack frame"></a>1 - Via obsolete stack frame</h3><p>首先，我们尝试检测那些访问栈指针的 <strong>LOAD</strong>、<strong>STORE</strong>，并判断能否被用户控制。</p>
<p><img src="/2020/07/21/Detect_a_use_after_free_vulnerability/uaf_stack_frame.png" alt="UAF via obsolete stack frame"></p>
<p>为了测试检测过期的 stack frame，我们用以下的代码来进行测试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *ptr1;</span><br><span class="line"><span class="keyword">char</span> *ptr2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">foo2</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> d = buf[<span class="number">0</span>]; <span class="comment">/* 'd' is tainted because buf is controlled by the user */</span></span><br><span class="line">  <span class="keyword">char</span> e = buf[<span class="number">1</span>]; <span class="comment">/* 'e' is tainted because buf is controlled by the user */</span></span><br><span class="line">  <span class="keyword">char</span> f = <span class="number">1</span>;      <span class="comment">/* 'f' is not tainted */</span></span><br><span class="line"></span><br><span class="line">  ptr1 = &amp;e;</span><br><span class="line">  ptr2 = &amp;f;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo1</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> a = *foo2(buf); <span class="comment">/* UAF match          */</span></span><br><span class="line">  <span class="keyword">char</span> b = *ptr1;      <span class="comment">/* UAF match          */</span></span><br><span class="line">  <span class="keyword">char</span> c = *ptr2;      <span class="comment">/* UAF does not match */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上代码所示，函数 <strong>foo2</strong> 初始化了指针 <strong>ptr1、ptr2</strong>，但是他们指向 <strong>foo2</strong> 的  stack-frame。函数 <strong>foo2</strong> 返回一个指向其 stack-frame 的指针，也即函数 <strong>foo1</strong> 中的变量 <strong>a、b</strong> 指向了过期 stack frame 中的变量 <strong>d、e</strong>。本例中，我们可以控制变量 <strong>a、b</strong>，变量 <strong>c</strong> 是被赋予的常数，不能被用户控制。</p>
<p>下面是函数 <strong>foo1、foo2</strong> 的反汇编代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400614</span> &lt;foo2&gt;:</span><br><span class="line">  <span class="number">400614</span>:   <span class="number">55</span>                      push   rbp</span><br><span class="line">  <span class="number">400615</span>:   <span class="number">48</span> <span class="number">89</span> e5                mov    rbp,rsp</span><br><span class="line">  <span class="number">400618</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">7</span>d e8             mov    QWORD PTR [rbp<span class="number">-0x18</span>],rdi</span><br><span class="line">  <span class="number">40061</span>c:   <span class="number">48</span> <span class="number">8b</span> <span class="number">45</span> e8             mov    rax,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">400620</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">400623</span>:   <span class="number">88</span> <span class="number">45</span> ff                mov    BYTE PTR [rbp<span class="number">-0x1</span>],al</span><br><span class="line">  <span class="number">400626</span>:   <span class="number">48</span> <span class="number">8b</span> <span class="number">45</span> e8             mov    rax,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">40062</span>a:   <span class="number">0f</span> b6 <span class="number">40</span> <span class="number">01</span>             movzx  eax,BYTE PTR [rax+<span class="number">0x1</span>]</span><br><span class="line">  <span class="number">40062</span>e:   <span class="number">88</span> <span class="number">45</span> fe                mov    BYTE PTR [rbp<span class="number">-0x2</span>],al</span><br><span class="line">  <span class="number">400631</span>:   c6 <span class="number">45</span> fd <span class="number">01</span>             mov    BYTE PTR [rbp<span class="number">-0x3</span>],<span class="number">0x1</span></span><br><span class="line">  <span class="number">400635</span>:   <span class="number">48</span> <span class="number">8</span>d <span class="number">45</span> fe             lea    rax,[rbp<span class="number">-0x2</span>]</span><br><span class="line">  <span class="number">400639</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">20</span> <span class="number">0</span>a <span class="number">20</span> <span class="number">00</span>    mov    QWORD PTR [rip+<span class="number">0x200a20</span>],rax # <span class="number">601060</span> &lt;ptr1&gt;</span><br><span class="line">  <span class="number">400640</span>:   <span class="number">48</span> <span class="number">8</span>d <span class="number">45</span> fd             lea    rax,[rbp<span class="number">-0x3</span>]</span><br><span class="line">  <span class="number">400644</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">1</span>d <span class="number">0</span>a <span class="number">20</span> <span class="number">00</span>    mov    QWORD PTR [rip+<span class="number">0x200a1d</span>],rax # <span class="number">601068</span> &lt;ptr2&gt;</span><br><span class="line">  <span class="number">40064b</span>:   <span class="number">48</span> <span class="number">8</span>d <span class="number">45</span> ff             lea    rax,[rbp<span class="number">-0x1</span>]</span><br><span class="line">  <span class="number">40064f</span>:   <span class="number">5</span>d                      pop    rbp</span><br><span class="line">  <span class="number">400650</span>:   c3                      ret</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400651</span> &lt;foo1&gt;:</span><br><span class="line">  <span class="number">400651</span>:   <span class="number">55</span>                      push   rbp</span><br><span class="line">  <span class="number">400652</span>:   <span class="number">48</span> <span class="number">89</span> e5                mov    rbp,rsp</span><br><span class="line">  <span class="number">400655</span>:   <span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>             sub    rsp,<span class="number">0x18</span></span><br><span class="line">  <span class="number">400659</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">7</span>d e8             mov    QWORD PTR [rbp<span class="number">-0x18</span>],rdi</span><br><span class="line">  <span class="number">40065</span>d:   <span class="number">48</span> <span class="number">8b</span> <span class="number">45</span> e8             mov    rax,QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">  <span class="number">400661</span>:   <span class="number">48</span> <span class="number">89</span> c7                mov    rdi,rax</span><br><span class="line">  <span class="number">400664</span>:   e8 ab ff ff ff          call   <span class="number">400614</span> &lt;foo2&gt;</span><br><span class="line">  <span class="number">400669</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">40066</span>c:   <span class="number">88</span> <span class="number">45</span> ff                mov    BYTE PTR [rbp<span class="number">-0x1</span>],al</span><br><span class="line">  <span class="number">40066f</span>:   <span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> ea <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    mov    rax,QWORD PTR [rip+<span class="number">0x2009ea</span>] # <span class="number">601060</span> &lt;ptr1&gt;</span><br><span class="line">  <span class="number">400676</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">400679</span>:   <span class="number">88</span> <span class="number">45</span> fe                mov    BYTE PTR [rbp<span class="number">-0x2</span>],al</span><br><span class="line">  <span class="number">40067</span>c:   <span class="number">48</span> <span class="number">8b</span> <span class="number">05</span> e5 <span class="number">09</span> <span class="number">20</span> <span class="number">00</span>    mov    rax,QWORD PTR [rip+<span class="number">0x2009e5</span>] # <span class="number">601068</span> &lt;ptr2&gt;</span><br><span class="line">  <span class="number">400683</span>:   <span class="number">0f</span> b6 <span class="number">00</span>                movzx  eax,BYTE PTR [rax]</span><br><span class="line">  <span class="number">400686</span>:   <span class="number">88</span> <span class="number">45</span> fd                mov    BYTE PTR [rbp<span class="number">-0x3</span>],al</span><br><span class="line">  <span class="number">400689</span>:   c9                      leave  </span><br><span class="line">  <span class="number">40068</span>a:   c3</span><br></pre></td></tr></table></figure>

<p>要检测此问题，可以仅使用当前内存操作的 source 指针来检测当前的 stack 指针。如果当前 stack 指针大于 source 指针，则意味着可能有过期的 stack-frame 的使用。如下所示，当 foo2 返回时，变量 a 指向的是 foo2 中的变量 d，存在对过期 stack frame 的使用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|   f   |</span><br><span class="line">|   e   |</span><br><span class="line">|   d   |</span><br><span class="line">|  ret  |   <span class="comment">// foo2's stack frame</span></span><br><span class="line">|  ebp  |</span><br><span class="line">|  buf  |</span><br><span class="line">|   c   |</span><br><span class="line">|   b   |</span><br><span class="line">|   a   |   <span class="comment">// foo1's stack frame</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sp &gt; addr &amp;&amp; addr &gt; <span class="number">0x700000000000</span>) <span class="comment">//addr &gt; 0x700000000000 保证addr属于栈内存</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr \</span><br><span class="line">    &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>

<p>下面是检测到的使用过期 stack-frame 的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ../../../pin -t ./obj-intel64/Taint.so -- ./test</span><br><span class="line">[TAINT]                   bytes tainted from <span class="number">0x611010</span> to <span class="number">0x611030</span> (via <span class="built_in">read</span>)</span><br><span class="line">[READ in <span class="number">611010</span>]          <span class="number">400620</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is now tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd14495e7]   <span class="number">400623</span>: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x1</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd14495e7 is now tainted</span><br><span class="line">[READ in <span class="number">611011</span>]          <span class="number">40062</span>a: movzx eax, <span class="keyword">byte</span> ptr [rax+<span class="number">0x1</span>]</span><br><span class="line">                          eax is already tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd14495e6]   <span class="number">40062</span>e: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x2</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd14495e6 is now tainted</span><br><span class="line">[READ in <span class="number">7f</span>ffd14495e7]    <span class="number">400669</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is already tainted</span><br><span class="line">[UAF in <span class="number">7f</span>ffd14495e7]     <span class="number">400669</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd144960f]   <span class="number">40066</span>c: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x1</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd144960f is now tainted</span><br><span class="line">[READ in <span class="number">7f</span>ffd14495e6]    <span class="number">400676</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is already tainted</span><br><span class="line">[UAF in <span class="number">7f</span>ffd14495e6]     <span class="number">400676</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd144960e]   <span class="number">400679</span>: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x2</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd144960e is now tainted</span><br><span class="line">[READ in <span class="number">7f</span>ffd14495e5]    <span class="number">400683</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is now freed</span><br></pre></td></tr></table></figure>

<p>如果你向过期 stack-frame 写入数据同理，下面的代码中向过期的 stack-frame 写入了数据。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">foo2</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> d = buf[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">return</span> &amp;d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo1</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *foo2(buf) = <span class="number">1</span>; <span class="comment">/* UAF match */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Pin tool 告诉我们在地址  <code>400644</code> 处向过期的 stack-frame 写入了数据</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ../../../pin -t ./obj-intel64/Taint.so -- ./test</span><br><span class="line">[TAINT]                   bytes tainted from <span class="number">0x19fd010</span> to <span class="number">0x19fd030</span> (via <span class="built_in">read</span>)</span><br><span class="line">[READ in <span class="number">19f</span>d010]         <span class="number">400620</span>: movzx eax, <span class="keyword">byte</span> ptr [rax]</span><br><span class="line">                          eax is now tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd3fd0f37]   <span class="number">400623</span>: mov <span class="keyword">byte</span> ptr [rbp<span class="number">-0x1</span>], al</span><br><span class="line">                          <span class="number">7f</span>ffd3fd0f37 is now tainted</span><br><span class="line">[WRITE in <span class="number">7f</span>ffd3fd0f37]   <span class="number">400644</span>: mov <span class="keyword">byte</span> ptr [rax], <span class="number">0x1</span></span><br><span class="line">                          <span class="number">7f</span>ffd3fd0f37 is now freed</span><br><span class="line">[UAF in <span class="number">7f</span>ffd3fd0f37]     <span class="number">400644</span>: mov <span class="keyword">byte</span> ptr [rax], <span class="number">0x1</span></span><br></pre></td></tr></table></figure>

<p>上述代码、输出并未进行测试，明白其原理即可，例子代码：<code>/PinTools/ObsoleteStackFrameAccessDetection/Taint.cpp</code></p>
<h3 id="2-Classical-use-after-free"><a href="#2-Classical-use-after-free" class="headerlink" title="2 - Classical use after free"></a>2 - Classical use after free</h3><p>若指针被释放后我们还能使用它则会触发UAF漏洞。</p>
<p><img src="/2020/07/21/Detect_a_use_after_free_vulnerability/use_after_free.png" alt="Use after free"></p>
<p> 这个错误在C ++世界中广为人知。想象一个对象具有 public(private) 的方法(变量) 。第一个对象 <strong>A</strong> 被初始化（我们不能控制该对象），然后一段时间后，该对象被释放。在我们有了第二个相同的对象 <strong>B</strong>（我们可以控制它）之后，对象 <strong>B</strong> 会被分配到与 <strong>A</strong> 相同的内存位置。 如果在 <strong>A</strong> 对象中有一些私有、公共数据，则在使用对象 <strong>B</strong> 时会访问到。</p>
<h4 id="2-1-Methodology"><a href="#2-1-Methodology" class="headerlink" title="2.1 - Methodology"></a>2.1 - Methodology</h4><p> 为此，我们需要捕获程序调用的所有的 <strong>malloc、free</strong> 函数。使用 Pin 通过他们的符号可以轻易的捕获这些调用。当一个 <strong>malloc</strong> 发生时，我们将一些信息保存在列表中：chunk块的基地址、size、状态（<strong>ALLOCATE、FREE</strong>）。当 <strong>free</strong> 发生时，设置flag为 <strong>FREE</strong>。</p>
<p><img src="/2020/07/21/Detect_a_use_after_free_vulnerability/struct_mallocarea.png" alt="struct mallocArea"></p>
<p> 然后，当我们遇到 <strong>LOAD、STORE</strong> 操作时，我们检查该地址是否在我们的列表中并检查它的 flag。如果 flag 是 <strong>FREE</strong> 并且对该地址有 <strong>LOAD、STORE</strong> 操作，那么意味着我们找到了一个潜在的 UAF 漏洞。</p>
<h4 id="2-2-Pin-API-Symbols"><a href="#2-2-Pin-API-Symbols" class="headerlink" title="2.2 - Pin API - Symbols"></a>2.2 - Pin API - Symbols</h4><p>使用 Pin 可以当一个符号被触发后执行一个回调函数。因此，当捕获到符号 <strong>malloc、free</strong> 时，我们增加一个回调函数。首先，我们需要初始化 Pin symbols。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PIN_InitSymbols();</span><br><span class="line"><span class="keyword">if</span>(PIN_Init(argc, argv))&#123;</span><br><span class="line">    <span class="keyword">return</span> Usage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，在 image 的处理函数中，我们对特定的符号增加一个回调函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span></span>&#123;</span><br><span class="line">  RTN mallocRtn = RTN_FindByName(img, <span class="string">"malloc"</span>);</span><br><span class="line">  RTN freeRtn = RTN_FindByName(img, <span class="string">"free"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(mallocRtn))&#123;</span><br><span class="line">    RTN_Open(mallocRtn);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeMalloc,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_AFTER, (AFUNPTR)callbackAfterMalloc,</span><br><span class="line">        IARG_FUNCRET_EXITPOINT_VALUE, </span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_Close(mallocRtn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(freeRtn))&#123;</span><br><span class="line">    RTN_Open(freeRtn);</span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        freeRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeFree,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">        IARG_END);</span><br><span class="line">    RTN_Close(freeRtn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这些回调函数中，我们保存、监控所有的 allocations。然后，在访问内存的 <strong>LOAD、STORE</strong> 的回调函数中，检查 des、src 地址是已被分配、还是被释放。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i2 = mallocAreaList.<span class="built_in">begin</span>(); i2 != mallocAreaList.<span class="built_in">end</span>(); i2++)&#123;</span><br><span class="line">  <span class="keyword">if</span> (addr &gt;= i2-&gt;base &amp;&amp; addr &lt; (i2-&gt;base + i2-&gt;<span class="built_in">size</span>) &amp;&amp; i2-&gt;status == FREE)&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> </span><br><span class="line">      &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-Test-on-a-C-based-program"><a href="#2-3-Test-on-a-C-based-program" class="headerlink" title="2.3 - Test on a C based program"></a>2.3 - Test on a C based program</h4><p>在 C 程序上进行测试。在这里，我们分配一个32字节的堆块。第一个和第三个 <strong>STORE</strong> 可以正常操作，因为是在分配 <strong>buf</strong> 之后，但第二个 <strong>STORE</strong> 发生在 <strong>buf</strong> 被释放后，存在 UAF。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> ac, <span class="keyword">char</span> **av)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *buf;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line">    <span class="comment">//   printf("BEGIN\n");</span></span><br><span class="line">    <span class="comment">/* （疑问，有时会遇到此种情况）必须在第一个malloc前执行printf，才会按照预期打印结果。反之，最后输出为:</span></span><br><span class="line"><span class="comment">    [INFO]		free(e36010)</span></span><br><span class="line"><span class="comment">    [INFO]		malloc(20) = e36010</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">if</span> (!(buf = <span class="built_in">malloc</span>(<span class="number">32</span>)))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  c = buf[<span class="number">0</span>];           <span class="comment">/* UAF not match */</span></span><br><span class="line">  <span class="built_in">free</span>(buf);  </span><br><span class="line">  c = buf[<span class="number">0</span>];           <span class="comment">/* UAF match     */</span></span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">  c = buf[<span class="number">0</span>];           <span class="comment">/* UAF not match */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-source-code"><a href="#2-4-source-code" class="headerlink" title="2.4 - source code"></a>2.4 - source code</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Jonathan Salwan - Copyright (C) 2013-08</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">//  http://shell-storm.org</span></span><br><span class="line"><span class="comment">//  http://twitter.com/JonathanSalwan</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Note: Example 5 - http://shell-storm.org/blog/Taint-analysis-with-Pin/</span></span><br><span class="line"><span class="comment">//        Detect the classical use after free vulnerability </span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCKED    1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNLOCKED  !LOCKED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALLOCATE  1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE      !ALLOCATE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span>         lastSize;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mallocArea</span>&#123;</span></span><br><span class="line">  ADDRINT  base;</span><br><span class="line">  ADDRINT  <span class="built_in">size</span>;</span><br><span class="line">  BOOL    status;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ADDRINT lockTaint = LOCKED;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;ADDRINT&gt;               addressTainted;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;REG&gt;                  regsTainted;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">list</span>&lt;struct mallocArea&gt;    mallocAreaList;</span><br><span class="line"></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"Ex 5"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查寄存器是否已被污染</span></span><br><span class="line"><span class="function">BOOL <span class="title">checkAlreadyRegTainted</span><span class="params">(REG reg)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;REG&gt;::iterator i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = regsTainted.<span class="built_in">begin</span>(); i != regsTainted.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (*i == reg)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">removeMemTainted</span><span class="params">(ADDRINT addr)</span></span>&#123;</span><br><span class="line">  addressTainted.<span class="built_in">remove</span>(addr);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; addr &lt;&lt; <span class="string">" is now freed"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">addMemTainted</span><span class="params">(ADDRINT addr)</span></span>&#123;</span><br><span class="line">  addressTainted.push_back(addr);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; addr &lt;&lt; <span class="string">" is now tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">taintReg</span><span class="params">(REG reg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg) == <span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" is already tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(reg)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RAX:  regsTainted.push_front(REG_RAX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EAX:  regsTainted.push_front(REG_EAX); </span><br><span class="line">    <span class="keyword">case</span> REG_AX:   regsTainted.push_front(REG_AX);  <span class="comment">//AX：32位下为低16位</span></span><br><span class="line">    <span class="keyword">case</span> REG_AH:   regsTainted.push_front(REG_AH);  <span class="comment">//AH：32位下为高8位</span></span><br><span class="line">    <span class="keyword">case</span> REG_AL:   regsTainted.push_front(REG_AL);  <span class="comment">//AL：32位下为低8位</span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RBX:  regsTainted.push_front(REG_RBX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EBX:  regsTainted.push_front(REG_EBX);</span><br><span class="line">    <span class="keyword">case</span> REG_BX:   regsTainted.push_front(REG_BX);</span><br><span class="line">    <span class="keyword">case</span> REG_BH:   regsTainted.push_front(REG_BH);</span><br><span class="line">    <span class="keyword">case</span> REG_BL:   regsTainted.push_front(REG_BL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RCX:  regsTainted.push_front(REG_RCX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ECX:  regsTainted.push_front(REG_ECX);</span><br><span class="line">    <span class="keyword">case</span> REG_CX:   regsTainted.push_front(REG_CX);</span><br><span class="line">    <span class="keyword">case</span> REG_CH:   regsTainted.push_front(REG_CH);</span><br><span class="line">    <span class="keyword">case</span> REG_CL:   regsTainted.push_front(REG_CL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDX:  regsTainted.push_front(REG_RDX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDX:  regsTainted.push_front(REG_EDX); </span><br><span class="line">    <span class="keyword">case</span> REG_DX:   regsTainted.push_front(REG_DX); </span><br><span class="line">    <span class="keyword">case</span> REG_DH:   regsTainted.push_front(REG_DH); </span><br><span class="line">    <span class="keyword">case</span> REG_DL:   regsTainted.push_front(REG_DL); </span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDI:  regsTainted.push_front(REG_RDI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDI:  regsTainted.push_front(REG_EDI); </span><br><span class="line">    <span class="keyword">case</span> REG_DI:   regsTainted.push_front(REG_DI); </span><br><span class="line">    <span class="comment">// case REG_DIL:  regsTainted.push_front(REG_DIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RSI:  regsTainted.push_front(REG_RSI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ESI:  regsTainted.push_front(REG_ESI); </span><br><span class="line">    <span class="keyword">case</span> REG_SI:   regsTainted.push_front(REG_SI); </span><br><span class="line">    <span class="comment">// case REG_SIL:  regsTainted.push_front(REG_SIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" can't be tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" is now tainted"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">removeRegTainted</span><span class="params">(REG reg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(reg)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RAX:  regsTainted.remove(REG_RAX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EAX:  regsTainted.<span class="built_in">remove</span>(REG_EAX);</span><br><span class="line">    <span class="keyword">case</span> REG_AX:   regsTainted.<span class="built_in">remove</span>(REG_AX);</span><br><span class="line">    <span class="keyword">case</span> REG_AH:   regsTainted.<span class="built_in">remove</span>(REG_AH);</span><br><span class="line">    <span class="keyword">case</span> REG_AL:   regsTainted.<span class="built_in">remove</span>(REG_AL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RBX:  regsTainted.remove(REG_RBX);</span></span><br><span class="line">    <span class="keyword">case</span> REG_EBX:  regsTainted.<span class="built_in">remove</span>(REG_EBX);</span><br><span class="line">    <span class="keyword">case</span> REG_BX:   regsTainted.<span class="built_in">remove</span>(REG_BX);</span><br><span class="line">    <span class="keyword">case</span> REG_BH:   regsTainted.<span class="built_in">remove</span>(REG_BH);</span><br><span class="line">    <span class="keyword">case</span> REG_BL:   regsTainted.<span class="built_in">remove</span>(REG_BL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RCX:  regsTainted.remove(REG_RCX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ECX:  regsTainted.<span class="built_in">remove</span>(REG_ECX);</span><br><span class="line">    <span class="keyword">case</span> REG_CX:   regsTainted.<span class="built_in">remove</span>(REG_CX);</span><br><span class="line">    <span class="keyword">case</span> REG_CH:   regsTainted.<span class="built_in">remove</span>(REG_CH);</span><br><span class="line">    <span class="keyword">case</span> REG_CL:   regsTainted.<span class="built_in">remove</span>(REG_CL);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDX:  regsTainted.remove(REG_RDX); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDX:  regsTainted.<span class="built_in">remove</span>(REG_EDX); </span><br><span class="line">    <span class="keyword">case</span> REG_DX:   regsTainted.<span class="built_in">remove</span>(REG_DX); </span><br><span class="line">    <span class="keyword">case</span> REG_DH:   regsTainted.<span class="built_in">remove</span>(REG_DH); </span><br><span class="line">    <span class="keyword">case</span> REG_DL:   regsTainted.<span class="built_in">remove</span>(REG_DL); </span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RDI:  regsTainted.remove(REG_RDI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_EDI:  regsTainted.<span class="built_in">remove</span>(REG_EDI); </span><br><span class="line">    <span class="keyword">case</span> REG_DI:   regsTainted.<span class="built_in">remove</span>(REG_DI); </span><br><span class="line">    <span class="comment">// case REG_DIL:  regsTainted.remove(REG_DIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case REG_RSI:  regsTainted.remove(REG_RSI); </span></span><br><span class="line">    <span class="keyword">case</span> REG_ESI:  regsTainted.<span class="built_in">remove</span>(REG_ESI); </span><br><span class="line">    <span class="keyword">case</span> REG_SI:   regsTainted.<span class="built_in">remove</span>(REG_SI); </span><br><span class="line">    <span class="comment">// case REG_SIL:  regsTainted.remove(REG_SIL); </span></span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\t"</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="string">" is now freed"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  操作数大于1个，当前指令为读操作，第一个操作数为寄存器</span></span><br><span class="line"><span class="comment">  ins: mov eax, dword ptr [esi]</span></span><br><span class="line"><span class="comment">  ins: mov esi, dword ptr [esi+0x34]</span></span><br><span class="line"><span class="comment">  ins: mov eax, dword ptr [esp+0xc]</span></span><br><span class="line"><span class="comment">  ins: pop ebx</span></span><br><span class="line"><span class="comment">  ins: pop esi</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  若不限定第一个操作数为寄存器，可能出现的指令为：</span></span><br><span class="line"><span class="comment">  ins: add dword ptr [eax+0x4], 0x1</span></span><br><span class="line"><span class="comment">  ins: cmp dword ptr [eax+0x14], eax</span></span><br><span class="line"><span class="comment">  ins: test byte ptr [ebx-0x2e0], 0x8</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID <span class="title">ReadMem</span><span class="params">(ADDRINT insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, ADDRINT opCount, REG reg_r, ADDRINT memOp, ADDRINT sp)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;ADDRINT&gt;::iterator i;</span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i2;</span><br><span class="line">  ADDRINT addr = memOp; <span class="comment">//内存读取操作的地址</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (opCount != <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">for</span>(i2 = mallocAreaList.<span class="built_in">begin</span>(); i2 != mallocAreaList.<span class="built_in">end</span>(); i2++)&#123;</span><br><span class="line">    <span class="comment">//UAF：读取了标志为FREE状态的内存</span></span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= i2-&gt;base &amp;&amp; addr &lt; (i2-&gt;base + i2-&gt;<span class="built_in">size</span>) &amp;&amp; i2-&gt;status == FREE)&#123; </span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//若read读取的地址被污染，则将污点信息传播至寄存器</span></span><br><span class="line">  <span class="keyword">for</span>(i = addressTainted.<span class="built_in">begin</span>(); i != addressTainted.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (addr == *i)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[READ in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        taintReg(reg_r); <span class="comment">//将该寄存器标记为被污染</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (sp &gt; addr &amp;&amp; addr &gt; <span class="number">0x700000000000</span>) <span class="comment">//检测栈变量的UAF</span></span><br><span class="line">          <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//若read读取的地址未被污染，则会覆盖目标寄存器的污点信息</span></span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg_r))&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[READ in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    removeRegTainted(reg_r);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esi+0x4c], 0xffffffff</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esp+0x8], eax</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esp+0xc], 0x0</span></span><br><span class="line"><span class="comment">  ins: mov dword ptr [esp], esi</span></span><br><span class="line"><span class="comment">  ins: call 0xb5d8bbe0</span></span><br><span class="line"><span class="comment">  ins: push esi</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID <span class="title">WriteMem</span><span class="params">(ADDRINT insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, ADDRINT opCount, REG reg_r, ADDRINT memOp, ADDRINT sp)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;ADDRINT&gt;::iterator i;</span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i2;</span><br><span class="line">  ADDRINT addr = memOp;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (opCount != <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span>(i2 = mallocAreaList.<span class="built_in">begin</span>(); i2 != mallocAreaList.<span class="built_in">end</span>(); i2++)&#123;</span><br><span class="line">    <span class="comment">//UAF：向标志为FREE状态的内存写入数据</span></span><br><span class="line">    <span class="keyword">if</span> (addr &gt;= i2-&gt;base &amp;&amp; addr &lt; (i2-&gt;base + i2-&gt;<span class="built_in">size</span>) &amp;&amp; i2-&gt;status == FREE)&#123;  </span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//若write写入的地址已被污染，且寄存器未被污染，那么write操作会覆盖目标地址的污点信息</span></span><br><span class="line">  <span class="keyword">for</span>(i = addressTainted.<span class="built_in">begin</span>(); i != addressTainted.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (addr == *i)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[WRITE in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">if</span> (!REG_valid(reg_r) || !checkAlreadyRegTainted(reg_r))</span><br><span class="line">          removeMemTainted(addr);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sp &gt; addr &amp;&amp; addr &gt; <span class="number">0x700000000000</span>)</span><br><span class="line">          <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[UAF in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//若write写入的地址未被污染，且寄存器已被污染，那么write操作会将寄存器的污点信息传播至目标地址</span></span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg_r))&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="string">"[WRITE in "</span> &lt;&lt; addr &lt;&lt; <span class="string">"]\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    addMemTainted(addr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  操作数大于1个，第一个操作数是寄存器</span></span><br><span class="line"><span class="comment">  ins: mov esi, eax</span></span><br><span class="line"><span class="comment">  ins: mov ebp, esp</span></span><br><span class="line"><span class="comment">  ins: sub esp, 0x8</span></span><br><span class="line"><span class="comment">  ins: mov eax, 0x804a02b</span></span><br><span class="line"><span class="comment">  ins: sub eax, 0x804a028</span></span><br><span class="line"><span class="comment">  ins: cmp eax, 0x6</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  ins: mov eax, 0x467 reg_r: 0 reg_w: a</span></span><br><span class="line"><span class="comment">  ins: mov edx, eax reg_r: a reg_w: 8</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">VOID <span class="title">spreadRegTaint</span><span class="params">(ADDRINT *insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, ADDRINT opCount, REG reg_r, REG reg_w)</span></span>&#123;</span><br><span class="line">  <span class="comment">// std::cout &lt;&lt; "ins: " &lt;&lt; insDis &lt;&lt; " reg_r: " &lt;&lt; reg_r &lt;&lt; " reg_w: " &lt;&lt; reg_w &lt;&lt; "\n";</span></span><br><span class="line">  <span class="keyword">if</span> (opCount != <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (REG_valid(reg_w))&#123;</span><br><span class="line">    <span class="comment">//被写入的寄存器已被污染且读取的不是寄存器 或者 读取的寄存器未被污染，此时需要移除被写入寄存器的污点信息</span></span><br><span class="line">    <span class="keyword">if</span> (checkAlreadyRegTainted(reg_w) &amp;&amp; (!REG_valid(reg_r) || !checkAlreadyRegTainted(reg_r)))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[SPREAD]\t\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\toutput: "</span>&lt;&lt; REG_StringShort(reg_w) &lt;&lt; <span class="string">" | input: "</span> &lt;&lt; (REG_valid(reg_r) ? REG_StringShort(reg_r) : <span class="string">"constant"</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      removeRegTainted(reg_w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 被写入的寄存器未被污染，读取的寄存器被污染，传播污点信息至被写入的寄存器</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!checkAlreadyRegTainted(reg_w) &amp;&amp; checkAlreadyRegTainted(reg_r))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[SPREAD]\t\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t\toutput: "</span> &lt;&lt; REG_StringShort(reg_w) &lt;&lt; <span class="string">" | input: "</span>&lt;&lt; REG_StringShort(reg_r) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">      taintReg(reg_w);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">followData</span><span class="params">(ADDRINT *insAddr, <span class="built_in">std</span>::<span class="built_in">string</span> insDis, REG reg)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!REG_valid(reg))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (checkAlreadyRegTainted(reg))&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[FOLLOW]\t\t"</span> &lt;&lt; insAddr &lt;&lt; <span class="string">": "</span> &lt;&lt; insDis &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span>&#123;</span><br><span class="line">  <span class="comment">//将数据读取到寄存器中</span></span><br><span class="line">  <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_MemoryOperandIsRead(ins, <span class="number">0</span>) &amp;&amp; INS_OperandIsReg(ins, <span class="number">0</span>))&#123; </span><br><span class="line">     INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)ReadMem,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins), </span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)), </span><br><span class="line">        IARG_ADDRINT, INS_OperandCount(ins), </span><br><span class="line">        IARG_ADDRINT, INS_OperandReg(ins, <span class="number">0</span>), </span><br><span class="line">        IARG_MEMORYOP_EA, <span class="number">0</span>,</span><br><span class="line">        IARG_REG_VALUE, REG_STACK_PTR,</span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_MemoryOperandIsWritten(ins, <span class="number">0</span>))&#123;</span><br><span class="line">    INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)WriteMem,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">        IARG_ADDRINT, INS_OperandCount(ins),</span><br><span class="line">        IARG_ADDRINT, INS_OperandReg(ins, <span class="number">1</span>),</span><br><span class="line">        IARG_MEMORYOP_EA, <span class="number">0</span>,</span><br><span class="line">        IARG_REG_VALUE, REG_STACK_PTR, </span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_OperandIsReg(ins, <span class="number">0</span>))&#123;</span><br><span class="line">    INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)spreadRegTaint,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">        IARG_ADDRINT, INS_OperandCount(ins),</span><br><span class="line">        IARG_ADDRINT, INS_RegR(ins, <span class="number">0</span>),</span><br><span class="line">        IARG_ADDRINT, INS_RegW(ins, <span class="number">0</span>),</span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (INS_OperandCount(ins) &gt; <span class="number">1</span> &amp;&amp; INS_OperandIsReg(ins, <span class="number">0</span>))&#123;</span><br><span class="line">    INS_InsertCall(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)followData,</span><br><span class="line">        IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">        IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">        IARG_ADDRINT, INS_RegR(ins, <span class="number">0</span>),</span><br><span class="line">        IARG_END);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">callbackBeforeMalloc</span><span class="params">(ADDRINT <span class="built_in">size</span>, ADDRINT ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PIN_LockClient();</span><br><span class="line">  IMG img = IMG_FindByAddress(ret);</span><br><span class="line">  PIN_UnlockClient(); </span><br><span class="line">  <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">    <span class="keyword">if</span> (IMG_IsMainExecutable(img))&#123; <span class="comment">//仅监控main函数中的malloc信息</span></span><br><span class="line">      lastSize = <span class="built_in">size</span>; <span class="comment">//全局变量lastSize保存的是malloc()函数的参数，也即申请分配的chunk大小</span></span><br><span class="line">      <span class="comment">// std::cout &lt;&lt; "image's name: " &lt;&lt; IMG_Name(img) &lt;&lt; "\n";</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">callbackBeforeFree</span><span class="params">(ADDRINT addr)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[INFO]\t\tfree("</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; addr &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="comment">//若释放的chunk在mallocAreaList中，将其status设置为 FREE</span></span><br><span class="line">  <span class="keyword">for</span>(i = mallocAreaList.<span class="built_in">begin</span>(); i != mallocAreaList.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr == i-&gt;base)&#123;</span><br><span class="line">      i-&gt;status = FREE;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">callbackAfterMalloc</span><span class="params">(ADDRINT ret)</span></span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;struct mallocArea&gt;::iterator i;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mallocArea</span> <span class="title">elem</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lastSize == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"[INFO]\t\tmalloc("</span> &lt;&lt; lastSize &lt;&lt; <span class="string">") = 0x"</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; ret &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">if</span> (ret)&#123;</span><br><span class="line">    <span class="comment">//若该chunk已在list中保存，更新其size、status信息</span></span><br><span class="line">    <span class="keyword">for</span>(i = mallocAreaList.<span class="built_in">begin</span>(); i != mallocAreaList.<span class="built_in">end</span>(); i++)&#123;</span><br><span class="line">      <span class="keyword">if</span> (ret == i-&gt;base)&#123;</span><br><span class="line">        i-&gt;status = ALLOCATE;</span><br><span class="line">        i-&gt;<span class="built_in">size</span> = lastSize;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//该chunk尚未记录，初始化elem并将其加入mallocAreaList中</span></span><br><span class="line">    elem.base = ret;</span><br><span class="line">    elem.<span class="built_in">size</span> = lastSize;</span><br><span class="line">    elem.status = ALLOCATE;</span><br><span class="line">    mallocAreaList.push_front(elem);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span></span>&#123;</span><br><span class="line">  RTN mallocRtn = RTN_FindByName(img, <span class="string">"malloc"</span>);</span><br><span class="line">  RTN freeRtn = RTN_FindByName(img, <span class="string">"free"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(mallocRtn))&#123;</span><br><span class="line">    RTN_Open(mallocRtn);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeMalloc,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, <span class="comment">//获取malloc()函数的参数</span></span><br><span class="line">        IARG_RETURN_IP,</span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        mallocRtn, </span><br><span class="line">        IPOINT_AFTER, (AFUNPTR)callbackAfterMalloc,</span><br><span class="line">        IARG_FUNCRET_EXITPOINT_VALUE,   <span class="comment">//malloc()函数的返回值</span></span><br><span class="line">        IARG_END);</span><br><span class="line"></span><br><span class="line">    RTN_Close(mallocRtn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTN_Valid(freeRtn))&#123;</span><br><span class="line">    RTN_Open(freeRtn);</span><br><span class="line">    RTN_InsertCall(</span><br><span class="line">        freeRtn, </span><br><span class="line">        IPOINT_BEFORE, (AFUNPTR)callbackBeforeFree,</span><br><span class="line">        IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, <span class="comment">//free()函数的参数</span></span><br><span class="line">        IARG_END);</span><br><span class="line">    RTN_Close(freeRtn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>(PIN_Init(argc, argv))&#123;</span><br><span class="line">        <span class="keyword">return</span> Usage();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    PIN_SetSyntaxIntel();</span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ol>
<li>对32位程序进行的测试，源码中部分类型为UINT64的变量需要将其改为UINT32或者ADDRINT</li>
</ol>
<p><strong>参数解释：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IARG_ADDRINT, INS_Address(ins), <span class="comment">//被插桩指令的地址</span></span><br><span class="line">IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)), <span class="comment">//指令的可打印字符串</span></span><br><span class="line">IARG_ADDRINT, INS_OperandCount(ins), <span class="comment">//指令操作数的个数</span></span><br><span class="line">IARG_ADDRINT, INS_OperandReg(ins, <span class="number">0</span>),  <span class="comment">//返回该操作数所对应的寄存器</span></span><br><span class="line">IARG_MEMORYOP_EA, <span class="number">0</span>,  <span class="comment">//Type: ADDRINT. 内存操作的有效地址（内存操作索引是下一个参数）仅在设置IPOINT_BEFORE时有效</span></span><br><span class="line">IARG_REG_VALUE, REG_STACK_PTR,<span class="comment">//REG_STACK_PTR：esp、rsp；IARG_REG_VALUE：ADDRINT，寄存器的值，需额外的寄存器作为参数</span></span><br></pre></td></tr></table></figure>

<p><strong>API：INS_RegR()、INS_REGW()</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">REG <span class="title">LEVEL_CORE::INS_RegR</span><span class="params">(INS x, UINT32 k)</span>		</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	指令x的第k个read操作的寄存器，包含隐式read（如：32位系统中的push esp）</span><br><span class="line">    </span><br><span class="line"><span class="function">REG <span class="title">LEVEL_CORE::INS_RegW</span><span class="params">(INS x, UINT32 k)</span>		</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line">	指令x的第k个write操作的寄存器，包含隐式write（如：32位系统中的push esp）</span><br></pre></td></tr></table></figure>

<p><strong>输出：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:ClassicalUseAfterFreePatternMatching# /<span class="built_in">home</span>/vuzzer/pin/pin -t ./obj-ia32/Taint.so -- ./test</span><br><span class="line">[INFO]		<span class="built_in">malloc</span>(<span class="number">0x32</span>) = <span class="number">0x936b008</span></span><br><span class="line">[INFO]		<span class="built_in">malloc</span>(<span class="number">0x20</span>) = <span class="number">0x936b008</span></span><br><span class="line">[INFO]		<span class="built_in">free</span>(<span class="number">936b</span>008)</span><br><span class="line">[UAF in <span class="number">936b</span>008]	b5cebcb5: mov dword ptr [esi+<span class="number">0x8</span>], ecx</span><br><span class="line">[UAF in <span class="number">936b</span>008]	<span class="number">804848f</span>: movzx eax, <span class="keyword">byte</span> ptr [eax]</span><br><span class="line">[UAF in <span class="number">936b</span>008]	b5cec92f: mov ecx, dword ptr [edi+<span class="number">0x8</span>]</span><br><span class="line">[INFO]		<span class="built_in">malloc</span>(<span class="number">0x20</span>) = <span class="number">0x936b008</span></span><br></pre></td></tr></table></figure>

<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><blockquote>
<ol>
<li><a href="http://shell-storm.org/blog/Taint-analysis-and-pattern-matching-with-Pin/#5.2" target="_blank" rel="noopener">http://shell-storm.org/blog/Taint-analysis-and-pattern-matching-with-Pin/#5.2</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/18/Glibc%E4%B8%ADmalloc%E5%88%86%E9%85%8Dchunk%E5%A4%A7%E5%B0%8F%E3%80%81%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/18/Glibc%E4%B8%ADmalloc%E5%88%86%E9%85%8Dchunk%E5%A4%A7%E5%B0%8F%E3%80%81%E5%AF%B9%E9%BD%90%E9%97%AE%E9%A2%98/" itemprop="url">Glibc中malloc分配chunk大小、对齐问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-18T18:47:04+08:00">
                2020-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn/" itemprop="url" rel="index">
                    <span itemprop="name">Pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Glibc中malloc分配chunk大小、对齐问题"><a href="#Glibc中malloc分配chunk大小、对齐问题" class="headerlink" title="Glibc中malloc分配chunk大小、对齐问题"></a>Glibc中malloc分配chunk大小、对齐问题</h2><p>用户最小申请的内存大小必须是<code>2 * SIZE_SZ</code>的最小整数倍。如果申请的内存大小不<code>2 * SIZE_SZ</code>的整数倍，会被转换满足大小的最小的<code>2 * SIZE_SZ</code>的倍数。</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>32bit</th>
<th>64bit</th>
</tr>
</thead>
<tbody><tr>
<td>SIZE_SZ</td>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td>MIN_CHUNK_SIZE</td>
<td>16</td>
<td>32</td>
</tr>
<tr>
<td>MINSIZE</td>
<td>16</td>
<td>32</td>
</tr>
</tbody></table>
<h3 id="将用户请求内存大小转为实际分配内存大小"><a href="#将用户请求内存大小转为实际分配内存大小" class="headerlink" title="将用户请求内存大小转为实际分配内存大小"></a>将用户请求内存大小转为实际分配内存大小</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MALLOC_ALIGN_MASK &#x3D; 2 * SIZE_SZ -1</span><br><span class="line">#define request2size(req)                                                      \</span><br><span class="line">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span><br><span class="line">         ? MINSIZE                                                             \</span><br><span class="line">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br></pre></td></tr></table></figure>

<p><code>((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)：（MALLOC_ALIGN_MASK+1）的倍数中，是（req+SIZE_SZ）的最小上界的那个数，此处最后求解的size包括chunk头</code></p>
<h3 id="检查分配给用户的内存是否对齐"><a href="#检查分配给用户的内存是否对齐" class="headerlink" title="检查分配给用户的内存是否对齐"></a>检查分配给用户的内存是否对齐</h3><p><code>2 * SIZE_SZ</code>大小对齐。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; MALLOC_ALIGN_MASK &#x3D; 2 * SIZE_SZ -1</span><br><span class="line">#define aligned_OK(m) (((unsigned long) (m) &amp; MALLOC_ALIGN_MASK) &#x3D;&#x3D; 0)</span><br></pre></td></tr></table></figure>

<p>malloc(27) -&gt; (27 + 4 + 7) &amp;~ (7) -&gt; 32，减去chunk头实际分配的堆内存大小为24字节：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;20wx 0x804b018 - 0x10</span><br><span class="line">0x804b008:	0x00000000	0x00000000	0x00000000	0x00000021</span><br><span class="line">0x804b018:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x804b028:	0x00000000	0x00000000	0x00000000	0x00020fd1</span><br></pre></td></tr></table></figure>

<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><h4 id="逻辑表达式-a-b-amp-b-的含义"><a href="#逻辑表达式-a-b-amp-b-的含义" class="headerlink" title="逻辑表达式 (a+b) &amp;~b 的含义"></a>逻辑表达式 (a+b) &amp;~b 的含义</h4><p> 例1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a &#x3D; 7,b &#x3D; 3</span><br><span class="line">(7 + 3) &amp; (~3) &#x3D; (0111 + 0011) &amp; (~0011)</span><br><span class="line">&#x3D; (1010) &amp; (1100) &#x3D; 1000 &#x3D; 8</span><br></pre></td></tr></table></figure>

<p>得到的结果是8</p>
<p>例2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a &#x3D; 21,b &#x3D; 7</span><br><span class="line">(21 + 7) &amp; (~7) &#x3D; (010101 + 000111) &amp; (111000) </span><br><span class="line">&#x3D; (011100) &amp; (111000) &#x3D; (011000) &#x3D; 24</span><br></pre></td></tr></table></figure>

<p>由上可知，8 是 4（b+1)的倍数中7的最小上界，</p>
<p>24是8（7 + 1）的倍数中21的最小上界。</p>
<p>逻辑表达式的作用是求出在b + 1的倍数中a的最小上界</p>
<blockquote>
<ol>
<li><a href="https://zhidao.baidu.com/question/1704099990419179620.html" target="_blank" rel="noopener">https://zhidao.baidu.com/question/1704099990419179620.html</a> </li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/17/Using%20PIN_SafeCopy()/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/17/Using%20PIN_SafeCopy()/" itemprop="url">九、Using PIN_SafeCopy()</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-17T10:06:58+08:00">
                2020-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Using-PIN-SafeCopy"><a href="#Using-PIN-SafeCopy" class="headerlink" title="Using PIN_SafeCopy()"></a>Using PIN_SafeCopy()</h2><p><code>PIN_SafeCopy</code>用于将指定数量的字节从<code>source</code>内存区域复制到<code>destination</code>内存区域。即使<code>source</code>或<code>destination</code>区域不能被访问（部分或完全），此函数也会保证安全的返回到调用方。</p>
<p>使用此函数还可以保证tool读取或写入那些被程序使用的值。例如，在Windows上，Pin会在运行tool的分析代码时替换某些TEB字段。如果tool直接访问这些字段，它将看到修改后的值而不是原始值。使用PIN_SafeCopy（）可使tool读取或写入这些字段的应用程序值。</p>
<p>每当tool读取或写入应用程序内存时可以使用此API。</p>
<p>首先进行编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># make obj-ia32&#x2F;safecopy.so TARGET&#x3D;ia32</span><br><span class="line"></span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER&#x3D;1 -Wall -Werror -Wno-unknown-pragmas -fno-stack-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;gen -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;components&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;tools&#x2F;InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32&#x2F;safecopy.o safecopy.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style&#x3D;sysv -Wl,-Bsymbolic -Wl,--version-script&#x3D;..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;pintool.ver    -o obj-ia32&#x2F;safecopy.so obj-ia32&#x2F;safecopy.o  -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib-ext -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;runtime&#x2F;glibc -L..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;lib -lpin -lxed -ldwarf -lelf -ldl</span><br></pre></td></tr></table></figure>

<p>测试程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test<span class="meta"># cat hello.c </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Hello World!\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行它并显示它的输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# /<span class="built_in">home</span>/vuzzer/pin/pin -t ../obj-ia32/safecopy.so -- ./hello</span><br><span class="line">Hello World!</span><br><span class="line"></span><br><span class="line">root@ubuntu:test<span class="meta"># cat safecopy.out </span></span><br><span class="line"><span class="number">0x8048350</span> mov ebx, dword ptr [esp] Emulate loading from addr <span class="number">0xbfc869e8</span> to ebx</span><br><span class="line"><span class="number">0x8048454</span> mov ebp, dword ptr [esp+<span class="number">0x30</span>] Emulate loading from addr <span class="number">0xbfc86a00</span> to ebp</span><br><span class="line"><span class="number">0x8048350</span> mov ebx, dword ptr [esp] Emulate loading from addr <span class="number">0xbfc869bc</span> to ebx</span><br><span class="line"><span class="number">0x80482bf</span> mov eax, dword ptr [ebx<span class="number">-0x4</span>] Emulate loading from addr <span class="number">0x8049ffc</span> to eax</span><br><span class="line"><span class="number">0x8048478</span> mov eax, dword ptr [esp+<span class="number">0x38</span>] Emulate loading from addr <span class="number">0xbfc86a08</span> to eax</span><br><span class="line"><span class="number">0x8048483</span> mov eax, dword ptr [esp+<span class="number">0x34</span>] Emulate loading from addr <span class="number">0xbfc86a04</span> to eax</span><br><span class="line"><span class="number">0x80483f0</span> mov eax, dword ptr [<span class="number">0x8049f10</span>] Emulate loading from addr <span class="number">0x8049f10</span> to eax</span><br><span class="line"><span class="number">0x8048350</span> mov ebx, dword ptr [esp] Emulate loading from addr <span class="number">0xbfc8690c</span> to ebx</span><br></pre></td></tr></table></figure>

<p>本例源码在<code>source/tools/ManualExamples/safecopy.cpp.</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cerr</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">std</span>::ofstream* out = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="comment">//  Analysis routines</span></span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="comment">// Move from memory to register</span></span><br><span class="line"><span class="function">ADDRINT <span class="title">DoLoad</span><span class="params">(REG reg, ADDRINT * addr, <span class="built_in">std</span>::<span class="built_in">string</span> ins_str, ADDRINT *ip)</span></span>&#123;</span><br><span class="line">    *out &lt;&lt; ip &lt;&lt; <span class="string">" "</span> &lt;&lt; ins_str.c_str() &lt;&lt; <span class="string">" Emulate loading from addr "</span> &lt;&lt; addr </span><br><span class="line">      		&lt;&lt; <span class="string">" to "</span> &lt;&lt; REG_StringShort(reg) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ADDRINT value;</span><br><span class="line">    PIN_SafeCopy(&amp;value, addr, <span class="keyword">sizeof</span>(ADDRINT)); <span class="comment">//将内存中的值读取到 value 中，并返回</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="comment">// Instrumentation routines</span></span><br><span class="line"><span class="comment">//=======================================================</span></span><br><span class="line"><span class="function">VOID <span class="title">EmulateLoad</span><span class="params">(INS ins, VOID* v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (INS_Address(ins) &lt;= <span class="number">0x8048000</span> || INS_Address(ins) &gt;= <span class="number">0x80000000</span>)&#123;<span class="comment">// 仅打印main中的指令</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Find the instructions that move a value from memory to a register</span></span><br><span class="line">    <span class="keyword">if</span> (INS_Opcode(ins) == XED_ICLASS_MOV &amp;&amp;</span><br><span class="line">        INS_IsMemoryRead(ins) &amp;&amp;</span><br><span class="line">        INS_OperandIsReg(ins, <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        INS_OperandIsMemory(ins, <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// op0 &lt;- *op1</span></span><br><span class="line">        INS_InsertCall(ins,</span><br><span class="line">                       IPOINT_BEFORE,</span><br><span class="line">                       AFUNPTR(DoLoad),</span><br><span class="line">                       IARG_UINT32,	REG(INS_OperandReg(ins, <span class="number">0</span>)),<span class="comment">// REG reg</span></span><br><span class="line">                       IARG_MEMORYREAD_EA, <span class="comment">//ADDRINT * addr</span></span><br><span class="line">                       <span class="comment">//因为删除了指令，所以需要把读取内存中的数据存入寄存器使用函数 PIN_SafeCopy 自己实现，</span></span><br><span class="line">                       <span class="comment">//最后将返回值存入到第一个操作数对应的寄存器中</span></span><br><span class="line">                       IARG_RETURN_REGS, INS_OperandReg(ins, <span class="number">0</span>), </span><br><span class="line">                       IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)), <span class="comment">//std::string ins_str</span></span><br><span class="line">                       IARG_INST_PTR, <span class="comment">//ADDRINT *ip</span></span><br><span class="line">                       IARG_END);</span><br><span class="line">        <span class="comment">// 删除该指令，需要模拟该指令的功能</span></span><br><span class="line">        INS_Delete(ins);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool demonstrates the use of SafeCopy"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    out = <span class="keyword">new</span> <span class="built_in">std</span>::ofstream(<span class="string">"safecopy.out"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Initialize pin &amp; symbol manager</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Register EmulateLoad to be called to instrument instructions</span></span><br><span class="line">    INS_AddInstrumentFunction(EmulateLoad, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>INS_InsertCall参数解释：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IARG_UINT32：Type: UINT32. 常量值 (需要额外的整型参数)</span><br><span class="line">IARG_RETURN_REGS：保存分析函数返回值的寄存器 (需要额外的寄存器作为参数)</span><br><span class="line">IARG_PTR：Type: &quot;VOID *&quot;. 常量值 (需要额外的指针类型数据作为参数)</span><br><span class="line">IARG_INST_PTR：Type: ADDRINT. 被插桩指令的地址。该值在IPOINT_AFTER不会改变，是IARG_ADDRINT和INS_Address（ins）的简写</span><br><span class="line">IARG_MEMORYREAD_EA：有效内存读的地址，仅当INS_IsMemoryRead时True，且设置了IPOINT_BEFORE</span><br></pre></td></tr></table></figure>

<p><strong>API：INS_OperandReg(INS ins, UINT32 n)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">REG <span class="title">LEVEL_CORE::INS_OperandReg</span><span class="params">(INS ins, UINT32 n)</span>		</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">  返回此操作数对应的寄存器"名字"(返回的其实是一个数字，REG是一个枚举类型，代表不同的寄存器)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">enum  	LEVEL_BASE::REG &#123;</span></span><br><span class="line"><span class="comment">  REG_INVALID_ = 0,</span></span><br><span class="line"><span class="comment">  REG_GR_BASE = REG_RBASE,</span></span><br><span class="line"><span class="comment">  REG_EDI = REG_GR_BASE,</span></span><br><span class="line"><span class="comment">  REG_GDI = REG_EDI,</span></span><br><span class="line"><span class="comment">  REG_ESI,</span></span><br><span class="line"><span class="comment">  REG_GSI = REG_ESI,</span></span><br><span class="line"><span class="comment">  REG_EBP,</span></span><br><span class="line"><span class="comment">  REG_GBP = REG_EBP,</span></span><br><span class="line"><span class="comment">  REG_ESP,</span></span><br><span class="line"><span class="comment">  ......</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>API：REG_StringShort(REG reg)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">LEVEL_BASE::REG_StringShort</span><span class="params">(REG reg)</span>	</span></span><br><span class="line"><span class="function">	<span class="comment">//将一个REG转换成可打印的字符串</span></span></span><br></pre></td></tr></table></figure>

<p><strong>API：INS_IsMemoryRead(INS ins)</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_CORE::INS_IsMemoryRead</span>	<span class="params">(	INS 	ins	)</span>	</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">	若该指令读取内存返回 true（有的系统的指令读取gs、fs中的值不会被视为访问内存）</span><br></pre></td></tr></table></figure>

<p><strong>API：INS_OperandIsReg(INS ins, UINT32 n )</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_CORE::INS_OperandIsReg</span><span class="params">(INS ins, UINT32 n)</span>		</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">	若该操作数是一个寄存器则返回true</span><br></pre></td></tr></table></figure>

<p><strong>API：INS_OperandIsMemory(INS ins, UINT32 n)</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LEVEL_CORE::INS_OperandIsMemory</span><span class="params">(INS ins, UINT32 n)</span>		</span></span><br><span class="line"><span class="function">	Returns:</span></span><br><span class="line">	若该操作数是一个内存的引用则返回true。注意：不包括LEA操作数</span><br></pre></td></tr></table></figure>

<p><strong>API：PIN_SafeCopy(VOID *dst，const VOID *src，size_t size)：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">LEVEL_PINCLIENT::PIN_SafeCopy</span><span class="params">(VOID *dst, <span class="keyword">const</span> VOID *src, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span>		</span></span><br><span class="line"><span class="function"><span class="comment">/*</span></span></span><br><span class="line"><span class="function"><span class="comment">将指定数量的字节从 source 内存区域复制到 destination 内存区域。即使 source 或 destination </span></span></span><br><span class="line"><span class="function"><span class="comment">区域不能被访问（部分或完全），此函数也会保证安全的返回到调用方。</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">Pintool 应使用此函数来确保安全访问应用程序内存的原始内容。例如，在Windows上，在tool中运行分析例程时，</span></span></span><br><span class="line"><span class="function"><span class="comment">Pin会替换某些TEB字段。 如果tool直接访问这些字段，它将看到由Pin分配的值而不是原始值。相反，PIN_SafeCopy() </span></span></span><br><span class="line"><span class="function"><span class="comment">始终读取和修改这些字段的原始应用程序值。</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">此函数可以在任何线程中使用，包括tool产生的任何内部线程。</span></span></span><br><span class="line"><span class="function"><span class="comment">*/</span></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line">    [out]	dst	destination region</span><br><span class="line">    [in]	src	region to copy from</span><br><span class="line">    [in]	<span class="built_in">size</span>	number of bytes to copy</span><br><span class="line">Returns:</span><br><span class="line">		Number of bytes successfully copied from the source to the destination region.</span><br><span class="line">Note:</span><br><span class="line">		PIN_SafeCopy() should <span class="keyword">not</span> be called before the application has been started. For instance, </span><br><span class="line">		it cannot be called in an Image load callback. Unexpected results will occur.</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/15/Finding-the-Value-of-Function-Arguments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/15/Finding-the-Value-of-Function-Arguments/" itemprop="url">十一、Finding the Value of Function Arguments</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-15T10:43:22+08:00">
                2020-07-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Finding-the-Value-of-Function-Arguments"><a href="#1-Finding-the-Value-of-Function-Arguments" class="headerlink" title="1. Finding the Value of Function Arguments"></a>1. Finding the Value of Function Arguments</h2><p>有时候我们需要得到函数的参数，或者返回值。可以使用Pin来获取这些信息，使用<a href="https://software.intel.com/sites/landingpage/pintool/docs/98223/Pin/html/group__RTN__BASIC__API.html#ga76bde295a78d1232fd6ff98a5ff011cf" target="_blank" rel="noopener">RTN_InsertCall()</a>函数可以获取感兴趣的参数。</p>
<p>下面的例子打印出函数<code>malloc()、free()</code>的参数和函数<code>malloc()</code>的返回值。</p>
<p>编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make .&#x2F;obj-ia32&#x2F;malloctrace.so TARGET&#x3D;ia32</span><br></pre></td></tr></table></figure>

<p>被测程序<code>malloc.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *a = <span class="built_in">malloc</span>(<span class="number">0x100</span><span class="number">-8</span>);</span><br><span class="line">	a[<span class="number">0</span>] = <span class="string">'h'</span>;</span><br><span class="line">	a[<span class="number">1</span>] = <span class="string">'e'</span>;</span><br><span class="line">	a[<span class="number">2</span>] = <span class="string">'l'</span>;</span><br><span class="line">	a[<span class="number">3</span>] = <span class="string">'l'</span>;</span><br><span class="line">	a[<span class="number">4</span>] = <span class="string">'o'</span>;</span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>RTN_InsertCall</code>中增加一个参数<code>IARG_RETURN_IP</code>，以此来获得<code>malloc</code>函数的返回值地址</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RTN_InsertCall(mallocRtn, IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">              IARG_ADDRINT, MALLOC,</span><br><span class="line">              IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, IARG_RETURN_IP,</span><br><span class="line">              IARG_END);</span><br></pre></td></tr></table></figure>

<p>将返回地址打印出的结果为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># /<span class="built_in">home</span>/vuzzer/pin/pin -t ../../obj-ia32/malloctrace.so -- ./<span class="built_in">malloc</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77469a0</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7751ee1</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb774bcec</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb774bd26</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7749196</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb774ead3</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7750d3d</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7750f1e</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb7759871</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x8048462</span>	<span class="comment">//malloc.c</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb5e3eaaf</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x206</span></span><br></pre></td></tr></table></figure>

<p>由上可知，Pin监控到了多个<code>malloc</code>函数，其中只有返回地址为<code>0x8048462</code>属于<code>malloc.c</code>。</p>
<p>将函数<code>Arg1Before</code>修改为如下形式，可以打印出<code>image</code>的名字</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Arg1Before</span><span class="params">(CHAR * name, ADDRINT <span class="built_in">size</span>, ADDRINT ret_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ret_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"IMG_Name: %s\n"</span>, IMG_Name(img).c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    TraceFile &lt;&lt; name &lt;&lt; <span class="string">"("</span> &lt;&lt; <span class="built_in">size</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"malloc's ret_addr: 0x%x\n"</span>, ret_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># /<span class="built_in">home</span>/vuzzer/pin/pin -t ../../obj-ia32/malloctrace.so -- ./<span class="built_in">malloc</span></span><br><span class="line">IMG_Name: /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77c0871</span></span><br><span class="line">IMG_Name: /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77c0871</span></span><br><span class="line">IMG_Name: /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb77ad9a0</span></span><br><span class="line">......</span><br><span class="line">IMG_Name: ManualExamples/test/heapview/<span class="built_in">malloc</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x8048462</span></span><br><span class="line">IMG_Name: /lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0xb5ea5aaf</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x206</span></span><br></pre></td></tr></table></figure>

<p>表明，Pin除了监控到<code>image malloc</code>，还监控到<code>ld-linux.so.2、libc.so.6</code>。再次对<code>Arg1Before</code>进行修改，去除对<code>image ld-linux.so.2、libc.so.6</code>的处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># /<span class="built_in">home</span>/vuzzer/pin/pin -t ../../obj-ia32/malloctrace.so -- ./<span class="built_in">malloc</span></span><br><span class="line">IMG_Name: ManualExamples/test/heapview/<span class="built_in">malloc</span></span><br><span class="line"><span class="built_in">malloc</span><span class="number">'</span>s ret_addr: <span class="number">0x8048462</span></span><br></pre></td></tr></table></figure>

<p>本例的源码在<code>pin/source/tools/ManualExamples/malloctrace.cpp</code>中，修改后为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::hex;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cerr</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::ios;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Names of malloc and free */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(TARGET_MAC)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC <span class="meta-string">"_malloc"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE <span class="meta-string">"_free"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC <span class="meta-string">"malloc"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE <span class="meta-string">"free"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Global Variables */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="built_in">std</span>::ofstream TraceFile;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Commandline Switches */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">KNOB&lt;<span class="built_in">string</span>&gt; <span class="title">KnobOutputFile</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"o"</span>, <span class="string">"malloctrace.out"</span>, <span class="string">"specify trace file name"</span>)</span></span>;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Analysis routines                                                     */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"> </span><br><span class="line"><span class="function">VOID <span class="title">Arg1Before</span><span class="params">(CHAR * name, ADDRINT <span class="built_in">size</span>, ADDRINT ret_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ret_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="keyword">if</span> (IMG_Name(img).<span class="built_in">find</span>(<span class="string">".so."</span>) == <span class="built_in">string</span>::npos)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"IMG_Name: %s\n"</span>, IMG_Name(img).c_str());</span><br><span class="line">            TraceFile &lt;&lt; name &lt;&lt; <span class="string">"("</span> &lt;&lt; <span class="built_in">size</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"malloc's ret_addr: 0x%x\n"</span>, ret_addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">MallocAfter</span><span class="params">(ADDRINT ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TraceFile &lt;&lt; <span class="string">"  returns "</span> &lt;&lt; ret &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Instrumentation routines                                              */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line">   </span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Instrument the malloc() and free() functions.  Print the input argument</span></span><br><span class="line">    <span class="comment">// of each malloc() or free(), and the return value of malloc().</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Find the malloc() function.</span></span><br><span class="line">    RTN mallocRtn = RTN_FindByName(img, MALLOC);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(mallocRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(mallocRtn);</span><br><span class="line">        <span class="comment">// Instrument malloc() to print the input argument value and the return value.</span></span><br><span class="line">        RTN_InsertCall(mallocRtn, IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, MALLOC,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, IARG_RETURN_IP，</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_InsertCall(mallocRtn, IPOINT_AFTER, (AFUNPTR)MallocAfter,</span><br><span class="line">                       IARG_FUNCRET_EXITPOINT_VALUE, IARG_END);</span><br><span class="line">        RTN_Close(mallocRtn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Find the free() function.</span></span><br><span class="line">    RTN freeRtn = RTN_FindByName(img, FREE);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(freeRtn))</span><br><span class="line">    &#123;</span><br><span class="line">        RTN_Open(freeRtn);</span><br><span class="line">        <span class="comment">// Instrument free() to print the input argument value.</span></span><br><span class="line">        RTN_InsertCall(freeRtn, IPOINT_BEFORE, (AFUNPTR)Arg1Before,</span><br><span class="line">                       IARG_ADDRINT, FREE,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        RTN_Close(freeRtn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TraceFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line">   </span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool produces a trace of calls to malloc."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Initialize pin &amp; symbol manager</span></span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>( PIN_Init(argc,argv) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Usage();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></span><br><span class="line">    TraceFile.<span class="built_in">open</span>(KnobOutputFile.Value().c_str());</span><br><span class="line">    TraceFile &lt;&lt; hex;</span><br><span class="line">    TraceFile.setf(ios::showbase);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Register Image to be called to instrument functions.</span></span><br><span class="line">    IMG_AddInstrumentFunction(Image, <span class="number">0</span>);</span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* eof */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br></pre></td></tr></table></figure>

<h2 id="2-使用IMG-IsMainExecutable来判断是否对malloc的调用属于main"><a href="#2-使用IMG-IsMainExecutable来判断是否对malloc的调用属于main" class="headerlink" title="2. 使用IMG_IsMainExecutable来判断是否对malloc的调用属于main"></a>2. 使用IMG_IsMainExecutable来判断是否对malloc的调用属于main</h2><p>将有谁调用<code>malloc()</code>函数的信息添加到回调函数中，最简单的方法是将<code>IARG_RETURN_IP</code>添加到<code>RTN_InsertCall()</code>的调用中，并相应地更改函数<code>Arg1Before</code>。在<code>Arg1Before</code>中对<code>ret_addr</code>使用<code>IMG_IsMainExecutable(IMG_FindByAddress(ret_addr))</code>进行判断，以查看此调用是否来自<code>main</code>可执行文件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">Arg1Before</span><span class="params">(CHAR * name, ADDRINT <span class="built_in">size</span>, ADDRINT ret_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ret_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="keyword">if</span> (IMG_IsMainExecutable(img))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"IMG_Name: %s\n"</span>, IMG_Name(img).c_str());</span><br><span class="line">            TraceFile &lt;&lt; name &lt;&lt; <span class="string">"("</span> &lt;&lt; <span class="built_in">size</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"malloc's ret_addr: 0x%x\n"</span>, ret_addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-获取函数的多个参数"><a href="#3-获取函数的多个参数" class="headerlink" title="3. 获取函数的多个参数"></a>3. 获取函数的多个参数</h2><p>假设需要获取下面函数的多个参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">funcA</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Actual: %i %i %i\n"</span>, a,b,c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">funcHandler</span><span class="params">(CHAR* name, <span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"Pin: %s %i %i %i\n"</span>, name, a, b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Image</span><span class="params">(IMG img, VOID *v)</span> </span>&#123;</span><br><span class="line">    RTN funcRtn = RTN_FindByName(img, <span class="string">"funcA"</span>);</span><br><span class="line">    <span class="keyword">if</span> (RTN_Valid(funcRtn)) &#123;</span><br><span class="line">        RTN_Open(funcRtn);</span><br><span class="line">				RTN_InsertCall(funcRtn, IPOINT_BEFORE, (AFUNPTR)funcHandler, </span><br><span class="line">    									IARG_ADDRINT, <span class="string">"funcA"</span>, </span><br><span class="line">                      IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>，IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">1</span>,</span><br><span class="line">    									IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">2</span>, IARG_END);</span><br><span class="line">        RTN_Close(funcRtn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在获取第0个参数之后，再添加几个带有1和2的<code>IARG_FUNCARG_ENTRYPOINT_VALUE</code>以获取第1和第2个参数。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://stackoverflow.com/questions/7896581/intel-pin-rtn-insertcall-multiple-function-arguments" target="_blank" rel="noopener">https://stackoverflow.com/questions/7896581/intel-pin-rtn-insertcall-multiple-function-arguments</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/14/INS_Address()%20%E5%92%8C%20IARG_INST_PTR%20%E7%9A%84%E4%B8%8D%E5%90%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/14/INS_Address()%20%E5%92%8C%20IARG_INST_PTR%20%E7%9A%84%E4%B8%8D%E5%90%8C/" itemprop="url">INS_Address()和IARG_INST_PTR的不同</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-14T17:35:45+08:00">
                2020-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、INS-Address-和-IARG-INST-PTR-的地址可能不一样"><a href="#一、INS-Address-和-IARG-INST-PTR-的地址可能不一样" class="headerlink" title="一、INS_Address() 和 IARG_INST_PTR 的地址可能不一样"></a>一、INS_Address() 和 IARG_INST_PTR 的地址可能不一样</h2><p>INS_Address（ins）：在<code>image</code>加载的时加载到当前指令时，打印该指令的地址</p>
<p>IARG_INST_PTR：执行指令时给出指令的地址。<code>image</code>的重定位在运行时发生，因此地址可能不同。</p>
<h2 id="二、同样的代码静态编译、动态编译，执行的地址不一样"><a href="#二、同样的代码静态编译、动态编译，执行的地址不一样" class="headerlink" title="二、同样的代码静态编译、动态编译，执行的地址不一样"></a>二、同样的代码静态编译、动态编译，执行的地址不一样</h2><p>由于动态链接程序不会直接以二进制开始执行：在控制权转移到可执行文件main中的_start之前，前几千条指令在动态链接器（ld-linux）中执行。</p>
<p>动态链接的<code>hello</code>的执行地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# gcc -o hello hello.c -m32</span><br><span class="line">root@ubuntu:test# file hello</span><br><span class="line">hello: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU&#x2F;Linux 2.6.24, BuildID[sha1]&#x3D;141cdcbf96da50c2e5b37f2f8b933a971d1a4f63, not stripped</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;itrace.so -- .&#x2F;hello</span><br><span class="line">Hello World!</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# head -10 itrace.out </span><br><span class="line">0xb76e8030</span><br><span class="line">0xb76e8032</span><br><span class="line">0xb76e86a0</span><br><span class="line">0xb76e86a1</span><br><span class="line">0xb76e86a3</span><br><span class="line">0xb76e86a4</span><br><span class="line">0xb76e86a5</span><br><span class="line">0xb76e86a6</span><br><span class="line">0xb76e86a9</span><br><span class="line">0xb76ff978</span><br></pre></td></tr></table></figure>

<p>静态链接的<code>hello</code>的执行地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:test# gcc -o hello hello.c -m32 -static</span><br><span class="line">root@ubuntu:test# file hello</span><br><span class="line">hello: ELF 32-bit LSB  executable, Intel 80386, version 1 (GNU&#x2F;Linux), statically linked, for GNU&#x2F;Linux 2.6.24, BuildID[sha1]&#x3D;800af8cbd98ee14dfc12aa4264dcc80e4727b333, not stripped</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;itrace.so -- .&#x2F;hello</span><br><span class="line">Hello World!</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# head -10 itrace.out </span><br><span class="line">0x8048d2a</span><br><span class="line">0x8048d2c</span><br><span class="line">0x8048d2d</span><br><span class="line">0x8048d2f</span><br><span class="line">0x8048d32</span><br><span class="line">0x8048d33</span><br><span class="line">0x8048d34</span><br><span class="line">0x8048d35</span><br><span class="line">0x8048d3a</span><br><span class="line">0x8048d3f</span><br></pre></td></tr></table></figure>

<p>动态链接的程序在运行时的步骤是：</p>
<ol>
<li><p>内核创建一个新进程“ shell”，并将可执行文件映射到其中。</p>
</li>
<li><p>内核观察到该可执行文件具有<code>PT_INTERP</code>段，并将其中引用的文件映射到进程中。此处，<code>PT_INTERP</code>的内容是<code>/lib64/ld-linux-x86-64.so.2</code>，又名动态加载程序，不要与<code>/usr/bin/ld</code>（又名静态链接器）混淆。此外，因为需要程序解释器，所以内核将控制权转移给它（而不是main文件中的_start，因为main文件尚未准备好运行）。</p>
</li>
<li><p>当<code>ld-linux</code>开始运行时，它会首先对自己重定位，然后映射main文件链接到的所有库。可以使用<code>readelf -d a.out |grep NEEDED</code>查看这些库。</p>
<p>注意：由于这些库中的每个库本身可能直接依赖于其他库，因此将以递归方式重复此过程。</p>
</li>
<li><p>库被初始化（通过调用其构造函数，该函数通常称为<em>init，但也可以具有不同的名称）</em></p>
</li>
<li><p>加载并初始化所有库后，<code>ld-linux</code>最终调用_start，最终将调用main。</p>
</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://stackoverflow.com/questions/62050627/pin-tool-the-static-ins-address-ins-addressins-is-different-from-the-address" target="_blank" rel="noopener">https://stackoverflow.com/questions/62050627/pin-tool-the-static-ins-address-ins-addressins-is-different-from-the-address</a></li>
<li><a href="https://stackoverflow.com/questions/62125651/instruction-point-value-of-dynamic-linking-and-static-linking" target="_blank" rel="noopener">https://stackoverflow.com/questions/62125651/instruction-point-value-of-dynamic-linking-and-static-linking</a></li>
<li><a href="https://stackoverflow.com/questions/61789860/how-to-set-breakpoint-on-entry-of-dynamically-opened-shared-library/61790355#61790355" target="_blank" rel="noopener">https://stackoverflow.com/questions/61789860/how-to-set-breakpoint-on-entry-of-dynamically-opened-shared-library/61790355#61790355</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/14/Instruction-Address-Trace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/14/Instruction-Address-Trace/" itemprop="url">二、Instruction Address Trace (Instruction Instrumentation)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-14T16:59:23+08:00">
                2020-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Instruction-Address-Trace-Instruction-Instrumentation"><a href="#Instruction-Address-Trace-Instruction-Instrumentation" class="headerlink" title="Instruction Address Trace (Instruction Instrumentation)"></a>Instruction Address Trace (Instruction Instrumentation)</h2><p>在上一个例子中，我们没有给分析函数<code>docount</code>传递任何参数。在本例中，将展示如何进行参数传递。当调用分析函数时候，Pin允许传入指令指针、当前寄存器的值、内存操作的有效地址、常量等。具体可见<a href="https://software.intel.com/sites/landingpage/pintool/docs/98223/Pin/html/group__INST__ARGS.html#ga089c27ca15e9ff139dd3a3f8a6f8451d" target="_blank" rel="noopener">IARG_TYPE</a>。</p>
<p>在之前的例子上稍作改动，我们将指令计数的例子转化为打印每条执行过的指令地址的Pintool。这有助于调试时理解程序的控制流，或益于模拟指令缓存时的处理器设计中。</p>
<p>我们改变函数<code>INS_InsertCall</code>的参数，将被执行过的指令的地址作为参数。将<code>docount</code>替换为<code>printip</code>，打印指令的地址。将输出写入文件<code>itrace.out</code>中。</p>
<p>首先进行编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cd source&#x2F;tools&#x2F;ManualExamples</span><br><span class="line"></span><br><span class="line"># make obj-ia32&#x2F;itrace.so TARGET&#x3D;ia32</span><br><span class="line">g++ -DBIGARRAY_MULTIPLIER&#x3D;1 -Wall -Werror -Wno-unknown-pragmas -fno-stack-protector -DTARGET_IA32 -DHOST_IA32 -DTARGET_LINUX  -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;gen -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;components&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;include -I..&#x2F;..&#x2F;..&#x2F;source&#x2F;tools&#x2F;InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-ia32&#x2F;itrace.o itrace.cpp</span><br><span class="line">g++ -shared -Wl,--hash-style&#x3D;sysv -Wl,-Bsymbolic -Wl,--version-script&#x3D;..&#x2F;..&#x2F;..&#x2F;source&#x2F;include&#x2F;pin&#x2F;pintool.ver    -o obj-ia32&#x2F;itrace.so obj-ia32&#x2F;itrace.o  -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;lib-ext -L..&#x2F;..&#x2F;..&#x2F;ia32&#x2F;runtime&#x2F;glibc -L..&#x2F;..&#x2F;..&#x2F;extras&#x2F;xed2-ia32&#x2F;lib -lpin -lxed -ldwarf -lelf -ldl</span><br></pre></td></tr></table></figure>

<p>下面是如何运行它并显示它的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;home&#x2F;vuzzer&#x2F;pin&#x2F;pin -t ..&#x2F;obj-ia32&#x2F;itrace.so -- &#x2F;bin&#x2F;ls</span><br><span class="line">2comp  hello.txt  inscount0.log  inscount.out  itrace.out  pinatrace.out  pin.log  tmp_res.out</span><br><span class="line"></span><br><span class="line">root@ubuntu:test# head -10 itrace.out </span><br><span class="line">0x804c041</span><br><span class="line">0x804c043</span><br><span class="line">0x804c044</span><br><span class="line">0x804c046</span><br><span class="line">0x804c049</span><br><span class="line">0x804c04a</span><br><span class="line">0x804c04b</span><br><span class="line">0x804c04c</span><br><span class="line">0x804c051</span><br><span class="line">0x804c056</span><br></pre></td></tr></table></figure>

<p>Pintool 运行在 32 位系统上，发现打印出很多以 0xb 开头的指令地址，所以加了判断，限定仅分析二进制属于范围：0x8048000 - 0x8800000 中的指令，结果如上所示。</p>
<p>本例的源码在<code>source/tools/ManualExamples/itrace.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line">FILE * trace;</span><br><span class="line"><span class="comment">// This function is called before every instruction is executed</span></span><br><span class="line"><span class="comment">// and prints the IP</span></span><br><span class="line"><span class="function">VOID <span class="title">printip</span><span class="params">(VOID *ip)</span> </span>&#123; <span class="built_in">fprintf</span>(trace, <span class="string">"%p\n"</span>, ip); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin calls this function every time a new instruction is encountered</span></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Insert a call to printip before every instruction, and pass it the IP</span></span><br><span class="line">  	<span class="comment">// IARG_INST_PTR：被插桩指令的地址</span></span><br><span class="line">    <span class="comment">// INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)printip, IARG_INST_PTR, IARG_END);</span></span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">if</span> (INS_Address(ins) &gt; <span class="number">0x8048000</span> &amp;&amp; INS_Address(ins) &lt; <span class="number">0x8800000</span>)&#123;</span><br><span class="line">        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)printip, IARG_INST_PTR, IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(trace, <span class="string">"#eof\n"</span>);</span><br><span class="line">    fclose(trace);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIN_ERROR(<span class="string">"This Pintool prints the IPs of every instruction executed\n"</span> </span><br><span class="line">              + KNOB_BASE::StringKnobSummary() + <span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    trace = fopen(<span class="string">"itrace.out"</span>, <span class="string">"w"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本例使用的API：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INS_Address（INS ins）</span><br><span class="line">返回值：指令的地址</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zyt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zyt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
