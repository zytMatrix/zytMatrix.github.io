<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Matrix">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zyt">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Matrix</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Matrix</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/05/How%20Fuzzers%20Decide%20if%20a%20Crash%20is%20Unique/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/05/How%20Fuzzers%20Decide%20if%20a%20Crash%20is%20Unique/" itemprop="url">How Fuzzers Decide if a Crash is Unique.md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-05T21:21:16+08:00">
                2021-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Crash-Triage/" itemprop="url" rel="index">
                    <span itemprop="name">Crash Triage</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="How-Fuzzers-Decide-if-a-Crash-is-Unique"><a href="#How-Fuzzers-Decide-if-a-Crash-is-Unique" class="headerlink" title="How Fuzzers Decide if a Crash is Unique"></a>How Fuzzers Decide if a Crash is Unique</h1><h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>主要是研究AFL++和Honggfuzz判定unique crash的不同之处。</p>
<p><strong>test1.c：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>* n = (<span class="keyword">void</span>*) <span class="number">0</span>;</span><br><span class="line">    *n = <span class="number">42</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">99</span>);</span><br><span class="line">    buf[len] = <span class="string">'\x00'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'0'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'1'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'2'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'3'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'4'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'5'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'6'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'7'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'8'</span>)</span><br><span class="line">        vuln();</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'9'</span>)</span><br><span class="line">        vuln();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>test2.c：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vuln</span><span class="params">(<span class="keyword">char</span> *buf)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">99</span>);</span><br><span class="line">    buf[len] = <span class="string">'\x00'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *buf2 = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'0'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'1'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'2'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'3'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'4'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'5'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'6'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'7'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'8'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'9'</span>)</span><br><span class="line">        vuln(buf2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(buf2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用相同的字典：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat dict.txt</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>使用相同的初始种子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat in_1 in_2</span><br><span class="line">a</span><br><span class="line">a1</span><br></pre></td></tr></table></figure>

<h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><p>按照官网安装两个<code>fuzzer</code>，并编译测试程序。</p>
<p><strong>honggfuzz：</strong></p>
<ul>
<li><pre><code class="c">docker <span class="built_in">run</span>  -itd --restart=always --name zyt_honggfuzz --privileged -v /data/honggfuzz/:/data -p <span class="number">30001</span>:<span class="number">22</span> zjuchenyuan/honggfuzz /bin/bashc
&lt;!--￼<span class="number">4</span>--&gt;
</code></pre>
</li>
</ul>
<p><strong>AFL++：</strong></p>
<ul>
<li><pre><code class="c">docker <span class="built_in">run</span>  -itd --restart=always --name zyt_aflpp --privileged -v /data/afl++/:/data -p <span class="number">30000</span>:<span class="number">22</span> aflplusplus/aflplusplus /bin/bash
&lt;!--￼<span class="number">5</span>--&gt;
</code></pre>
</li>
</ul>
<h2 id="二、对test-1进行测试"><a href="#二、对test-1进行测试" class="headerlink" title="二、对test_1进行测试"></a>二、对test_1进行测试</h2><h3 id="1、honggfuzz"><a href="#1、honggfuzz" class="headerlink" title="1、honggfuzz"></a>1、honggfuzz</h3><p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">honggfuzz -i input/ --output out/ -W out/crashes/ -s -w dict.txt -- ./test1_hong <span class="comment">//-o参数报错</span></span><br><span class="line"></span><br><span class="line">------------------------[  <span class="number">0</span> days <span class="number">00</span> hrs <span class="number">00</span> mins <span class="number">08</span> secs ]----------------------</span><br><span class="line">  Iterations : <span class="number">356</span></span><br><span class="line">  Mode [<span class="number">3</span>/<span class="number">3</span>] : Feedback Driven Mode</span><br><span class="line">      Target : ./test1_hong</span><br><span class="line">     Threads : <span class="number">1</span>, CPUs: <span class="number">2</span>, CPU%: <span class="number">104</span>% [<span class="number">52</span>%/CPU]</span><br><span class="line">       Speed : <span class="number">108</span>/sec [avg: <span class="number">44</span>]</span><br><span class="line">     Crashes : <span class="number">70</span> [unique: <span class="number">9</span>, blacklist: <span class="number">0</span>, verified: <span class="number">0</span>]</span><br><span class="line">    Timeouts : <span class="number">0</span> [<span class="number">10</span> sec]</span><br><span class="line"> Corpus Size : <span class="number">16</span>, <span class="built_in">max</span>: <span class="number">8192</span> bytes, init: <span class="number">2</span> files</span><br><span class="line">  Cov Update : <span class="number">0</span> days <span class="number">00</span> hrs <span class="number">00</span> mins <span class="number">01</span> secs ago</span><br><span class="line">    Coverage : edge: <span class="number">22</span>/<span class="number">22</span> [<span class="number">100</span>%] pc: <span class="number">0</span> cmp: <span class="number">319</span></span><br><span class="line">---------------------------------- [ LOGS ] ------------------/ honggfuzz <span class="number">2.0</span> /-</span><br></pre></td></tr></table></figure>

<p><strong>结果输出：</strong></p>
<p>如下所示，<code>Honggfuzz</code>的<code>crash</code>文件还包含一些其他的信息，如：崩溃信号、指令地址、指令的<code>AT&amp;T</code>汇编码、<code>call stack</code>的<code>hash</code>值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@de807c761e71:/data<span class="meta"># ls out/crashes/</span></span><br><span class="line">HONGGFUZZ.REPORT.TXT</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.1730949569</span>.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.1733f</span>1e06f.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.17728</span>a643c.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.1772e8</span>d49e.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.1773b</span>8140e.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.17b</span>55c53ac.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.17b</span>5b90c66.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.17b</span>6ed13b1.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br><span class="line">SIGSEGV.PC<span class="number">.428f</span>a3.STACK<span class="number">.17f</span>4119132.CODE<span class="number">.1</span>.ADDR<span class="number">.0</span>.INSTR.movl___$<span class="number">0x2a</span>,(%rdi).fuzz</span><br></pre></td></tr></table></figure>

<h3 id="2、AFL"><a href="#2、AFL" class="headerlink" title="2、AFL++"></a>2、AFL++</h3><p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[afl++]root@<span class="number">78950679</span>a281:/data<span class="meta"># afl-fuzz -i input/ -o out/ -x dict.txt -- ./test1_afl </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               american fuzzy lop ++<span class="number">3.01</span>a (<span class="keyword">default</span>) [fast] &#123;<span class="number">0</span>&#125;</span><br><span class="line">┌─ <span class="built_in">process</span> timing ────────────────────────────────────┬─ overall results ────┐</span><br><span class="line">│        <span class="built_in">run</span> time : <span class="number">0</span> days, <span class="number">0</span> hrs, <span class="number">0</span> <span class="built_in">min</span>, <span class="number">11</span> sec      │  cycles done : <span class="number">9</span>     │</span><br><span class="line">│   last <span class="keyword">new</span> path : none yet (odd, check syntax!)     │  total paths : <span class="number">2</span>     │</span><br><span class="line">│ last uniq crash : <span class="number">0</span> days, <span class="number">0</span> hrs, <span class="number">0</span> <span class="built_in">min</span>, <span class="number">8</span> sec       │ uniq crashes : <span class="number">10</span>    │</span><br><span class="line">│  last uniq hang : none seen yet                     │   uniq hangs : <span class="number">0</span>     │</span><br><span class="line">├─ cycle progress ───────────────────┬─ <span class="built_in">map</span> coverage ─┴──────────────────────┤</span><br><span class="line">│  now processing : <span class="number">0.40</span> (<span class="number">0.0</span>%)      │    <span class="built_in">map</span> density : <span class="number">6.25</span>% / <span class="number">6.25</span>%        │</span><br><span class="line">│ paths timed out : <span class="number">0</span> (<span class="number">0.00</span>%)        │ count coverage : <span class="number">1.00</span> bits/tuple      │</span><br><span class="line">├─ stage progress ───────────────────┼─ findings in depth ───────────────────┤</span><br><span class="line">│  now trying : havoc                │ favored paths : <span class="number">1</span> (<span class="number">50.00</span>%)            │</span><br><span class="line">│ stage execs : <span class="number">188</span>/<span class="number">256</span> (<span class="number">73.44</span>%)     │  <span class="keyword">new</span> edges on : <span class="number">1</span> (<span class="number">50.00</span>%)            │</span><br><span class="line">│ total execs : <span class="number">10.2</span>k                │ total crashes : <span class="number">10</span> (<span class="number">10</span> unique)        │</span><br><span class="line">│  exec speed : <span class="number">786.8</span>/sec            │  total tmouts : <span class="number">181</span> (<span class="number">12</span> unique)       │</span><br><span class="line">├─ fuzzing strategy yields ──────────┴───────────────┬─ path geometry ───────┤</span><br><span class="line">│   <span class="built_in">bit</span> flips : n/a, n/a, n/a                        │    levels : <span class="number">1</span>         │</span><br><span class="line">│  <span class="keyword">byte</span> flips : n/a, n/a, n/a                        │   pending : <span class="number">0</span>         │</span><br><span class="line">│ arithmetics : n/a, n/a, n/a                        │  pend fav : <span class="number">0</span>         │</span><br><span class="line">│  known ints : n/a, n/a, n/a                        │ own finds : <span class="number">0</span>         │</span><br><span class="line">│  dictionary : n/a, n/a, n/a                        │  imported : <span class="number">0</span>         │</span><br><span class="line">│havoc/splice : <span class="number">10</span>/<span class="number">9984</span>, <span class="number">0</span>/<span class="number">0</span>                         │ stability : <span class="number">100.00</span>%   │</span><br><span class="line">│   py/custom : <span class="number">0</span>/<span class="number">0</span>, <span class="number">0</span>/<span class="number">0</span>                             ├───────────────────────┘</span><br><span class="line">│        trim : n/a, n/a                             │          [cpu000:<span class="number">800</span>%]</span><br><span class="line">└────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">+++ Testing aborted by user +++</span><br><span class="line">[+] We<span class="number">'</span>re done here. Have a nice day!</span><br></pre></td></tr></table></figure>

<p><strong>结果输出：</strong></p>
<p>如下所示，<code>AFL++</code>输出的<code>crash</code>文件包含信号（<code>SIGILL</code>）、<code>crash</code>文件的父文件、变异方式等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[afl++]root@<span class="number">78950679</span>a281:/data<span class="meta"># ls out/default/crashes/</span></span><br><span class="line">README.txt                                             id:<span class="number">000005</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">1323</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">id:<span class="number">000000</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">419</span>,op:havoc,rep:<span class="number">16</span>   id:<span class="number">000006</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">1576</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">id:<span class="number">000001</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">654</span>,op:havoc,rep:<span class="number">16</span>   id:<span class="number">000007</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">1719</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">id:<span class="number">000002</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">787</span>,op:havoc,rep:<span class="number">8</span>    id:<span class="number">000008</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">2568</span>,op:havoc,rep:<span class="number">4</span></span><br><span class="line">id:<span class="number">000003</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">942</span>,op:havoc,rep:<span class="number">16</span>   id:<span class="number">000009</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">2872</span>,op:havoc,rep:<span class="number">16</span></span><br><span class="line">id:<span class="number">000004</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">1098</span>,op:havoc,rep:<span class="number">16</span></span><br></pre></td></tr></table></figure>

<h2 id="三、对test-2测试"><a href="#三、对test-2测试" class="headerlink" title="三、对test_2测试"></a>三、对test_2测试</h2><p>第一次使用编译源码的方式来得到二进制并测试，但是<code>AFL++</code>只能挖到一个<code>unique crash</code>，应该是插桩的位置太少了（由前面源码编译的日志可知），所以第二次直接用<code>gcc</code>编译得到二进制，然后利用两个<code>fuzzer</code>的二进制模式来进行<code>fuzz</code>。</p>
<h3 id="测试一（源码编译）"><a href="#测试一（源码编译）" class="headerlink" title="测试一（源码编译）"></a>测试一（源码编译）</h3><h3 id="1-honggfuzz"><a href="#1-honggfuzz" class="headerlink" title="1. honggfuzz"></a>1. honggfuzz</h3><p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">------------------------[  <span class="number">0</span> days <span class="number">00</span> hrs <span class="number">00</span> mins <span class="number">30</span> secs ]----------------------</span><br><span class="line">  Iterations : <span class="number">225</span></span><br><span class="line">  Mode [<span class="number">3</span>/<span class="number">3</span>] : Feedback Driven Mode</span><br><span class="line">      Target : ./test2_hong</span><br><span class="line">     Threads : <span class="number">1</span>, CPUs: <span class="number">2</span>, CPU%: <span class="number">200</span>% [<span class="number">100</span>%/CPU]</span><br><span class="line">       Speed : <span class="number">7</span>/sec [avg: <span class="number">7</span>]</span><br><span class="line">     Crashes : <span class="number">50</span> [unique: <span class="number">1</span>, blacklist: <span class="number">0</span>, verified: <span class="number">0</span>]</span><br><span class="line">    Timeouts : <span class="number">0</span> [<span class="number">10</span> sec]</span><br><span class="line"> Corpus Size : <span class="number">15</span>, <span class="built_in">max</span>: <span class="number">8192</span> bytes, init: <span class="number">2</span> files</span><br><span class="line">  Cov Update : <span class="number">0</span> days <span class="number">00</span> hrs <span class="number">00</span> mins <span class="number">03</span> secs ago</span><br><span class="line">    Coverage : edge: <span class="number">23</span>/<span class="number">24</span> [<span class="number">95</span>%] pc: <span class="number">1</span> cmp: <span class="number">319</span></span><br><span class="line">---------------------------------- [ LOGS ] ------------------/ honggfuzz <span class="number">2.0</span> /-</span><br></pre></td></tr></table></figure>

<p><strong>结果输出：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@de807c761e71:/data<span class="meta"># ls out/crashes2/</span></span><br><span class="line">HONGGFUZZ.REPORT.TXT  SIGABRT.PC<span class="number">.7f</span>fff7a42428.STACK.d38a05301.CODE.<span class="number">-6.</span>ADDR<span class="number">.0</span>.INSTR.cmp____$<span class="number">0xfffffffffffff000</span>,%rax.fuzz</span><br></pre></td></tr></table></figure>

<h3 id="2、AFL-1"><a href="#2、AFL-1" class="headerlink" title="2、AFL++"></a>2、AFL++</h3><p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> afl-fuzz -i input/ -o out2/ -x dict.txt -- ./test2_afl</span><br><span class="line"> </span><br><span class="line"> 						american fuzzy lop ++<span class="number">3.01</span>a (<span class="keyword">default</span>) [fast] &#123;<span class="number">0</span>&#125;</span><br><span class="line">┌─ <span class="built_in">process</span> timing ────────────────────────────────────┬─ overall results ────┐</span><br><span class="line">│        <span class="built_in">run</span> time : <span class="number">0</span> days, <span class="number">0</span> hrs, <span class="number">1</span> <span class="built_in">min</span>, <span class="number">30</span> sec      │  cycles done : <span class="number">65</span>    │</span><br><span class="line">│   last <span class="keyword">new</span> path : none yet (odd, check syntax!)     │  total paths : <span class="number">2</span>     │</span><br><span class="line">│ last uniq crash : <span class="number">0</span> days, <span class="number">0</span> hrs, <span class="number">1</span> <span class="built_in">min</span>, <span class="number">30</span> sec      │ uniq crashes : <span class="number">1</span>     │</span><br><span class="line">│  last uniq hang : none seen yet                     │   uniq hangs : <span class="number">0</span>     │</span><br><span class="line">├─ cycle progress ───────────────────┬─ <span class="built_in">map</span> coverage ─┴──────────────────────┤</span><br><span class="line">│  now processing : <span class="number">0.264</span> (<span class="number">0.0</span>%)     │    <span class="built_in">map</span> density : <span class="number">6.25</span>% / <span class="number">6.25</span>%        │</span><br><span class="line">│ paths timed out : <span class="number">0</span> (<span class="number">0.00</span>%)        │ count coverage : <span class="number">1.00</span> bits/tuple      │</span><br><span class="line">├─ stage progress ───────────────────┼─ findings in depth ───────────────────┤</span><br><span class="line">│  now trying : havoc                │ favored paths : <span class="number">1</span> (<span class="number">50.00</span>%)            │</span><br><span class="line">│ stage execs : <span class="number">40</span>/<span class="number">256</span> (<span class="number">15.62</span>%)      │  <span class="keyword">new</span> edges on : <span class="number">1</span> (<span class="number">50.00</span>%)            │</span><br><span class="line">│ total execs : <span class="number">67.4</span>k                │ total crashes : <span class="number">1</span> (<span class="number">1</span> unique)          │</span><br><span class="line">│  exec speed : <span class="number">678.6</span>/sec            │  total tmouts : <span class="number">1485</span> (<span class="number">3</span> unique)       │</span><br><span class="line">├─ fuzzing strategy yields ──────────┴───────────────┬─ path geometry ───────┤</span><br><span class="line">│   <span class="built_in">bit</span> flips : n/a, n/a, n/a                        │    levels : <span class="number">1</span>         │</span><br><span class="line">│  <span class="keyword">byte</span> flips : n/a, n/a, n/a                        │   pending : <span class="number">0</span>         │</span><br><span class="line">│ arithmetics : n/a, n/a, n/a                        │  pend fav : <span class="number">0</span>         │</span><br><span class="line">│  known ints : n/a, n/a, n/a                        │ own finds : <span class="number">0</span>         │</span><br><span class="line">│  dictionary : n/a, n/a, n/a                        │  imported : <span class="number">0</span>         │</span><br><span class="line">│havoc/splice : <span class="number">1</span>/<span class="number">67.3</span>k, <span class="number">0</span>/<span class="number">0</span>                         │ stability : <span class="number">100.00</span>%   │</span><br><span class="line">│   py/custom : <span class="number">0</span>/<span class="number">0</span>, <span class="number">0</span>/<span class="number">0</span>                             ├───────────────────────┘</span><br><span class="line">│        trim : n/a, n/a                             │          [cpu000:<span class="number">750</span>%]</span><br><span class="line">└────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">+++ Testing aborted by user +++</span><br></pre></td></tr></table></figure>

<p><strong>结果输出：</strong></p>
<p>如下所示，AFL++输出的crash文件包含信号（SIGABRT）、crash文件的父文件、变异方式等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[afl++]root@<span class="number">78950679</span>a281:/data<span class="meta"># ls out2/default/crashes/</span></span><br><span class="line">README.txt  id:<span class="number">000000</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">140</span>,op:havoc,rep:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<h3 id="测试二（二进制）"><a href="#测试二（二进制）" class="headerlink" title="测试二（二进制）"></a>测试二（二进制）</h3><h3 id="1、honggfuzz-1"><a href="#1、honggfuzz-1" class="headerlink" title="1、honggfuzz"></a>1、honggfuzz</h3><p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">honggfuzz -i input/ --output out/ -W out/crashes2/ -s -w dict.txt -- ./a.out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------[  <span class="number">0</span> days <span class="number">00</span> hrs <span class="number">00</span> mins <span class="number">10</span> secs ]----------------------</span><br><span class="line">  Iterations : <span class="number">1316</span> [<span class="number">1.32</span>k]</span><br><span class="line">  Mode [<span class="number">3</span>/<span class="number">3</span>] : Feedback Driven Mode</span><br><span class="line">      Target : ./a.out</span><br><span class="line">     Threads : <span class="number">1</span>, CPUs: <span class="number">2</span>, CPU%: <span class="number">105</span>% [<span class="number">52</span>%/CPU]</span><br><span class="line">       Speed : <span class="number">107</span>/sec [avg: <span class="number">131</span>]</span><br><span class="line">     Crashes : <span class="number">95</span> [unique: <span class="number">1</span>, blacklist: <span class="number">0</span>, verified: <span class="number">0</span>]</span><br><span class="line">    Timeouts : <span class="number">0</span> [<span class="number">10</span> sec]</span><br><span class="line"> Corpus Size : <span class="number">1</span>, <span class="built_in">max</span>: <span class="number">8192</span> bytes, init: <span class="number">2</span> files</span><br><span class="line">  Cov Update : <span class="number">0</span> days <span class="number">00</span> hrs <span class="number">00</span> mins <span class="number">10</span> secs ago</span><br><span class="line">    Coverage : edge: <span class="number">0</span>/<span class="number">0</span> [<span class="number">0</span>%] pc: <span class="number">0</span> cmp: <span class="number">0</span></span><br><span class="line">---------------------------------- [ LOGS ] ------------------/ honggfuzz <span class="number">2.0</span> /-</span><br></pre></td></tr></table></figure>

<p><strong>结果输出：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@de807c761e71:/data<span class="meta"># ls out/crashes2/</span></span><br><span class="line">HONGGFUZZ.REPORT.TXT  SIGABRT.PC<span class="number">.7f</span>fff7a42428.STACK.cfb95914e.CODE.<span class="number">-6.</span>ADDR<span class="number">.0</span>.INSTR.cmp____$<span class="number">0xfffffffffffff000</span>,%rax.fuzz</span><br></pre></td></tr></table></figure>

<h3 id="2、AFL-2"><a href="#2、AFL-2" class="headerlink" title="2、AFL++"></a>2、AFL++</h3><p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> afl-fuzz -i input/ -o out2/ -x dict.txt -Q -- ./a.out</span><br><span class="line">   </span><br><span class="line">               american fuzzy lop ++<span class="number">3.01</span>a (<span class="keyword">default</span>) [fast] &#123;<span class="number">0</span>&#125;</span><br><span class="line">┌─ <span class="built_in">process</span> timing ────────────────────────────────────┬─ overall results ────┐</span><br><span class="line">│        <span class="built_in">run</span> time : <span class="number">0</span> days, <span class="number">0</span> hrs, <span class="number">0</span> <span class="built_in">min</span>, <span class="number">10</span> sec      │  cycles done : <span class="number">11</span>    │</span><br><span class="line">│   last <span class="keyword">new</span> path : none yet (odd, check syntax!)     │  total paths : <span class="number">2</span>     │</span><br><span class="line">│ last uniq crash : <span class="number">0</span> days, <span class="number">0</span> hrs, <span class="number">0</span> <span class="built_in">min</span>, <span class="number">7</span> sec       │ uniq crashes : <span class="number">10</span>    │</span><br><span class="line">│  last uniq hang : none seen yet                     │   uniq hangs : <span class="number">0</span>     │</span><br><span class="line">├─ cycle progress ───────────────────┬─ <span class="built_in">map</span> coverage ─┴──────────────────────┤</span><br><span class="line">│  now processing : <span class="number">0</span>*<span class="number">48</span> (<span class="number">0.0</span>%)      │    <span class="built_in">map</span> density : <span class="number">0.05</span>% / <span class="number">0.05</span>%        │</span><br><span class="line">│ paths timed out : <span class="number">0</span> (<span class="number">0.00</span>%)        │ count coverage : <span class="number">1.00</span> bits/tuple      │</span><br><span class="line">├─ stage progress ───────────────────┼─ findings in depth ───────────────────┤</span><br><span class="line">│  now trying : havoc                │ favored paths : <span class="number">1</span> (<span class="number">50.00</span>%)            │</span><br><span class="line">│ stage execs : <span class="number">167</span>/<span class="number">192</span> (<span class="number">86.98</span>%)     │  <span class="keyword">new</span> edges on : <span class="number">1</span> (<span class="number">50.00</span>%)            │</span><br><span class="line">│ total execs : <span class="number">9217</span>                 │ total crashes : <span class="number">10</span> (<span class="number">10</span> unique)        │</span><br><span class="line">│  exec speed : <span class="number">956.0</span>/sec            │  total tmouts : <span class="number">167</span> (<span class="number">10</span> unique)       │</span><br><span class="line">├─ fuzzing strategy yields ──────────┴───────────────┬─ path geometry ───────┤</span><br><span class="line">│   <span class="built_in">bit</span> flips : n/a, n/a, n/a                        │    levels : <span class="number">1</span>         │</span><br><span class="line">│  <span class="keyword">byte</span> flips : n/a, n/a, n/a                        │   pending : <span class="number">0</span>         │</span><br><span class="line">│ arithmetics : n/a, n/a, n/a                        │  pend fav : <span class="number">1</span>         │</span><br><span class="line">│  known ints : n/a, n/a, n/a                        │ own finds : <span class="number">0</span>         │</span><br><span class="line">│  dictionary : n/a, n/a, n/a                        │  imported : <span class="number">0</span>         │</span><br><span class="line">│havoc/splice : <span class="number">10</span>/<span class="number">9024</span>, <span class="number">0</span>/<span class="number">0</span>                         │ stability : <span class="number">100.00</span>%   │</span><br><span class="line">│   py/custom : <span class="number">0</span>/<span class="number">0</span>, <span class="number">0</span>/<span class="number">0</span>                             ├───────────────────────┘</span><br><span class="line">│        trim : n/a, n/a                             │          [cpu000:<span class="number">100</span>%]</span><br><span class="line">└────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">+++ Testing aborted by user +++</span><br><span class="line">[+] We<span class="number">'</span>re done here. Have a nice day!</span><br></pre></td></tr></table></figure>

<p><strong>测试结果：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[afl++]root@<span class="number">78950679</span>a281:/data<span class="meta"># ls out2/default/crashes/</span></span><br><span class="line">README.txt                                            id:<span class="number">000005</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">1114</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">id:<span class="number">000000</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">211</span>,op:havoc,rep:<span class="number">8</span>   id:<span class="number">000006</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">1427</span>,op:havoc,rep:<span class="number">4</span></span><br><span class="line">id:<span class="number">000001</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">360</span>,op:havoc,rep:<span class="number">16</span>  id:<span class="number">000007</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">1570</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">id:<span class="number">000002</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">552</span>,op:havoc,rep:<span class="number">16</span>  id:<span class="number">000008</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">1779</span>,op:havoc,rep:<span class="number">4</span></span><br><span class="line">id:<span class="number">000003</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">789</span>,op:havoc,rep:<span class="number">16</span>  id:<span class="number">000009</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">2478</span>,op:havoc,rep:<span class="number">16</span></span><br><span class="line">id:<span class="number">000004</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">918</span>,op:havoc,rep:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p><code>honggfuzz</code>挖掘出的<code>crash</code>与<code>AFL ++</code>挖掘出的<code>crash</code>崩溃信号一致，但<code>honggfuzz</code>只有一个<code>unique crash</code>而<code>AFL++</code>有10个<code>unique crash</code>。<code>AFL</code>及其派生<code>fuzz</code>工具是检查不同的<code>crash</code>输入是否执行了相同的边来确定其唯一性。也即，不同的<code>crash</code>输入如果执行了相同的边，属于相同的崩溃。但若执行了不同的边，属于不同的崩溃。<code>Honggfuzz</code>的策略是，程序发生崩溃时，对<code>stack frame</code>进行分析，计算其<code>hash</code>值，以此作为崩溃唯一性的判断标准。</p>
<p>如下所示，对于<code>test1.c</code>来说，发生崩溃时的调用栈是<code>main-&gt;vuln</code>；但是发生与<code>main</code>函数的不同地址处，所以<code>honggfuzz</code>将其识别为不同的崩溃。</p>
<p><strong>id_1：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">     <span class="number">0x428f92</span> &lt;vuln+<span class="number">18</span>&gt;        call   <span class="number">0x429fc0</span> &lt;__sanitizer_cov_trace_pc_guard&gt;</span><br><span class="line">     <span class="number">0x428f97</span> &lt;vuln+<span class="number">23</span>&gt;        mov    QWORD PTR [rbp<span class="number">-0x8</span>], <span class="number">0x0</span></span><br><span class="line">     <span class="number">0x428f9f</span> &lt;vuln+<span class="number">31</span>&gt;        mov    rdi, QWORD PTR [rbp<span class="number">-0x8</span>]</span><br><span class="line"> →   <span class="number">0x428fa3</span> &lt;vuln+<span class="number">35</span>&gt;        mov    DWORD PTR [rdi], <span class="number">0x2a</span></span><br><span class="line">     <span class="number">0x428fa9</span> &lt;vuln+<span class="number">41</span>&gt;        add    rsp, <span class="number">0x10</span></span><br><span class="line">     <span class="number">0x428fad</span> &lt;vuln+<span class="number">45</span>&gt;        pop    rbp</span><br><span class="line">     <span class="number">0x428fae</span> &lt;vuln+<span class="number">46</span>&gt;        ret    </span><br><span class="line">     <span class="number">0x428faf</span>                  nop    </span><br><span class="line">     <span class="number">0x428fb0</span> &lt;main+<span class="number">0</span>&gt;         push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: "test1_hong", stopped 0x428fa3 in vuln (), reason: SIGSEGV</span><br><span class="line">──────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x428fa3</span> → vuln()</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x4290bb</span> → main()</span><br><span class="line">──────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">0x0000000000428fa3</span> <span class="function">in <span class="title">vuln</span> <span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p><strong>id_2：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">     <span class="number">0x428f92</span> &lt;vuln+<span class="number">18</span>&gt;        call   <span class="number">0x429fc0</span> &lt;__sanitizer_cov_trace_pc_guard&gt;</span><br><span class="line">     <span class="number">0x428f97</span> &lt;vuln+<span class="number">23</span>&gt;        mov    QWORD PTR [rbp<span class="number">-0x8</span>], <span class="number">0x0</span></span><br><span class="line">     <span class="number">0x428f9f</span> &lt;vuln+<span class="number">31</span>&gt;        mov    rdi, QWORD PTR [rbp<span class="number">-0x8</span>]</span><br><span class="line"> →   <span class="number">0x428fa3</span> &lt;vuln+<span class="number">35</span>&gt;        mov    DWORD PTR [rdi], <span class="number">0x2a</span></span><br><span class="line">     <span class="number">0x428fa9</span> &lt;vuln+<span class="number">41</span>&gt;        add    rsp, <span class="number">0x10</span></span><br><span class="line">     <span class="number">0x428fad</span> &lt;vuln+<span class="number">45</span>&gt;        pop    rbp</span><br><span class="line">     <span class="number">0x428fae</span> &lt;vuln+<span class="number">46</span>&gt;        ret    </span><br><span class="line">     <span class="number">0x428faf</span>                  nop    </span><br><span class="line">     <span class="number">0x428fb0</span> &lt;main+<span class="number">0</span>&gt;         push   rbp</span><br><span class="line">───────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: "test1_hong", stopped 0x428fa3 in vuln (), reason: SIGSEGV</span><br><span class="line">───────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x428fa3</span> → vuln()</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x429338</span> → main()</span><br><span class="line">─────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">0x0000000000428fa3</span> <span class="function">in <span class="title">vuln</span> <span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>但是对于<code>test2.c</code>来说，我们查看发生崩溃时的调用栈可知，当前程序执行状态不在我们的程序中，而是在<code>libc</code>中。这是由于<code>main-&gt;vuln(free)-&gt;main-&gt;free</code>，也即最后崩溃时的调用栈是<code>main-&gt;free</code>。所以所有的崩溃输入在<code>honggfuzz</code>看来都是相同的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x7ffff7a20fab</span> &lt;raise+<span class="number">187</span>&gt;      mov    edi, <span class="number">0x2</span></span><br><span class="line">   <span class="number">0x7ffff7a20fb0</span> &lt;raise+<span class="number">192</span>&gt;      mov    eax, <span class="number">0xe</span></span><br><span class="line">   <span class="number">0x7ffff7a20fb5</span> &lt;raise+<span class="number">197</span>&gt;      syscall </span><br><span class="line"> → <span class="number">0x7ffff7a20fb7</span> &lt;raise+<span class="number">199</span>&gt;      mov    rcx, QWORD PTR [rsp+<span class="number">0x108</span>]</span><br><span class="line">   <span class="number">0x7ffff7a20fbf</span> &lt;raise+<span class="number">207</span>&gt;      <span class="keyword">xor</span>    rcx, QWORD PTR fs:<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x7ffff7a20fc8</span> &lt;raise+<span class="number">216</span>&gt;      mov    eax, r8d</span><br><span class="line">   <span class="number">0x7ffff7a20fcb</span> &lt;raise+<span class="number">219</span>&gt;      jne    <span class="number">0x7ffff7a20fec</span> &lt;__GI_raise+<span class="number">252</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7a20fcd</span> &lt;raise+<span class="number">221</span>&gt;      add    rsp, <span class="number">0x118</span></span><br><span class="line">   <span class="number">0x7ffff7a20fd4</span> &lt;raise+<span class="number">228</span>&gt;      ret    </span><br><span class="line">─────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#<span class="number">0</span>] Id <span class="number">1</span>, Name: <span class="string">"a.out"</span>, stopped <span class="number">0x7ffff7a20fb7</span> in __GI_raise (), reason: SIGABRT</span><br><span class="line">──────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x7ffff7a20fb7</span> → __GI_raise(sig=<span class="number">0x6</span>)</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x7ffff7a22921</span> → __GI_abort()</span><br><span class="line">[#<span class="number">2</span>] <span class="number">0x7ffff7a6b967</span> → __libc_message(action=do_abort, fmt=<span class="number">0x7ffff7b98b0d</span> <span class="string">"%s\n"</span>)</span><br><span class="line">[#<span class="number">3</span>] <span class="number">0x7ffff7a729da</span> → malloc_printerr(str=<span class="number">0x7ffff7b9a778</span> <span class="string">"free(): double free detected in tcache 2"</span>)</span><br><span class="line">[#<span class="number">4</span>] <span class="number">0x7ffff7a7a20d</span> → _int_free(have_lock=<span class="number">0x0</span>, p=<span class="number">0x555555559250</span>, av=<span class="number">0x7ffff7dcdc40</span> &lt;main_arena&gt;)</span><br><span class="line">[#<span class="number">5</span>] <span class="number">0x7ffff7a7a20d</span> → __GI___libc_free(mem=<span class="number">0x555555559260</span>)</span><br><span class="line">[#<span class="number">6</span>] <span class="number">0x5555555552e8</span> → main()</span><br><span class="line">────────────────────────────────────────────────────────────────────</span><br><span class="line">__GI_raise (sig=sig@entry=<span class="number">0x6</span>) at ../sysdeps/unix/sysv/linux/raise.c:<span class="number">51</span></span><br><span class="line"><span class="number">51</span>	../sysdeps/unix/sysv/linux/raise.c: No such file <span class="keyword">or</span> directory.</span><br></pre></td></tr></table></figure>

<p>本文主要是为了说明两个<code>fuzzer</code>判定<code>unique crash</code>的不同之处。但从<code>test1.c</code>的测试结果来看，<code>AFL++</code>的判定标准并不合理，实际的错误与输入数据无关，输入并不会影响漏洞本身。</p>
<h2 id="四、exploitable"><a href="#四、exploitable" class="headerlink" title="四、exploitable"></a>四、exploitable</h2><p>这是<code>gdb</code>的一个插件，它也使用了程序崩溃时<code>stack frame</code>的<code>hash</code>值作为<code>crash</code>分类的标准。</p>
<p><strong>test1.c：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[#<span class="number">0</span>] <span class="number">0x428fa3</span> → vuln()</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x4290bb</span> → main()</span><br><span class="line">─────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">0x0000000000428fa3</span> <span class="function">in <span class="title">vuln</span> <span class="params">()</span></span></span><br><span class="line">gef➤  exploitable </span><br><span class="line">Description: Access violation near <span class="literal">NULL</span> on destination operand</span><br><span class="line">Short description: DestAvNearNull (<span class="number">15</span>/<span class="number">22</span>)</span><br><span class="line">Hash: <span class="number">4</span>c033e9bab954200ad1a1c2f7e900862<span class="number">.4</span>c033e9bab954200ad1a1c2f7e900862</span><br><span class="line">Exploitability Classification: PROBABLY_EXPLOITABLE</span><br><span class="line">Explanation: The target crashed on an access violation at an address matching the destination operand of the instruction. This likely indicates a <span class="built_in">write</span> access violation, which means the attacker may control <span class="built_in">write</span> address <span class="keyword">and</span>/<span class="keyword">or</span> value. However, it there is a chance it could be a <span class="literal">NULL</span> dereference.</span><br><span class="line">Other tags: AccessViolation (<span class="number">21</span>/<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p><strong>test2.c：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[#<span class="number">0</span>] <span class="number">0x7ffff7a20fb7</span> → __GI_raise(sig=<span class="number">0x6</span>)</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x7ffff7a22921</span> → __GI_abort()</span><br><span class="line">[#<span class="number">2</span>] <span class="number">0x7ffff7a6b967</span> → __libc_message(action=do_abort, fmt=<span class="number">0x7ffff7b98b0d</span> <span class="string">"%s\n"</span>)</span><br><span class="line">[#<span class="number">3</span>] <span class="number">0x7ffff7a729da</span> → malloc_printerr(str=<span class="number">0x7ffff7b9a778</span> <span class="string">"free(): double free detected in tcache 2"</span>)</span><br><span class="line">[#<span class="number">4</span>] <span class="number">0x7ffff7a7a20d</span> → _int_free(have_lock=<span class="number">0x0</span>, p=<span class="number">0x555555559250</span>, av=<span class="number">0x7ffff7dcdc40</span> &lt;main_arena&gt;)</span><br><span class="line">[#<span class="number">5</span>] <span class="number">0x7ffff7a7a20d</span> → __GI___libc_free(mem=<span class="number">0x555555559260</span>)</span><br><span class="line">[#<span class="number">6</span>] <span class="number">0x5555555552e8</span> → main()</span><br><span class="line">───────────────────────────────────────────────────────────────────────────</span><br><span class="line">__GI_raise (sig=sig@entry=<span class="number">0x6</span>) at ../sysdeps/unix/sysv/linux/raise.c:<span class="number">51</span></span><br><span class="line"><span class="number">51</span>	../sysdeps/unix/sysv/linux/raise.c: No such file <span class="keyword">or</span> directory.</span><br><span class="line">gef➤  exploitable </span><br><span class="line">Description: Heap error</span><br><span class="line">Short description: HeapError (<span class="number">10</span>/<span class="number">22</span>)</span><br><span class="line">Hash: e34fddc8b3624c6925411059ef0e7e48<span class="number">.4f</span>2fa546c07f6ab6315cb75f6168e245</span><br><span class="line">Exploitability Classification: EXPLOITABLE</span><br><span class="line">Explanation: The target's backtrace indicates that libc has detected a heap error or that the target was executing a heap function when it stopped. This could be due to heap corruption, passing a bad pointer to a heap function such as free(), etc. Since heap errors might include buffer overflows, use-after-free situations, etc. they are generally considered exploitable.</span><br><span class="line">Other tags: AbortSignal (<span class="number">20</span>/<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<h2 id="五、CrashWalk"><a href="#五、CrashWalk" class="headerlink" title="五、CrashWalk"></a>五、CrashWalk</h2><p><code>CrashWalk</code>可以自动化运行<code>exploitable</code>插件，对<code>crash</code>进行批量分析，并将结果保存至<code>db</code>文件。</p>
<p><strong>test1.c：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/crashwalk/bin/cwtriage -root ./out/<span class="keyword">default</span>/crashes/ -match id -- ./test1_afl</span><br></pre></td></tr></table></figure>

<p>查看db文件</p>
<p>按理说，<code>crashwalk</code>应该将10个<code>crash</code>分为10种类型才对，不该是一种类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@vm:/data/afl++# /root/crashwalk/bin/cwdump ./crashwalk.db </span><br><span class="line">(<span class="number">1</span> of <span class="number">10</span>) - Hash: b285fc0ef368db2a018e400ea5c1d9f1.b285fc0ef368db2a018e400ea5c1d9f1</span><br><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: out/<span class="keyword">default</span>/crashes/id:<span class="number">000004</span>,sig:<span class="number">04</span>,src:<span class="number">000000</span>,time:<span class="number">1098</span>,op:havoc,rep:<span class="number">16</span></span><br><span class="line">SHA1: <span class="number">1b</span>6453892473a467d07372d45eb05abc2031647a</span><br><span class="line">Classification: EXPLOITABLE</span><br><span class="line">Hash: b285fc0ef368db2a018e400ea5c1d9f1.b285fc0ef368db2a018e400ea5c1d9f1</span><br><span class="line">Command: ./test1_afl</span><br><span class="line">Faulting Frame:</span><br><span class="line">   main @ <span class="number">0x00000000004013fe</span>: in /data/afl++/test1_afl</span><br><span class="line">Disassembly:</span><br><span class="line">   <span class="number">0x00000000004013ef</span>: mov rcx,QWORD PTR [r14]</span><br><span class="line">   <span class="number">0x00000000004013f2</span>: mov dl,BYTE PTR [rcx+rax*<span class="number">1</span>]</span><br><span class="line">   <span class="number">0x00000000004013f5</span>: add dl,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x00000000004013f8</span>: adc dl,<span class="number">0x0</span></span><br><span class="line">   <span class="number">0x00000000004013fb</span>: mov BYTE PTR [rcx+rax*<span class="number">1</span>],dl</span><br><span class="line">=&gt; <span class="number">0x00000000004013fe</span>: ud2</span><br><span class="line">Stack Head (<span class="number">1</span> entries):</span><br><span class="line">   main                      @ <span class="number">0x00000000004013fe</span>: in /data/afl++/test1_afl</span><br><span class="line">Registers:</span><br><span class="line">rax=<span class="number">0x0000000000000006</span> rbx=<span class="number">0x00007fffffffe310</span> rcx=<span class="number">0x0000000000406190</span> rdx=<span class="number">0x00007ffff7dcf801</span> </span><br><span class="line">rsi=<span class="number">0x00007fffffffe310</span> rdi=<span class="number">0x00007ffff7dce760</span> rbp=<span class="number">0x0000000000403b90</span> rsp=<span class="number">0x00007fffffffe310</span> </span><br><span class="line"> r8=<span class="number">0x0000000000000000</span>  r9=<span class="number">0x0000000000000000</span> r10=<span class="number">0x0000000000607010</span> r11=<span class="number">0x0000000000000000</span> </span><br><span class="line">r12=<span class="number">0x0000000000401220</span> r13=<span class="number">0x00007fffffffe460</span> r14=<span class="number">0x0000000000406128</span> r15=<span class="number">0x0000000000000000</span> </span><br><span class="line">rip=<span class="number">0x00000000004013fe</span> efl=<span class="number">0x0000000000010202</span>  cs=<span class="number">0x0000000000000033</span>  ss=<span class="number">0x000000000000002b</span> </span><br><span class="line"> ds=<span class="number">0x0000000000000000</span>  es=<span class="number">0x0000000000000000</span>  fs=<span class="number">0x0000000000000000</span>  gs=<span class="number">0x0000000000000000</span> </span><br><span class="line">Extra Data:</span><br><span class="line">   Description: Bad instruction</span><br><span class="line">   Short description: BadInstruction (<span class="number">9</span>/<span class="number">22</span>)</span><br><span class="line">   Explanation: The target tried to execute a malformed <span class="keyword">or</span> privileged instruction. This may indicate that the control flow is tainted.</span><br><span class="line">---END SUMMARY---</span><br></pre></td></tr></table></figure>

<p><strong>test2.c：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/crashwalk/bin/cwtriage -root ./out2/<span class="keyword">default</span>/crashes/ -match id -- ./a.out</span><br></pre></td></tr></table></figure>

<p>查看db文件：</p>
<p>由下可知，<code>crashwalk</code>将10个<code>crash</code>分类为同一类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root@vm:/data/afl++# /root/crashwalk/bin/cwdump ./crashwalk.db </span><br><span class="line">(<span class="number">1</span> of <span class="number">10</span>) - Hash: <span class="number">9b</span>d3e28a685f34691518e98a9108508a<span class="number">.1b</span>6f925959746a071401ff0dac31e6d4</span><br><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: out2/<span class="keyword">default</span>/crashes/id:<span class="number">000004</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">918</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">SHA1: <span class="number">58444</span>a509ad03bdb1afc44f126f7a1650717ddd1</span><br><span class="line">Classification: EXPLOITABLE</span><br><span class="line">Hash: <span class="number">9b</span>d3e28a685f34691518e98a9108508a<span class="number">.1b</span>6f925959746a071401ff0dac31e6d4</span><br><span class="line">Command: ./a.out</span><br><span class="line">Faulting Frame:</span><br><span class="line">   main @ <span class="number">0x00005555555552e8</span>: in /data/afl++/a.out</span><br><span class="line">Disassembly:</span><br><span class="line">   <span class="number">0x00007ffff7a20fa6</span>: <span class="keyword">xor</span> edx,edx</span><br><span class="line">   <span class="number">0x00007ffff7a20fa8</span>: mov rsi,r9</span><br><span class="line">   <span class="number">0x00007ffff7a20fab</span>: mov edi,<span class="number">0x2</span></span><br><span class="line">   <span class="number">0x00007ffff7a20fb0</span>: mov eax,<span class="number">0xe</span></span><br><span class="line">   <span class="number">0x00007ffff7a20fb5</span>: syscall</span><br><span class="line">=&gt; <span class="number">0x00007ffff7a20fb7</span>: mov rcx,QWORD PTR [rsp+<span class="number">0x108</span>]</span><br><span class="line">   <span class="number">0x00007ffff7a20fbf</span>: <span class="keyword">xor</span> rcx,QWORD PTR fs:<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x00007ffff7a20fc8</span>: mov eax,r8d</span><br><span class="line">   <span class="number">0x00007ffff7a20fcb</span>: jne <span class="number">0x7ffff7a20fec</span> &lt;__GI_raise+<span class="number">252</span>&gt;</span><br><span class="line">   <span class="number">0x00007ffff7a20fcd</span>: add rsp,<span class="number">0x118</span></span><br><span class="line">Stack Head (<span class="number">7</span> entries):</span><br><span class="line">   __GI_raise                @ <span class="number">0x00007ffff7a20fb7</span>: in (BL)</span><br><span class="line">   __GI_abort                @ <span class="number">0x00007ffff7a22921</span>: in (BL)</span><br><span class="line">   __libc_message            @ <span class="number">0x00007ffff7a6b967</span>: in (BL)</span><br><span class="line">   malloc_printerr           @ <span class="number">0x00007ffff7a729da</span>: in (BL)</span><br><span class="line">   _int_free                 @ <span class="number">0x00007ffff7a7a20d</span>: in (BL)</span><br><span class="line">   __GI___libc_free          @ <span class="number">0x00007ffff7a7a20d</span>: in (BL)</span><br><span class="line">   main                      @ <span class="number">0x00005555555552e8</span>: in /data/afl++/a.out</span><br><span class="line">Registers:</span><br><span class="line">rax=<span class="number">0x0000000000000000</span> rbx=<span class="number">0x00007fffffffe180</span> rcx=<span class="number">0x00007ffff7a20fb7</span> rdx=<span class="number">0x0000000000000000</span> </span><br><span class="line">rsi=<span class="number">0x00007fffffffdf10</span> rdi=<span class="number">0x0000000000000002</span> rbp=<span class="number">0x00007fffffffe280</span> rsp=<span class="number">0x00007fffffffdf10</span> </span><br><span class="line"> r8=<span class="number">0x0000000000000000</span>  r9=<span class="number">0x00007fffffffdf10</span> r10=<span class="number">0x0000000000000008</span> r11=<span class="number">0x0000000000000246</span> </span><br><span class="line">r12=<span class="number">0x00007fffffffe180</span> r13=<span class="number">0x0000000000001000</span> r14=<span class="number">0x0000000000000000</span> r15=<span class="number">0x0000000000000030</span> </span><br><span class="line">rip=<span class="number">0x00007ffff7a20fb7</span> efl=<span class="number">0x0000000000000246</span>  cs=<span class="number">0x0000000000000033</span>  ss=<span class="number">0x000000000000002b</span> </span><br><span class="line"> ds=<span class="number">0x0000000000000000</span>  es=<span class="number">0x0000000000000000</span>  fs=<span class="number">0x0000000000000000</span>  gs=<span class="number">0x0000000000000000</span> </span><br><span class="line">Extra Data:</span><br><span class="line">   Description: Heap error</span><br><span class="line">   Short description: HeapError (<span class="number">10</span>/<span class="number">22</span>)</span><br><span class="line">   Explanation: The target<span class="number">'</span>s backtrace indicates that libc has detected a heap error <span class="keyword">or</span> that the target was executing a heap function when it stopped. This could be due to heap corruption, passing a bad pointer to a heap function such as <span class="built_in">free</span>(), etc. Since heap errors might include <span class="built_in">buffer</span> overflows, use-after-<span class="built_in">free</span> situations, etc. they are generally considered exploitable.</span><br><span class="line">---END SUMMARY---</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li><a href="https://insinuator.net/2020/12/how-fuzzers-decide-if-a-crash-is-unique/" target="_blank" rel="noopener">https://insinuator.net/2020/12/how-fuzzers-decide-if-a-crash-is-unique/</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/05/%E5%A6%82%E4%BD%95%E5%AF%B9Fuzzer%E7%94%9F%E6%88%90%E7%9A%84%E5%B4%A9%E6%BA%83%E8%BE%93%E5%85%A5%E8%BF%9B%E8%A1%8C%E5%88%86%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/05/%E5%A6%82%E4%BD%95%E5%AF%B9Fuzzer%E7%94%9F%E6%88%90%E7%9A%84%E5%B4%A9%E6%BA%83%E8%BE%93%E5%85%A5%E8%BF%9B%E8%A1%8C%E5%88%86%E7%B1%BB/" itemprop="url">如何对Fuzzer生成的崩溃输入进行分类</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-05T21:18:41+08:00">
                2021-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Crash-Triage/" itemprop="url" rel="index">
                    <span itemprop="name">Crash Triage</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>对fuzzer发现的每个溃崩输入进行分类，以确定该崩溃输入是否值得进一步研究，如：崩溃的根本原因是什么。往往fuzzer发现的崩溃输入数目很多，此时详细考察每个崩溃输入会非常耗时。本文简要介绍一些可用于崩溃分类过程的技术和工具。以下各节中描述的工具可以减轻分类过程中的一些工作，并协助确定和分析崩溃输入的优先级。</p>
<h2 id="一、gef"><a href="#一、gef" class="headerlink" title="一、gef"></a>一、gef</h2><p><strong>安装：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O ~/.gdbinit-gef.py -q http:<span class="comment">//gef.blah.cat/py</span></span><br><span class="line">$ echo source ~/.gdbinit-gef.py &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>

<p><strong>测试：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@vm:/root<span class="meta"># gdb -q /path/to/my/bin</span></span><br><span class="line">GEF <span class="keyword">for</span> linux <span class="built_in">ready</span>, type `gef<span class="number">'</span> to start, `gef <span class="built_in">config</span><span class="number">'</span> to configure</span><br><span class="line"><span class="number">87</span> commands loaded <span class="keyword">for</span> GDB <span class="number">7.11</span><span class="number">.1</span> <span class="keyword">using</span> Python engine <span class="number">3.5</span></span><br><span class="line">[*] <span class="number">5</span> commands could <span class="keyword">not</span> be loaded, <span class="built_in">run</span> `gef missing` to know why.</span><br><span class="line">/path/to/my/bin: No such file <span class="keyword">or</span> directory.</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>

<h2 id="二、AFLplusplus"><a href="#二、AFLplusplus" class="headerlink" title="二、AFLplusplus"></a>二、AFLplusplus</h2><p><strong>安装：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:<span class="comment">//github.com/AFLplusplus/AFLplusplus</span></span><br><span class="line">$ cd AFLplusplus</span><br><span class="line">$ git checkout <span class="number">2.68</span>c <span class="meta"># <span class="meta-keyword">if</span> you want a specific version, otherwise skip this step</span></span><br><span class="line">$ make distrib</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>编译漏洞程序：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd quickstart/</span><br><span class="line">CC=/root/AFLplusplus/afl-gcc  AFL_HARDEN=<span class="number">1</span> make</span><br></pre></td></tr></table></figure>

<p><strong>测试结果：</strong></p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20210303224005.png" style="zoom:50%;">

<p><strong>crash信息：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@vm:/root/afl-training/quickstart<span class="meta"># ls -alh out/crashes/</span></span><br><span class="line">total <span class="number">36</span>K</span><br><span class="line">drwx------ <span class="number">2</span> root root <span class="number">4.0</span>K <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> .</span><br><span class="line">drwxr-xr-x <span class="number">5</span> root root <span class="number">4.0</span>K <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> ..</span><br><span class="line">-rw------- <span class="number">1</span> root root   <span class="number">36</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> id:<span class="number">000000</span>,sig:<span class="number">11</span>,src:<span class="number">000010</span>,time:<span class="number">7917</span>,op:havoc,rep:<span class="number">32</span></span><br><span class="line">-rw------- <span class="number">1</span> root root   <span class="number">21</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> id:<span class="number">000001</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9351</span>,op:arith8,pos:<span class="number">2</span>,val:+<span class="number">5</span></span><br><span class="line">-rw------- <span class="number">1</span> root root   <span class="number">35</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> id:<span class="number">000002</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9831</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">-rw------- <span class="number">1</span> root root   <span class="number">28</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> id:<span class="number">000003</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9848</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">-rw------- <span class="number">1</span> root root   <span class="number">44</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> id:<span class="number">000004</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9950</span>,op:havoc,rep:<span class="number">4</span></span><br><span class="line">-rw------- <span class="number">1</span> root root   <span class="number">53</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> id:<span class="number">000005</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9955</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">-rw------- <span class="number">1</span> root root  <span class="number">562</span> <span class="number">3</span>月   <span class="number">3</span> <span class="number">22</span>:<span class="number">39</span> README.txt</span><br></pre></td></tr></table></figure>

<p><strong>gef分析结果</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root@vm:/root/afl-training/quickstart/out/crashes<span class="meta"># gdb -q ../../vulnerable</span></span><br><span class="line">GEF <span class="keyword">for</span> linux <span class="built_in">ready</span>, type `gef<span class="number">'</span> to start, `gef <span class="built_in">config</span><span class="number">'</span> to configure</span><br><span class="line"><span class="number">87</span> commands loaded <span class="keyword">for</span> GDB <span class="number">7.11</span><span class="number">.1</span> <span class="keyword">using</span> Python engine <span class="number">3.5</span></span><br><span class="line">[*] <span class="number">5</span> commands could <span class="keyword">not</span> be loaded, <span class="built_in">run</span> `gef missing` to know why.</span><br><span class="line">Reading symbols from ../../vulnerable...done.</span><br><span class="line">gef➤  r &lt; id:<span class="number">000000</span>,sig:<span class="number">11</span>,src:<span class="number">000010</span>,time:<span class="number">7917</span>,op:havoc,rep:<span class="number">32</span></span><br><span class="line">Starting program: /root/afl-training/quickstart/vulnerable &lt; id:<span class="number">000000</span>,sig:<span class="number">11</span>,src:<span class="number">000010</span>,time:<span class="number">7917</span>,op:havoc,rep:<span class="number">32</span></span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="built_in">process</span> (input=&lt;optimized out&gt;, input@entry=<span class="number">0x7fffffffe380</span> <span class="string">"head "</span>, <span class="string">'9'</span> &lt;repeats <span class="number">15</span> times&gt;, <span class="string">"\"9"</span>, &lt;incomplete sequence \<span class="number">340</span>&gt;) at vulnerable.c:<span class="number">49</span></span><br><span class="line"><span class="number">49</span>				rest[len] = <span class="string">'\0'</span>; <span class="comment">// truncate string at specified offset</span></span><br><span class="line">[ Legend: Modified <span class="keyword">register</span> | Code | Heap | Stack | <span class="keyword">String</span> ]</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0xffffffffa4c67fff</span></span><br><span class="line">$rbx   : <span class="number">0x0</span>               </span><br><span class="line">$rcx   : <span class="number">0x1999999999999999</span></span><br><span class="line">$rdx   : <span class="number">0x0</span>               </span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe320</span>  →  <span class="number">0x00007ffff7b95707</span>  →  <span class="string">"__vdso_getcpu"</span></span><br><span class="line">$rbp   : <span class="number">0x00007fffffffe380</span>  →  <span class="number">0x3939392064616568</span> (<span class="string">"head 999"</span>?)</span><br><span class="line">$rsi   : <span class="number">0xfffffff2</span>        </span><br><span class="line">$rdi   : <span class="number">0x22</span>              </span><br><span class="line">$rip   : <span class="number">0x0000000000400faf</span>  →  &lt;<span class="built_in">process</span>+<span class="number">639</span>&gt; mov BYTE PTR [r11+rax*<span class="number">1</span>+<span class="number">0x1</span>], <span class="number">0x0</span></span><br><span class="line">$r8    : <span class="number">0x00007fffffffe394</span>  →  <span class="number">0xfafa0000e0393922</span></span><br><span class="line">$r9    : <span class="number">0x0</span>               </span><br><span class="line">$r10   : <span class="number">0x00007ffff7b80c40</span>  →  <span class="number">0x0002000200020002</span></span><br><span class="line">$r11   : <span class="number">0x00007fffffffe394</span>  →  <span class="number">0xfafa0000e0393922</span></span><br><span class="line">$r12   : <span class="number">0x00007fffffffe395</span>  →  <span class="number">0x39fafa0000e03939</span></span><br><span class="line">$r13   : <span class="number">0x00007fffffffe4e0</span>  →  <span class="number">0x0000000000000001</span></span><br><span class="line">$r14   : <span class="number">0x0</span>               </span><br><span class="line">$r15   : <span class="number">0x0</span>               </span><br><span class="line">$eflags: [carry PARITY adjust zero sign trap INTERRUPT direction <span class="built_in">overflow</span> RESUME virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span> </span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe320</span>│+<span class="number">0x0000</span>: <span class="number">0x00007ffff7b95707</span>  →  <span class="string">"__vdso_getcpu"</span>	 ← $rsp</span><br><span class="line"><span class="number">0x00007fffffffe328</span>│+<span class="number">0x0008</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fffffffe330</span>│+<span class="number">0x0010</span>: <span class="number">0x00007fffffffe395</span>  →  <span class="number">0x39fafa0000e03939</span></span><br><span class="line"><span class="number">0x00007fffffffe338</span>│+<span class="number">0x0018</span>: <span class="number">0x134d0e73044e8d00</span></span><br><span class="line"><span class="number">0x00007fffffffe340</span>│+<span class="number">0x0020</span>: <span class="number">0x00007ffff7ffea98</span>  →  <span class="number">0x00007ffff7ffe9c8</span>  →  <span class="number">0x00007ffff7ffe738</span>  →  <span class="number">0x00007ffff7ffe710</span>  →  <span class="number">0x00007ffff7ffa000</span>  →  <span class="number">0x00010102464c457f</span></span><br><span class="line"><span class="number">0x00007fffffffe348</span>│+<span class="number">0x0028</span>: <span class="number">0x00007fffffffe380</span>  →  <span class="number">0x3939392064616568</span></span><br><span class="line"><span class="number">0x00007fffffffe350</span>│+<span class="number">0x0030</span>: <span class="number">0x00007fffffffe4e8</span>  →  <span class="number">0x00007fffffffe768</span>  →  <span class="string">"/root/afl-training/quickstart/vulnerable"</span></span><br><span class="line"><span class="number">0x00007fffffffe358</span>│+<span class="number">0x0038</span>: <span class="number">0x0000000000400c20</span>  →  &lt;_start+<span class="number">0</span>&gt; <span class="keyword">xor</span> ebp, ebp</span><br><span class="line">[!] Command 'context' failed to execute properly, reason: 'NoneType' object is not iterable</span><br></pre></td></tr></table></figure>

<p>由上可得的信息有：</p>
<ul>
<li>崩溃信号： signal SIGSEGV</li>
<li>崩溃时的源码信息：行号，代码（编译时添加-g参数）</li>
<li>栈、寄存器信息</li>
</ul>
<h2 id="三、GDB-exploitable-plugin"><a href="#三、GDB-exploitable-plugin" class="headerlink" title="三、GDB exploitable plugin"></a>三、GDB exploitable plugin</h2><p>这是<code>GDB</code>的一个插件，用来判定一个<code>crash</code>能否被利用，它提供了一些分类器来对程序当前崩溃状态进行判定。如果插件识别出程序崩溃时的状态，插件会为崩溃时状态分配一个可利用的类别。</p>
<p>它的作用是可以帮助用户对<code>crash</code>根据可利用性进行优先级排序。那些被识别为不可利用的<code>crash</code>或插件无法评估的<code>crash</code>仍然值得进一步分析，但是能应对大多数情况。</p>
<p><strong>安装：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/jfoote/exploitable.git</span></span><br><span class="line">cd exploitable/</span><br><span class="line">apt install execstack</span><br><span class="line">python <span class="built_in">setup</span>.py test</span><br><span class="line">python <span class="built_in">setup</span>.py install</span><br></pre></td></tr></table></figure>

<p>测试上面的<code>crash</code>输入：<code>id:000000,sig:11,src:000010,time:7917,op:havoc,rep:32</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gef➤  exploitable </span><br><span class="line">Description: Access violation on destination operand</span><br><span class="line">Short description: DestAv (<span class="number">8</span>/<span class="number">22</span>)</span><br><span class="line">Hash: c7c94564fa106de33f1f050fc7680f5a.c7c94564fa106de33f1f050fc7680f5a</span><br><span class="line">Exploitability Classification: EXPLOITABLE</span><br><span class="line">Explanation: The target crashed on an access violation at an address matching the destination operand of the instruction. This likely indicates a <span class="built_in">write</span> access violation, which means the attacker may control the <span class="built_in">write</span> address <span class="keyword">and</span>/<span class="keyword">or</span> value.</span><br><span class="line">Other tags: AccessViolation (<span class="number">21</span>/<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p>该插件将<code>crash</code>分类为<code>EXPLOITABLE</code>，并提供了崩溃情况的简要说明。目前为止，插件并未考虑如何绕过利用过程中的缓解措施等。但是，<code>EXPLOITABLE</code>类别是一个很好的指示，表明此错误提供了可能有用的利用原语。该插件的描述和说明还可以帮助用户快速确定错误的类别可能是什么。</p>
<p>测试<code>crash</code>输入：<code>id:000005,sig:11,src:000014,time:9955,op:havoc,rep:8</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">gef➤  r &lt; id:<span class="number">000005</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9955</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">Starting program: /root/afl-training/quickstart/vulnerable &lt; id:<span class="number">000005</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9955</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="built_in">process</span> (input=&lt;optimized out&gt;, input@entry=<span class="number">0x7fffffffe380</span> <span class="string">"u "</span>, <span class="string">'4'</span> &lt;repeats <span class="number">28</span> times&gt;, <span class="string">"he]d 4444444A44A44d4444"</span>) at vulnerable.c:<span class="number">31</span></span><br><span class="line"><span class="number">31</span>				<span class="keyword">char</span> c = rest[i];</span><br><span class="line">[ Legend: Modified <span class="keyword">register</span> | Code | Heap | Stack | <span class="keyword">String</span> ]</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0xc30</span>             </span><br><span class="line">$rbx   : <span class="number">0x0</span>               </span><br><span class="line">$rcx   : <span class="number">0x2</span>               </span><br><span class="line">$rdx   : <span class="number">0x1</span>               </span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe320</span>  →  <span class="number">0x0000000000000035</span> (<span class="string">"5"</span>?)</span><br><span class="line">$rbp   : <span class="number">0x0000000000605260</span>  →  <span class="string">"E]D 4444444A44A44D4444"</span></span><br><span class="line">$rsi   : <span class="number">0xc7</span>              </span><br><span class="line">$rdi   : <span class="number">0x00007fffffffe3a0</span>  →  <span class="string">"]d 4444444A44A44d4444"</span></span><br><span class="line">$rip   : <span class="number">0x0000000000401b34</span>  →  &lt;<span class="built_in">process</span>+<span class="number">3588</span>&gt; movdqa xmm13, XMMWORD PTR [rdi+rax*<span class="number">1</span>+<span class="number">0x30</span>]</span><br><span class="line">$r8    : <span class="number">0xfffffff</span>         </span><br><span class="line">$r9    : <span class="number">0xfffffffe</span>        </span><br><span class="line">$r10   : <span class="number">0xfffffff0</span>        </span><br><span class="line">$r11   : <span class="number">0x0000000000605261</span>  →  <span class="string">"]D 4444444A44A44D4444"</span></span><br><span class="line">$r12   : <span class="number">0x00007fffffffe39e</span>  →  <span class="string">"he]d 4444444A44A44d4444"</span></span><br><span class="line">$r13   : <span class="number">0xffffffffffffffff</span></span><br><span class="line">$r14   : <span class="number">0x00007fffffffe39f</span>  →  <span class="string">"e]d 4444444A44A44d4444"</span></span><br><span class="line">$r15   : <span class="number">0x7fffffffffffffff</span></span><br><span class="line">$eflags: [carry parity adjust zero sign trap INTERRUPT direction <span class="built_in">overflow</span> RESUME virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span> </span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe320</span>│+<span class="number">0x0000</span>: <span class="number">0x0000000000000035</span> (<span class="string">"5"</span>?)	 ← $rsp</span><br><span class="line"><span class="number">0x00007fffffffe328</span>│+<span class="number">0x0008</span>: <span class="number">0xffffffff00000000</span></span><br><span class="line"><span class="number">0x00007fffffffe330</span>│+<span class="number">0x0010</span>: <span class="number">0x00007fffffffe39f</span>  →  <span class="string">"e]d 4444444A44A44d4444"</span></span><br><span class="line"><span class="number">0x00007fffffffe338</span>│+<span class="number">0x0018</span>: <span class="number">0xdde30b66a19eef00</span></span><br><span class="line"><span class="number">0x00007fffffffe340</span>│+<span class="number">0x0020</span>: <span class="number">0x00007ffff7ffea98</span>  →  <span class="number">0x00007ffff7ffe9c8</span>  →  <span class="number">0x00007ffff7ffe738</span>  →  <span class="number">0x00007ffff7ffe710</span>  →  <span class="number">0x00007ffff7ffa000</span>  →  <span class="number">0x00010102464c457f</span></span><br><span class="line"><span class="number">0x00007fffffffe348</span>│+<span class="number">0x0028</span>: <span class="number">0x00007fffffffe380</span>  →  <span class="string">"u 4444444444444444444444444444he]d 4444444A44A44d4[...]"</span></span><br><span class="line"><span class="number">0x00007fffffffe350</span>│+<span class="number">0x0030</span>: <span class="number">0x00007fffffffe4e8</span>  →  <span class="number">0x00007fffffffe768</span>  →  <span class="string">"/root/afl-training/quickstart/vulnerable"</span></span><br><span class="line"><span class="number">0x00007fffffffe358</span>│+<span class="number">0x0038</span>: <span class="number">0x0000000000400c20</span>  →  &lt;_start+<span class="number">0</span>&gt; <span class="keyword">xor</span> ebp, ebp</span><br><span class="line">[!] Command 'context' failed to execute properly, reason: 'NoneType' object is not iterable</span><br><span class="line">gef➤  exploitable </span><br><span class="line">Description: Access violation on source operand</span><br><span class="line">Short description: SourceAv (<span class="number">19</span>/<span class="number">22</span>)</span><br><span class="line">Hash: <span class="number">0f</span>e8f44deb493d085f92c9f5fa03a71a<span class="number">.0f</span>e8f44deb493d085f92c9f5fa03a71a</span><br><span class="line">Exploitability Classification: UNKNOWN</span><br><span class="line">Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a <span class="built_in">read</span> access violation.</span><br><span class="line">Other tags: AccessViolation (<span class="number">21</span>/<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p>测试<code>crash</code>输入：<code>id:000001,sig:11,src:000014,time:9351,op:arith8,pos:2,val:+5</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">gef➤  r &lt; id:<span class="number">000001</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9351</span>,op:arith8,pos:<span class="number">2</span>,val:+<span class="number">5</span></span><br><span class="line">Starting program: /root/afl-training/quickstart/vulnerable &lt; id:<span class="number">000001</span>,sig:<span class="number">11</span>,src:<span class="number">000014</span>,time:<span class="number">9351</span>,op:arith8,pos:<span class="number">2</span>,val:+<span class="number">5</span></span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line"><span class="built_in">process</span> (input=&lt;optimized out&gt;, input@entry=<span class="number">0x7fffffffe380</span> <span class="string">"u 9"</span>, <span class="string">'4'</span> &lt;repeats <span class="number">18</span> times&gt;) at vulnerable.c:<span class="number">31</span></span><br><span class="line"><span class="number">31</span>				<span class="keyword">char</span> c = rest[i];</span><br><span class="line">[ Legend: Modified <span class="keyword">register</span> | Code | Heap | Stack | <span class="keyword">String</span> ]</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0xc30</span>             </span><br><span class="line">$rbx   : <span class="number">0x0</span>               </span><br><span class="line">$rcx   : <span class="number">0x2</span>               </span><br><span class="line">$rdx   : <span class="number">0xa</span>               </span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe320</span>  →  <span class="number">0x0000000000000015</span></span><br><span class="line">$rbp   : <span class="number">0x0000000000605260</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$rsi   : <span class="number">0xc7</span>              </span><br><span class="line">$rdi   : <span class="number">0x00007fffffffe3a0</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$rip   : <span class="number">0x0000000000401b34</span>  →  &lt;<span class="built_in">process</span>+<span class="number">3588</span>&gt; movdqa xmm13, XMMWORD PTR [rdi+rax*<span class="number">1</span>+<span class="number">0x30</span>]</span><br><span class="line">$r8    : <span class="number">0xfffffff</span>         </span><br><span class="line">$r9    : <span class="number">0xfffffff5</span>        </span><br><span class="line">$r10   : <span class="number">0xfffffff0</span>        </span><br><span class="line">$r11   : <span class="number">0x000000000060526a</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$r12   : <span class="number">0x00007fffffffe395</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$r13   : <span class="number">0xffffffffffffffff</span></span><br><span class="line">$r14   : <span class="number">0x00007fffffffe396</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$r15   : <span class="number">0x7fffffffffffffff</span></span><br><span class="line">$eflags: [carry parity adjust zero sign trap INTERRUPT direction <span class="built_in">overflow</span> RESUME virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span> </span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe320</span>│+<span class="number">0x0000</span>: <span class="number">0x0000000000000015</span>	 ← $rsp</span><br><span class="line"><span class="number">0x00007fffffffe328</span>│+<span class="number">0x0008</span>: <span class="number">0xffffffff00000000</span></span><br><span class="line"><span class="number">0x00007fffffffe330</span>│+<span class="number">0x0010</span>: <span class="number">0x00007fffffffe396</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fffffffe338</span>│+<span class="number">0x0018</span>: <span class="number">0xa765e3c4b4acfa00</span></span><br><span class="line"><span class="number">0x00007fffffffe340</span>│+<span class="number">0x0020</span>: <span class="number">0x00007ffff7ffea98</span>  →  <span class="number">0x00007ffff7ffe9c8</span>  →  <span class="number">0x00007ffff7ffe738</span>  →  <span class="number">0x00007ffff7ffe710</span>  →  <span class="number">0x00007ffff7ffa000</span>  →  <span class="number">0x00010102464c457f</span></span><br><span class="line"><span class="number">0x00007fffffffe348</span>│+<span class="number">0x0028</span>: <span class="number">0x00007fffffffe380</span>  →  <span class="string">"u 9444444444444444444"</span></span><br><span class="line"><span class="number">0x00007fffffffe350</span>│+<span class="number">0x0030</span>: <span class="number">0x00007fffffffe4e8</span>  →  <span class="number">0x00007fffffffe768</span>  →  <span class="string">"/root/afl-training/quickstart/vulnerable"</span></span><br><span class="line"><span class="number">0x00007fffffffe358</span>│+<span class="number">0x0038</span>: <span class="number">0x0000000000400c20</span>  →  &lt;_start+<span class="number">0</span>&gt; <span class="keyword">xor</span> ebp, ebp</span><br><span class="line">[!] Command 'context' failed to execute properly, reason: 'NoneType' object is not iterable</span><br><span class="line">gef➤  exploitable </span><br><span class="line">Description: Access violation on source operand</span><br><span class="line">Short description: SourceAv (<span class="number">19</span>/<span class="number">22</span>)</span><br><span class="line">Hash: <span class="number">0f</span>e8f44deb493d085f92c9f5fa03a71a<span class="number">.0f</span>e8f44deb493d085f92c9f5fa03a71a</span><br><span class="line">Exploitability Classification: UNKNOWN</span><br><span class="line">Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a <span class="built_in">read</span> access violation.</span><br><span class="line">Other tags: AccessViolation (<span class="number">21</span>/<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<h2 id="四、Crashwalk"><a href="#四、Crashwalk" class="headerlink" title="四、Crashwalk"></a>四、Crashwalk</h2><p><code>Crashwalk</code>是对上述插件<code>exploitable</code>的补充。<code>Crashwalk</code>可以遍历<code>AFL</code>生成的crash输入，并在崩溃状态下运行<code>exploitable</code>。最终，它将创建一个包含来<code>exploitable</code>输出<code>crashwalk.db</code>文件。可以将它简单看做：一个自动使用<code>GDB</code>对每个<code>crash</code>输入进行检查，自动运行插件<code>exploitable</code>并获得其输出内容的工具。</p>
<p><code>Crashwalk</code>似乎在从<code>stdin</code>而非从文件读取输入的程序上重现崩溃时会有一些问题，因此，在本示例中，将使用程序<code>fuzzgoat</code>。</p>
<p><strong>安装</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:<span class="comment">//github.com/bnagy/crashwalk.git</span></span><br><span class="line">$ sudo apt-<span class="built_in">get</span> install golang</span><br><span class="line">$ <span class="keyword">export</span> GOPATH=$PWD/crashwalk/</span><br><span class="line">$ go <span class="built_in">get</span> -u github.com/bnagy/crashwalk/cmd/...</span><br></pre></td></tr></table></figure>

<p><strong>对目标程序进行fuzz</strong>：</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20210304092811.png" style="zoom:50%;">

<p><strong>使用crashwalk：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">export</span> CW_EXPLOITABLE=/root/exploitable/exploitable/exploitable.py</span><br><span class="line">$ ./crashwalk/bin/cwtriage -root ./fuzzgoat/out/crashes -match id -- ./fuzzgoat/fuzzgoat @@</span><br></pre></td></tr></table></figure>

<p>由于<code>cwtriage</code>使用了<code>exploitable</code>，所以需要指明<code>exploitable</code> 的路径：设置环境变量<code>CW_EXPLOITABLE</code>。参数<code>-match</code>表明<code>crash</code>文件表达式信息，用来识别<code>crash</code>文件信息。由于AFL挖掘出的<code>crash</code>文件名开头是<code>id</code>，所以我们的设置为：<code>-match id</code>。参数<code>@@</code>表明<code>crash</code>文件应该作为参数传递给二进制程序。</p>
<p>运行上述命令得到的输出是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: fuzzgoat/out/crashes/id:<span class="number">000000</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>,time:<span class="number">191</span>,op:arith8,pos:<span class="number">5</span>,val:<span class="number">-5</span></span><br><span class="line">SHA1: <span class="number">45b</span>b9b6983e58a877957a2eb4409ad2c18939452</span><br><span class="line">Classification: PROBABLY_NOT_EXPLOITABLE</span><br><span class="line">Hash: <span class="number">0b</span>54f82b97d9e614dba4f9d9352def3d<span class="number">.0b</span>54f82b97d9e614dba4f9d9352def3d</span><br><span class="line">Command: ./fuzzgoat/fuzzgoat fuzzgoat/out/crashes/id:<span class="number">000000</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>,time:<span class="number">191</span>,op:arith8,pos:<span class="number">5</span>,val:<span class="number">-5</span></span><br><span class="line">Faulting Frame:</span><br><span class="line">   json_value_free_ex @ <span class="number">0x000055555555e46c</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">Disassembly:</span><br><span class="line">   <span class="number">0x000055555555e451</span>: call <span class="number">0x55555555e680</span> &lt;__afl_maybe_log&gt;</span><br><span class="line">   <span class="number">0x000055555555e456</span>: mov rax,QWORD PTR [rsp+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x000055555555e45b</span>: mov rcx,QWORD PTR [rsp+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x000055555555e460</span>: mov rdx,QWORD PTR [rsp]</span><br><span class="line">   <span class="number">0x000055555555e464</span>: lea rsp,[rsp+<span class="number">0x98</span>]</span><br><span class="line">=&gt; <span class="number">0x000055555555e46c</span>: mov eax,DWORD PTR [rbx+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x000055555555e46f</span>: cmp eax,<span class="number">0x2</span></span><br><span class="line">   <span class="number">0x000055555555e472</span>: jne <span class="number">0x55555555e2e8</span> &lt;json_value_free+<span class="number">152</span>&gt;</span><br><span class="line">   <span class="number">0x000055555555e478</span>: lea rsp,[rsp<span class="number">-0x98</span>]</span><br><span class="line">   <span class="number">0x000055555555e480</span>: mov QWORD PTR [rsp],rdx</span><br><span class="line">Stack Head (<span class="number">3</span> entries):</span><br><span class="line">   json_value_free_ex        @ <span class="number">0x000055555555e46c</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">   json_value_free           @ <span class="number">0x000055555555e46c</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">   main                      @ <span class="number">0x00005555555551f6</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">Registers:</span><br><span class="line">rax=<span class="number">0x0000000000000001</span> rbx=<span class="number">0x0000000000000021</span> rcx=<span class="number">0x0000000000000001</span> rdx=<span class="number">0x0000000000000000</span> </span><br><span class="line">rsi=<span class="number">0x0000000000000009</span> rdi=<span class="number">0x0000555555762520</span> rbp=<span class="number">0x00005555557624c0</span> rsp=<span class="number">0x00007fffffffe250</span> </span><br><span class="line"> r8=<span class="number">0x0000555555762550</span>  r9=<span class="number">0x0000000000000000</span> r10=<span class="number">0x0000000000000000</span> r11=<span class="number">0x000055555555eb47</span> </span><br><span class="line">r12=<span class="number">0x0000000000000008</span> r13=<span class="number">0x0000555555761260</span> r14=<span class="number">0x0000555555761280</span> r15=<span class="number">0x0000000000000000</span> </span><br><span class="line">rip=<span class="number">0x000055555555e46c</span> efl=<span class="number">0x0000000000010206</span>  cs=<span class="number">0x0000000000000033</span>  ss=<span class="number">0x000000000000002b</span> </span><br><span class="line"> ds=<span class="number">0x0000000000000000</span>  es=<span class="number">0x0000000000000000</span>  fs=<span class="number">0x0000000000000000</span>  gs=<span class="number">0x0000000000000000</span> </span><br><span class="line">Extra Data:</span><br><span class="line">   Description: Access violation near <span class="literal">NULL</span> on source operand</span><br><span class="line">   Short description: SourceAvNearNull (<span class="number">16</span>/<span class="number">22</span>)</span><br><span class="line">   Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a <span class="built_in">read</span> access violation, which may mean the application crashed on a simple <span class="literal">NULL</span> dereference to data structure that has no immediate effect on control of the processor.</span><br><span class="line">---END SUMMARY---</span><br><span class="line"></span><br><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: fuzzgoat/out/crashes/id:<span class="number">000001</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">462</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">SHA1: <span class="number">9</span>c08dafb954cbeb51a275891a24eaf851c071900</span><br><span class="line">Classification: EXPLOITABLE</span><br><span class="line">Hash: c4f0988a8dae89b95cf01d71d85553e9<span class="number">.23f</span>a7969f3cb9c54fd796568f394dc7f</span><br><span class="line">Command: ./fuzzgoat/fuzzgoat fuzzgoat/out/crashes/id:<span class="number">000001</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">462</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">... ...</span><br><span class="line">---END SUMMARY---</span><br></pre></td></tr></table></figure>

<p>使用<code>cwdump</code>来分析<code>crashwalk.db</code>文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">root@vm:/root# ./crashwalk/bin/cwdump ./crashwalk.db </span><br><span class="line">(<span class="number">1</span> of <span class="number">4</span>) - Hash: <span class="number">0b</span>54f82b97d9e614dba4f9d9352def3d<span class="number">.0b</span>54f82b97d9e614dba4f9d9352def3d</span><br><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: fuzzgoat/out/crashes/id:<span class="number">000006</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>,time:<span class="number">5072</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">SHA1: d6bfc450688c952fb51a9c283586e8e3109ed9de</span><br><span class="line">Classification: UNKNOWN</span><br><span class="line">Hash: <span class="number">0b</span>54f82b97d9e614dba4f9d9352def3d<span class="number">.0b</span>54f82b97d9e614dba4f9d9352def3d</span><br><span class="line">Command: ./fuzzgoat/fuzzgoat fuzzgoat/out/crashes/id:<span class="number">000006</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>,time:<span class="number">5072</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">Faulting Frame:</span><br><span class="line">   json_value_free_ex @ <span class="number">0x000055555555e46c</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">Disassembly:</span><br><span class="line">   <span class="number">0x000055555555e451</span>: call <span class="number">0x55555555e680</span> &lt;__afl_maybe_log&gt;</span><br><span class="line">   <span class="number">0x000055555555e456</span>: mov rax,QWORD PTR [rsp+<span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x000055555555e45b</span>: mov rcx,QWORD PTR [rsp+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x000055555555e460</span>: mov rdx,QWORD PTR [rsp]</span><br><span class="line">   <span class="number">0x000055555555e464</span>: lea rsp,[rsp+<span class="number">0x98</span>]</span><br><span class="line">=&gt; <span class="number">0x000055555555e46c</span>: mov eax,DWORD PTR [rbx+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x000055555555e46f</span>: cmp eax,<span class="number">0x2</span></span><br><span class="line">   <span class="number">0x000055555555e472</span>: jne <span class="number">0x55555555e2e8</span> &lt;json_value_free+<span class="number">152</span>&gt;</span><br><span class="line">   <span class="number">0x000055555555e478</span>: lea rsp,[rsp<span class="number">-0x98</span>]</span><br><span class="line">   <span class="number">0x000055555555e480</span>: mov QWORD PTR [rsp],rdx</span><br><span class="line">Stack Head (<span class="number">3</span> entries):</span><br><span class="line">   json_value_free_ex        @ <span class="number">0x000055555555e46c</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">   json_value_free           @ <span class="number">0x000055555555e46c</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">   main                      @ <span class="number">0x00005555555551f6</span>: in /root/fuzzgoat/fuzzgoat</span><br><span class="line">Registers:</span><br><span class="line">rax=<span class="number">0x0000000000000001</span> rbx=<span class="number">0x000000000001fac1</span> rcx=<span class="number">0x0000000000000001</span> rdx=<span class="number">0x0000000000000000</span> </span><br><span class="line">rsi=<span class="number">0x0000000000000010</span> rdi=<span class="number">0x0000555555762520</span> rbp=<span class="number">0x00005555557624c0</span> rsp=<span class="number">0x00007fffffffe250</span> </span><br><span class="line"> r8=<span class="number">0x0000000000000000</span>  r9=<span class="number">0x0000000000000000</span> r10=<span class="number">0x0000000000000009</span> r11=<span class="number">0x000055555555eb2f</span> </span><br><span class="line">r12=<span class="number">0x0000000000000007</span> r13=<span class="number">0x0000555555761260</span> r14=<span class="number">0x0000555555761280</span> r15=<span class="number">0x0000000000000000</span> </span><br><span class="line">rip=<span class="number">0x000055555555e46c</span> efl=<span class="number">0x0000000000010202</span>  cs=<span class="number">0x0000000000000033</span>  ss=<span class="number">0x000000000000002b</span> </span><br><span class="line"> ds=<span class="number">0x0000000000000000</span>  es=<span class="number">0x0000000000000000</span>  fs=<span class="number">0x0000000000000000</span>  gs=<span class="number">0x0000000000000000</span> </span><br><span class="line">Extra Data:</span><br><span class="line">   Description: Access violation on source operand</span><br><span class="line">   Short description: SourceAv (<span class="number">19</span>/<span class="number">22</span>)</span><br><span class="line">   Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a <span class="built_in">read</span> access violation.</span><br><span class="line">---END SUMMARY---</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> of <span class="number">2</span>) - Hash: c4f0988a8dae89b95cf01d71d85553e9<span class="number">.23f</span>a7969f3cb9c54fd796568f394dc7f</span><br><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: fuzzgoat/out/crashes/id:<span class="number">000001</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">462</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">SHA1: <span class="number">9</span>c08dafb954cbeb51a275891a24eaf851c071900</span><br><span class="line">Classification: EXPLOITABLE</span><br><span class="line">Hash: c4f0988a8dae89b95cf01d71d85553e9<span class="number">.23f</span>a7969f3cb9c54fd796568f394dc7f</span><br><span class="line">Command: ./fuzzgoat/fuzzgoat fuzzgoat/out/crashes/id:<span class="number">000001</span>,sig:<span class="number">06</span>,src:<span class="number">000000</span>,time:<span class="number">462</span>,op:havoc,rep:<span class="number">8</span></span><br><span class="line">... ...</span><br><span class="line">Extra Data:</span><br><span class="line">   Description: Heap error</span><br><span class="line">   Short description: HeapError (<span class="number">10</span>/<span class="number">22</span>)</span><br><span class="line">   Explanation: The target<span class="number">'</span>s backtrace indicates that libc has detected a heap error <span class="keyword">or</span> that the target was executing a heap function when it stopped. This could be due to heap corruption, passing a bad pointer to a heap function such as <span class="built_in">free</span>(), etc. Since heap errors might include <span class="built_in">buffer</span> overflows, use-after-<span class="built_in">free</span> situations, etc. they are generally considered exploitable.</span><br><span class="line">---END SUMMARY---</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> of <span class="number">1</span>) - Hash: <span class="number">7e602</span>b02ee692c15c21dd3b75900877a<span class="number">.7e602</span>b02ee692c15c21dd3b75900877a</span><br><span class="line">---CRASH SUMMARY---</span><br><span class="line">Filename: fuzzgoat/out/crashes/id:<span class="number">000002</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>,time:<span class="number">594</span>,op:havoc,rep:<span class="number">4</span></span><br><span class="line">SHA1: ddbf3aa6373d825b6bc607d8ae404b792d8fe273</span><br><span class="line">Classification: PROBABLY_NOT_EXPLOITABLE</span><br><span class="line">Hash: <span class="number">7e602</span>b02ee692c15c21dd3b75900877a<span class="number">.7e602</span>b02ee692c15c21dd3b75900877a</span><br><span class="line">Command: ./fuzzgoat/fuzzgoat fuzzgoat/out/crashes/id:<span class="number">000002</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>,time:<span class="number">594</span>,op:havoc,rep:<span class="number">4</span></span><br><span class="line">... ...</span><br><span class="line">Extra Data:</span><br><span class="line">   Description: Access violation near <span class="literal">NULL</span> on source operand</span><br><span class="line">   Short description: SourceAvNearNull (<span class="number">16</span>/<span class="number">22</span>)</span><br><span class="line">   Explanation: The target crashed on an access violation at an address matching the source operand of the current instruction. This likely indicates a <span class="built_in">read</span> access violation, which may mean the application crashed on a simple <span class="literal">NULL</span> dereference to data structure that has no immediate effect on control of the processor.</span><br><span class="line">---END SUMMARY---</span><br></pre></td></tr></table></figure>

<p>由上可知，7个<code>crash</code>根据其能否被利用、漏洞类型被分为3类。</p>
<blockquote>
<ol>
<li><a href="https://github.com/bnagy/crashwalk" target="_blank" rel="noopener">https://github.com/bnagy/crashwalk</a></li>
</ol>
</blockquote>
<h2 id="五、AFL-crash-exploration-mode"><a href="#五、AFL-crash-exploration-mode" class="headerlink" title="五、AFL crash exploration mode"></a>五、AFL crash exploration mode</h2><p>这是<code>AFL</code>自己提供的一个模块，它以已知的<code>crash</code>作为输入，并且在此基础上进行测试来发现其他变体。此模式下，<code>AFL</code>能识别出那些应用于生成<code>crash</code>文件的变化，保证在仍能触发相同<code>crash</code>的情况下探索其他的代码区域。</p>
<p>一般来说，我们希望<code>fuzzer</code>发现越多的唯一<code>crash</code>，而不是一直触发相同的<code>crash</code>。但是，<code>AFL</code>中的<code>exploration mode</code>的目的是：创建一个小的语料库，可以快速的对他们进行检查，来查看攻击者对错读地址的控制程度，或者是否可能实现越界读</p>
<p>换句话说，查看一个<code>crash</code>的多种变化可以帮助了解这个<code>crash</code>提供了多少灵活性，例如：如果崩溃是地址写相关的，但无法控制该地址，那这可能不是一个特别有用的原语。 另一方面，如果<code>AFL</code>的<code>exploration mode</code>表示可以更改输入以实现任意地址写，则更有可能利用该漏洞。</p>
<p>使用命令：<code>afl-fuzz -C -i out/crashes/ -o crash_exploration/ -- ./vulnerable</code>进行测试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ afl-fuzz -C -i out/crashes/ -o crash_exploration/ -- ./vulnerable</span><br><span class="line">afl-fuzz++<span class="number">2.68</span>c based on afl by Michal Zalewski <span class="keyword">and</span> a big online community</span><br><span class="line">[+] afl++ is maintained by Marc <span class="string">"van Hauser"</span> Heuse, Heiko <span class="string">"hexcoder"</span> Eißfeldt, Andrea Fioraldi <span class="keyword">and</span> Dominik Maier</span><br><span class="line">[+] afl++ is <span class="built_in">open</span> source, <span class="built_in">get</span> it at https:<span class="comment">//github.com/AFLplusplus/AFLplusplus</span></span><br><span class="line">[+] Power schedules from github.com/mboehme/aflfast</span><br><span class="line">[+] Python Mutator <span class="keyword">and</span> llvm_mode instrument file <span class="built_in">list</span> from github.com/choller/afl</span><br><span class="line">[+] MOpt Mutator from github.com/puppet-meteor/MOpt-AFL</span><br><span class="line">[*] Getting to work...</span><br><span class="line">[+] Using exploration-<span class="function">based constant power <span class="title">schedule</span> <span class="params">(EXPLORE, <span class="keyword">default</span>)</span></span></span><br><span class="line">[*] Checking core_pattern...</span><br><span class="line">[!] WARNING: Could <span class="keyword">not</span> check CPU scaling governor</span><br><span class="line">[+] You have 2 CPU cores and 1 runnable tasks (utilization: 50%).</span><br><span class="line">[+] Try parallel jobs - see /usr/local/share/doc/afl/parallel_fuzzing.md.</span><br><span class="line">[*] Setting up output directories...</span><br><span class="line">[+] Output directory <span class="built_in">exists</span> but deemed OK to reuse.</span><br><span class="line">[*] Deleting old session data...</span><br><span class="line">[+] Output dir cleanup successful.</span><br><span class="line">[*] Checking CPU core loadout...</span><br><span class="line">[+] Found a <span class="built_in">free</span> CPU core, <span class="keyword">try</span> binding to #<span class="number">0.</span></span><br><span class="line">[*] Scanning 'out/crashes/'...</span><br><span class="line">[+] No <span class="keyword">auto</span>-generated dictionary tokens to reuse.</span><br><span class="line">[*] Creating hard links <span class="keyword">for</span> all input files...</span><br><span class="line">[*] Validating target binary...</span><br><span class="line">[*] Attempting dry run with 'id:000000,sig:11,src:000010,time:7917,op:havoc,rep:32'...</span><br><span class="line">[*] Spinning up the fork server...</span><br><span class="line">[+] All right - fork server is up.</span><br><span class="line">    len = <span class="number">36</span>, <span class="built_in">map</span> <span class="built_in">size</span> = <span class="number">6</span>, exec speed = <span class="number">160</span> us</span><br><span class="line">[*] Attempting dry run with 'id:000001,sig:11,src:000014,time:9351,op:arith8,pos:2,val:+5'...</span><br><span class="line">    len = <span class="number">21</span>, <span class="built_in">map</span> <span class="built_in">size</span> = <span class="number">30</span>, exec speed = <span class="number">237</span> us</span><br><span class="line">[*] Attempting dry run with 'id:000002,sig:11,src:000014,time:9831,op:havoc,rep:2'...</span><br><span class="line">    len = <span class="number">35</span>, <span class="built_in">map</span> <span class="built_in">size</span> = <span class="number">22</span>, exec speed = <span class="number">234</span> us</span><br><span class="line">[*] Attempting dry run with 'id:000003,sig:11,src:000014,time:9848,op:havoc,rep:2'...</span><br><span class="line">    len = <span class="number">28</span>, <span class="built_in">map</span> <span class="built_in">size</span> = <span class="number">28</span>, exec speed = <span class="number">231</span> us</span><br><span class="line">[*] Attempting dry run with 'id:000004,sig:11,src:000014,time:9950,op:havoc,rep:4'...</span><br><span class="line">    len = <span class="number">44</span>, <span class="built_in">map</span> <span class="built_in">size</span> = <span class="number">23</span>, exec speed = <span class="number">227</span> us</span><br><span class="line">[*] Attempting dry run with 'id:000005,sig:11,src:000014,time:9955,op:havoc,rep:8'...</span><br><span class="line">    len = <span class="number">53</span>, <span class="built_in">map</span> <span class="built_in">size</span> = <span class="number">21</span>, exec speed = <span class="number">244</span> us</span><br><span class="line">[+] All test cases processed.</span><br><span class="line"></span><br><span class="line">[+] Here are some useful stats:</span><br><span class="line"></span><br><span class="line">    Test <span class="keyword">case</span> count : <span class="number">6</span> favored, <span class="number">0</span> variable, <span class="number">6</span> total</span><br><span class="line">       Bitmap range : <span class="number">6</span> to <span class="number">30</span> bits (average: <span class="number">21.67</span> bits)</span><br><span class="line">        Exec timing : <span class="number">160</span> to <span class="number">244</span> us (average: <span class="number">222</span> us)</span><br><span class="line"></span><br><span class="line">[*] Applying timeout settings from resumed session (<span class="number">20</span> ms).</span><br><span class="line">[+] All <span class="built_in">set</span> <span class="keyword">and</span> <span class="built_in">ready</span> to roll!</span><br></pre></td></tr></table></figure>

<p>在<code>AFL</code>的普通模式下，上面的<code>dry run</code>是为了检查<code>test case</code>是否满足<code>sanity check</code>，确保他们不会直接导致程序崩溃。<code>AFL</code>会<code>clean</code>测试文件，确保程序的行为正常并开始循环测试这些输入来发现反常的行为。与之相反，<code>exploration mode</code>是为了确保这些<code>test case</code>已经导致了崩溃，因为他的目的是在保证触发同样崩溃的基础上来探索程序中其他代码、路径。</p>
<p><strong>测试结果：</strong></p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20210304110318.png" style="zoom:50%;">

<p>顶部显示的名称是<code>peruvian are-rabbit</code>，这是<code>crash exploration mode</code>的名称。 我们感兴趣的是<code>unique crash</code>，因为他是在已有<code>crash</code>的基础上触发了新的路径。如果我们得到足够多能触发新路径但保持原<code>crash</code>的输入，我们就能对他们进行比较，得到不同之处。<code>crasg exploration mode</code>有助于对于确定哪些crash值得进行进一步的研究。</p>
<blockquote>
<ol>
<li><a href="https://github.com/google/AFL#10-crash-triage" target="_blank" rel="noopener">https://github.com/google/AFL#10-crash-triage</a></li>
<li><a href="https://lcamtuf.blogspot.com/2014/11/afl-fuzz-crash-exploration-mode.html" target="_blank" rel="noopener">https://lcamtuf.blogspot.com/2014/11/afl-fuzz-crash-exploration-mode.html</a></li>
</ol>
</blockquote>
<h2 id="六、rr-Record-and-Replay-Framework"><a href="#六、rr-Record-and-Replay-Framework" class="headerlink" title="六、rr (Record and Replay Framework)"></a>六、rr (Record and Replay Framework)</h2><p><code>rr</code>可以<code>recording</code>程序的执行。然后可以<code>debiug</code>这个<code>recording</code>，可以查看不同时间点的程序状态，所以有时候也将其称为<code>time-travel debugging</code>或<code>timeless debugging</code>。</p>
<p>从对fuzzer生成的crashes进行分类来说，rr最明显的优势是他可以很方便的从崩溃点进行回滚，以此来分析崩溃输入是如何产生的以及其执行路径是什么。</p>
<p>使用<code>rr</code>的另一个好处是更方便对<code>non-determinism</code>导致的崩溃进行分析，只需要重现一次获得<code>rr</code>产生的<code>recording</code>即可。通常，要是想对<code>crash</code>进行调试，并且回到较早的时间点进行检查，需要重新运行目标程序，再次分析程序。对于非确定性错误，是程序重新发生同样的崩溃可能比较麻烦。由于<code>rr</code>会<code>recording</code>该程序的执行情况，因此可以快速返回到较早的时间点进行检查，然后再返回到当前点。不再需要重新运行该程序，每次<code>recording</code>都会始终以相同的方式重现程序的执行。</p>
<p>但<code>rr</code>依赖于虚拟机中某些特定的硬件虚拟化，并非每个虚拟化平台都支持。目前通过<code>VMWare</code>能成功运行<code>rr</code>，但无法通过<code>VirtualBox</code>不行。此外，<code>rr</code>当前仅支持<code>Linux</code>。</p>
<p><strong>安装依赖：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ccache cmake make g++-multilib gdb pkg-<span class="built_in">config</span> coreutils python3-pexpect manpages-dev git ninja-build capnproto libcapnp-dev</span><br></pre></td></tr></table></figure>

<p><strong>下载源码并编译：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="comment">//github.com/mozilla/rr.git</span></span><br><span class="line"><span class="built_in">mkdir</span> obj &amp;&amp; cd obj</span><br><span class="line">cmake ../rr</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>环境配置：</strong></p>
<p>在支持的虚拟化平台上安装<code>rr</code>后，首先需要将<code>perf_event_paranoid</code>文件的值设置为<code>1</code>来允许<code>rr</code>读取特定的性能事件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;perf_event_paranoid</span><br></pre></td></tr></table></figure>

<p>如果是使用虚拟机，还需要进行以下设置：</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20210304150923.png" style="zoom: 50%;">

<p>使用命令<code>rr record</code>，得到测试结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ rr record ./vulnerable &lt; out/crashes/id\:<span class="number">000000</span>\,sig\:<span class="number">11</span>\,src\:<span class="number">000010</span>\,time\:<span class="number">7917</span>\,op\:havoc\,rep\:<span class="number">32</span> </span><br><span class="line">rr: Saving execution to trace directory `/<span class="built_in">home</span>/zyt/.local/share/rr/vulnerable<span class="number">-0'.</span></span><br><span class="line">Segmentation fault</span><br><span class="line">  </span><br><span class="line">$ vim /<span class="built_in">home</span>/zyt/.local/share/rr/vulnerable<span class="number">-0</span>/</span><br><span class="line">data                        mmap_hardlink_3_vulnerable  tasks                       </span><br><span class="line">events                      mmaps                       version</span><br></pre></td></tr></table></figure>

<p>然后使用命令<code>rr replay</code>来启动一个<code>GDB session</code>来检查刚刚记录程序执行的<code>recording</code>。如下所示，程序开始运行并且在<code>_start()</code>函数处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────────────── code:x86:<span class="number">64</span> ──────────────────────────────────────────</span><br><span class="line">   <span class="number">0x7f280d06407d</span> &lt;oom+<span class="number">28</span>&gt;         call   <span class="number">0x7f280d080210</span> &lt;__GI__exit&gt;</span><br><span class="line">   <span class="number">0x7f280d064082</span>                  nop    WORD PTR cs:[rax+rax*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">   <span class="number">0x7f280d06408c</span>                  nop    DWORD PTR [rax+<span class="number">0x0</span>]</span><br><span class="line"> → <span class="number">0x7f280d064090</span> &lt;_start+<span class="number">0</span>&gt;       mov    rdi, rsp</span><br><span class="line">   <span class="number">0x7f280d064093</span> &lt;_start+<span class="number">3</span>&gt;       call   <span class="number">0x7f280d064ea0</span> &lt;_dl_start&gt;</span><br><span class="line">   <span class="number">0x7f280d064098</span> &lt;_dl_start_user+<span class="number">0</span>&gt; mov    r12, rax</span><br><span class="line">   <span class="number">0x7f280d06409b</span> &lt;_dl_start_user+<span class="number">3</span>&gt; mov    eax, DWORD PTR [rip+<span class="number">0x228697</span>]        # <span class="number">0x7f280d28c738</span> &lt;_dl_skip_args&gt;</span><br><span class="line">   <span class="number">0x7f280d0640a1</span> &lt;_dl_start_user+<span class="number">9</span>&gt; pop    rdx</span><br><span class="line">   <span class="number">0x7f280d0640a2</span> &lt;_dl_start_user+<span class="number">10</span>&gt; lea    rsp, [rsp+rax*<span class="number">8</span>]</span><br><span class="line">─────────────────────────────────────────threads────────────────────────────────────────────────</span><br><span class="line">[#<span class="number">0</span>] Id <span class="number">1</span>, stopped <span class="number">0x7f280d064090</span> in _start (), reason: STOPPED</span><br><span class="line">────────────────────────────────────────────────────── trace ───────────────────────────────────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x7f280d064090</span> → _start()</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">0x00007f280d064090</span> in _start () from /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span></span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>

<p>输入<code>c</code>继续执行，到达程序崩溃的地方：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">     <span class="number">0x400fbf</span> &lt;<span class="built_in">process</span>+<span class="number">655</span>&gt;    jmp    <span class="number">0x400ea8</span> &lt;<span class="built_in">process</span>+<span class="number">376</span>&gt;</span><br><span class="line">     <span class="number">0x400fc4</span> &lt;<span class="built_in">process</span>+<span class="number">660</span>&gt;    nop    DWORD PTR [rax+<span class="number">0x0</span>]</span><br><span class="line">     <span class="number">0x400fc8</span> &lt;<span class="built_in">process</span>+<span class="number">664</span>&gt;    lea    rdi, [rbp+<span class="number">0x2</span>]</span><br><span class="line">─────────────────────────────────── source:vulnerable.c+<span class="number">49</span> ───────────────────────────────────────────────</span><br><span class="line">     <span class="number">44</span>	 	&#123; <span class="comment">// head command</span></span><br><span class="line">     <span class="number">45</span>	 		<span class="keyword">if</span> (<span class="built_in">strlen</span>(input) &gt; <span class="number">6</span>)</span><br><span class="line">     <span class="number">46</span>	 		&#123;</span><br><span class="line">     <span class="number">47</span>	 			len = strtol(input + <span class="number">4</span>, &amp;rest, <span class="number">10</span>);</span><br><span class="line">     <span class="number">48</span>	 			rest += <span class="number">1</span>;		  <span class="comment">// skip the first char (should be a space)</span></span><br><span class="line">            <span class="comment">// rest=0x00007fff832657d0  →  [...]  →  0x39fafa0000e03939, len=-0x5b398001</span></span><br><span class="line"> →   <span class="number">49</span>	 			rest[len] = <span class="string">'\0'</span>; <span class="comment">// truncate string at specified offset</span></span><br><span class="line">     <span class="number">50</span>	 			<span class="built_in">printf</span>(<span class="string">"%s\n"</span>, rest);</span><br><span class="line">     <span class="number">51</span>	 		&#125;</span><br><span class="line">     <span class="number">52</span>	 		<span class="keyword">else</span></span><br><span class="line">     <span class="number">53</span>	 		&#123;</span><br><span class="line">     <span class="number">54</span>	 			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"head input was too small\n"</span>);</span><br><span class="line">────────────────────────────────────────── threads ───────────────────────────────────────────────────</span><br><span class="line">[#0] Id 1, stopped 0x400faf in process (), reason: SIGSEGV</span><br><span class="line">─────────────────────────────────────── trace ───────────────────────────────────────────────────────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x400faf</span> → <span class="built_in">process</span>(input=&lt;optimized out&gt;)</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x400a98</span> → main(argc=&lt;optimized out&gt;, argv=<span class="number">0x7fff83265988</span>)</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="built_in">process</span> (input=&lt;optimized out&gt;, input@entry=<span class="number">0x7fff83265820</span> <span class="string">"head "</span>, <span class="string">'9'</span> &lt;repeats <span class="number">15</span> times&gt;, <span class="string">"\"9"</span>, &lt;incomplete sequence \<span class="number">340</span>&gt;) at vulnerable.c:<span class="number">49</span></span><br><span class="line"><span class="number">49</span>				rest[len] = <span class="string">'\0'</span>; <span class="comment">// truncate string at specified offset</span></span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>

<p>到目前为止，除了能一遍又一遍地执行完全相同的程序之外，没有发现其他东西。现在，让我们看看<code>rr</code>的主要功能之一。如果我们想知道程序崩溃前的状态，该怎么办？通常，我们必须重新执行整个二进制程序，并在崩溃点前的指令上设置一个断点。但使用<code>rr</code>，我们可以利用反向执行来实现回滚：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x400fa3</span> &lt;<span class="built_in">process</span>+<span class="number">627</span>&gt;    adc    BYTE PTR [rax<span class="number">-0x68</span>], cl</span><br><span class="line">    <span class="number">0x400fa6</span> &lt;<span class="built_in">process</span>+<span class="number">630</span>&gt;    lea    r12, [r11+<span class="number">0x1</span>]</span><br><span class="line">    <span class="number">0x400faa</span> &lt;<span class="built_in">process</span>+<span class="number">634</span>&gt;    mov    QWORD PTR [rsp+<span class="number">0x10</span>], r12</span><br><span class="line">→   <span class="number">0x400faf</span> &lt;<span class="built_in">process</span>+<span class="number">639</span>&gt;    mov    BYTE PTR [r11+rax*<span class="number">1</span>+<span class="number">0x1</span>], <span class="number">0x0</span></span><br><span class="line">    <span class="number">0x400fb5</span> &lt;<span class="built_in">process</span>+<span class="number">645</span>&gt;    mov    rdi, QWORD PTR [rsp+<span class="number">0x10</span>]</span><br><span class="line">    <span class="number">0x400fba</span> &lt;<span class="built_in">process</span>+<span class="number">650</span>&gt;    call   <span class="number">0x4008a0</span> &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">    <span class="number">0x400fbf</span> &lt;<span class="built_in">process</span>+<span class="number">655</span>&gt;    jmp    <span class="number">0x400ea8</span> &lt;<span class="built_in">process</span>+<span class="number">376</span>&gt;</span><br><span class="line">    <span class="number">0x400fc4</span> &lt;<span class="built_in">process</span>+<span class="number">660</span>&gt;    nop    DWORD PTR [rax+<span class="number">0x0</span>]</span><br><span class="line">    <span class="number">0x400fc8</span> &lt;<span class="built_in">process</span>+<span class="number">664</span>&gt;    lea    rdi, [rbp+<span class="number">0x2</span>]</span><br></pre></td></tr></table></figure>

<p>当前的指令是<code>0x400faf</code>，现在可以使用<code>rr</code>的命令<code>reverse-step</code>来回滚，执行4次后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x400f90</span> &lt;<span class="built_in">process</span>+<span class="number">608</span>&gt;    lea    rsi, [rsp+<span class="number">0x10</span>]</span><br><span class="line">    <span class="number">0x400f95</span> &lt;<span class="built_in">process</span>+<span class="number">613</span>&gt;    mov    edx, <span class="number">0xa</span></span><br><span class="line">    <span class="number">0x400f9a</span> &lt;<span class="built_in">process</span>+<span class="number">618</span>&gt;    call   <span class="number">0x400900</span> &lt;strtol@plt&gt;</span><br><span class="line">→   <span class="number">0x400f9f</span> &lt;<span class="built_in">process</span>+<span class="number">623</span>&gt;    mov    r11, QWORD PTR [rsp+<span class="number">0x10</span>]</span><br><span class="line">    <span class="number">0x400fa4</span> &lt;<span class="built_in">process</span>+<span class="number">628</span>&gt;    cdqe   </span><br><span class="line">    <span class="number">0x400fa6</span> &lt;<span class="built_in">process</span>+<span class="number">630</span>&gt;    lea    r12, [r11+<span class="number">0x1</span>]</span><br><span class="line">    <span class="number">0x400faa</span> &lt;<span class="built_in">process</span>+<span class="number">634</span>&gt;    mov    QWORD PTR [rsp+<span class="number">0x10</span>], r12</span><br><span class="line">    <span class="number">0x400faf</span> &lt;<span class="built_in">process</span>+<span class="number">639</span>&gt;    mov    BYTE PTR [r11+rax*<span class="number">1</span>+<span class="number">0x1</span>], <span class="number">0x0</span></span><br><span class="line">    <span class="number">0x400fb5</span> &lt;<span class="built_in">process</span>+<span class="number">645</span>&gt;    mov    rdi, QWORD PTR [rsp+<span class="number">0x10</span>]</span><br></pre></td></tr></table></figure>

<p>如上所示，我们已经回滚到之前的指令。下一步回退会进入到函数<code>strtol()</code>中，假设我们不想对其调试，可以直接使用命令<code>reverse-next</code>来跳过：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x400f7b</span> &lt;<span class="built_in">process</span>+<span class="number">587</span>&gt;    mov    rcx, QWORD PTR [rsp+<span class="number">0x8</span>]</span><br><span class="line">    <span class="number">0x400f80</span> &lt;<span class="built_in">process</span>+<span class="number">592</span>&gt;    mov    rdx, QWORD PTR [rsp]</span><br><span class="line">    <span class="number">0x400f84</span> &lt;<span class="built_in">process</span>+<span class="number">596</span>&gt;    lea    rsp, [rsp+<span class="number">0x98</span>]</span><br><span class="line">→   <span class="number">0x400f8c</span> &lt;<span class="built_in">process</span>+<span class="number">604</span>&gt;    lea    rdi, [rbp+<span class="number">0x4</span>]</span><br><span class="line">    <span class="number">0x400f90</span> &lt;<span class="built_in">process</span>+<span class="number">608</span>&gt;    lea    rsi, [rsp+<span class="number">0x10</span>]</span><br><span class="line">    <span class="number">0x400f95</span> &lt;<span class="built_in">process</span>+<span class="number">613</span>&gt;    mov    edx, <span class="number">0xa</span></span><br><span class="line">    <span class="number">0x400f9a</span> &lt;<span class="built_in">process</span>+<span class="number">618</span>&gt;    call   <span class="number">0x400900</span> &lt;strtol@plt&gt;</span><br><span class="line">    <span class="number">0x400f9f</span> &lt;<span class="built_in">process</span>+<span class="number">623</span>&gt;    mov    r11, QWORD PTR [rsp+<span class="number">0x10</span>]</span><br><span class="line">    <span class="number">0x400fa4</span> &lt;<span class="built_in">process</span>+<span class="number">628</span>&gt;    cdqe</span><br></pre></td></tr></table></figure>

<p>如上所示，我们已经跳过了函数<code>strtol()</code>。假设我们像知道一个内存地址什么时候被改变以及该地址保存的数据在<code>crash</code>前是怎么变化的。使用命令<code>c</code>使程序继续执行到达崩溃点，然后使用命令`watch进行设置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch *<span class="number">0x00007fff83265820</span></span><br></pre></td></tr></table></figure>

<p>设置后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">     <span class="number">54</span>	 			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"head input was too small\n"</span>);</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, stopped 0x400faf in process (), reason: SIGSEGV</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x400faf</span> → <span class="built_in">process</span>(input=&lt;optimized out&gt;)</span><br><span class="line">[#<span class="number">1</span>] <span class="number">0x400a98</span> → main(argc=&lt;optimized out&gt;, argv=<span class="number">0x7fff83265988</span>)</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="built_in">process</span> (input=&lt;optimized out&gt;, input@entry=<span class="number">0x7fff83265820</span> <span class="string">"head "</span>, <span class="string">'9'</span> &lt;repeats <span class="number">15</span> times&gt;, <span class="string">"\"9"</span>, &lt;incomplete sequence \<span class="number">340</span>&gt;) at vulnerable.c:<span class="number">49</span></span><br><span class="line"><span class="number">49</span>				rest[len] = <span class="string">'\0'</span>; <span class="comment">// truncate string at specified offset</span></span><br><span class="line">gef➤  watch *<span class="number">0x00007fff83265820</span></span><br><span class="line">Hardware watchpoint <span class="number">2</span>: *<span class="number">0x00007fff83265820</span></span><br></pre></td></tr></table></figure>

<p>With that set, let’s now run the “reverse-continue” command to go back in time until the most recent write to that address</p>
<p>然后，我们运行命令<code>reverse-continue</code>来回退，直到最近该地址被写入的时刻：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00000000681ffdd8</span>│+<span class="number">0x0000</span>: <span class="number">0x00007f280ce58e44</span>  →  &lt;syscall_hook+<span class="number">10916</span>&gt; mov r15, rax	 ← $rsp</span><br><span class="line"><span class="number">0x00000000681ffde0</span>│+<span class="number">0x0008</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00000000681ffde8</span>│+<span class="number">0x0010</span>: <span class="number">0x000000007fffffff</span></span><br><span class="line"><span class="number">0x00000000681ffdf0</span>│+<span class="number">0x0018</span>: <span class="number">0x00007f280c85a320</span>  →  <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x00000000681ffdf8</span>│+<span class="number">0x0020</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00000000681ffe00</span>│+<span class="number">0x0028</span>: <span class="number">0x0000000000000081</span></span><br><span class="line"><span class="number">0x00000000681ffe08</span>│+<span class="number">0x0030</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00000000681ffe10</span>│+<span class="number">0x0038</span>: <span class="number">0x0000000000000000</span></span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:<span class="number">64</span> ────</span><br><span class="line">   <span class="number">0x7f280ce55214</span> &lt;copy_output_buffer.part+<span class="number">20</span>&gt; rol    BYTE PTR [rcx+rcx*<span class="number">8</span><span class="number">-0x76b7f48b</span>], <span class="number">1</span></span><br><span class="line">   <span class="number">0x7f280ce5521b</span> &lt;copy_output_buffer.part+<span class="number">27</span>&gt; (bad)  </span><br><span class="line">   <span class="number">0x7f280ce5521c</span> &lt;copy_output_buffer.part+<span class="number">28</span>&gt; mov    ecx, r8d</span><br><span class="line"> → <span class="number">0x7f280ce5521f</span> &lt;copy_output_buffer.part+<span class="number">31</span>&gt; rep    movs BYTE PTR es:[rdi], BYTE PTR ds:[rsi]</span><br><span class="line">   <span class="number">0x7f280ce55221</span> &lt;copy_output_buffer.part+<span class="number">33</span>&gt; add    rax, r8</span><br><span class="line">   <span class="number">0x7f280ce55224</span> &lt;copy_output_buffer.part+<span class="number">36</span>&gt; repz   ret</span><br><span class="line">   <span class="number">0x7f280ce55226</span>                  nop    WORD PTR cs:[rax+rax*<span class="number">1</span>+<span class="number">0x0</span>]</span><br><span class="line">   <span class="number">0x7f280ce55230</span> &lt;force_traced_syscall_for_chaos_mode.part+<span class="number">0</span>&gt; mov    edx, DWORD PTR [rip+<span class="number">0x206e4a</span>]        # <span class="number">0x7f280d05c080</span> &lt;buffer_chaos_mode_syscalls&gt;</span><br><span class="line">   <span class="number">0x7f280ce55236</span> &lt;force_traced_syscall_for_chaos_mode.part+<span class="number">6</span>&gt; mov    eax, DWORD PTR [rip+<span class="number">0x206e48</span>]        # <span class="number">0x7f280d05c084</span> &lt;trace_chaos_mode_syscalls&gt;</span><br><span class="line">[!] Command 'context' failed to execute properly, reason: argument of type 'NoneType' is not iterable</span><br><span class="line"></span><br><span class="line">Hardware watchpoint <span class="number">2</span>: * <span class="number">0x00007fff83265820</span></span><br><span class="line"></span><br><span class="line">Old value = <span class="number">0x64616568</span></span><br><span class="line">New value = <span class="number">0x616568</span></span><br><span class="line"><span class="number">0x00007f280ce5521f</span> in local_memcpy (n=<span class="number">0x24</span>, source=<span class="number">0x7f280d16f02e</span>, dest=<span class="number">0x7fff83265823</span>) at /root/rr/src/preload/syscallbuf.c:<span class="number">196</span></span><br><span class="line"><span class="number">196</span>	  __asm__ __volatile__(<span class="string">"rep movsb\n\t"</span></span><br></pre></td></tr></table></figure>

<p>现在，我们可以确切地看到地址中的内容合适被更改以及写入的内容。注意，由于是回退操作，因此“Old value”实际上是该地址最近被修改的值，而“新值”是该地址在更改之前持有的值。<code>向后</code>观察地址的每次更改都可以帮助查找棘手的错误，如：UAF。</p>
<p><code>rr</code>是执行详细崩溃分析的出色工具。但是，进行仔细的调试可能是一个缓慢的过程，因此，在开始对由<code>Fuzzer</code>生成的崩溃进行分类时，<code>rr</code>可能并不是首选工具。相反，可以通过使用本文前面详细介绍的一些分类工具来缩小可能发生的崩溃的数量。一旦将崩溃输入减少到一定的数目，在使用工具rr，可以大大减少调试崩溃以确定安全隐患所花费的时间。</p>
<p><code>rr</code>的设计旨在使更复杂的软件（例如浏览器）的调试更加容易。如果想了解<code>rr的在实际中较为复杂程序上如何使用，可以参考链接</code>3。</p>
<blockquote>
<ol>
<li><a href="https://github.com/mozilla/rr" target="_blank" rel="noopener">https://github.com/mozilla/rr</a></li>
<li><a href="https://rr-project.org/" target="_blank" rel="noopener">https://rr-project.org/</a></li>
<li><a href="https://blog.ret2.io/2018/06/19/pwn2own-2018-root-cause-analysis/" target="_blank" rel="noopener">https://blog.ret2.io/2018/06/19/pwn2own-2018-root-cause-analysis/</a></li>
</ol>
</blockquote>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>本文主要是介绍了一些对<code>crash</code>输入进行分类的工具，可以减少分析的繁琐程度和时间开销。</p>
<ul>
<li>可以仅使用<code>crash</code>文件作为输入，在<code>GDB</code>（或其他调试器）中重新运行目标二进制程序来对crash进行分类。这可以重现崩溃，并在调试器中检查有关崩溃的详细信息</li>
<li><code>exploitable</code>是<code>GDB</code>的一个插件。它会检查目标程序在崩溃点处的状态，并根据当前漏洞能否被利用对其进行分类。</li>
<li><code>Crashwalk</code>是一款与<code>exploitable</code>搭配使用的工具，可以遍历<code>AFL</code>生成的所有<code>crash</code>输入，并使用<code>exploitable</code>对其进行分析，将结果存储在<code>crashwalk.db</code>文件中。这样可以避免每次对单个崩溃手动运行插件来调试，<code>Crashwalk</code>为了使得结果便于理解，进行了简单的排序。</li>
<li>AFL的<code>crash exploration mode</code>，通过对当前<code>crash</code>输入进行变异，以便在不更改原来崩溃的情况下探索新的代码路径。这有助于更好地了解攻击者对错误地址或其他崩溃的实际控制权，并且可以在进行漏洞利用时选择最有可能成功的崩溃输入。</li>
<li><code>rr</code>可以记录程序的执行，然后在调试会话中重放该程序。这样可以很容易地“遍历”整个执行过程，从而避免一遍又一遍地重新启动程序。并且便于检查崩溃之前的程序状态。</li>
</ul>
<blockquote>
<ol>
<li><a href="https://trustfoundry.net/introduction-to-triaging-fuzzer-generated-crashes/" target="_blank" rel="noopener">https://trustfoundry.net/introduction-to-triaging-fuzzer-generated-crashes/</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/26/IDAPython%E6%8F%90%E5%8F%96%E7%A8%8B%E5%BA%8F%E4%B8%ADCompare%E5%AD%97%E7%AC%A6%E4%BF%A1%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/26/IDAPython%E6%8F%90%E5%8F%96%E7%A8%8B%E5%BA%8F%E4%B8%ADCompare%E5%AD%97%E7%AC%A6%E4%BF%A1%E6%81%AF/" itemprop="url">IDAPython提取程序中Compare字符信息</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-26T17:00:38+08:00">
                2021-01-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IDAPython/" itemprop="url" rel="index">
                    <span itemprop="name">IDAPython</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="IDAPython提取程序中Compare字符信息"><a href="#IDAPython提取程序中Compare字符信息" class="headerlink" title="IDAPython提取程序中Compare字符信息"></a>IDAPython提取程序中Compare字符信息</h1><h2 id="一、脚本"><a href="#一、脚本" class="headerlink" title="一、脚本"></a>一、脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_string</span><span class="params">(para,index)</span>:</span></span><br><span class="line">    out = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> GetOpType(para, <span class="number">0</span>) == <span class="number">5</span>:</span><br><span class="line">        addr = GetOperandValue(para,<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> addr &gt; <span class="number">0x8048000</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">if</span> Byte(addr) != <span class="number">0</span>:</span><br><span class="line">                    out += chr(Byte(addr))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out = GetOpnd(para,index)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findCMPopnds</span><span class="params">()</span>:</span></span><br><span class="line">    cmpl=[<span class="string">'cmp'</span>,<span class="string">'CMP'</span>]</span><br><span class="line">    strcmp_func = [<span class="string">'strcmp'</span>, <span class="string">'strncmp'</span>]</span><br><span class="line">    names=set()</span><br><span class="line">    result1=set()<span class="comment">#contains full strings as they appear in the instruction </span></span><br><span class="line">    result2=set()<span class="comment">#contains bytes of strings in instruction</span></span><br><span class="line">    <span class="comment"># For each of the segments</span></span><br><span class="line">    <span class="keyword">for</span> seg_ea <span class="keyword">in</span> Segments(): <span class="comment">##获取程序的段信息</span></span><br><span class="line">        <span class="keyword">for</span> head <span class="keyword">in</span> Heads(seg_ea, SegEnd(seg_ea)): <span class="comment">##获取seg_ea和SegEnd(seg_ea)之间所有的地址</span></span><br><span class="line">            <span class="keyword">if</span> isCode(GetFlags(head)):</span><br><span class="line">                mnem = GetMnem(head) <span class="comment">##获取汇编语句的操作码</span></span><br><span class="line">                <span class="comment">#print mnem</span></span><br><span class="line">                <span class="keyword">if</span> mnem <span class="keyword">in</span> cmpl:</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                        <span class="keyword">if</span> GetOpType(head,i)==<span class="number">5</span>: <span class="comment">##操作数是确定的一个立即数，类型为5，o_imm</span></span><br><span class="line">                            names.add(GetOpnd(head,i))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> mnem <span class="keyword">in</span> <span class="string">"call"</span>:</span><br><span class="line">                    call_string = GetOpnd(head, <span class="number">0</span>)</span><br><span class="line">                    <span class="comment"># print "mnem: ", mnem, " call: ", call_string </span></span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> strcmp_func:</span><br><span class="line">                        <span class="keyword">if</span> item <span class="keyword">in</span> call_string:</span><br><span class="line">                            <span class="keyword">for</span> para <span class="keyword">in</span> idaapi.get_arg_addrs(head):</span><br><span class="line">                                <span class="keyword">print</span> idc.GetDisasm(para)</span><br><span class="line">                                <span class="keyword">if</span> <span class="string">'push'</span> <span class="keyword">in</span> GetMnem(para):</span><br><span class="line">                                    oper_string = get_string(para,<span class="number">0</span>)</span><br><span class="line">                                    <span class="keyword">print</span> oper_string</span><br><span class="line">                                    result1.add(oper_string)</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> <span class="string">'mov'</span> <span class="keyword">in</span> GetMnem(para):</span><br><span class="line">                                    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                                        <span class="keyword">if</span> GetOpType(para, i) == <span class="number">5</span>:</span><br><span class="line">                                            oper_string = get_string(para,i)</span><br><span class="line">                                            result1.add(oper_string)</span><br><span class="line">    <span class="keyword">for</span> el <span class="keyword">in</span> names:</span><br><span class="line">        tm=el.rstrip(<span class="string">'h'</span>)</span><br><span class="line">        <span class="keyword">print</span> tm</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all(c <span class="keyword">in</span> string.hexdigits <span class="keyword">for</span> c <span class="keyword">in</span> tm): <span class="comment"># string.hexdigits will give the hexadecimal letters ‘0123456789abcdefABCDEF’.</span></span><br><span class="line">            <span class="keyword">continue</span> <span class="comment"># strange case: sometimes ida returns not immediate!!</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(tm)%<span class="number">2</span> !=<span class="number">0</span>:</span><br><span class="line">            tm=<span class="string">"0"</span>+tm</span><br><span class="line">        whx=<span class="string">''</span></span><br><span class="line">        <span class="keyword">print</span> tm</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,len(tm),<span class="number">2</span>):</span><br><span class="line">            <span class="comment"># hx=chr(int(tm[i:i+2],16))</span></span><br><span class="line">            hx = <span class="string">"\\x"</span>+str(tm[i:i+<span class="number">2</span>])</span><br><span class="line">            result2.add(hx)</span><br><span class="line">            whx=whx+hx</span><br><span class="line">        result1.add(whx)</span><br><span class="line"></span><br><span class="line">    result1.difference_update(result2)</span><br><span class="line">    <span class="keyword">print</span> result1, result2</span><br><span class="line">    <span class="keyword">return</span> result1,result2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    result1, result2=findCMPopnds()</span><br><span class="line">    outFile=GetInputFile() <span class="comment"># name of the that is being analysed</span></span><br><span class="line">    strFile=outFile+<span class="string">".txt"</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> open(strFile, <span class="string">"w"</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> result1:</span><br><span class="line">            <span class="keyword">if</span> len(item) &gt; <span class="number">0</span>:</span><br><span class="line">                fp.write(<span class="string">"String=\""</span>+item+<span class="string">"\"\n"</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> result2:</span><br><span class="line">            <span class="keyword">if</span> len(item) &gt; <span class="number">0</span>:</span><br><span class="line">                fp.write(<span class="string">"String=\""</span>+item+<span class="string">"\"\n"</span>)      </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"[*] Saved results in files: %s"</span>%(strFile)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="二、API"><a href="#二、API" class="headerlink" title="二、API"></a>二、API</h2><h3 id="获取指令操作数的值"><a href="#获取指令操作数的值" class="headerlink" title="获取指令操作数的值"></a>获取指令操作数的值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetOperandValue(addr, index) <span class="comment">## 获取地址对应指令中操作数的值。例如:push offset s2; cond。index为0代表得到 s2 的地址</span></span><br></pre></td></tr></table></figure>

<h2 id="获取函数参数"><a href="#获取函数参数" class="headerlink" title="获取函数参数"></a>获取函数参数</h2><p>使用<code>API：daapi.get_arg_addrs()</code>。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LOAD:FFFFFFFF82491188                 mov     rdi, offset unk_FFFFFFFF832EF148 ; a1</span><br><span class="line">LOAD:FFFFFFFF8249118F                 mov     rsi, rbx        ; a2</span><br><span class="line">LOAD:FFFFFFFF82491192                 xor     edx, edx        ; a3</span><br><span class="line">LOAD:FFFFFFFF82491194                 xor     ecx, ecx</span><br><span class="line">LOAD:FFFFFFFF82491196                 xor     r8d, r8d</span><br><span class="line">LOAD:FFFFFFFF82491199                 call    _sx_xlock_hard</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">Python&gt;<span class="keyword">print</span> map(hex, idaapi.get_arg_addrs(here()))</span><br></pre></td></tr></table></figure>

<p>通过运行<code>idaapi.get_arg_address（0xFFFFFFFF82491199）</code>，它将按照调用函数时给出的顺序返回3个参数的地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'0xffffffff82491188L'</span>, <span class="string">'0xffffffff8249118fL'</span>, <span class="string">'0xffffffff82491192L'</span>](rdi、rsi、edx)</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://unit42.paloaltonetworks.com/using-idapython-to-make-your-life-easier-part-1/" target="_blank" rel="noopener">https://unit42.paloaltonetworks.com/using-idapython-to-make-your-life-easier-part-1/</a></li>
<li><a href="https://wooyun.js.org/drops/IDAPython%20%E8%AE%A9%E4%BD%A0%E7%9A%84%E7%94%9F%E6%B4%BB%E6%9B%B4%E6%BB%8B%E6%B6%A6%20part1%20and%20part2.html" target="_blank" rel="noopener">https://wooyun.js.org/drops/IDAPython%20%E8%AE%A9%E4%BD%A0%E7%9A%84%E7%94%9F%E6%B4%BB%E6%9B%B4%E6%BB%8B%E6%B6%A6%20part1%20and%20part2.html</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/18/GCC%20%E5%92%8C%20Address%20Sanitizer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/18/GCC%20%E5%92%8C%20Address%20Sanitizer/" itemprop="url">GCC 和 Address Sanitizer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-18T12:11:09+08:00">
                2020-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AddressSanitizer/" itemprop="url" rel="index">
                    <span itemprop="name">AddressSanitizer</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="GCC-和-Address-Sanitizer"><a href="#GCC-和-Address-Sanitizer" class="headerlink" title="GCC 和 Address Sanitizer"></a>GCC 和 Address Sanitizer</h1><h2 id="GCC"><a href="#GCC" class="headerlink" title="GCC"></a>GCC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget -c http:&#x2F;&#x2F;www.mirrorservice.org&#x2F;sites&#x2F;sourceware.org&#x2F;pub&#x2F;gcc&#x2F;releases&#x2F;gcc-4.4.0&#x2F;gcc-4.4.0.tar.bz2</span><br><span class="line">$ tar -xjvf gcc-4.4.0.tar.bz2</span><br><span class="line">$ .&#x2F;configure</span><br><span class="line">$ make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h2><p>使用 <code>gcc -v</code> 可以查看默认开启的选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC&#x3D;gcc</span><br><span class="line">COLLECT_LTO_WRAPPER&#x3D;&#x2F;usr&#x2F;lib&#x2F;gcc&#x2F;x86_64-linux-gnu&#x2F;5&#x2F;lto-wrapper</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ..&#x2F;src&#x2F;configure -v --with-pkgversion&#x3D;&#39;Ubuntu 5.4.0-6ubuntu1~16.04.9&#39; --with-bugurl&#x3D;file:&#x2F;&#x2F;&#x2F;usr&#x2F;share&#x2F;doc&#x2F;gcc-5&#x2F;README.Bugs --enable-languages&#x3D;c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix&#x3D;&#x2F;usr --program-suffix&#x3D;-5 --enable-shared --enable-linker-build-id --libexecdir&#x3D;&#x2F;usr&#x2F;lib --without-included-gettext --enable-threads&#x3D;posix --libdir&#x3D;&#x2F;usr&#x2F;lib --enable-nls --with-sysroot&#x3D;&#x2F; --enable-clocale&#x3D;gnu --enable-libstdcxx-debug --enable-libstdcxx-time&#x3D;yes --with-default-libstdcxx-abi&#x3D;new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt&#x3D;gtk --enable-gtk-cairo --with-java-home&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.5.0-gcj-5-amd64&#x2F;jre --enable-java-home --with-jvm-root-dir&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-1.5.0-gcj-5-amd64 --with-jvm-jar-dir&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm-exports&#x2F;java-1.5.0-gcj-5-amd64 --with-arch-directory&#x3D;amd64 --with-ecj-jar&#x3D;&#x2F;usr&#x2F;share&#x2F;java&#x2F;eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32&#x3D;i686 --with-abi&#x3D;m64 --with-multilib-list&#x3D;m32,m64,mx32 --enable-multilib --with-tune&#x3D;generic --enable-checking&#x3D;release --build&#x3D;x86_64-linux-gnu --host&#x3D;x86_64-linux-gnu --target&#x3D;x86_64-linux-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.9)</span><br></pre></td></tr></table></figure>

<h3 id="控制标准版本的编译选项"><a href="#控制标准版本的编译选项" class="headerlink" title="控制标准版本的编译选项"></a>控制标准版本的编译选项</h3><ul>
<li><p><code>-ansi</code>：告诉编译器遵守 C 语言的 ISO C90 标准。</p>
</li>
<li><pre><code>-std=
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ：通过使用一个参数来设置需要的标准。</span><br><span class="line"></span><br><span class="line">  - &#96;c89&#96;：支持 C89 标准。</span><br><span class="line">  - &#96;iso9899:1999&#96;：支持 ISO C90 标准。</span><br><span class="line">  - &#96;gnu89&#96;：支持 C89 标准。</span><br><span class="line"></span><br><span class="line">### 控制标准版本的常量</span><br><span class="line"></span><br><span class="line">这些常量（#define）可以通过编译器的命令行选项来设置，或者通过源代码总的 &#96;#define&#96; 语句来定义。</span><br><span class="line"></span><br><span class="line">- &#96;__STRICT_ANSI__&#96;：强制使用 C 语言的 ISO 标准。这个常量通过命令行选项 &#96;-ansi&#96; 来定义。</span><br><span class="line">- &#96;_POSIX_C_SOURCE&#x3D;2&#96;：启用由 IEEE Std1003.1 和 1003.2 标准定义的特性。</span><br><span class="line">- &#96;_BSD_SOURCE&#96;：启用 BSD 类型的特性。</span><br><span class="line">- &#96;_GNU_SOURCE&#96;：启用大量特性，其中包括 GNU 扩展。</span><br><span class="line"></span><br><span class="line">### 编译器的警告选项</span><br><span class="line"></span><br><span class="line">- &#96;-pedantic&#96;：除了启用用于检查代码是否遵守 C 语言标准的选项外，还关闭了一些不被标准允许的传统 C 语言结构，并且禁用所有的 GNU 扩展。</span><br><span class="line">- &#96;-Wformat&#96;：检查 printf 系列函数所使用的参数类型是否正确。</span><br><span class="line">- &#96;Wparentheses&#96;：检查是否总是提供了需要的圆括号。当想要检查一个复杂结构的初始化是否按照预期进行时，这个选项就很有用。</span><br><span class="line">- &#96;Wswitch-default&#96;：检查是否所有的 switch 语句都包含一个 default case。</span><br><span class="line">- &#96;Wunused&#96;：检查诸如声明静态函数但没有定义、未使用的参数和丢弃返回结果等情况。</span><br><span class="line">- &#96;Wall&#96;：启用绝大多数 gcc 的警告选项，包括所有以 -W 为前缀的选项。</span><br><span class="line"></span><br><span class="line">## Address sanitizer</span><br><span class="line"></span><br><span class="line">Address sanitizer 是一种用于检测内存错误的技术，GCC 从 4.8 版本开始支持了这一技术。ASan 在编译时插入额外指令到内存访问操作中，同时通过 Shadow memory 来记录和检测内存的有效性。ASan 其实只是 Sanitizer 一系列工具中的一员，其他工具比如 memory leak 检测在 LeakSanitizer 中，uninitialized memory read 检测在 MemorySanitizer 中等等。</span><br><span class="line"></span><br><span class="line">举个例子，很明显下面这个程序存在栈溢出：</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;C</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">void main() &#123;</span><br><span class="line">    int a[10] &#x3D; &#123;0&#125;;</span><br><span class="line">    int b &#x3D; a[11];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ul>
<p>编译时加上参数 <code>-fsanitize=address</code>，如果使用 Makefile，则将参数加入到 CFLAGS 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -fsanitize&#x3D;address santest.c</span><br></pre></td></tr></table></figure>

<p>然后运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;a.out</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;9399&#x3D;&#x3D;ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffc03f4d64c at pc 0x565515082ad6 bp 0x7ffc03f4d5e0 sp 0x7ffc03f4d5d0</span><br><span class="line">READ of size 4 at 0x7ffc03f4d64c thread T0</span><br><span class="line">    #0 0x565515082ad5 in main (&#x2F;home&#x2F;firmy&#x2F;a.out+0xad5)</span><br><span class="line">    #1 0x7fb4c04c0f69 in __libc_start_main (&#x2F;usr&#x2F;lib&#x2F;libc.so.6+0x20f69)</span><br><span class="line">    #2 0x565515082899 in _start (&#x2F;home&#x2F;firmy&#x2F;a.out+0x899)</span><br><span class="line"></span><br><span class="line">Address 0x7ffc03f4d64c is located in stack of thread T0 at offset 76 in frame</span><br><span class="line">    #0 0x565515082989 in main (&#x2F;home&#x2F;firmy&#x2F;a.out+0x989)</span><br><span class="line"></span><br><span class="line">  This frame has 1 object(s):</span><br><span class="line">    [32, 72) &#39;a&#39; &lt;&#x3D;&#x3D; Memory access at offset 76 overflows this variable</span><br><span class="line">HINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext</span><br><span class="line">      (longjmp and C++ exceptions *are* supported)</span><br><span class="line">SUMMARY: AddressSanitizer: stack-buffer-overflow (&#x2F;home&#x2F;firmy&#x2F;a.out+0xad5) in main</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x1000007e1a70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1a80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1a90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1aa0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1ab0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">&#x3D;&gt;0x1000007e1ac0: f1 f1 f1 f1 00 00 00 00 00[f2]f2 f2 00 00 00 00</span><br><span class="line">  0x1000007e1ad0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1ae0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1af0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1b00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x1000007e1b10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07</span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after return:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">&#x3D;&#x3D;9399&#x3D;&#x3D;ABORTING</span><br></pre></td></tr></table></figure>

<p>确实检测出了问题。在实战篇中，为了更好地分析软件漏洞，我们可能会经常用到这个选项。</p>
<p>参考：<a href="https://en.wikipedia.org/wiki/AddressSanitizer" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/AddressSanitizer</a></p>
<h2 id="mcheck"><a href="#mcheck" class="headerlink" title="mcheck"></a>mcheck</h2><p>利用 mcheck 可以实现堆内存的一致性状态检查。其定义在 <code>/usr/include/mcheck.h</code>，是一个 GNU 扩展函数，原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mcheck.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mcheck</span><span class="params">(<span class="keyword">void</span> (*abortfunc)(<span class="keyword">enum</span> mcheck_status mstatus))</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以看到参数是一个函数指针，但检查到堆内存异常时，通过该指针调用 abortfunc 函数，同时传入一个 mcheck_status 类型的参数。</p>
<p>举个例子，下面的程序存在 double-free 的问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    p = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"About to free\n"</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"About to free a second time\n"</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Finish\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过设置参数 <code>-lmcheck</code> 来链接 mcheck 函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -lmcheck t_mcheck.c</span><br><span class="line">$ .&#x2F;a.out</span><br><span class="line">About to free</span><br><span class="line">About to free a second time</span><br><span class="line">block freed twice</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>

<p>还可以通过设置环境变量 <code>MALLOC_CHECK_</code> 来实现，这样就不需要重新编译程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ gcc mcheck.c</span><br><span class="line">$ #检查到错误时不作任何提示</span><br><span class="line">$ MALLOC_CHECK_&#x3D;0 .&#x2F;a.out</span><br><span class="line">About to free</span><br><span class="line">About to free a second time</span><br><span class="line">Finish</span><br><span class="line">$ #检查到错误时打印一条信息到标准输出</span><br><span class="line">$ MALLOC_CHECK_&#x3D;1 .&#x2F;a.out</span><br><span class="line">About to free</span><br><span class="line">About to free a second time</span><br><span class="line">*** Error in &#96;.&#x2F;a.out&#39;: free(): invalid pointer: 0x0000000001fb9010 ***</span><br><span class="line">Finish</span><br><span class="line">$ #检查到错误时直接中止程序</span><br><span class="line">$ MALLOC_CHECK_&#x3D;2 .&#x2F;a.out</span><br><span class="line">About to free</span><br><span class="line">About to free a second time</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>

<p>具体参考 <code>man 3 mcheck</code> 和 <code>man 3 mallopt</code>。</p>
<p>glibc 还提供了 <code>mtrace()</code> 和 <code>muntrace()</code> 函数分别在程序中打开和关闭对内存分配调用进行跟踪的功能。这些函数需要与环境变量 <code>MALLOC_TRACE</code> 配合使用，该变量定义了写入跟踪信息的文件名。在被调用时，<code>mtrace()</code> 会检查是否定义了该文件，又是否可以读写该文件。如果一切正常，那么会在文件里跟踪和记录所有对 malloc 系列函数的调用。由于生成的文件不易于理解，还提供了脚本（<code>mtrace</code>）用于分析文件，并生成易于理解的汇总报告。</p>
<p>将上面的例子修改一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mcheck.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line"></span><br><span class="line">    mtrace();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">16</span>, <span class="number">16</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"calloc some chunks that will not be freed\n"</span>);</span><br><span class="line"></span><br><span class="line">    p = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"About to free\n"</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"About to free a second time\n"</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Finish\n"</span>);</span><br><span class="line"></span><br><span class="line">    muntrace();</span><br><span class="line">&#125;</span><br><span class="line">$ gcc t_mtrace.c</span><br><span class="line">$ <span class="keyword">export</span> MALLOC_TRACE=/tmp/t</span><br><span class="line">$ ./a.out</span><br><span class="line"><span class="built_in">calloc</span> some chunks that will <span class="keyword">not</span> be freed</span><br><span class="line">About to <span class="built_in">free</span></span><br><span class="line">About to <span class="built_in">free</span> a second time</span><br><span class="line">Finish</span><br><span class="line">$ mtrace /tmp/t</span><br><span class="line">- <span class="number">0x000055e427cde7b0</span> Free <span class="number">5</span> was never alloc<span class="number">'</span>d <span class="number">0x55e425da287c</span></span><br><span class="line"></span><br><span class="line">Memory <span class="keyword">not</span> freed:</span><br><span class="line">-----------------</span><br><span class="line">           Address     Size     Caller</span><br><span class="line"><span class="number">0x000055e427cde6a0</span>    <span class="number">0x100</span>  at <span class="number">0x55e425da27f6</span></span><br></pre></td></tr></table></figure>

<p>于是 double-free 和内存泄漏被检测出来了。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>[GCC online documentation](</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/30/%E5%8A%A8%E6%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8F%92%E6%A1%A9(Pin)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/30/%E5%8A%A8%E6%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8F%92%E6%A1%A9(Pin)/" itemprop="url">动态二进制插桩 (Pin)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-30T15:20:13+08:00">
                2020-11-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>DBI</strong>（dynamic binary instrumentation）会监控程序的执行，并对指令流插桩，不会像 <strong>SBI</strong>（static binary instrumentation）那样反汇编、重写二进制，容错率更高。</p>
<p>下图展现了现代 <strong>DBI</strong> 系统（如：Pin、 DynamoRIO）的架构：</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201126195918.png" style="zoom: 50%;">

<h2 id="一、Architecture-of-a-DBI-System"><a href="#一、Architecture-of-a-DBI-System" class="headerlink" title="一、Architecture of a DBI System"></a>一、Architecture of a DBI System</h2><p><strong>DBI</strong> 引擎通过监控、控制执行的指令来动态对程序插桩。<strong>DBI</strong> 引擎会提供一些API，可以用来实现用户自己的 <strong>DBI</strong> 工具，实现动态插桩。通常这些工具以共享库的形式被 <strong>DBI</strong> 引擎加载。如上图右侧所示，它利用 <strong>DBI</strong> 的API实现了一个简单的 DBI tool，对每个基本块的最后一条指令插桩，注册了一个回调函数来递增指令计数器。</p>
<p>在 <strong>DBI</strong> 引擎开始其主要工作之前，允许 DBI tool 来初始化它自己。比如上图的 <code>1</code>，DBI tool 的初始化函数<code>init()</code>注册了一个函数 <code>instrument_bb()</code>，告诉 <strong>DBI</strong> 引擎如何对每一个基本块进行插桩：每当基本块最后一条指令执行后会调用回调函数<code>bb_callback()</code>。然后，初始化函数<code>init()</code>告诉 <strong>DBI</strong> 引擎已完成初始化操作，可以开始执行目标程序。</p>
<p><strong>DBI</strong> 引擎不会直接运行目标程序，而是运行<code>code cache</code>中所包含的已经插桩后的代码。初始时，<code>code cache</code>是空的，<strong>DBI</strong> 引擎会从进程中截取基本块<code>3</code>，然后使用 DBI tool 对其插桩 <code>4</code>。<strong>DBI</strong> 引擎并不会在基本块粒度截取代码并对其插桩，而是在<code>Trace</code>粒度进行。为了方便，此处的例子通过调用函数<code>instrument_bb()</code>，在基本块粒度进行插桩。</p>
<p>插桩后，<strong>DBI</strong> 引擎使用JIT编译器来对插桩后的代码重新编译并优化<code>6</code>，然后将其保存在<code>code cache</code>中<code>7</code>。JIT编译器还会重写控制流指令，以确保 <strong>DBI</strong> 引擎保留控制权，从而防止控制流转换在未插桩的目标程序中继续执行。<strong>DBI</strong> 中的JIT编译器不会把代码编译为其他的语言形式，它仅是将机器码编译为机器码。同时，仅需要对第一次执行的代码进行插桩和使用JIT编译。之后，会将其保存到<code>code cache</code>中并重用。</p>
<p>接下来开始执行经过插桩和JIT编译后的放在<code>code cache</code>中的代码，直到遇见一个控制流指令，需要截取新的代码或者需要<code>cache</code>中的下一个代码块<code>8</code>。<strong>DBI</strong> 引擎通过尽量重写控制流指令来减少运行时的开销，比如，不经过 <strong>DBI</strong> 引擎的参与就直接跳转到<code>code cache</code>中的下一个基本块。当遇到间接调用时候，重写后的指令将控制权返回给 <strong>DBI</strong> 引擎，便于获取新的<code>code chunk</code>。</p>
<p>尽管在<code>code cache</code>中的大多数指令会直接被执行，但是 <strong>DBI</strong> 引擎也会模拟执行一些指令而不是直接执行他们。例如，Pin引擎会模拟执行类似于<code>execve</code>的指令，对其进行特殊处理。</p>
<p>插桩后的代码包含 DBI tool 中指定的回调函数，它会改变代码的行为<code>9</code>。当执行流到达 DBI tool 中的回调函数或从回调函数返回的时候，<strong>DBI</strong> 引擎会自动存取寄存器的状态。</p>
<h2 id="二、Introduction-to-Pin"><a href="#二、Introduction-to-Pin" class="headerlink" title="二、Introduction to Pin"></a>二、Introduction to Pin</h2><h3 id="1-PIN-INTERNALS"><a href="#1-PIN-INTERNALS" class="headerlink" title="1. PIN INTERNALS"></a>1. PIN INTERNALS</h3><p>Pin目前支持 Intel CPU 架构，包括x86、x64，支持Linux、Windows、macOS。Pin的架构和上图类似。Pin在<code>Trace</code>粒度上截取代码并使用JIT编译器来编译。<code>Trace</code>的定义类似于标准基本块的定义，仅包含一个入口，但它包含多个出口。也即一个<code>trace</code>是一个指令序列，当它命中一个非条件控制转换指令、到达指定的最大长度、命中一定数目的条件控制转换指令终止。</p>
<p>尽管Pin在<code>trace</code>粒度上进行JIT即时编译，但是它允许基于不同的粒度进行插桩，包括：指令、基本块、trace、函数、image。Pin的 <strong>DBI</strong> 引擎和Pintool均运行在用户态，所以仅仅可以对用户态的程序进行插桩。</p>
<h3 id="2-IMPLEMENTING-PINTOOLS"><a href="#2-IMPLEMENTING-PINTOOLS" class="headerlink" title="2. IMPLEMENTING PINTOOLS"></a>2. IMPLEMENTING PINTOOLS</h3><p>用Pin实现的DBI工具称为Pintools，它们是使用Pin API以C / C ++中编写的共享库。Pin API尽可能独立于体系结构，仅在需要时才使用特定于体系结构的组件。这样可以编写可在两种体系结构之间移植的Pintools，或者只需要进行最小的更改即可支持另一种体系结构。</p>
<p>一个Pintool包含两部分不同的函数：插桩函数和分析函数。插桩函数用来告诉Pin插桩的代码是什么以及在哪里插入，这些代码仅当Pin首次遇见那些未被插桩的特定的代码片段时会被调用。为了插入代码，插桩函数注册了可以调用分析函数的回调函数，它包含了实际的插桩代码，并且每次在被插桩的特定代码序列执行时都会执行插桩代码。</p>
<ul>
<li><strong>instrumentation routines：</strong>注册调用<code>analysis routines</code>的回调函数</li>
<li><strong>analysis routines：</strong>实际执行的插桩代码</li>
</ul>
<h2 id="三、PROFILING-WITH-PIN"><a href="#三、PROFILING-WITH-PIN" class="headerlink" title="三、PROFILING WITH PIN"></a>三、PROFILING WITH PIN</h2><p>该Pintool记录有关程序执行的统计信息，以帮助优化程序。它统计已执行指令、基本块，函数和syscall的次数。</p>
<h3 id="1-The-Profiler’s-Data-Structures-and-Setup-Code"><a href="#1-The-Profiler’s-Data-Structures-and-Setup-Code" class="headerlink" title="1. The Profiler’s Data Structures and Setup Code"></a>1. The Profiler’s Data Structures and Setup Code</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;<span class="keyword">bool</span>&gt; <span class="title">ProfileCalls</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>, <span class="string">"c"</span>, <span class="string">"0"</span>, <span class="string">"Profile function calls"</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;<span class="keyword">bool</span>&gt; <span class="title">ProfileSyscalls</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>, <span class="string">"s"</span>, <span class="string">"0"</span>, <span class="string">"Profile syscalls"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; &gt; cflows;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; &gt; calls;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; syscalls;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; funcnames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> insn_count    = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cflow_count   = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> call_count    = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> syscall_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>(PIN_Init(argc,argv)) &#123;</span><br><span class="line">        print_usage();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMG_AddInstrumentFunction(parse_funcsyms, <span class="literal">NULL</span>);</span><br><span class="line">    INS_AddInstrumentFunction(instrument_insn, <span class="literal">NULL</span>);</span><br><span class="line">    TRACE_AddInstrumentFunction(instrument_trace, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ProfileSyscalls.Value()) &#123;</span><br><span class="line">        PIN_AddSyscallEntryFunction(log_syscall, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PIN_AddFiniFunction(print_results, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Never returns */</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一个Pintool都得包含头文件 pin.H来访问 PIn 的API，它包含了所有的API line1。</p>
<p>Pin从程序开始的第一条指令就开始监控，这意味着Pintool不仅会看到应用程的代码，还包括被执行过的动态加载器、共享库的指令。</p>
<p><strong>COMMAND LINE OPTIONS AND DATA STRUCTURES</strong></p>
<p>Pintool使用<code>knob</code>来设置特定的命令行参数。此处使用<code>KNOB&lt;bool&gt;</code>设置了两个参数：<code>ProfileCalls、ProfileSyscalls line3</code>。选项使用的<code>mode</code>为<code>KNOB_MODE_WRITEONCE</code>，这是因为他们是<code>bool</code>类型的<code>flag</code>，当使用这些<code>flag</code>时候仅需要设置一次。若是不传递参数，两者默认为<code>o</code>，也就是<code>false</code>。</p>
<p>Pintool使用<code>std::map</code>的结构来存储程序运行时的信息<code>line6、line7</code>：</p>
<ul>
<li><strong>cflows：</strong>跳转指令相关信息<code>&lt;destination &lt;source, times&gt; &gt;</code></li>
<li><strong>call：</strong>函数调用指令相关信息<code>&lt;destination &lt;source, times&gt; &gt;</code></li>
<li><strong>insn_count：</strong>执行的指令数目</li>
<li><strong>cflow_count：</strong>执行的控制流指令数目</li>
<li><strong>call_count：</strong>执行的call指令的数目</li>
<li><strong>syscall_count：</strong>执行的syscall的数目</li>
</ul>
<p><strong>INITIALIZING PIN</strong></p>
<p>如果要在Pintool中使用符号，Pin要求在任何其他的API函数调用之前来调用<code>PIN_InitSymbols() line19</code>。</p>
<p><code>PIN_Init()</code>在<code>PIN_InitSymbols()</code>之后，在任何其他的API函数之前被调用<code>line20</code>。主要完成初始化Pin的工作，处理Pin本身的命令行参数和Pintool中使用<code>Knob</code>指定的参数。</p>
<p><strong>REGISTERING INSTRUMENTATION FUNCTIONS</strong></p>
<p>Pin被初始化之后，现在需要初始化Pintool。其中最重要的事情是注册插桩函数来对插入需要执行的分析代码。</p>
<p>Pintool一共注册了3个插桩函数：</p>
<ul>
<li><strong>parse_funcsyms：</strong>使用函数<code>IMG_AddInstrumentFunction()</code>来实现<code>image</code>粒度的插桩，<code>line25</code></li>
<li><strong>instrument_trace：</strong>使用函数<code>TRACE_AddInstrumentFunction()</code>来实现<code>trace</code>粒度的插桩，<code>line26</code></li>
<li><strong>instrument_insn：</strong>使用函数<code>INS_AddInstrumentFunction()</code>来实现<code>instruction</code>粒度的插桩，<code>line27</code></li>
</ul>
<p>上述三个插桩函数分别使用<code>IMG、TRACE、INS</code>作为其第一个参数。并且都使用<code>void*</code>作为第二个参数，当使用<code>*_AddInstrumentFunction</code>来注册插桩函数时，<code>void *</code>允许传一个Pintool特定的数据结构，此处的Pintool不使用这种方法，将<code>NULL</code>传给<code>void*</code>。</p>
<p><strong>REGISTERING A SYSCALL ENTRY FUNCTION</strong></p>
<p>Pin允许我们在<code>syscall</code>调用前、后注册回调函数。仅有少数一些<code>syscall</code>我们不能注册回调函数，并且只能在回调函数内部来区分系统调用之间的不同。</p>
<p>Pintool使用函数<code>PIN_AddSyscallEntryFunction()</code>来注册了名为<code>log_syscall()</code> 的函数，当程序执行进入到<code>syscall</code>中的时候会被执行<code>line30</code>。可以使用函数<code>PIN_AddSyscallExitFunction()</code>注册一个回调函数，在<code>syscall</code>执行完的时候调用。在此处仅当 <code>ProfileSyscalls</code>为<code>true</code>的时候才会注册回调函数<code>log_syscall()</code>。</p>
<p><strong>REGISTERING A FINI FUNCTION</strong></p>
<p>最后注册的回调函数是<code>fini()</code>，当应用程序退出的时候或将Pin从应用程序<code>detach</code>的时候会调用该函数<code>line32</code>。它接受一个退出码作为第一个参数，以及<code>void*</code>作为第二个参数。取决于程序退出的实际情况，<code>fini()</code>函数可能被程序以不合理的方式调用。此处的<code>fini()</code>函数调用函数<code>print_results()</code>来打印输出信息。</p>
<p><strong>STARTING THE APPLICATION</strong></p>
<p>每一个Pintool初始化的最后一步是调用函数<code>PIN_StartProgram() line35</code>，然后开始执行应用程序。在这之后，不能再注册任何新的回调函数，仅当插桩函数、分析函数被调用的时候，Pintool才会再次获得控制权。并且，<code>PIN_StartProgram()</code>永远不会返回，也即<code>main</code>函数中的<code>return 0</code>永远不会被执行。</p>
<h3 id="2-Parsing-Function-Symbols"><a href="#2-Parsing-Function-Symbols" class="headerlink" title="2. Parsing Function Symbols"></a>2. Parsing Function Symbols</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse_funcsyms</span><span class="params">(IMG img, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!IMG_Valid(img)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(SEC sec = IMG_SecHead(img); SEC_Valid(sec); sec = SEC_Next(sec)) &#123;</span><br><span class="line">        <span class="keyword">for</span>(RTN rtn = SEC_RtnHead(sec); RTN_Valid(rtn); rtn = RTN_Next(rtn)) &#123;</span><br><span class="line">            funcnames[RTN_Address(rtn)] = RTN_Name(rtn); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>parse_funcsyms()</code>是一个在<code>image</code>粒度上插桩的函数，它以<code>IMG</code>为其第一个参数。每当一个新的<code>image</code>（可执行文件或共享库）被加载的时候，<code>Image</code>插桩函数可以对整个<code>image</code>进行插桩。这样可以遍历<code>image</code>中所有的函数，同时在每个函数运行前、后注册分析函数。但是，对函数插桩仅当二进制有符号表的时候才可以做到，并且二进制有一些优化的时候，如：尾调用，函数插桩不能工作。</p>
<p>此处的<code>parse_funcsyms()</code>没有注册任何回调函数，它利用了<code>image</code>插桩函数的另一个特性：可以遍历<code>image</code>的所有函数符号。在使用参数 ING 之前，<code>parse_funcsyms()</code>调用<code>IMG_Valid</code>来判断<code>image</code>的有效性<code>line2</code>。<code>img</code>有效的话，<code>parse_funcsyms()</code>函数会遍历所有的 <code>SEC</code> 对象，也即<code>sections</code>。<code>IMG_SecHead()</code>返回<code>image</code>的第一个<code>section</code>，<code>SEC_Next()</code>返回下一个<code>section</code>，直到下一个<code>section</code>不存在。</p>
<p>对于每一个<code>section</code>，函数<code>parse_funcsyms()</code>会以<code>RTNobjects</code>的形式来循环遍历所有的函数<code>line6</code>，然后使用函数<code>RTN_Address()</code> 来获取每一个函数的地址，使用<code>RTN_Name()</code>来获取函数的名字，最后将他们保存到 map 数据结构中。如果二进制没有符号表，<code>RTN_Name()</code>返回一个空字符串。</p>
<h3 id="3-Instrumenting-Basic-Blocks"><a href="#3-Instrumenting-Basic-Blocks" class="headerlink" title="3. Instrumenting Basic Blocks"></a>3. Instrumenting Basic Blocks</h3><p><strong>A FEW NOTES ON BASIC BLOCKS IN PIN</strong></p>
<p>由于Pin是动态的发现基本块，这可能与静态分析得到的基本块有差别。例如，Pin最初可能发现了一个很大的基本块，然后发现一条跳转指令指向该基本块的中间，那么Pin会将该基本块分为两部分，并且对这两部分重新插桩。</p>
<p>另外，作为一种替代实现，可以在指令粒度上增加<code>insn_counton</code>。但是，这种实现比基本的粒度慢得多，因为它需要对每条指令都执行一次回调的分析函数来增加<code>insn_count</code>。相反，基本块粒度的实现使得每个基本块仅需要执行一次回调。编写Pintool时，尽可能优化分析函数非常重要，因为在执行过程中会反复调用分析函数，而不同于插桩函数（仅在第一次遇到特定的代码段时才会调用）</p>
<p><strong>IMPLEMENTING BASIC BLOCK INSTRUMENTATION</strong></p>
<p>由于Pin没有API直接对基本块插桩，所以先使用trace 粒度的插桩函数，然后遍历其中的每一个基本块</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instrument_bb</span><span class="params">(BBL bb)</span></span>&#123;</span><br><span class="line">    BBL_InsertCall(</span><br><span class="line">        bb, IPOINT_ANYWHERE, (AFUNPTR)count_bb_insns, </span><br><span class="line">        IARG_UINT32, BBL_NumIns(bb), </span><br><span class="line">        IARG_END  </span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instrument_trace</span><span class="params">(TRACE trace, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    IMG img = IMG_FindByAddress(TRACE_Address(trace)); </span><br><span class="line">    <span class="keyword">if</span>(!IMG_Valid(img) || !IMG_IsMainExecutable(img)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span>(BBL bb = TRACE_BblHead(trace); BBL_Valid(bb); bb = BBL_Next(bb)) &#123;</span><br><span class="line">        instrument_bb(bb); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数<code>instrument_trace()</code>是一个<code>trace</code>粒度的插桩函数，它以<code>TRACE</code>为其第一个参数。在<code>line 10</code>，它首先调用函数 <code>IMG_FindByAddress()</code>来找到该<code>trace</code>所属于的<code>image</code>。在<code>line11</code>，调用函数<code>IMG_IsMainExecutable()</code>判断该<code>image</code>是否是主要的可执行程序，也即main。我们仅提取主要执行程序的信息，忽略共享库或动态加载器。如果<code>trace</code>是有效的并且是主要的可执行程序，在<code>line14</code>，函数<code>instrument_trace()</code>遍历所有的基本块对象<code>BBL</code>，调用<code>line 1</code>的函数<code>instrument_bb()</code> 来对每个基本块执行真正的插桩代码。</p>
<p>为了插桩一个给定的<code>BBL</code>，<code>instrument_bb()</code>调用<code>BBL_InsertCall()</code>来注册一个进行分析的回调函数。它接收的参数为：</p>
<ul>
<li><strong>bb：</strong>被插桩基本块</li>
<li><strong>insertion point：</strong>插入点，它确定 Pin 在基本块中的哪个位置插入回调的分析函数。此处，插入点为<code>IPOINT_ANYWHERE</code>，因为在基本块中的哪个点更新指令计数器都没有关系。可能的插入点如下图所示。</li>
<li><strong>function pointer：</strong>指向分析函数的函数指针</li>
<li><strong>（AFUNPTR）count_bb_insns：</strong>AFUNPTR的作用是将函数指针传递给Pin的API时使用<code>AFUNPTR</code>做一个类型转换，分析函数的名字是<code>count_bb_insns</code></li>
<li><strong>IARG_UINT32, BBL_NumIns(bb)：</strong>可选参数，基本块中指令的数目，为<code>IARG_UINT32</code>类型</li>
<li><strong>IARG_END：</strong>告诉Pin参数列表结束</li>
</ul>
<p>其中前三个参数是<code>BBL_InsertCall()</code>指定的，后面的参数是传递给分析函数<code>count_bb_insns()</code>的可选参数。</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201127212101.png" style="zoom:50%;">

<h3 id="4-Instrumenting-Control-Flow-Instructions"><a href="#4-Instrumenting-Control-Flow-Instructions" class="headerlink" title="4. Instrumenting Control Flow Instructions"></a>4. Instrumenting Control Flow Instructions</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instrument_insn</span><span class="params">(INS ins, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!INS_IsBranchOrCall(ins))  </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    IMG img = IMG_FindByAddress(INS_Address(ins));  </span><br><span class="line">    <span class="keyword">if</span>(!IMG_Valid(img) || !IMG_IsMainExecutable(img)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    INS_InsertPredicatedCall(</span><br><span class="line">        ins, IPOINT_TAKEN_BRANCH, (AFUNPTR)count_cflow, </span><br><span class="line">        IARG_INST_PTR,  <span class="comment">//特殊的参数类型，他的数据类型和值是在一起的。一个指针，指向回调函数执行时候的指令</span></span><br><span class="line">        IARG_BRANCH_TARGET_ADDR,  <span class="comment">//特殊的参数类型，他的数据类型和值是在一起的。分支taken edge的目标地址</span></span><br><span class="line">        IARG_END</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 对分支指令的fallthrough edge插桩。一些非条件跳转指令，没有fallthrough edge，因此在对指令的fallthrough插桩之前使用INS_HasFallthrough()检查其是否有fallthrough的边</span></span><br><span class="line">    <span class="keyword">if</span>(INS_HasFallThrough(ins)) &#123;</span><br><span class="line">        INS_InsertPredicatedCall(</span><br><span class="line">            ins, IPOINT_AFTER, (AFUNPTR)count_cflow, </span><br><span class="line">            IARG_INST_PTR, </span><br><span class="line">            IARG_FALLTHROUGH_ADDR,  <span class="comment">//分支fallthrough edge的目标地址</span></span><br><span class="line">            IARG_END</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//3. 对call指令进行插桩。因为call指令不会内置判断条件，此处可以不使用INS_InsertPredicatedCall()</span></span><br><span class="line">    <span class="keyword">if</span>(INS_IsCall(ins)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ProfileCalls.Value()) &#123;</span><br><span class="line">            INS_InsertCall(</span><br><span class="line">                ins, IPOINT_BEFORE, (AFUNPTR)count_call, </span><br><span class="line">                IARG_INST_PTR,  <span class="comment">//指向call指令的指针</span></span><br><span class="line">                IARG_BRANCH_TARGET_ADDR,  <span class="comment">//call指令的目标地址</span></span><br><span class="line">                IARG_END</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数<code>instrument_insn</code>接收一个<code>INSobject</code>作为其第一个参数，表示要检测的指令。 首先，调用函数<code>instrument_insncalls</code>来判断指令是否是<code>control-flow</code>指令，也即是否是call指令、条件判断指令。然后调用<code>IMG_FindByAddress()</code>检查该指令是否属于主要可执行程序。</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201127212209.png" style="zoom:50%;">

<p>为了记录控制流转换指令和call指令，<code>instrument_insn</code> 注册了三个不同的回调分析函数：</p>
<p><strong>INSTRUMENTING THE TAKEN EDGE</strong></p>
<p>对分支指令的<code>taken edge</code>注册回调函数<code>count_cflow()</code>，当分支执行<code>taken edge</code>时它会增加<code>control-flow counter</code>：<code>cflow_count</code>。同时记录该分支的源、目标地址。该分析函数<code>cflow_count()</code>接受两个特殊的参数：</p>
<ul>
<li><strong>IARG_INST_PTR：</strong>特殊的参数类型，数据类型和值在一起。是一个指针，指向回调函数执行时候的指令</li>
<li><strong>IARG_BRANCH_TARGET_ADDR：</strong>特殊的参数类型，数据类型和值在一起。分支<code>taken edge</code>的目标地址</li>
</ul>
<p>如表 9-2 所示，仅当指令是控制流指令或call指令的时候，<code>taken edge</code> 才是一个有效的插入点（INS_IsBranchOrCall为true）。</p>
<p>一些X86指令，如条件移动指令(cmov)和以rep为前缀的字符串操作指令，内置了条件判断，当满足条件时会执行该指令。使用<code>INS_InsertPredicatedCall()</code>作为回调分析函数，它仅当条件满足指令被执行的时候才会被执行。相反，要是使用<code>INS_InsertCall()</code>作为回调分析函数，即使条件不满足也会被执行，导致指令的数目增加很多。</p>
<p><strong>INSTRUMENTING THE FALLTHROUGH EDGE</strong></p>
<p>一些非条件跳转指令，没有<code>fallthrough edge</code>，因此在对指令的<code>fallthrough</code>插桩之前使用<code>INS_HasFallthrough()</code>检查其是否有fallthrough的边</p>
<p>如果给定的指令具有<code>fallthrough edge</code>，则<code>instrument_insn</code>在该edge上插入回调分析函数 count_cflow。此回调函数使用的插入点是IPOINT_AFTER，并将 fallthrough 地址（目标地址） IARG_FALLTHROUGH_ADDR 作为参数传给分析函数以记录。</p>
<p><strong>INSTRUMENTING CALLS</strong></p>
<p>instrument_insn 首先使用函数 INS_IsCall 来找出 call 指令。如果当前正在执行的指令确实是一个call指令，并且可选参数 -c 传递给了Pintool，Pintool 在 call 指令执行之前（在IPOINT_BEFORE）插入回调分析函数 count_call ，并传入调用的源（IARG_INST_PTR）和目标地址（IARG_BRANCH_TARGET_ADDR）。在这种情况下，使用INS_InsertCall代替INS_InsertPredicatedCall是安全的，因为没有带有内置条件的调用指令。</p>
<h3 id="5-Counting-Instructions-Control-Transfers-and-Syscalls"><a href="#5-Counting-Instructions-Control-Transfers-and-Syscalls" class="headerlink" title="5. Counting Instructions, Control Transfers, and Syscalls"></a>5. Counting Instructions, Control Transfers, and Syscalls</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">count_bb_insns</span><span class="params">(UINT32 n)</span></span>&#123;</span><br><span class="line">    insn_count += n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">count_cflow</span><span class="params">(ADDRINT ip, ADDRINT target)</span></span>&#123;</span><br><span class="line">    cflows[target][ip]++;</span><br><span class="line">    cflow_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">count_call</span><span class="params">(ADDRINT ip, ADDRINT target)</span></span>&#123;</span><br><span class="line">    calls[target][ip]++;</span><br><span class="line">    call_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">log_syscall</span><span class="params">(THREADID tid, CONTEXT *ctxt, SYSCALL_STANDARD <span class="built_in">std</span>, VOID *v)</span></span>&#123;</span><br><span class="line">    syscalls[PIN_GetSyscallNumber(ctxt, <span class="built_in">std</span>)]++;</span><br><span class="line">    syscall_count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上所见，分析函数很简单，用最少的代码即可记录所需的统计信息。在应用程序执行时经常会调用分析函数，因此会对Pintool的性能产生重大影响。当执行基本块时，将调用第一个分析函数count_bb_insns，简单地用基本块中的指令数来递增 insn_count。同样，当执行控制流指令时，函数 count_cflow 会递增 cflow_count。另外，在man cflows 中记录分支的源地址和目标地址，并为源地址和目标的这种特定组合增加计数器。在Pin中，使用 ADDRINT 类型来存储地址。记录call 指令信息的分析函数 count_call 与count_cflow类似。</p>
<p>最后一个函数 log_syscall 并不是一个标准的分析函数，他仅是开始执行 syscall 时候的一个回调函数。在Pin中，处理 syscall 的函数接受4个参数：</p>
<ul>
<li>THREADID，指明哪个线程调了该syscall</li>
<li>CONTEXT*，包含如系统调用号、参数、返回值(syscall exit handlers)等</li>
<li>SYSCALL_STANDARD，指明系统调用的标准信息</li>
<li>void*，用户定义的数据结构</li>
</ul>
<p>log_syscall 的目的是记录每个系统调用的调用频率。为此，它调用 PIN_GetSyscallNumber 以获取当前syscall的编号，并将执行次数记录在map数据结构中。</p>
<h3 id="6-Testing-the-Profiler"><a href="#6-Testing-the-Profiler" class="headerlink" title="6. Testing the Profiler"></a>6. Testing the Profiler</h3><p><strong>PROFILING AN APPLICATION FROM THE START</strong></p>
<p>编译Pintool：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">binary@binary-VirtualBox:profiler$ <span class="built_in">export</span> PIN_ROOT=/home/pin</span><br><span class="line">binary@binary-VirtualBox:profiler$ make obj-intel64/profiler.so TARGET=intel64</span><br><span class="line"></span><br><span class="line">mkdir -p obj-intel64/</span><br><span class="line">g++ -Wall -Werror -Wno-unknown-pragmas -D__PIN__=1 -DPIN_CRT=1 -fno-stack-protector -fno-exceptions -funwind-tables -fasynchronous-unwind-tables -fno-rtti -DTARGET_IA32E -DHOST_IA32E -fPIC -DTARGET_LINUX -fabi-version=2  -I/home/pin/<span class="built_in">source</span>/include/pin -I/home/pin/<span class="built_in">source</span>/include/pin/gen -isystem /home/binary/pin/pin-3.6-97554-g31f0a167d-gcc-linux/extras/stlport/include -isystem /home/binary/pin/pin-3.6-97554-g31f0a167d-gcc-linux/extras/libstdc++/include -isystem /home/binary/pin/pin-3.6-97554-g31f0a167d-gcc-linux/extras/crt/include -isystem /home/binary/pin/pin-3.6-97554-g31f0a167d-gcc-linux/extras/crt/include/arch-x86_64 -isystem /home/binary/pin/pin-3.6-97554-g31f0a167d-gcc-linux/extras/crt/include/kernel/uapi -isystem /home/binary/pin/pin-3.6-97554-g31f0a167d-gcc-linux/extras/crt/include/kernel/uapi/asm-x86 -I/home/pin/extras/components/include -I/home/pin/extras/xed-intel64/include/xed -I/home/pin/<span class="built_in">source</span>/tools/InstLib -O3 -fomit-frame-pointer -fno-strict-aliasing   -c -o obj-intel64/profiler.o profiler.cpp</span><br><span class="line">g++ -shared -Wl,--<span class="built_in">hash</span>-style=sysv /home/pin/intel64/runtime/pincrt/crtbeginS.o -Wl,-Bsymbolic -Wl,--version-script=/home/pin/<span class="built_in">source</span>/include/pin/pintool.ver -fabi-version=2    -o obj-intel64/profiler.so obj-intel64/profiler.o /home/pin/<span class="built_in">source</span>/tools/InstLib/obj-intel64/controller.a  -L/home/pin/intel64/runtime/pincrt -L/home/pin/intel64/lib -L/home/pin/intel64/lib-ext -L/home/pin/extras/xed-intel64/lib -lpin -lxed /home/pin/intel64/runtime/pincrt/crtendS.o -lpin3dwarf  -ldl-dynamic -nostdlib -lstlport-dynamic -lm-dynamic -lc-dynamic -lunwind-dynamic</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">binary@binary-VirtualBox:profiler$ /home/pin/pin -t ./obj-intel64/profiler.so -c -s -- /bin/<span class="literal">true</span> </span><br><span class="line">executed 95 instructions</span><br><span class="line"></span><br><span class="line">******* CONTROL TRANSFERS *******</span><br><span class="line">0x00401000 &lt;- 0x00403f7c:   1 (4.35%)</span><br><span class="line">0x00401015 &lt;- 0x0040100e:   1 (4.35%)</span><br><span class="line">0x00401020 &lt;- 0x0040118b:   1 (4.35%)</span><br><span class="line">0x00401180 &lt;- 0x004013f4:   1 (4.35%)</span><br><span class="line">0x00401186 &lt;- 0x00401180:   1 (4.35%)</span><br><span class="line">0x00401335 &lt;- 0x00401333:   1 (4.35%)</span><br><span class="line">0x00401400 &lt;- 0x0040148d:   1 (4.35%)</span><br><span class="line">0x00401430 &lt;- 0x00401413:   1 (4.35%)</span><br><span class="line">0x00401440 &lt;- 0x004014ab:   1 (4.35%)</span><br><span class="line">0x00401478 &lt;- 0x00401461:   1 (4.35%)</span><br><span class="line">0x00401489 &lt;- 0x00401487:   1 (4.35%)</span><br><span class="line">0x00401492 &lt;- 0x00401431:   1 (4.35%)</span><br><span class="line">0x004014a0 &lt;- 0x00403f99:   1 (4.35%)</span><br><span class="line">0x004014ab &lt;- 0x004014a9:   1 (4.35%)</span><br><span class="line">0x00403f81 &lt;- 0x00401019:   1 (4.35%)</span><br><span class="line">0x00403f86 &lt;- 0x00403f84:   1 (4.35%)</span><br><span class="line">0x00403f9d &lt;- 0x00401479:   1 (4.35%)</span><br><span class="line">0x00403fa6 &lt;- 0x00403fa4:   1 (4.35%)</span><br><span class="line">0x7fa74fc647bf &lt;- 0x00403fb4:   1 (4.35%)</span><br><span class="line">0x7fa74fc64830 &lt;- 0x00401337:   1 (4.35%)</span><br><span class="line">0x7fa763658de7 &lt;- 0x0040149a:   1 (4.35%)</span><br><span class="line">0x7fa763658e05 &lt;- 0x00404004:   1 (4.35%)</span><br><span class="line">0x7fa76365f870 &lt;- 0x00401026:   1 (4.35%)</span><br><span class="line"></span><br><span class="line">******* FUNCTION CALLS *******</span><br><span class="line">[_init                         ] 0x00401000 &lt;- 0x00403f7c:   1 (25.00%)</span><br><span class="line">[__libc_start_main@plt         ] 0x00401180 &lt;- 0x004013f4:   1 (25.00%)</span><br><span class="line">[                              ] 0x00401400 &lt;- 0x0040148d:   1 (25.00%)</span><br><span class="line">[                              ] 0x004014a0 &lt;- 0x00403f99:   1 (25.00%)</span><br><span class="line"></span><br><span class="line">******* SYSCALLS *******</span><br><span class="line">  0:   1 (4.00%)</span><br><span class="line">  2:   2 (8.00%)</span><br><span class="line">  3:   2 (8.00%)</span><br><span class="line">  5:   2 (8.00%)</span><br><span class="line">  9:   7 (28.00%)</span><br><span class="line"> 10:   4 (16.00%)</span><br><span class="line"> 11:   1 (4.00%)</span><br><span class="line"> 12:   1 (4.00%)</span><br><span class="line"> 21:   3 (12.00%)</span><br><span class="line">158:   1 (4.00%)</span><br><span class="line">231:   1 (4.00%)</span><br><span class="line">binary@binary-VirtualBox:profiler$</span><br></pre></td></tr></table></figure>

<p>首先指定Pin目录下的可执行文件pin，来开启PIN引擎，然后使用pin选择相应的Pintool来执行应用程序。参数解释：</p>
<ul>
<li><strong>-t：</strong>指明使用的Pintool的路径，后面跟着传给Pintool的参数。</li>
<li><strong>-c：</strong>收集calls</li>
<li><strong>-s：</strong>收集syscalls</li>
<li><strong>–：</strong>表示Pintool的可选参数结束，后面跟着Pin所执行的应用程序的名字和参数</li>
</ul>
<p><strong>ATTACHING THE PROFILER TO A RUNNING APPLICATION</strong></p>
<p>由于一些安全机制，Pin不能attach到运行中的程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">E: Attach to pid 6210 failed. </span><br><span class="line">E:   The Operating System configuration prevents Pin from using the default (parent) injection mode.</span><br><span class="line">E:   To resolve this, either execute the following (as root):</span><br><span class="line">E:   $ <span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/yama/ptrace_scope</span><br><span class="line">E:   Or use the <span class="string">"-injection child"</span> option.</span><br><span class="line">E:   For more information, regarding child injection, see Injection section <span class="keyword">in</span> the Pin User Manual.</span><br></pre></td></tr></table></figure>

<p>需要临时关闭安全机制(重启后恢复)，首先运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 | sudo tee/proc/sys/kernel/yama/ptrace_scope</span><br></pre></td></tr></table></figure>

<p>启动一个后台进程 netcat 来监听 local-host 的UDP的端口9999：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@binary-VirtualBox:profiler<span class="comment"># nc -l -u 127.0.0.1 9999 &amp;</span></span><br><span class="line">[1] 6272</span><br></pre></td></tr></table></figure>

<p>&amp; 放在命令后面表示设置此进程为后台进程。默认情况下，进程是前台进程，这时此进程（命令执行相当于本质是开启一个进程）就把Shell给占据了，我们无法进行其他操作，对于那些没有交互的进程，很多时候，我们希望将其在后台启动，可以在启动参数的时候加一个’&amp;’实现这个目的。</p>
<p>使用<code>-pid</code>来讲pin attach 到运行中的进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@binary-VirtualBox:profiler<span class="comment"># /home/pin/pin -pid 6272 -t ./obj-intel64/profiler.so -c -s</span></span><br></pre></td></tr></table></figure>

<p>为了使正在监听的 netcat 进程执行一些指令，而不是阻塞等待网络输入，使用了另一个netcat 进程向其发送消息“ Testing the profiler”。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@binary-VirtualBox:profiler<span class="comment"># echo ¨Testing the profiler¨ | nc -u 127.0.0.1 9999</span></span><br><span class="line">¨Testing the profiler¨</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>

<p>然后，它将监听的那个进程 netcat 带到前台并终止它。当应用程序终止时，Pintool 将调用其fini函数并打印统计信息。可以看到与网络相关的函数调用（例如connect）以及netcat 用来接收以测试消息的sys_recvfrom 系统调用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">root@binary-VirtualBox:profiler<span class="comment"># fg</span></span><br><span class="line">nc -l -u 127.0.0.1 9999</span><br><span class="line">^Cexecuted 164 instructions</span><br><span class="line"></span><br><span class="line">******* CONTROL TRANSFERS *******</span><br><span class="line">0x00401380 &lt;- 0x0040140b:   1 (2.04%)</span><br><span class="line">0x00401380 &lt;- 0x0040144b:   1 (2.04%)</span><br><span class="line">0x00401380 &lt;- 0x004014db:   1 (2.04%)</span><br><span class="line">0x00401380 &lt;- 0x004015eb:   1 (2.04%)</span><br><span class="line">0x00401380 &lt;- 0x004016ab:   1 (2.04%)</span><br><span class="line">0x00401400 &lt;- 0x00402dc7:   1 (2.04%)</span><br><span class="line">0x00401406 &lt;- 0x00401400:   1 (2.04%)</span><br><span class="line">0x00401440 &lt;- 0x00403c06:   1 (2.04%)</span><br><span class="line">0x00401446 &lt;- 0x00401440:   1 (2.04%)</span><br><span class="line">0x004014d0 &lt;- 0x00402eba:   2 (4.08%)</span><br><span class="line">0x004014d6 &lt;- 0x004014d0:   1 (2.04%)</span><br><span class="line">0x004015e0 &lt;- 0x00402d62:   1 (2.04%)</span><br><span class="line">0x004015e0 &lt;- 0x00402d71:   1 (2.04%)</span><br><span class="line">0x004015e6 &lt;- 0x004015e0:   1 (2.04%)</span><br><span class="line">0x004016a0 &lt;- 0x00401e80:   1 (2.04%)</span><br><span class="line">0x004016a6 &lt;- 0x004016a0:   1 (2.04%)</span><br><span class="line">0x00401e73 &lt;- 0x00401e6d:   1 (2.04%)</span><br><span class="line">0x00401e8d &lt;- 0x00401e87:   1 (2.04%)</span><br><span class="line">0x00402d30 &lt;- 0x00401e90:   1 (2.04%)</span><br><span class="line">0x00402db8 &lt;- 0x00402ed6:   1 (2.04%)</span><br><span class="line">0x00402dd5 &lt;- 0x00402dcf:   1 (2.04%)</span><br><span class="line">0x00402ddb &lt;- 0x00402dd5:   1 (2.04%)</span><br><span class="line">0x00402de9 &lt;- 0x00402de3:   1 (2.04%)</span><br><span class="line">0x00402e01 &lt;- 0x00403c3e:   1 (2.04%)</span><br><span class="line">0x00402e0a &lt;- 0x00402e04:   1 (2.04%)</span><br><span class="line">0x00402e14 &lt;- 0x00402e12:   1 (2.04%)</span><br><span class="line">0x00402e88 &lt;- 0x00402f12:   1 (2.04%)</span><br><span class="line">0x00402e8c &lt;- 0x00402dad:   1 (2.04%)</span><br><span class="line">0x00402e95 &lt;- 0x00402e8f:   2 (4.08%)</span><br><span class="line">0x00402e9f &lt;- 0x00402e9d:   2 (4.08%)</span><br><span class="line">0x00402ec8 &lt;- 0x00402ec2:   1 (2.04%)</span><br><span class="line">0x00402ece &lt;- 0x00402ec8:   1 (2.04%)</span><br><span class="line">0x00402f10 &lt;- 0x00402e1b:   1 (2.04%)</span><br><span class="line">0x00403bb0 &lt;- 0x00402dfc:   1 (2.04%)</span><br><span class="line">0x00403bf8 &lt;- 0x00403bf6:   1 (2.04%)</span><br><span class="line">0x00403c0e &lt;- 0x00403c0c:   1 (2.04%)</span><br><span class="line">0x00403c1e &lt;- 0x00403c68:   1 (2.04%)</span><br><span class="line">0x00403c60 &lt;- 0x00403c11:   1 (2.04%)</span><br><span class="line">0x00403c68 &lt;- 0x00403c66:   1 (2.04%)</span><br><span class="line">0x7ff1e4c13ad0 &lt;- 0x004015e0:   1 (2.04%)</span><br><span class="line">0x7ff1e4cb70b0 &lt;- 0x004014d0:   1 (2.04%)</span><br><span class="line">0x7ff1e53af870 &lt;- 0x00401386:   5 (10.20%)</span><br><span class="line"></span><br><span class="line">******* FUNCTION CALLS *******</span><br><span class="line">[__read_chk@plt                ] 0x00401400 &lt;- 0x00402dc7:   1 (11.11%)</span><br><span class="line">[write@plt                     ] 0x00401440 &lt;- 0x00403c06:   1 (11.11%)</span><br><span class="line">[__poll_chk@plt                ] 0x004014d0 &lt;- 0x00402eba:   2 (22.22%)</span><br><span class="line">[fileno@plt                    ] 0x004015e0 &lt;- 0x00402d62:   1 (11.11%)</span><br><span class="line">[fileno@plt                    ] 0x004015e0 &lt;- 0x00402d71:   1 (11.11%)</span><br><span class="line">[connect@plt                   ] 0x004016a0 &lt;- 0x00401e80:   1 (11.11%)</span><br><span class="line">[                              ] 0x00402d30 &lt;- 0x00401e90:   1 (11.11%)</span><br><span class="line">[                              ] 0x00403bb0 &lt;- 0x00402dfc:   1 (11.11%)</span><br><span class="line"></span><br><span class="line">******* SYSCALLS *******</span><br><span class="line">  0:   1 (16.67%)</span><br><span class="line">  1:   1 (16.67%)</span><br><span class="line">  7:   2 (33.33%)</span><br><span class="line"> 42:   1 (16.67%)</span><br><span class="line"> 45:   1 (16.67%)</span><br></pre></td></tr></table></figure>

<p>一旦将Pin attach到一个运行中的程序，他会一直持续，直到程序退出或在Pintool中调用PIN_Detach。这意味着要是对一个永远不会终止的系统程序插桩，必须在Pintool中写好退出条件。</p>
<h2 id="四、代码"><a href="#四、代码" class="headerlink" title="四、代码"></a>四、代码</h2><p><strong>Makefile：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line">#                   DO NOT EDIT THIS FILE!</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"># If the tool is built out of the kit, PIN_ROOT must be specified in the make invocation <span class="keyword">and</span> <span class="built_in">point</span> to the kit root.</span><br><span class="line">ifdef PIN_ROOT</span><br><span class="line">CONFIG_ROOT := $(PIN_ROOT)/source/tools/Config</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">CONFIG_ROOT := ../Config</span><br><span class="line">endif</span><br><span class="line">include $(CONFIG_ROOT)/makefile.<span class="built_in">config</span></span><br><span class="line">include makefile.rules</span><br><span class="line">include $(TOOLS_ROOT)/Config/makefile.<span class="keyword">default</span>.rules</span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line">#                   DO NOT EDIT THIS FILE!</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br></pre></td></tr></table></figure>

<p><strong>Makefile.rules：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># This file includes all the test targets as well as all the</span><br><span class="line"><span class="meta"># non-default build rules and test recipes.</span></span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># Test targets</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line">###### Place all generic definitions here ######</span><br><span class="line"></span><br><span class="line"># This defines tests which <span class="built_in">run</span> tools of the same name.  This is simply <span class="keyword">for</span> convenience to avoid</span><br><span class="line"><span class="meta"># defining the test name twice (once in TOOL_ROOTS and again in TEST_ROOTS).</span></span><br><span class="line"># Tests defined here should <span class="keyword">not</span> be defined in TOOL_ROOTS <span class="keyword">and</span> TEST_ROOTS.</span><br><span class="line">TEST_TOOL_ROOTS := profiler</span><br><span class="line"></span><br><span class="line"># This defines the tests to be <span class="built_in">run</span> that were <span class="keyword">not</span> already defined in TEST_TOOL_ROOTS.</span><br><span class="line">TEST_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines the tools which will be <span class="built_in">run</span> during the the tests, <span class="keyword">and</span> were <span class="keyword">not</span> already defined in</span><br><span class="line"># TEST_TOOL_ROOTS.</span><br><span class="line">TOOL_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines the <span class="keyword">static</span> analysis tools which will be <span class="built_in">run</span> during the the tests. They should <span class="keyword">not</span></span><br><span class="line"># be defined in TEST_TOOL_ROOTS. If a test with the same name <span class="built_in">exists</span>, it should be defined in</span><br><span class="line"># TEST_ROOTS.</span><br><span class="line"># Note: Static analysis tools are in fact executables linked with the Pin Static Analysis Library.</span><br><span class="line"># This library provides a subset of the Pin APIs which allows the tool to perform <span class="keyword">static</span> analysis</span><br><span class="line"># of an application <span class="keyword">or</span> dll. Pin itself is <span class="keyword">not</span> used when <span class="keyword">this</span> tool runs.</span><br><span class="line">SA_TOOL_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines all the applications that will be <span class="built_in">run</span> during the tests.</span><br><span class="line">APP_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines any additional object files that need to be compiled.</span><br><span class="line">OBJECT_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines any additional dlls (shared objects), other than the pintools, that need to be compiled.</span><br><span class="line">DLL_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines any <span class="keyword">static</span> libraries (archives), that need to be built.</span><br><span class="line">LIB_ROOTS :=</span><br><span class="line"></span><br><span class="line">###### Define the sanity subset ######</span><br><span class="line"></span><br><span class="line"># This defines the <span class="built_in">list</span> of tests that should <span class="built_in">run</span> in sanity. It should include all the tests listed in</span><br><span class="line"># TEST_TOOL_ROOTS <span class="keyword">and</span> TEST_ROOTS excluding only unstable tests.</span><br><span class="line">SANITY_SUBSET := $(TEST_TOOL_ROOTS) $(TEST_ROOTS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># Test recipes</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"># This section contains recipes <span class="keyword">for</span> tests other than the <span class="keyword">default</span>.</span><br><span class="line"># See makefile.<span class="keyword">default</span>.rules <span class="keyword">for</span> the <span class="keyword">default</span> test rules.</span><br><span class="line"># All tests in <span class="keyword">this</span> section should adhere to the naming convention: &lt;testname&gt;.test</span><br><span class="line"></span><br><span class="line">profiler.test: $(OBJDIR)profiler$(PINTOOL_SUFFIX) $(TESTAPP)</span><br><span class="line">	$(RM) -f $(OBJDIR)profiler.makefile.copy</span><br><span class="line">	$(PIN) -t $(OBJDIR)profiler$(PINTOOL_SUFFIX) -silent -instruction -memory \</span><br><span class="line">	  -- $(TESTAPP) makefile $(OBJDIR)profiler.makefile.copy</span><br><span class="line">	$(CMP) makefile $(OBJDIR)profiler.makefile.copy</span><br><span class="line">	$(RM) $(OBJDIR)profiler.makefile.copy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># Build rules</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"># This section contains the build rules <span class="keyword">for</span> all binaries that have special build rules.</span><br><span class="line"># See makefile.<span class="keyword">default</span>.rules <span class="keyword">for</span> the <span class="keyword">default</span> build rules.</span><br><span class="line"></span><br><span class="line">###### Special tool<span class="number">'</span>s build rules ######</span><br><span class="line"></span><br><span class="line">$(OBJDIR)profiler$(PINTOOL_SUFFIX): $(OBJDIR)profiler$(OBJ_SUFFIX) $(CONTROLLERLIB)</span><br><span class="line">	$(LINKER) $(TOOL_LDFLAGS) $(LINK_EXE)$@ $^ $(TOOL_LPATHS) $(TOOL_LIBS)</span><br></pre></td></tr></table></figure>

<p><strong>Pintool：</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm-generic/unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;<span class="keyword">bool</span>&gt; <span class="title">ProfileCalls</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>, <span class="string">"c"</span>, <span class="string">"0"</span>, <span class="string">"Profile function calls"</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;<span class="keyword">bool</span>&gt; <span class="title">ProfileSyscalls</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>, <span class="string">"s"</span>, <span class="string">"0"</span>, <span class="string">"Profile syscalls"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; &gt; cflows;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; &gt; calls;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; syscalls;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; funcnames;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> insn_count    = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cflow_count   = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> call_count    = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> syscall_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment"> *                             Analysis functions                            *</span></span><br><span class="line"><span class="comment"> *****************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">count_bb_insns</span><span class="params">(UINT32 n)</span></span>&#123;</span><br><span class="line">    insn_count += n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">count_cflow</span><span class="params">(ADDRINT ip, ADDRINT target)</span></span>&#123;</span><br><span class="line">    cflows[target][ip]++;</span><br><span class="line">    cflow_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">count_call</span><span class="params">(ADDRINT ip, ADDRINT target)</span></span>&#123;</span><br><span class="line">    calls[target][ip]++;</span><br><span class="line">    call_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">log_syscall</span><span class="params">(THREADID tid, CONTEXT *ctxt, SYSCALL_STANDARD <span class="built_in">std</span>, VOID *v)</span></span>&#123;</span><br><span class="line">    syscalls[PIN_GetSyscallNumber(ctxt, <span class="built_in">std</span>)]++;</span><br><span class="line">    syscall_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment"> *                         Instrumentation functions                         *</span></span><br><span class="line"><span class="comment"> *****************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instrument_bb</span><span class="params">(BBL bb)</span></span>&#123;</span><br><span class="line">    BBL_InsertCall(</span><br><span class="line">        bb, IPOINT_ANYWHERE, (AFUNPTR)count_bb_insns, </span><br><span class="line">        IARG_UINT32, BBL_NumIns(bb), </span><br><span class="line">        IARG_END  </span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instrument_trace</span><span class="params">(TRACE trace, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    IMG img = IMG_FindByAddress(TRACE_Address(trace)); </span><br><span class="line">    <span class="keyword">if</span>(!IMG_Valid(img) || !IMG_IsMainExecutable(img)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span>(BBL bb = TRACE_BblHead(trace); BBL_Valid(bb); bb = BBL_Next(bb)) &#123;</span><br><span class="line">        instrument_bb(bb); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instrument_insn</span><span class="params">(INS ins, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!INS_IsBranchOrCall(ins))  </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    IMG img = IMG_FindByAddress(INS_Address(ins));  </span><br><span class="line">    <span class="keyword">if</span>(!IMG_Valid(img) || !IMG_IsMainExecutable(img)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    INS_InsertPredicatedCall(</span><br><span class="line">        ins, IPOINT_TAKEN_BRANCH, (AFUNPTR)count_cflow, </span><br><span class="line">        IARG_INST_PTR,  </span><br><span class="line">        IARG_BRANCH_TARGET_ADDR,  </span><br><span class="line">        IARG_END</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(INS_HasFallThrough(ins)) &#123;</span><br><span class="line">        INS_InsertPredicatedCall(</span><br><span class="line">            ins, IPOINT_AFTER, (AFUNPTR)count_cflow, </span><br><span class="line">            IARG_INST_PTR, </span><br><span class="line">            IARG_FALLTHROUGH_ADDR, </span><br><span class="line">            IARG_END</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(INS_IsCall(ins)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(ProfileCalls.Value()) &#123;</span><br><span class="line">            INS_InsertCall(</span><br><span class="line">                ins, IPOINT_BEFORE, (AFUNPTR)count_call, </span><br><span class="line">                IARG_INST_PTR,  </span><br><span class="line">                IARG_BRANCH_TARGET_ADDR,  </span><br><span class="line">                IARG_END</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse_funcsyms</span><span class="params">(IMG img, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!IMG_Valid(img)) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(SEC sec = IMG_SecHead(img); SEC_Valid(sec); sec = SEC_Next(sec)) &#123;</span><br><span class="line">        <span class="keyword">for</span>(RTN rtn = SEC_RtnHead(sec); RTN_Valid(rtn); rtn = RTN_Next(rtn)) &#123;</span><br><span class="line">            funcnames[RTN_Address(rtn)] = RTN_Name(rtn); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment"> *                               Other functions                             *</span></span><br><span class="line"><span class="comment"> *****************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print_results</span><span class="params">(INT32 code, <span class="keyword">void</span> *v)</span></span>&#123;</span><br><span class="line">    ADDRINT ip, target;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> count;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt; &gt;::iterator i;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">map</span>&lt;ADDRINT, <span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;::iterator j;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"executed %lu instructions\n\n"</span>, insn_count);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"******* CONTROL TRANSFERS *******\n"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = cflows.<span class="built_in">begin</span>(); i != cflows.<span class="built_in">end</span>(); i++) &#123;</span><br><span class="line">        target = i-&gt;first;</span><br><span class="line">        <span class="keyword">for</span>(j = i-&gt;second.<span class="built_in">begin</span>(); j != i-&gt;second.<span class="built_in">end</span>(); j++) &#123;</span><br><span class="line">            ip = j-&gt;first;</span><br><span class="line">            count = j-&gt;second;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"0x%08jx &lt;- 0x%08jx: %3lu (%0.2f%%)\n"</span>, </span><br><span class="line">                    target, ip, count, (<span class="keyword">double</span>)count/cflow_count*<span class="number">100.0</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!calls.empty()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n******* FUNCTION CALLS *******\n"</span>);</span><br><span class="line">        <span class="keyword">for</span>(i = calls.<span class="built_in">begin</span>(); i != calls.<span class="built_in">end</span>(); i++) &#123;</span><br><span class="line">            target = i-&gt;first;</span><br><span class="line">            <span class="keyword">for</span>(j = i-&gt;second.<span class="built_in">begin</span>(); j != i-&gt;second.<span class="built_in">end</span>(); j++) &#123;</span><br><span class="line">                ip = j-&gt;first;</span><br><span class="line">                count = j-&gt;second;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[%-30s] 0x%08jx &lt;- 0x%08jx: %3lu (%0.2f%%)\n"</span>, </span><br><span class="line">                        funcnames[target].c_str(), target, ip, count, (<span class="keyword">double</span>)count/call_count*<span class="number">100.0</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!syscalls.empty()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n******* SYSCALLS *******\n"</span>);</span><br><span class="line">        <span class="keyword">for</span>(j = syscalls.<span class="built_in">begin</span>(); j != syscalls.<span class="built_in">end</span>(); j++) &#123;</span><br><span class="line">            count = j-&gt;second;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%3ju: %3lu (%0.2f%%)\n"</span>, j-&gt;first, count, (<span class="keyword">double</span>)count/syscall_count*<span class="number">100.0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print_usage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> help = KNOB_BASE::StringKnobSummary();</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\nProfile call and jump targets\n"</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, help.c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    PIN_InitSymbols();</span><br><span class="line">    <span class="keyword">if</span>(PIN_Init(argc,argv)) &#123;</span><br><span class="line">        print_usage();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IMG_AddInstrumentFunction(parse_funcsyms, <span class="literal">NULL</span>);</span><br><span class="line">    INS_AddInstrumentFunction(instrument_insn, <span class="literal">NULL</span>);</span><br><span class="line">    TRACE_AddInstrumentFunction(instrument_trace, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ProfileSyscalls.Value()) &#123;</span><br><span class="line">        PIN_AddSyscallEntryFunction(log_syscall, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PIN_AddFiniFunction(print_results, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Never returns */</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><blockquote>
<p>1.<a href="https://practicalbinaryanalysis.com/" target="_blank" rel="noopener">https://practicalbinaryanalysis.com/</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/13/AddressSanitizer%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/13/AddressSanitizer%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D/" itemprop="url">AddressSanitizer使用介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-13T15:42:13+08:00">
                2020-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AddressSanitizer/" itemprop="url" rel="index">
                    <span itemprop="name">AddressSanitizer</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="AddressSanitizer使用介绍"><a href="#AddressSanitizer使用介绍" class="headerlink" title="AddressSanitizer使用介绍"></a>AddressSanitizer使用介绍</h1><h2 id="1、关于AddressSanitizer"><a href="#1、关于AddressSanitizer" class="headerlink" title="1、关于AddressSanitizer"></a>1、关于AddressSanitizer</h2><h3 id="1-1-引言"><a href="#1-1-引言" class="headerlink" title="1.1 引言"></a>1.1 引言</h3><p>也许很多人都听说过类似这样的一个故事：某公司的服务器每隔3个月就会毫无预兆的崩溃一次，怎么也查不出原因，为了避免崩溃可能引发的问题，只得每2个月手动重启一次服务器。在这类有些灵异的事件背后，以内存泄露为代表的一系列内存错误往往就是那个幕后黑手。</p>
<p>在计算机科学中，内存泄漏指由于疏忽或错误造成程序未能释放已经不再使用的内存的情况。内存泄漏并非指内存在物理上的消失，而是应用程序分配某段内存后，由于设计错误，失去了对该段内存的控制，因而造成了内存的浪费。</p>
<p>内存泄漏会导致可用内存的数量减少从而降低计算机的性能。过多的可用内存被分配掉会导致全部或部分设备停止正常工作，或者应用程序崩溃。</p>
<p>其他的内存错误还包括缓冲区溢出、越界访问等，此类错误轻则导致程序计算错误，重则引起程序崩溃，在内存紧张的嵌入式系统中尤为致命，Google旗下的开源工具AddressSanitizer可以帮助我们检测此类错误。</p>
<p>AddressSanitizer（ASan）是一个快速的内存错误检测工具。它非常快，开销只是原程序运行速度的两倍左右。它包括一个编译器instrumentation模块和一个提供malloc()/free()替代项的运行时库。从gcc 4.8开始，AddressSanitizer成为gcc的一部分。</p>
<p>详细了解AddressSanitizer信息可以访问其github项目地址：<a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="noopener">https://github.com/google/sanitizers/wiki/AddressSanitizer</a></p>
<h3 id="1-2-AddressSanitizer原理简介"><a href="#1-2-AddressSanitizer原理简介" class="headerlink" title="1.2 AddressSanitizer原理简介"></a>1.2 AddressSanitizer原理简介</h3><p>程序中的每一个内存访问被转化为下面的形式：</p>
<p>访问前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*address = ...;  <span class="comment">// or: ... = *address;</span></span><br></pre></td></tr></table></figure>

<p>访问后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IsPoisoned(address)) &#123;</span><br><span class="line">  ReportError(address, kAccessSize, kIsWrite);</span><br><span class="line">&#125;</span><br><span class="line">*address = ...;  <span class="comment">// or: ... = *address;</span></span><br></pre></td></tr></table></figure>

<p>困难的是如何快速的实现 <code>IsPoisoned</code>，以及稳定的实现 <code>ReportError</code>。</p>
<p>AddressSanitizer主要包括两部分：插桩(Instrumentation)和动态运行库(Run-time library)。插桩主要是针对在llvm编译器级别对访问内存的操作(store，load，alloca等)，将它们进行处理。动态运行库主要提供一些运行时的复杂的功能(比如poison/unpoison shadow memory)以及将malloc,free等系统调用函数hook住。该算法的思路是：如果想防住Buffer Overflow漏洞，只需要在每块内存区域右端（或两端，能防overflow和underflow）加一块区域（RedZone），使RedZone的区域的影子内存（Shadow Memory)设置为不可写即可。具体的示意图如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201113123327.png" alt></p>
<h3 id="1-3-内存映射和插桩"><a href="#1-3-内存映射和插桩" class="headerlink" title="1.3 内存映射和插桩"></a>1.3 内存映射和插桩</h3><p>虚拟地址空间被分为两个单独的类别：</p>
<ul>
<li>程序主要使用的内存(Mem)：被正常的程序代码所使用</li>
<li>影子内存(Shadow)：此部分内存包含 shadow values（或称其为 metadata）。Mem和Shadow之间是有一定的内在联系的。<strong>Poisoning</strong> Mem中的一个字节，意味着对与其对应的 Shadow 内存写入特殊的值。</li>
</ul>
<p>第二类内存的组织方式，应当保证操作<code>MemToShadow</code>的运算速度。</p>
<p>对应的编译器插桩操作为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shadow_address = MemToShadow(address);</span><br><span class="line"><span class="keyword">if</span> (ShadowIsPoisoned(shadow_address)) &#123;</span><br><span class="line">  ReportError(address, kAccessSize, kIsWrite);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h4><p>AddressSanitizer保护的主要原理是对程序中的虚拟内存提供粗粒度的影子内存(每8个字节的内存对应一个字节的影子内存)，为了减少overhead，采用了直接内存映射策略，所采用的具体策略如下：Shadow=(Mem &gt;&gt; 3) + offset。每8个字节的内存对应一个字节的影子内存，影子内存中每个字节存取一个数字k,如果k=0，则表示该影子内存对应的8个字节的内存都能访问，如果0&lt;k&lt;7,表示前k个字节可以访问，如果k为负数，不同的数字表示不同的错误（e.g. Stack buffer overflow, Heap buffer overflow)。 </p>
<p>AddressSanitizer 将<code>Mem</code>中的8个字节映射为<code>Shadow</code>内存中的1个字节。</p>
<p>对于<code>Mem</code>中的任意8个字节，有9个不同的<code>shadow</code>值：</p>
<ul>
<li>所有8个字节均可以被访问，被标记为<code>unpoisoned</code>，对应的 shadow 值为0</li>
<li>所有8个字节均不可以被访问，被标记为<code>poisoned</code>，对应的 shadow 值为负数</li>
<li>前<code>k</code>字节被标记为<code>unpoisoned</code>，剩下的<code>8-k</code>字节被标记为<code>poisoned</code>，对应的shadow 值为 k。这通过<code>malloc</code>返回8字节对齐的chunk 块来保证。8字节对齐的内存区域中，不同字节拥有不同的state的唯一情况出现在所分配内存区域的尾部。例如，如果调用<code>malloc(13)</code>，我们将获得一个完整qword，它被标记为<code>unpoisoned</code>，以及另一个<code>qward</code>，它的前5个字节被标记为<code>unpoisoned</code>。</li>
</ul>
<p>对应的插桩代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span> *shadow_address = MemToShadow(address);</span><br><span class="line"><span class="keyword">byte</span> shadow_value = *shadow_address;</span><br><span class="line"><span class="keyword">if</span> (shadow_value) &#123;</span><br><span class="line">  <span class="keyword">if</span> (SlowPathCheck(shadow_value, address, kAccessSize)) &#123;</span><br><span class="line">    ReportError(address, kAccessSize, kIsWrite);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check the cases where we access first k bytes of the qword</span></span><br><span class="line"><span class="comment">// and these k bytes are unpoisoned.</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">SlowPathCheck</span><span class="params">(shadow_value, address, kAccessSize)</span> </span>&#123;</span><br><span class="line">  last_accessed_byte = (address &amp; <span class="number">7</span>) + kAccessSize - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> (last_accessed_byte &gt;= shadow_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果程序尝试访问在 shadow 区域的内存，那么会直接造成崩溃。</p>
<h5 id="64-bit"><a href="#64-bit" class="headerlink" title="64-bit"></a>64-bit</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shadow = (Mem &gt;&gt; <span class="number">3</span>) + <span class="number">0x7fff8000</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><code>[0x10007fff8000, 0x7fffffffffff]</code></th>
<th><code>HighMem</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>[0x02008fff7000, 0x10007fff7fff]</code></td>
<td><code>HighShadow</code></td>
</tr>
<tr>
<td><code>[0x00008fff7000, 0x02008fff6fff]</code></td>
<td><code>ShadowGap</code></td>
</tr>
<tr>
<td><code>[0x00007fff8000, 0x00008fff6fff]</code></td>
<td><code>LowShadow</code></td>
</tr>
<tr>
<td><code>[0x000000000000, 0x00007fff7fff]</code></td>
<td><code>LowMem</code></td>
</tr>
</tbody></table>
<h5 id="32-bit"><a href="#32-bit" class="headerlink" title="32 bit"></a>32 bit</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shadow = (Mem &gt;&gt; <span class="number">3</span>) + <span class="number">0x20000000</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><code>[0x40000000, 0xffffffff]</code></th>
<th><code>HighMem</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>[0x28000000, 0x3fffffff]</code></td>
<td><code>HighShadow</code></td>
</tr>
<tr>
<td><code>[0x24000000, 0x27ffffff]</code></td>
<td><code>ShadowGap</code></td>
</tr>
<tr>
<td><code>[0x20000000, 0x23ffffff]</code></td>
<td><code>LowShadow</code></td>
</tr>
<tr>
<td><code>[0x00000000, 0x1fffffff]</code></td>
<td><code>LowMem</code></td>
</tr>
</tbody></table>
<h5 id="Report-Error"><a href="#Report-Error" class="headerlink" title="Report Error"></a>Report Error</h5><p>ReportError可以实现为call（现在是默认设置），但是还有其他一些效率更高/或更紧凑的解决方案。在某些时候，默认行为是：</p>
<ul>
<li>将崩溃地址复制到％rax（％eax）。</li>
<li>执行ud2（产生SIGILL）</li>
<li>在ud2之后的一字节指令中编码访问类型和大小。总体而言，这3条指令需要5-6个字节的机器码。</li>
</ul>
<p>可以仅使用一条指令（例如ud2），但这将需要在运行时库中具有完整的反汇编程序（或其他一些技巧）。</p>
<h4 id="插桩"><a href="#插桩" class="headerlink" title="插桩"></a>插桩</h4><p>为了防止buffer overflow，需要将原来分配的内存两边分配额外的内存Redzone，并将这两边的内存加锁，设为不能访问状态，这样可以有效的防止buffer overflow(但不能杜绝buffer overflow)。以下是在栈中插桩的一个例子。</p>
<p>未插桩代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> a[<span class="number">8</span>];</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插桩后的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> redzone1[<span class="number">32</span>];  <span class="comment">// 32-byte aligned</span></span><br><span class="line">  <span class="keyword">char</span> a[<span class="number">8</span>];          <span class="comment">// 32-byte aligned</span></span><br><span class="line">  <span class="keyword">char</span> redzone2[<span class="number">24</span>];</span><br><span class="line">  <span class="keyword">char</span> redzone3[<span class="number">32</span>];  <span class="comment">// 32-byte aligned</span></span><br><span class="line">  <span class="keyword">int</span>  *shadow_base = MemToShadow(redzone1);</span><br><span class="line">  shadow_base[<span class="number">0</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// poison redzone1</span></span><br><span class="line">  shadow_base[<span class="number">1</span>] = <span class="number">0xffffff00</span>;  <span class="comment">// poison redzone2, unpoison 'a'</span></span><br><span class="line">  shadow_base[<span class="number">2</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// poison redzone3</span></span><br><span class="line">  ...</span><br><span class="line">  shadow_base[<span class="number">0</span>] = shadow_base[<span class="number">1</span>] = shadow_base[<span class="number">2</span>] = <span class="number">0</span>; <span class="comment">// unpoison all</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-运行库"><a href="#1-4-运行库" class="headerlink" title="1.4 运行库"></a>1.4 运行库</h3><p>在动态运行库中将<code>malloc、free</code>函数进行了替换。并提供了错误报告函数： <code>__asan_report_load8</code>。</p>
<p><code>malloc:</code>分配一定大小的内存，其周围有 redzones，并将其对应的 shadow value 标记为poisoned，分配的堆内存不做标记。</p>
<p><code>free:</code>对其释放的所有内存区域对于应的 shadows values 标记为 poisoned，并将其释放的chunk放到隔离队列中（防止该chunk很快被malloc再次申请）</p>
<h2 id="2、使用方法"><a href="#2、使用方法" class="headerlink" title="2、使用方法"></a>2、使用方法</h2><p>环境：Ubuntu 16.04  gcc 4.8以上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-fsanitize&#x3D;address：编译和链接目标程序 ，使其支持Asan</span><br><span class="line">-fno-omit-frame-pointer：在错误消息中添加更好的堆栈跟踪。</span><br><span class="line">-O1：获得更好的性能。</span><br></pre></td></tr></table></figure>

<p>测试程序的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">leaktest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *x = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">10</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>*));</span><br><span class="line">    <span class="keyword">return</span> x[<span class="number">5</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    leaktest();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输入下面命令来编译leaktest.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fsanitize&#x3D;address -fno-omit-frame-pointer -O1 -g leaktest.c -o leaktest</span><br></pre></td></tr></table></figure>

<p>运行程序，输出错误信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~ # ./leaktest </span><br><span class="line"></span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">2979</span>==ERROR: LeakSanitizer: detected memory leaks</span><br><span class="line"></span><br><span class="line">Direct leak of <span class="number">80</span> <span class="keyword">byte</span>(s) in <span class="number">1</span> object(s) allocated from:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x7f3ad5d02602</span> in <span class="built_in">malloc</span> (/usr/lib/x86_64-linux-gnu/libasan.so<span class="number">.2</span>+<span class="number">0x98602</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x400743</span> in leaktest /root/leaktest.c:<span class="number">4</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x40077c</span> in main /root/leaktest.c:<span class="number">9</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x7f3ad58c082f</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x2082f</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: <span class="number">80</span> <span class="keyword">byte</span>(s) leaked in <span class="number">1</span> allocation(s).</span><br></pre></td></tr></table></figure>

<ol>
<li>第一部分（ERROR），指出错误类型detected memory leaks；</li>
<li>第二部分给出详细的错误信息：Direct leak of 80 byte(s) in 1 object(s)，以及发生错误的对象名/源文件位置/行数；</li>
<li>第三部分是以上信息的一个总结（SUMMARY）。</li>
</ol>
<h2 id="3、AddressSanitizer能检测的错误类型（以官方Wiki为准）"><a href="#3、AddressSanitizer能检测的错误类型（以官方Wiki为准）" class="headerlink" title="3、AddressSanitizer能检测的错误类型（以官方Wiki为准）"></a>3、AddressSanitizer能检测的错误类型（以官方Wiki为准）</h2><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201113144105.png" style="zoom:50%;">

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><blockquote>
<ol>
<li><a href="https://www.bynav.com/cn/resource/bywork/healthy-work/70.html" target="_blank" rel="noopener">https://www.bynav.com/cn/resource/bywork/healthy-work/70.html</a></li>
<li><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm" target="_blank" rel="noopener">https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/04/%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E3%80%81%E9%97%B4%E6%8E%A5%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/04/%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E3%80%81%E9%97%B4%E6%8E%A5%E8%B0%83%E7%94%A8/" itemprop="url">Pintool 获取函数直接、间接调用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-11-04T10:40:52+08:00">
                2020-11-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pin/" itemprop="url" rel="index">
                    <span itemprop="name">Pin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Pintool-获取函数直接、间接调用"><a href="#Pintool-获取函数直接、间接调用" class="headerlink" title="Pintool 获取函数直接、间接调用"></a>Pintool 获取函数直接、间接调用</h1><h2 id="一、-源码"><a href="#一、-源码" class="headerlink" title="一、 源码"></a>一、 源码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></span><br><span class="line"></span><br><span class="line">FILE * trace;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">call_direct</span><span class="params">(ADDRINT target, ADDRINT ins_addr, <span class="built_in">std</span>::<span class="built_in">string</span> ins)</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"direct call: "</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; ins_addr &lt;&lt; <span class="string">" "</span> &lt;&lt; ins &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">call_indirect</span><span class="params">(ADDRINT target, BOOL taken, ADDRINT ins_addr, <span class="built_in">std</span>::<span class="built_in">string</span> ins)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!taken)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"indirect call: "</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; ins_addr &lt;&lt; <span class="string">" "</span> &lt;&lt; ins &lt;&lt; <span class="string">" "</span> &lt;&lt; target &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin calls this function every time a new instruction is encountered</span></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ADDRINT ins_addr = INS_Address(ins);</span><br><span class="line">    PIN_LockClient();</span><br><span class="line">    IMG img = IMG_FindByAddress(ins_addr);</span><br><span class="line">    PIN_UnlockClient();</span><br><span class="line">    <span class="keyword">if</span> (IMG_Valid(img))&#123;</span><br><span class="line">        <span class="keyword">if</span> (IMG_IsMainExecutable(img))&#123;</span><br><span class="line">            <span class="comment">// printf("IMG_Name: %s\n", IMG_Name(img).c_str());</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(INS_IsCall(ins))&#123; <span class="comment">//该指令是否是call指令</span></span><br><span class="line">                <span class="comment">// tail 是 call,jmp,jz,jnz等等，目标是地址。可以直接通过INS_DirectBranchOrCallTargetAddress获取到目标地址</span></span><br><span class="line">                <span class="keyword">if</span>(INS_IsDirectBranchOrCall(ins))&#123;</span><br><span class="line">                    ADDRINT target = INS_DirectBranchOrCallTargetAddress(ins);</span><br><span class="line">                    INS_InsertPredicatedCall(ins, </span><br><span class="line">                            IPOINT_BEFORE, </span><br><span class="line">                            AFUNPTR(call_direct), </span><br><span class="line">                            IARG_ADDRINT, target, </span><br><span class="line">                            IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">                            IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">                            IARG_END);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    INS_InsertCall(ins, </span><br><span class="line">                            IPOINT_BEFORE, </span><br><span class="line">                            AFUNPTR(call_indirect), </span><br><span class="line">                            IARG_BRANCH_TARGET_ADDR, </span><br><span class="line">                            IARG_BRANCH_TAKEN,</span><br><span class="line">                            IARG_ADDRINT, INS_Address(ins),</span><br><span class="line">                            IARG_PTR, <span class="keyword">new</span> <span class="built_in">string</span>(INS_Disassemble(ins)),</span><br><span class="line">                            IARG_END);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This function is called when the application exits</span></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(trace, <span class="string">"#eof\n"</span>);</span><br><span class="line">    fclose(trace);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Print Help Message                                                    */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"></span><br><span class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    PIN_ERROR(<span class="string">"This Pintool prints the IPs of every instruction executed\n"</span> </span><br><span class="line">              + KNOB_BASE::StringKnobSummary() + <span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"><span class="comment">/* Main                                                                  */</span></span><br><span class="line"><span class="comment">/* ===================================================================== */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    trace = fopen(<span class="string">"itrace.out"</span>, <span class="string">"w"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Initialize pin</span></span><br><span class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></span><br><span class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register Fini to be called when the application exits</span></span><br><span class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start the program, never returns</span></span><br><span class="line">    PIN_StartProgram();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、Makefile"><a href="#二、Makefile" class="headerlink" title="二、Makefile"></a>二、Makefile</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line">#                   DO NOT EDIT THIS FILE!</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"># If the tool is built out of the kit, PIN_ROOT must be specified in the make invocation <span class="keyword">and</span> <span class="built_in">point</span> to the kit root.</span><br><span class="line">ifdef PIN_ROOT</span><br><span class="line">CONFIG_ROOT := $(PIN_ROOT)/source/tools/Config</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">CONFIG_ROOT := ../Config</span><br><span class="line">endif</span><br><span class="line">include $(CONFIG_ROOT)/makefile.<span class="built_in">config</span></span><br><span class="line">include makefile.rules</span><br><span class="line">include $(TOOLS_ROOT)/Config/makefile.<span class="keyword">default</span>.rules</span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line">#                   DO NOT EDIT THIS FILE!</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br></pre></td></tr></table></figure>

<h2 id="三、Makefile-rules"><a href="#三、Makefile-rules" class="headerlink" title="三、Makefile.rules"></a>三、Makefile.rules</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># This file includes all the test targets as well as all the</span><br><span class="line"><span class="meta"># non-default build rules and test recipes.</span></span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># Test targets</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line">###### Place all generic definitions here ######</span><br><span class="line"></span><br><span class="line"># This defines tests which <span class="built_in">run</span> tools of the same name.  This is simply <span class="keyword">for</span> convenience to avoid</span><br><span class="line"><span class="meta"># defining the test name twice (once in TOOL_ROOTS and again in TEST_ROOTS).</span></span><br><span class="line"># Tests defined here should <span class="keyword">not</span> be defined in TOOL_ROOTS <span class="keyword">and</span> TEST_ROOTS.</span><br><span class="line"></span><br><span class="line">TEST_TOOL_ROOTS := callstack</span><br><span class="line"></span><br><span class="line"># This defines the tests to be <span class="built_in">run</span> that were <span class="keyword">not</span> already defined in TEST_TOOL_ROOTS.</span><br><span class="line">TEST_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines a <span class="built_in">list</span> of tests that should <span class="built_in">run</span> in the <span class="string">"short"</span> sanity. Tests in <span class="keyword">this</span> <span class="built_in">list</span> must also</span><br><span class="line"># appear either in the TEST_TOOL_ROOTS <span class="keyword">or</span> the TEST_ROOTS <span class="built_in">list</span>.</span><br><span class="line"># If the entire directory should be tested in sanity, assign TEST_TOOL_ROOTS <span class="keyword">and</span> TEST_ROOTS to the</span><br><span class="line"># SANITY_SUBSET variable in the tests section below (see example in makefile.rules.tmpl).</span><br><span class="line">SANITY_SUBSET :=</span><br><span class="line"></span><br><span class="line"># This defines the tools which will be <span class="built_in">run</span> during the the tests, <span class="keyword">and</span> were <span class="keyword">not</span> already defined in</span><br><span class="line"># TEST_TOOL_ROOTS.</span><br><span class="line">TOOL_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines the <span class="keyword">static</span> analysis tools which will be <span class="built_in">run</span> during the the tests. They should <span class="keyword">not</span></span><br><span class="line"># be defined in TEST_TOOL_ROOTS. If a test with the same name <span class="built_in">exists</span>, it should be defined in</span><br><span class="line"># TEST_ROOTS.</span><br><span class="line"># Note: Static analysis tools are in fact executables linked with the Pin Static Analysis Library.</span><br><span class="line"># This library provides a subset of the Pin APIs which allows the tool to perform <span class="keyword">static</span> analysis</span><br><span class="line"># of an application <span class="keyword">or</span> dll. Pin itself is <span class="keyword">not</span> used when <span class="keyword">this</span> tool runs.</span><br><span class="line">SA_TOOL_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines all the applications that will be <span class="built_in">run</span> during the tests.</span><br><span class="line">APP_ROOTS := fibonacci little_malloc thread_app</span><br><span class="line"></span><br><span class="line"># This defines any additional object files that need to be compiled.</span><br><span class="line">OBJECT_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines any additional dlls (shared objects), other than the pintools, that need to be compiled.</span><br><span class="line">DLL_ROOTS :=</span><br><span class="line"></span><br><span class="line"># This defines any <span class="keyword">static</span> libraries (archives), that need to be built.</span><br><span class="line">LIB_ROOTS :=</span><br><span class="line"></span><br><span class="line">###### Place probe mode tests here ######</span><br><span class="line">ifeq ($(PROBE),<span class="number">1</span>)</span><br><span class="line">    TEST_TOOL_ROOTS += replacesigprobed</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">###### Place OS-specific definitions here ######</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">ifeq ($(TARGET_OS),linux)</span><br><span class="line">    TEST_TOOL_ROOTS += buffer_linux fork_jit_tool follow_child_tool strace emudiv</span><br><span class="line">    TEST_ROOTS += statica</span><br><span class="line">    SA_TOOL_ROOTS += statica</span><br><span class="line">    APP_ROOTS += fork_app follow_child_app1 follow_child_app2 divide_by_zero</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"># Mac</span><br><span class="line">ifeq ($(TARGET_OS),mac)</span><br><span class="line">    TEST_TOOL_ROOTS += fork_jit_tool follow_child_tool strace</span><br><span class="line">    TEST_ROOTS += statica</span><br><span class="line">    SA_TOOL_ROOTS += statica</span><br><span class="line">    APP_ROOTS += fork_app follow_child_app1 follow_child_app2</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"># Windows</span><br><span class="line">ifeq ($(TARGET_OS),windows)</span><br><span class="line">    TEST_TOOL_ROOTS += w_malloctrace buffer_windows emudiv</span><br><span class="line">    APP_ROOTS += divide_by_zero</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">###### Handle exceptions here ######</span><br><span class="line"></span><br><span class="line"># TODO: These tests fail - fix <span class="keyword">and</span> <span class="built_in">remove</span> the following:</span><br><span class="line"># See mantis <span class="number">2963</span></span><br><span class="line">ifeq ($(TARGET),mic)</span><br><span class="line">    TEST_TOOL_ROOTS := $(filter-out nonstatica emudiv, $(TEST_TOOL_ROOTS))</span><br><span class="line">    TEST_ROOTS := $(filter-out statica, $(TEST_ROOTS))</span><br><span class="line">    SA_TOOL_ROOTS := $(filter-out statica, $(SA_TOOL_ROOTS))</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"># TODO: These tests fail - fix <span class="keyword">and</span> <span class="built_in">remove</span> the following:</span><br><span class="line">ifeq ($(TARGET_OS),mac)</span><br><span class="line">    TEST_TOOL_ROOTS := $(filter-out follow_child_tool fork_jit_tool inscount_tls invocation malloc_mt <span class="built_in">stack</span>-debugger, \</span><br><span class="line">                                    $(TEST_TOOL_ROOTS))</span><br><span class="line">    TEST_ROOTS := $(filter-out statica, $(TEST_ROOTS))</span><br><span class="line">    SA_TOOL_ROOTS := $(filter-out statica, $(SA_TOOL_ROOTS))</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># Test recipes</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"># This section contains recipes <span class="keyword">for</span> tests other than the <span class="keyword">default</span>.</span><br><span class="line"># See makefile.<span class="keyword">default</span>.rules <span class="keyword">for</span> the <span class="keyword">default</span> test rules.</span><br><span class="line"># All tests in <span class="keyword">this</span> section should adhere to the naming convention: &lt;testname&gt;.test</span><br><span class="line"></span><br><span class="line">inscount_tls.test: $(OBJDIR)inscount_tls$(PINTOOL_SUFFIX) $(OBJDIR)thread_app$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)inscount_tls$(PINTOOL_SUFFIX) -- $(OBJDIR)thread_app$(EXE_SUFFIX) &gt; $(OBJDIR)inscount_tls.out <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">	$(RM) $(OBJDIR)inscount_tls.out</span><br><span class="line"></span><br><span class="line">malloc_mt.test: $(OBJDIR)malloc_mt$(PINTOOL_SUFFIX) $(OBJDIR)thread_app$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)malloc_mt$(PINTOOL_SUFFIX) -- $(OBJDIR)thread_app$(EXE_SUFFIX) &gt; $(OBJDIR)malloc_mt.out <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">	$(RM) $(OBJDIR)malloc_mt.out</span><br><span class="line"></span><br><span class="line">buffer_linux.test: $(OBJDIR)buffer_linux$(PINTOOL_SUFFIX) $(OBJDIR)thread_app$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)buffer_linux$(PINTOOL_SUFFIX) -- $(OBJDIR)thread_app$(EXE_SUFFIX) &gt; $(OBJDIR)buffer_linux.out <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">	$(RM) $(OBJDIR)buffer_linux.out</span><br><span class="line"></span><br><span class="line">buffer_windows.test: $(OBJDIR)buffer_windows$(PINTOOL_SUFFIX) $(OBJDIR)thread_app$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)buffer_windows$(PINTOOL_SUFFIX) -emit <span class="number">0</span> \</span><br><span class="line">	  -- $(OBJDIR)thread_app$(EXE_SUFFIX) &gt; $(OBJDIR)buffer_windows.out <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">	$(RM) $(OBJDIR)buffer_windows.out</span><br><span class="line"></span><br><span class="line">invocation.test: $(OBJDIR)invocation$(PINTOOL_SUFFIX) $(OBJDIR)little_malloc$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)invocation$(PINTOOL_SUFFIX) -- $(OBJDIR)little_malloc$(EXE_SUFFIX) &gt; $(OBJDIR)invocation.out <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">	$(RM) $(OBJDIR)invocation.out</span><br><span class="line"></span><br><span class="line"># This tool is tested in <span class="string">"Debugger/makefile"</span>. However, leave <span class="keyword">this</span> <span class="built_in">line</span> because it is referenced in the user manual.</span><br><span class="line"># The user may invoke make <span class="built_in">stack</span>-debugger.test to build the tool <span class="keyword">and</span> app shown in the manual.</span><br><span class="line"># There is an intentional <span class="string">"empty"</span> <span class="built_in">line</span> which contains a tab character so <span class="keyword">this</span> <span class="string">"test"</span> will have an empty recipe.</span><br><span class="line"><span class="built_in">stack</span>-debugger.test: $(OBJDIR)<span class="built_in">stack</span>-debugger$(PINTOOL_SUFFIX) $(OBJDIR)fibonacci$(EXE_SUFFIX)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"># stand alone pin tool</span><br><span class="line">statica.test: $(OBJDIR)statica$(SATOOL_SUFFIX)</span><br><span class="line">	$(OBJDIR)statica$(SATOOL_SUFFIX) -i $(OBJDIR)statica$(SATOOL_SUFFIX) &gt; $(OBJDIR)statica.dmp</span><br><span class="line">	$(RM) $(OBJDIR)statica.dmp</span><br><span class="line"></span><br><span class="line">nonstatica.test: $(OBJDIR)nonstatica$(PINTOOL_SUFFIX) $(TESTAPP)</span><br><span class="line">	$(PIN) -t $(OBJDIR)nonstatica$(PINTOOL_SUFFIX) \</span><br><span class="line">	  -- $(TESTAPP) makefile $(OBJDIR)nonstatica.makefile.copy &gt; $(OBJDIR)nonstatica.dmp</span><br><span class="line">	$(DIFF) makefile $(OBJDIR)nonstatica.makefile.copy</span><br><span class="line">	$(RM) $(OBJDIR)nonstatica.makefile.copy $(OBJDIR)nonstatica.dmp</span><br><span class="line"></span><br><span class="line">emudiv.test: $(OBJDIR)emudiv$(PINTOOL_SUFFIX) $(OBJDIR)divide_by_zero$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)emudiv$(PINTOOL_SUFFIX) -- $(OBJDIR)divide_by_zero$(EXE_SUFFIX) &gt; $(OBJDIR)emudiv.out <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">	$(QGREP) <span class="string">"Caught divide by zero exception"</span> $(OBJDIR)emudiv.out</span><br><span class="line">	$(RM) $(OBJDIR)emudiv.out</span><br><span class="line"></span><br><span class="line">fork_jit_tool.test: $(OBJDIR)fork_jit_tool$(PINTOOL_SUFFIX) $(OBJDIR)fork_app$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -t $(OBJDIR)fork_jit_tool$(PINTOOL_SUFFIX) -- $(OBJDIR)fork_app$(EXE_SUFFIX)</span><br><span class="line"></span><br><span class="line">follow_child_tool.test: $(OBJDIR)follow_child_tool$(PINTOOL_SUFFIX) $(OBJDIR)follow_child_app1$(EXE_SUFFIX) $(OBJDIR)follow_child_app2$(EXE_SUFFIX)</span><br><span class="line">	$(PIN) -follow_execv <span class="number">1</span> -t $(OBJDIR)follow_child_tool$(PINTOOL_SUFFIX) \</span><br><span class="line">	  -- $(OBJDIR)follow_child_app1$(EXE_SUFFIX) $(OBJDIR)follow_child_app2$(EXE_SUFFIX)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##############################################################</span><br><span class="line">#</span><br><span class="line"># Build rules</span><br><span class="line">#</span><br><span class="line">##############################################################</span><br><span class="line"></span><br><span class="line"># This section contains the build rules <span class="keyword">for</span> all binaries that have special build rules.</span><br><span class="line"># See makefile.<span class="keyword">default</span>.rules <span class="keyword">for</span> the <span class="keyword">default</span> build rules.</span><br><span class="line"></span><br><span class="line">###### Special applications<span class="number">'</span> build rules ######</span><br><span class="line"></span><br><span class="line">$(OBJDIR)divide_by_zero$(EXE_SUFFIX): divide_by_zero_$(TARGET_OS).c</span><br><span class="line">	$(APP_CC) $(APP_CXXFLAGS_NOOPT) $(COMP_EXE)$@ $&lt; $(APP_LDFLAGS_NOOPT) $(APP_LIBS)</span><br><span class="line"></span><br><span class="line">$(OBJDIR)thread_app$(EXE_SUFFIX): thread_$(OS_TYPE).c</span><br><span class="line">	$(APP_CC) $(APP_CXXFLAGS) $(COMP_EXE)$@ $&lt; $(APP_LDFLAGS) $(APP_LIBS)</span><br></pre></td></tr></table></figure>

<h2 id="四、运行结果"><a href="#四、运行结果" class="headerlink" title="四、运行结果"></a>四、运行结果</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:ManualExamples# /<span class="built_in">home</span>/hpfuzzer/pin/pin -t ./obj-ia32/callstack.so -- /<span class="built_in">home</span>/hpfuzzer/swftophp /<span class="built_in">home</span>/hpfuzzer/input.txt</span><br><span class="line">direct call: <span class="number">8048e9</span>c call <span class="number">0x8048d70</span></span><br><span class="line">direct call: <span class="number">8066</span>ec6 call <span class="number">0x8048eb0</span></span><br><span class="line">direct call: <span class="number">8066</span>ede call <span class="number">0x8048ba8</span></span><br><span class="line">direct call: <span class="number">8048b</span>ac call <span class="number">0x8048eb0</span></span><br><span class="line">indirect call: <span class="number">8066f</span>0b call dword ptr [ebx+edi*<span class="number">4</span><span class="number">-0x11c</span>] <span class="number">8048f</span>50</span><br><span class="line">direct call: <span class="number">804e1</span>e4 call <span class="number">0x8048be0</span></span><br><span class="line">......</span><br><span class="line">direct call: <span class="number">8066f</span>96 call <span class="number">0x8048d10</span></span><br><span class="line">indirect call: <span class="number">804</span>df32 call eax b673e9f1</span><br><span class="line">header indicates a filesize of <span class="number">543449459</span> but filesize is <span class="number">22</span></span><br><span class="line">direct call: <span class="number">804</span>df4a call <span class="number">0x8064942</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/26/valgrind/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/26/valgrind/" itemprop="url">valgrind</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-26T17:41:01+08:00">
                2020-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Valgrind/" itemprop="url" rel="index">
                    <span itemprop="name">Valgrind</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>Valgrind 是一个用于内存调试、内存泄漏检测以及性能分析的动态二进制插桩工具。Valgrind 由 core 以及基于 core 的其他调试工具组成。core 类似于一个框架，它模拟了一个 CPU 环境，并提供服务给其他工具，而其他工具以插件的形式利用 core 提供的服务完成各种特定的任务。这些工具之中最有名的是Memcheck，它能够识别很多C或者C++程序中内存相关的错误。</p>
<p>VEX IR 是 Valgrind 所使用的中间表示，供 DBI 使用，后来这一部分被分离出去作为 libVEX，libVEX 负责将机器码转换成 VEX IR，转换结果存放在 cache 中。其他的类似用途的 IR 还有：BAP、REIL、LLVM、TCG 等。</p>
<h2 id="二、Valgrind的主要工具"><a href="#二、Valgrind的主要工具" class="headerlink" title="二、Valgrind的主要工具"></a>二、Valgrind的主要工具</h2><p>Valgrind工具包包含多个工具，如 Memcheck、Cachegrind、Helgrind、Callgrind、Massif。下面分别介绍个工具的作用：</p>
<h3 id="Memcheck"><a href="#Memcheck" class="headerlink" title="Memcheck"></a>Memcheck</h3><p>Memcheck工具主要检查下面的程序错误：</p>
<ul>
<li>使用未初始化的内存 (Use of uninitialised memory)</li>
<li>使用已经释放了的内存 (Reading/writingmemory after it has been free’d)</li>
<li>使用超过 malloc分配的内存空间(Reading/writing off the end of malloc’d blocks)</li>
<li>对堆栈的非法访问 (Reading/writinginappropriate areas on the stack)</li>
<li>申请的空间是否有释放 (Memory leaks –where pointers to malloc’d blocks are lost forever)</li>
<li>malloc/free/new/delete申请和释放内存的匹配(Mismatched use of malloc/new/new [] vs free/delete/delete [])</li>
<li>src和dst的重叠(Overlapping src and dst pointers in memcpy() and related functions)</li>
</ul>
<h3 id="Callgrind"><a href="#Callgrind" class="headerlink" title="Callgrind"></a>Callgrind</h3><p>Callgrind收集程序运行时的一些数据，函数调用关系等信息，还可以有选择地进行cache模拟。在运行结束时，它会把分析数据写入一个文件。callgrind_annotate可以把这个文件的内容转化成可读的形式。</p>
<h3 id="Cachegrind"><a href="#Cachegrind" class="headerlink" title="Cachegrind"></a>Cachegrind</h3><p>它模拟 CPU中的一级缓存I1、D1和L2二级缓存，能够精确地指出程序中cache的丢失和命中。如果需要，它还能够为我们提供cache丢失次数，内存引用次数，以及每行代码，每个函数，每个模块，整个程序产生的指令数。这对优化程序有很大的帮助。</p>
<h3 id="Helgrind"><a href="#Helgrind" class="headerlink" title="Helgrind"></a>Helgrind</h3><p>它主要用来检查多线程程序中出现的竞争问题。Helgrind寻找内存中被多个线程访问，而又没有一贯加锁的区域，这些区域往往是线程之间失去同步的地方，而且会导致难以发掘的错误。Helgrind实现了名为” Eraser” 的竞争检测算法，并做了进一步改进，减少了报告错误的次数。</p>
<h3 id="Massif"><a href="#Massif" class="headerlink" title="Massif"></a>Massif</h3><p>堆栈分析器，它能测量程序在堆栈中使用了多少内存，告诉我们堆块，堆管理块和栈的大小。Massif能帮助我们减少内存的使用，在带有虚拟内存的现代系统中，它还能够加速我们程序的运行，减少程序停留在交换区中的几率。</p>
<h2 id="三、使用方法"><a href="#三、使用方法" class="headerlink" title="三、使用方法"></a>三、使用方法</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//sourceware.org/pub/valgrind/valgrind-3.16.1.tar.bz2</span></span><br><span class="line">tar -xjvf valgrind<span class="number">-3.16</span><span class="number">.1</span>.tar.bz2</span><br><span class="line">cd valgrind<span class="number">-3.16</span><span class="number">.1</span>/</span><br><span class="line"></span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>运行 Valgrind 的格式如下，常用的选项是 <code>-tool=&lt;name&gt;</code>，默认为 Memcheck。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:hpfuzzer<span class="meta"># valgrind --help</span></span><br><span class="line">usage: valgrind [options] prog-<span class="keyword">and</span>-args</span><br><span class="line"></span><br><span class="line">  tool-selection option, with <span class="keyword">default</span> in [ ]:</span><br><span class="line">    --tool=&lt;name&gt;             use the Valgrind tool named &lt;name&gt; [memcheck]</span><br></pre></td></tr></table></figure>

<h3 id="实例："><a href="#实例：" class="headerlink" title="实例："></a>实例：</h3><p>Memcheck是默认的工具，开启–leak-check选项会启动内存泄露检查。你的程序会比正常运行慢很多(大概20到30倍)，并且会使用更多的内存。Memcheck会记录检测到的内存错误和内存泄露信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">   <span class="keyword">int</span>* x = <span class="built_in">malloc</span>(<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">   x[<span class="number">10</span>] = <span class="number">0</span>;        <span class="comment">// problem 1: heap block overrun</span></span><br><span class="line">&#125;                    <span class="comment">// problem 2: memory leak -- x not freed</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">   f();</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是一段有内存错误的程序，对它进行测试。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -g -o a a.c   </span><br><span class="line">valgrind --leak-check=yes ./a</span><br></pre></td></tr></table></figure>

<p>输出信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:hpfuzzer<span class="meta"># valgrind --leak-check=yes ./a</span></span><br><span class="line">==<span class="number">22415</span>== Memcheck, a memory error detector <span class="comment">//11298进程号</span></span><br><span class="line">==22415== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.</span><br><span class="line">==<span class="number">22415</span>== Using Valgrind<span class="number">-3.16</span><span class="number">.1</span> <span class="keyword">and</span> LibVEX; rerun with -h <span class="keyword">for</span> copyright info</span><br><span class="line">==<span class="number">22415</span>== Command: ./a</span><br><span class="line">==<span class="number">22415</span>==</span><br><span class="line">==<span class="number">22415</span>== Invalid <span class="built_in">write</span> of <span class="built_in">size</span> <span class="number">4</span>		<span class="comment">//检测出problem1，提示非法写操作</span></span><br><span class="line">==<span class="number">22415</span>==    at <span class="number">0x8048438</span>: f (in /<span class="built_in">home</span>/hpfuzzer/a)</span><br><span class="line">==<span class="number">22415</span>==    by <span class="number">0x804844A</span>: main (in /<span class="built_in">home</span>/hpfuzzer/a)</span><br><span class="line">==<span class="number">22415</span>==  Address <span class="number">0x41ef050</span> is <span class="number">0</span> bytes after a block of <span class="built_in">size</span> <span class="number">40</span> alloc<span class="number">'</span>d</span><br><span class="line">==<span class="number">22415</span>==    at <span class="number">0x40295E8</span>: <span class="built_in">malloc</span> (vg_replace_malloc.c:<span class="number">307</span>)</span><br><span class="line">==<span class="number">22415</span>==    by <span class="number">0x804842E</span>: f (in /<span class="built_in">home</span>/hpfuzzer/a)</span><br><span class="line">==<span class="number">22415</span>==    by <span class="number">0x804844A</span>: main (in /<span class="built_in">home</span>/hpfuzzer/a)</span><br><span class="line">==<span class="number">22415</span>==</span><br><span class="line">==<span class="number">22415</span>==</span><br><span class="line">==<span class="number">22415</span>== HEAP SUMMARY:		<span class="comment">//检测出problem2</span></span><br><span class="line">==<span class="number">22415</span>==     in use at <span class="built_in">exit</span>: <span class="number">40</span> bytes in <span class="number">1</span> blocks</span><br><span class="line">==<span class="number">22415</span>==   total heap usage: <span class="number">1</span> allocs, <span class="number">0</span> frees, <span class="number">40</span> bytes allocated</span><br><span class="line">==<span class="number">22415</span>==</span><br><span class="line">==<span class="number">22415</span>== <span class="number">40</span> bytes in <span class="number">1</span> blocks are definitely lost in loss record <span class="number">1</span> of <span class="number">1</span></span><br><span class="line">==<span class="number">22415</span>==    at <span class="number">0x40295E8</span>: <span class="built_in">malloc</span> (vg_replace_malloc.c:<span class="number">307</span>)</span><br><span class="line">==<span class="number">22415</span>==    by <span class="number">0x804842E</span>: f (in /<span class="built_in">home</span>/hpfuzzer/a)</span><br><span class="line">==<span class="number">22415</span>==    by <span class="number">0x804844A</span>: main (in /<span class="built_in">home</span>/hpfuzzer/a)</span><br><span class="line">==<span class="number">22415</span>==</span><br><span class="line">==<span class="number">22415</span>== LEAK SUMMARY:		<span class="comment">//内存泄露的信息</span></span><br><span class="line">==<span class="number">22415</span>==    definitely lost: <span class="number">40</span> bytes in <span class="number">1</span> blocks	</span><br><span class="line">==<span class="number">22415</span>==    indirectly lost: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">22415</span>==      possibly lost: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">22415</span>==    still reachable: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">22415</span>==         suppressed: <span class="number">0</span> bytes in <span class="number">0</span> blocks</span><br><span class="line">==<span class="number">22415</span>==</span><br><span class="line">==<span class="number">22415</span>== For lists of detected <span class="keyword">and</span> suppressed errors, rerun with: -s</span><br><span class="line">==<span class="number">22415</span>== ERROR SUMMARY: <span class="number">2</span> errors from <span class="number">2</span> contexts (suppressed: <span class="number">0</span> from <span class="number">0</span>)	<span class="comment">//上面程序的2个内存错误均被检测出来</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>Valgrind 用户手册：<a href="https://www.valgrind.org/docs/manual/manual.html" target="_blank" rel="noopener">https://www.valgrind.org/docs/manual/manual.html</a></li>
<li><a href="https://www.jianshu.com/p/7ce24f278b0e" target="_blank" rel="noopener">https://www.jianshu.com/p/7ce24f278b0e</a></li>
</ol>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/21/Introduction%20to%20Simulated%20Annealing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/21/Introduction%20to%20Simulated%20Annealing/" itemprop="url">Introduction to Simulated Annealing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-21T17:12:05+08:00">
                2020-10-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithms</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、求解全局最优解遇到的问题"><a href="#一、求解全局最优解遇到的问题" class="headerlink" title="一、求解全局最优解遇到的问题"></a>一、求解全局最优解遇到的问题</h2><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201021160838.png" style="zoom: 50%;">

<p>局部搜索方法，例如：梯度下降法在寻找局部最优解方面性能非常好。但当全局最优解与局部最优解不同时会出现问题，由于局部最优解附近所有直接相邻点的性能都比其差，因此一旦陷入局部最优，无法继续进行搜索。我们需要某种机制来帮助我们摆脱当前的局部最优，模拟退火算法是解决办法之一。</p>
<h2 id="二、可能的解决方案"><a href="#二、可能的解决方案" class="headerlink" title="二、可能的解决方案"></a>二、可能的解决方案</h2><h3 id="1-每当陷入局部最优状态时，随机选择一个新的起点（水平方向晃动图片）。"><a href="#1-每当陷入局部最优状态时，随机选择一个新的起点（水平方向晃动图片）。" class="headerlink" title="1. 每当陷入局部最优状态时，随机选择一个新的起点（水平方向晃动图片）。"></a>1. 每当陷入局部最优状态时，随机选择一个新的起点（水平方向晃动图片）。</h3><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/image-20201021161347916.png" style="zoom:50%;">

<h3 id="2-每当陷入局部最优状态时，偶尔沿上升方向进行搜索（垂直方向摇动图片）。"><a href="#2-每当陷入局部最优状态时，偶尔沿上升方向进行搜索（垂直方向摇动图片）。" class="headerlink" title="2. 每当陷入局部最优状态时，偶尔沿上升方向进行搜索（垂直方向摇动图片）。"></a>2. 每当陷入局部最优状态时，偶尔沿上升方向进行搜索（垂直方向摇动图片）。</h3><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201021161549.png" style="zoom:50%;">

<h2 id="三、模拟退火算法"><a href="#三、模拟退火算法" class="headerlink" title="三、模拟退火算法"></a>三、模拟退火算法</h2><p>模拟退火的名称来源于模拟加热固体的退火过程。“在凝聚态物理学中，退火是指一个物理过程，在该过程中，对固体加热并逐渐将温度提高到最大值，从而使所有固体内粒子随机地排列，然后缓慢降低温度来使其冷却。这样，所有粒子都以低能有序的排列。” </p>
<p>在解决优化问题时，我们可以模拟上述过程。其基本思想是，允许搜索过程偶尔朝着不利的方向进行搜索，也许可以摆脱局部最优，而到达全局最优。</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201021162729.png" style="zoom:50%;">

<p>但是，凡事具有两面性。从上图来看，偶尔”上坡“会有两种情况。一方面，它可以使得算法走出局部最优。另一方面，也可能越过全局最优。为了保持理想的效果并减少不利影响，我们需要一个复杂的方案来控制如何接受这种偶然性，这是模拟退火的核心。</p>
<h2 id="四、模拟退火算法的控制"><a href="#四、模拟退火算法的控制" class="headerlink" title="四、模拟退火算法的控制"></a>四、模拟退火算法的控制</h2><p><strong>Acceptance of a search step (Metropolis Criterion):</strong></p>
<ul>
<li>假设在搜索方向上性能改变的差异为$\Delta$</li>
<li>如果 $\Delta &lt;0$ ，那么我们永远接受此下降的步骤</li>
<li>否则，将以概率 $exp^{(-\frac{\Delta}{T})}$ 来接受此上升的步骤，其中 T 是参数</li>
</ul>
<p><strong>Cooling Schedule:</strong></p>
<ul>
<li>T，即退火温度，是控制接受上升步骤的频率的参数</li>
<li>我们需要逐渐降低温度 T(k)</li>
<li>在每个温度值下，允许进行探索的步骤的次数是 L（k）</li>
<li>参数 ${T(k),L(k)}$ 的选择称为 <code>colling schedule</code></li>
</ul>
<p>显然，参数 T 起着关键作用。T 越小，接受不利步骤的可能性就越小。为了获得理想的结果，随着算法的进行，需要将参数 T 逐渐减小。 因此，T 的初始值很大，搜索可以轻松摆脱局部最优。然后，通过减小 T 使得算法收敛。通常的做法是，在每次修改 T 值之后，我们都允许算法探索 L（k）步。</p>
<h2 id="五、模拟退火的算法"><a href="#五、模拟退火的算法" class="headerlink" title="五、模拟退火的算法"></a>五、模拟退火的算法</h2><ol>
<li>k = 0</li>
<li>从状态 i 到达状态 j，性能差距为 $\Delta$</li>
<li>如果 $\Delta &lt;0$ ，接受此步骤，否者若满足 $exp^{(-\frac{\Delta}{T})} &gt; random[0,1)$ 才接受此步骤</li>
<li>对 2、3 重复 L（k）次</li>
<li>k = k+1</li>
<li>重复1-5，直到满足条件</li>
</ol>
<p>模拟退火算法的实现取决于具体问题。首先，必须选择适当的局部搜索策略。我们需要定义一个”邻域结构“，然后通常随机选择当前状态的一个邻居来执行搜索操作。</p>
<h2 id="六、模拟退火算法的实现"><a href="#六、模拟退火算法的实现" class="headerlink" title="六、模拟退火算法的实现"></a>六、模拟退火算法的实现</h2><p><strong>Select a local search scheme：</strong></p>
<ul>
<li>Define a neighborhood structure</li>
<li>Sample a new design from the neighboring designs of the current design.</li>
<li>Accept the new design based on Metropolis Criterion.</li>
</ul>
<p><strong>Determine the cooling schedule：</strong></p>
<p>例如：</p>
<ul>
<li>设置 <em>L</em> = <em>n</em> （n为问题的规模）</li>
<li>设置 $T(0)$ 例如 $exp^{(-\frac{\Delta}{T(0)})} \approx 1$</li>
<li>设置 $T(k+1) = \alpha \cdot T(k)$, 其中 $\alpha$ 是一个接近于1的常数</li>
</ul>
<p>需要注意的是，这里没有固定的 <code>colling schedule</code>公式。基本原则是：在每个温度下设置的搜索步骤数目应足够，通常与问题的规模大小相关；初始温度应足够高来提高接受不利状态的概率；温度的降低的速度不应太快。</p>
<h2 id="七、备注"><a href="#七、备注" class="headerlink" title="七、备注"></a>七、备注</h2><p><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201021170805.png" alt></p>
<p><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201021171504.png" alt></p>
<h2 id="八、参考"><a href="#八、参考" class="headerlink" title="八、参考"></a>八、参考</h2><blockquote>
<p><a href="http://umsl.edu/~adhikarib/cs4130-fall2017/slides/11%20-%20The%20Simulated%20Annealing%20Algorithm.pdf" target="_blank" rel="noopener">http://umsl.edu/~adhikarib/cs4130-fall2017/slides/11%20-%20The%20Simulated%20Annealing%20Algorithm.pdf</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/11/Fuzzing%20&&%20Concolic%20Execution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zyt">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/11/Fuzzing%20&&%20Concolic%20Execution/" itemprop="url">Fuzzing && Concolic Execution</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-11T13:43:18+08:00">
                2020-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Fuzzing/" itemprop="url" rel="index">
                    <span itemprop="name">Fuzzing</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Fuzzing"><a href="#Fuzzing" class="headerlink" title="Fuzzing"></a>Fuzzing</h3><p>研究人员每月发现的软件漏洞数量表明我们并没有对软件进行充分的测试。我们通常会进行回归测试，但不会以发现未知行为为目的。找到这类异常行为并非易事，所以许多开发人员尝试自动化实现。</p>
<p>自动化测试的一种常见方法是模糊测试：将随机数据作为被测程序的输入。可以使用完全随机的数据作为输入，也可以获取有效的输入（例如有效的PDF文件）作为输入，然后对其中的某些部分进行变异（基于某种形式的规范（例如，上下文无关文法））生成结构化但仍具随机性的输入。</p>
<p>模糊测试使用很广泛，但是并不总能够有效地测试程序。一方面，当以二进制文件为目标程序时，弄清楚程序所期望的输入是非常困难的。另外，随机输入可能无法到达程序深处的代码。</p>
<h3 id="Concolic-Execution"><a href="#Concolic-Execution" class="headerlink" title="Concolic Execution"></a><strong>Concolic Execution</strong></h3><p>一种更好的方法是进行Conolic Execution，它结合了对程序的具体执行和符号执行，并使用SMT求解器来求解程序输入（命令行，文件，网络等）。</p>
<p>例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> z = <span class="number">2</span>*y;</span><br><span class="line">		<span class="keyword">if</span> (x == <span class="number">100000</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (x &lt; z) &#123;</span><br><span class="line">						assert(<span class="number">0</span>);</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有其他信息，则使用模糊测试来找到满足例子中两个<code>if</code>条件的x和y值将花费很多时间。</p>
<p>Concolic Execution 首先以任意输入来具体执行程序，在运行时收集路径的符号化表示。路径的符号化表示本质上是对输入数据的所做一组逻辑约束。约束条件确保任何满足它们的输入都使得程序遵循特定的执行路径。</p>
<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201011122132.png" style="zoom:50%;">

<p>在接下来的运行中，我们取反特定的分支条件相对应的约束，并将修改后的约束集合提供给SMT求解器，求解出执行新路径的输入。例如：对于初始输入，程序执行的分支是 $x\neq 100000$，我们想要求解器找到一个新输入，使其执行分支 $x = 100000$ 。再次运行该新输入将会执行所期望的路径。</p>
<h3 id="High-Level-Picture"><a href="#High-Level-Picture" class="headerlink" title="High-Level Picture"></a>High-Level Picture</h3><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201011133749.png" style="zoom:50%;">



<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201011133749.png" style="zoom:50%;">



<img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201011133749.png" style="zoom: 50%;">

<h3 id="Concolic-Covering-Middle-Ground"><a href="#Concolic-Covering-Middle-Ground" class="headerlink" title="Concolic Covering Middle Ground"></a>Concolic Covering Middle Ground</h3><p><img src="https://cdn.jsdelivr.net/gh/zytMatrix/images/posts/20201011135233.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zyt</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zyt</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
